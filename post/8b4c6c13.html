<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3"><link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="Python,Django,在线教育平台,"><link rel="alternate" href="/atom.xml" title="mtianyan's blog" type="application/atom+xml"><meta name="description" content="「比更大还更大」(Bigger than Bigger)   初级复习: 写一个留言板来复习Django基础知识 项目实战: 使用Django+xadmin搭建一个在线教育网站最终成果: http://mxonline.mtianyan.cn  GitHub代码仓库:https://github.com/mtianyan/Mxonline2"><meta name="keywords" content="Python,Django,在线教育平台"><meta property="og:type" content="article"><meta property="og:title" content="强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版"><meta property="og:url" content="http://blog.mtianyan.cn/post/8b4c6c13.html"><meta property="og:site_name" content="mtianyan&#39;s blog"><meta property="og:description" content="「比更大还更大」(Bigger than Bigger)   初级复习: 写一个留言板来复习Django基础知识 项目实战: 使用Django+xadmin搭建一个在线教育网站最终成果: http://mxonline.mtianyan.cn  GitHub代码仓库:https://github.com/mtianyan/Mxonline2"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/a5h8mfid18.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/2A76h7im9k.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/c91fA7Lb5e.png?imageslim"><meta property="og:image" content="http://upload-images.jianshu.io/upload_images/1779926-5e9910e92bdef649.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/eGhG2Kk51D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/J808E5JA1i.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/A7Cb96mEce.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/66L7DaJJCK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/8C2KL0HaI4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/78kgLjJl4F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/c8aLD2mdC4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/DL51BD687G.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/h1Aa2aJ0G4.png?imageslim"><meta property="og:image" content="http://oerdwodsk.bkt.clouddn.com/blog/180103/E72AIkEB07.png?imageslim"><meta property="og:image" content="http://oerdwodsk.bkt.clouddn.com/blog/180103/D3jB3C6A9g.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/AmbE1564gJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/lCIHhf568m.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/A2im5He9fK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/1cJK2F43I0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/d5a87Gid1f.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/6CjH0H1l5c.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/eKh4AC1mhB.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/0cFDmJdChd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/ifi4mGE7C9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/6lCEGEAJjL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/7gBl6DHb6d.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/JAJCHgBflc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/E2GFBe08Gb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/3BicA3E8aj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/mLGD68DB8H.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/D7FEGgIiC6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/hAB7KkaB29.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/maL6ccLG90.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/Kd0cAeCj1H.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/GFCgBHH2fC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/ajiDfHmBim.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/1b0h7dh3AC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/BKLg4JDJCe.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/3aIIDddEmc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/lFgLChlhdc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/Ef2F5Bf7FA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180106/3625a0imed.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/k10eEBg357.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/I9255edkaF.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/2043A3KagE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/IhD2bJDI6K.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/b230j2d65e.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/aFheliD18B.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/ci4AKb7Lb0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/6Af7m9cI0i.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/JjH1FjmB0i.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/ghebBaKDDa.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/bd7L9HEbB1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/7L3m4291JK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/EJHc2DdkK2.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/00e3abbbFJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/g8l89KCfam.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/lJKDjik9Cb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/65Gad4D4l9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/G60aadGLkJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/4mF5KmaCKj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/gaaL4hlAGj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/bK273a3j4D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/l0I7CGB2Be.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/73EjmflBe9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/ihf44icl9d.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/bCK3e2eF9C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/7j9GC32b44.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/dbKECKEBFg.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/26GK5BjhCd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/IA82jEgmAG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/0HhH9l2B9G.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/0hADe4ggDG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/IBga4E2FGh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/FGChlB50k7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/mAebKF06m9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/0cb6GGiGDa.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/hJgD3AC3c2.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/Eal2Ldj6e8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/IChf8L7ecd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/3b7aeEg0KE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/m2fF7j38dC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/bg6ICDcI9I.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/DiBKcaJd8A.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/glha3bHaC8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/chCamk6JDk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/3cCBcF96eC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/3BL02H2ljG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/c2lIdeH2A1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/gblC5dg219.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/heblbcAf4h.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/33ECK331eE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/4Ck700a9Ea.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/i22jKb99Bh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/0mJgFKbi9k.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/BamdmLI1Ec.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/F60Dl7jf93.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/27BFK0ieIL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/mhJlLmCiLh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/Ahch4LBcKd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/kBb2Ak6ec0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/5c6fK8mDAK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/he6fBLk1le.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/ihKmHmCLcD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/DccKL0EB4C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/m8jJE8KEae.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/aehl7G2K20.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/jm5AJLLmGd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/DB9D66LmaJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/JJamFecfhC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/i6lKIGdE93.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/I1fF3aL00H.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/3Ic2ehmkGK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/8dK5e5clJB.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/383ceKe92C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/al0KDCbiK6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/628mmAGLID.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/GeEcJgAbEA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/H6jBl0IKjb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/mghmfD45hJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/JDik7FIb8k.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/ijGBh98JL6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/79bbD88gJD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/gBLe65jc53.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180108/C3h6f7d4J5.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/LedJLC8e34.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/kmDB89IcFF.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/fg4J5a2Kb5.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/8cmDm7ADf8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/7ABfdDCf7C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/c9eBEHb0mL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/75hlgK7481.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/Kec5994359.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/e3081f8bJh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/K1faIbEA3A.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/1L2lebKCl0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/DlgdiG6K16.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/fi284KlfDk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/5k6HkC49im.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/BHHfi6Gj2J.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/9IJa5kgFAG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/mdib8gdGHc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/B01J3JChmd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/i7Cc4HHBgh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/kE5Fc9kjc7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/Bd16J68e9k.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/7l4AG2maAD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/mGLjCiL8aj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180107/IhD2bJDI6K.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/biF9eAhLHi.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/hJc05K1b28.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/BH84IH9beb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/bbbKglA0LI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/5ehi0hDB3C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/8f32C0imcE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/e60fJjHeEa.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/jg51D6Baj7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/3CLeJ5LCeD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/97kgi66hBJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/BdL32DBc99.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/ggemFK9lAJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/ie29f0bI0a.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/C0h63A68F5.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/L3fGhdb7C6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/c58F6dg549.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/Fk7G3EkDC4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/761bBAhbJl.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/l4mGKFaGm4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/2c3el2afjg.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/bgleKlg6kJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/Al734ikfA4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/7ccm6L5BG7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/KFaKi4gC3C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/FbJeCbijh4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/kmCI61m81H.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/I3F7K6KhLf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/KiBgGKCgLI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/22J8la5G8c.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/3LEG0j7e2h.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/BL45eAhd66.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/8A5cED00eC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/GG009ClkEE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/F45LiKCF16.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/gb0kBFIJKH.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/0mbjJe5ImK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/aj9gJbeJJJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/fDclFJl6el.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/8lLa4IIadB.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/FcAJjJcAAm.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/am4cLCB69D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/HcG0a8g2Ef.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/FhLLheAi2f.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/0L58d277Ba.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/H8eLIc73d9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/ICGm5c3acB.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/9mcfFD7kml.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/dH8Kblkmaj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/cIe1LjK7gC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/E6il5E9j86.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180109/14kIeC7dbA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/KGcFbA85d9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/314L2DdfGB.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/34EdEDHgac.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/fBkbi7968D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/1EJD2hFc7E.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ECL5dmKFkc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/LflfkaA3Kj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/cJ8c3l41H4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/CBIAK2cjH0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ejcbBB0diJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/889BdI0a2g.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/lm6DF2CE02.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/5LiGiKh2ID.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/I2C4i7FFj4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/IkkaFHhGAl.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ddDBg58ek1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/KAFII10hf9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/mEjmk6c1j9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/CgEm92B9Ig.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/4aBegCbaAk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/cc82F1f1kE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/F7JgIA41me.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/Gcia8G8fgG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/AeBb1BJE9m.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/J4caJi44DG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/741Ia99FLf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/g1Hb79JKGK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/l55JiK9Cmh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/3i7BF5edj8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/7I9gdJ5DLj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/9mKFBk0Fc8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/Ca0lhc68He.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/aelBLBFBG3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/F86386mI15.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/EefmGb08e9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/CKdB5L49dc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/C6AajKcm51.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/G89gGl2G75.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/a3CjlEhC9B.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/4F22diHeF6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/Bb6elgf96A.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/b3CH160G9h.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/F6d3AkdJB0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/9L54Emf6md.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/kLdLLALGB1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/2Hee7I5fIl.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/Gi40A0FFhB.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/BJl97lJ8bd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/Hm54EJ7IH9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ackf2LaLJ8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/3FDhdl2aiH.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/0KkhH7b8Bm.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/0Igb4IgB0F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/JiI713cAdd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/ac8KFHkCBc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/d55glDI9E1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/DL7ejk8EcF.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/01gC20eabk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ChgL88Ed76.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/547cdji7Gl.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/BKIjc06AF3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/bA0KEd7bhc.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ahg7KfbCAi.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/8leIJ2l6LD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/6fDDI979Dk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/FL04F47985.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/gmDlEB0L2G.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/e7a65cgj8D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/ElHe2gdDAL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180110/DGHbaLBkd3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/i7DdIaB5bd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/cgk66mgd35.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/Cf24GA16g0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/4e60888a7F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/fl8Dhg5B2H.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/KEmkdk9c3b.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/FI5fafG9a8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/LFKlj0CLAb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/BfaLgiG5k3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/AiiGBEkJLj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/Idbj8d04h5.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/4gb7aiICk7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/3e96fGcGma.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/14mBAlhH8D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/bBjf5DBLh2.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/IekmEbK9A8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/hbhi9lBah2.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/9AL06C2hjh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/BL8G2CkmGl.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/emCCcfGcEd.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/7KKbaGb97i.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/D5hBDAjHeA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/CJG79b8JJ5.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/325Id7l954.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/EG198BJgi3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/I4A16CDal5.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/lFLGKIH5fE.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/C6B1Hb7LKD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/amEhg6kFbf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/LcIB9jeKem.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/hg5g6Cc7f0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/8D6a8Dl3h3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/k1DG3bflLH.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/L7d5cE3D7h.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/6ejHjBFb9c.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/H0Gjeci29F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/E18ecbCEEI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/c2kA33KE9E.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/cKmHj6E9gi.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/cA22hF4fi7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/8KAAL61KBk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/jadkKHKkbI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/fcae2A0E0c.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180111/8gcmfdHb4J.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/DmC94JAmh3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/jIL4FAdjJb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/59iFhGLaCD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/aiKJL6kCKL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/mmChH6l2j9.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/GJa43hh95F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/Fgl4eHGJb8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/me43dl1f0g.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/BiKdf066CL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/dbFlbHIBmb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/DJeKIb9cK1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/cH5Dmm14Cj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/FkaCFJ4B7h.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/BeIFlkf97m.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/DFHg4mGkFb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/k09CHekje2.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/BBI8iLE97D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/ECJ36kDclf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/4j037g1DKj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/90m2l2A0Dj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/0ED5bcC9Jf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/I83bFbddC3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/mL08LkChhe.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/cLg8IFB1jA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/G2ICdgdDgh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/b7heml49dh.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/5gjFji2d25.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/Kd5ijhIAgK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/3CFjke2B3C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/2AdFE6He3D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/4f7A1Ei2Fg.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/c8aa7f62L1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/KelfeB7D2C.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/DI3GJKkJLI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180112/3gBdC96Aij.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/32hbAB04ec.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/L1Jm283bck.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/JBm95D0fK8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/L7Ibjh9g72.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/0DhjiABaA4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/al219GFJJ1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/FkIJ7mCjH3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/ji6bee4D31.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/Jb07I8Ef1f.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/6Ca5l1lBCf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/mk6Gb823k6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/HKLll9bL4F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/3kmjFehf7F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/93LBHie41d.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/F0jLggJge6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/8fDFkB7DIm.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/37jDHdha1l.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/KJc25I0KF8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/mKHhjj2d32.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/D4L8a0lmI0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/hBAAmHlm4g.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/5GjjhDe40D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/CL7fke0LGF.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/f0j8Ffec87.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/kCAHJkbAdb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/26FehA9AAf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/ljke7AEDjj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/k03L400l4c.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/H49BkEleaA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/4LGd72eA4J.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/kGG5I71CE1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/3I2G5kaK1G.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/Jabljb878I.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/Lb09b3457I.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/1IGKhbagJC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/he98j111Lj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/J6kBci76lA.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/3Bm665idcK.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/CC02dfbG57.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/ADFBmE7a6B.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/8LAe6f1dl7.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/i92c3ffgJD.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/LjGjh0B3cL.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180114/B4HKiBfla1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/kDd20GdFDb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/8IDjg5e8K0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/468aAaiajk.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/C2H1D6mBhg.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/8EjD3Ik9Gj.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/4F1KK3IaaI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/cB5cDiKFdJ.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/kfLLLEGa19.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/d42ef1h5HC.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/03jDakfC5A.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/6Ikm6edG47.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/043H5F0K8G.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/blD3Cgd9jG.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/jIJ1A5EijI.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/kF99c72b0K.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/lcH1c4Bb11.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180115/H92HC8eJ1D.png?imageslim"><meta property="og:updated_time" content="2018-01-29T19:13:35.411Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版"><meta name="twitter:description" content="「比更大还更大」(Bigger than Bigger)   初级复习: 写一个留言板来复习Django基础知识 项目实战: 使用Django+xadmin搭建一个在线教育网站最终成果: http://mxonline.mtianyan.cn  GitHub代码仓库:https://github.com/mtianyan/Mxonline2"><meta name="twitter:image" content="http://myphoto.mtianyan.cn/blog/180107/a5h8mfid18.png?imageslim"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.mtianyan.cn/post/8b4c6c13.html"><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement("script"),n=t.getElementsByTagName("script")[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,0,("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"e28768be"}),daovoice("update")</script><title>强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版 | mtianyan's blog</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?415372bd35fec36f7558dd96b48ec03f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/mtianyan" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">mtianyan's blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">天涯明月笙的博客小站(Github托管)</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br> 公益404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://blog.mtianyan.cn/post/8b4c6c13.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="mtianyan"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="mtianyan's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-17T00:15:31+08:00">2018-01-17</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Django-Xadmin打造在线教育平台/" itemprop="url" rel="index"><span itemprop="name">Django+Xadmin打造在线教育平台</span></a></span></span> <span id="/post/8b4c6c13.html" class="leancloud_visitors" data-flag-title="强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">热度&#58;</span><span class="leancloud-visitors-count"></span> <span>℃</span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">40,470</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">174</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote class="blockquote-center"><p>「比更大还更大」(Bigger than Bigger)</p></blockquote><div class="note"><ul><li>初级复习: 写一个留言板来复习Django基础知识</li><li>项目实战: 使用Django+xadmin搭建一个在线教育网站<br>最终成果: <a href="http://mxonline.mtianyan.cn" target="_blank" rel="noopener">http://mxonline.mtianyan.cn</a></li></ul><p>GitHub代码仓库:<br><a href="https://github.com/mtianyan/Mxonline2" target="_blank" rel="noopener">https://github.com/mtianyan/Mxonline2</a></p></div><a id="more"></a><blockquote class="blockquote-center"><p>请开始你的表演是做一个项目的第一步</p></blockquote><div class="note"><p>使用Django+Xadmin打造在线教育平台</p><ul><li>第一章：项目介绍和课程介绍</li></ul><p>教程仓库地址1:<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></p></div><h1 id="项目演示和课程介绍"><a href="#项目演示和课程介绍" class="headerlink" title="项目演示和课程介绍"></a>项目演示和课程介绍</h1><p>Django是一个Python中Web开发的主流框架，被许多大型公司使用，如Google，豆瓣，YouTube，知乎，instagram:</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/a5h8mfid18.png?imageslim" alt="mark"></p><p>创业公司喜欢的web框架。严格按照互联网公司开发流程，写出优雅简练的代码。<br>循序渐进，细致入微。独立完成完整项目。学习完课程，找份Python web开发工作不在话下。</p><p>教程线上已部署地址: <a href="http://mxonline.mtianyan.cn" target="_blank" rel="noopener">http://mxonline.mtianyan.cn</a></p><p><strong>系统介绍：</strong></p><ul><li>系统具有完整的用户登录注册以及找回密码功能，拥有完整个人中心。</li><li>个人中心: 修改头像，修改密码，修改邮箱，可以看到我的课程以及我的收藏。可以删除收藏，我的消息。</li><li>导航栏: 公开课，授课讲师，授课机构，全局搜索。</li><li>点击<code>公开课</code>–&gt; 课程列表，排序-搜索。热门课程推荐，课程的分页。</li><li>点击<code>课程</code>–&gt; 课程详情页中对课程进行收藏，取消收藏。富文本展示课程内容。</li><li>点击<code>开始学习</code>–&gt; 课程的章节信息，课程的评论信息。课程资源的下载链接。</li><li>点击<code>授课讲师</code>–&gt;授课讲师列表页，对讲师进行人气排序以及分页，右边有讲师排行榜。</li><li>点击<code>讲师的详情页面</code>–&gt; 对讲师进行收藏和分享，以及讲师的全部课程。</li><li>导航栏: 授课机构有分页，排序筛选功能。</li><li>机构列表页右侧有快速提交我要学习的表单。</li><li>点击<code>机构</code>–&gt; 左侧：机构首页,机构课程，机构介绍，机构讲师。</li><li>后台管理系统可以<code>切换主题</code>。左侧每一个功能都有列表显示, 增删改查，筛选功能。</li><li>课程列表页可以对不同字段进行排序。选择多条记录进行删除操作。</li><li>课程列表页：过滤器-&gt;选择字段范围等,搜索,导出csv，xml，json。</li><li>课程新增页面上传图片，富文本的编辑。时间选择，添加章节，添加课程资源。</li><li>日志记录：记录后台人员的操作</li></ul><p>学完后还可以将本网站改造成<code>电商网站</code>,<code>在线旅游</code>等其他网站</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/2A76h7im9k.png?imageslim" alt="mark"></p><h2 id="开发环境搭建任务"><a href="#开发环境搭建任务" class="headerlink" title="开发环境搭建任务"></a>开发环境搭建任务</h2><p>windows下通过<code>pycharm</code>和<code>virtualenv</code>搭建开发环境</p><h2 id="django基础知识回顾任务"><a href="#django基础知识回顾任务" class="headerlink" title="django基础知识回顾任务"></a>django基础知识回顾任务</h2><p>照顾基础薄弱同学: 通过留言板功能回顾django基础知识。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/c91fA7Lb5e.png?imageslim" alt="mark"></p><h2 id="数据库设计和xadmin搭建后台管理系统任务"><a href="#数据库设计和xadmin搭建后台管理系统任务" class="headerlink" title="数据库设计和xadmin搭建后台管理系统任务"></a>数据库设计和xadmin搭建后台管理系统任务</h2><p>通过业务分析设计<code>django</code>的每个<code>app</code>，设计<code>app</code>下的<code>model</code>。设计<code>外键关系</code>，通过django的<code>migrate</code>设计生成数据表。</p><p>然后将这些<code>model</code>注册到<code>xadmin</code>当中。为每个model配置<code>搜索</code>,<code>过滤字段</code>，以及<code>列表页的显示字段</code>。配置xadmin的<code>主题选择</code>功能。</p><p><img src="http://upload-images.jianshu.io/upload_images/1779926-5e9910e92bdef649.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="后台设计工作"></p><h2 id="系统功能模块实现任务"><a href="#系统功能模块实现任务" class="headerlink" title="系统功能模块实现任务"></a>系统功能模块实现任务</h2><p><strong>实现所有后台功能 &amp; 面试中经常被提及的web开发知识。</strong></p><p><strong>几乎所有的django常用模块：</strong></p><ul><li><code>setting</code>配置</li><li><code>url</code>配置</li><li><code>view</code>书写</li><li><code>model</code>设计</li><li><code>form</code>和<code>modelform</code>的使用</li><li><code>templates</code>模板的使用</li><li><code>django</code>常用的内置函数</li></ul><h2 id="web系统知识以及网络安全任务"><a href="#web系统知识以及网络安全任务" class="headerlink" title="web系统知识以及网络安全任务"></a>web系统知识以及网络安全任务</h2><p><strong>防止一些攻击问题：</strong></p><ul><li>sql注入</li><li>xss攻击</li><li>crsf攻击</li></ul><p>这些攻击的原理以及防护措施</p><h2 id="xadmin扩展知识"><a href="#xadmin扩展知识" class="headerlink" title="xadmin扩展知识"></a>xadmin扩展知识</h2><p><strong>掌握更多可定制功能:</strong></p><ul><li>权限管理</li><li>权限配置</li><li>权限，用户，组之间的关系。</li><li>xadmin常用插件</li><li>如何自定义xadmin插件</li><li>xadmin的富文本编辑功能</li><li>xadmin的excel导入功能。</li></ul><p>还会用到一些开源的django开发库。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/eGhG2Kk51D.png?imageslim" alt="mark"></p><p>不管是想全面学习Django还是想做一个线上教育平台都可以满足要求。学习完Django,我们对于学习其他框架和通过Django搭建我们自己的系统，都会成为很简单的事情。</p><blockquote class="blockquote-center"><p>老话总是没错的，工欲善其事，苟…</p></blockquote><div class="note success"><p>使用Django+Xadmin打造在线教育平台</p><ul><li>第二章：windows下搭建开发环境<br>教你安装pycharm,mysql,navicat,python相关环境。<br>教程仓库地址1: <a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></li></ul></div><h1 id="windows下搭建开发环境"><a href="#windows下搭建开发环境" class="headerlink" title="windows下搭建开发环境"></a>windows下搭建开发环境</h1><h2 id="2-1-pycharm-mysql-Navicat安装。"><a href="#2-1-pycharm-mysql-Navicat安装。" class="headerlink" title="2-1 pycharm,mysql,Navicat安装。"></a>2-1 pycharm,mysql,Navicat安装。</h2><p><strong>环境搭建：</strong></p><blockquote><ul><li>pycharm (我：PyCharm 2017.3.2)</li><li>mysql for windows(mysql-installer-community-5.7.20)</li><li>navicat for mysql(我：Navicat Premium）</li><li>python2.7</li></ul></blockquote><p> <strong>提醒：记住自己设置的mysql密码</strong></p><h3 id="Mysql"><a href="#Mysql" class="headerlink" title="Mysql"></a>Mysql</h3><p>百度”mysql for windows” 直接在百度软件中心下载即可</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/J808E5JA1i.png?imageslim" alt="mark"></p><p>如果你的电脑跟我电脑一样空，推荐遵循我的：</p><ol><li>点击接受协议</li><li>选择Custom选项。(如果默认选项，会发生必要条件缺失：如我电脑没有VS和py3.4)</li></ol><p><img src="http://myphoto.mtianyan.cn/blog/180106/A7Cb96mEce.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180106/66L7DaJJCK.png?imageslim" alt="mark"></p><ul><li>下图页面点击<code>next</code>会显示我们不满足的条件，<code>back</code>后点击绿色箭头移除。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180106/8C2KL0HaI4.png?imageslim" alt="mark"></p><ul><li>所有条件都达成，点击<code>Execute</code>，等待安装完成。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180106/78kgLjJl4F.png?imageslim" alt="mark"></p><blockquote><p>均为绿色代表安装完成。</p></blockquote><ul><li>一直默认选择直到下图页面。设置密码，添加用户(可选)</li></ul><blockquote><p><strong>注意：记住自己设置的mysql密码</strong></p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180106/c8aLD2mdC4.png?imageslim" alt="mark"></p><blockquote><p>之后全部默认下一步。直到安装完成<code>Finish</code></p></blockquote><p>这时Navicat已经可以正常连接了。如果想让<code>mysql</code>命令在cmd下可使用。</p><p><code>C:\Program Files\MySQL\MySQL Server 5.7\bin</code> (自行替换为自己的mysql.exe地址)加入环境变量中。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/DL51BD687G.png?imageslim" alt="mark"></p><p>通过<code>mysql -uroot -p</code>命令可以进行登入mysql控制台。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/h1Aa2aJ0G4.png?imageslim" alt="mark"></p><h3 id="Navicat"><a href="#Navicat" class="headerlink" title="Navicat"></a>Navicat</h3><p>安装指南：下一步下一步。</p><p>下载地址：<a href="http://www.navicat.com.cn/download/navicat-for-mysql" target="_blank" rel="noopener">http://www.navicat.com.cn/download/navicat-for-mysql</a></p><p>我的安装目录: <code>C:\software\Navicat Premium 12</code></p><h3 id="PyCharm-2017-3-2"><a href="#PyCharm-2017-3-2" class="headerlink" title="PyCharm 2017.3.2"></a>PyCharm 2017.3.2</h3><p>pycharm官方下载链接：<a href="https://www.jetbrains.com/pycharm/download/#section=windows" target="_blank" rel="noopener">https://www.jetbrains.com/pycharm/download/#section=windows</a></p><p><strong>我们要选择专业版（Professional）</strong>因为只有专业版才能够新建django项目,免费社区版不能。</p><p><strong>为Pycharm添加解释器：</strong></p><p><code>setting</code> - <code>Project Interpreter</code>：</p><p><img src="http://oerdwodsk.bkt.clouddn.com/blog/180103/E72AIkEB07.png?imageslim" alt="mark"></p><p><img src="http://oerdwodsk.bkt.clouddn.com/blog/180103/D3jB3C6A9g.png?imageslim" alt="mark"></p><p>一直定位到 <code>python.exe</code> 点击确认。</p><h3 id="Python2-7安装"><a href="#Python2-7安装" class="headerlink" title="Python2.7安装"></a>Python2.7安装</h3><p>推荐阅读：<strong>Python开发环境搭建指南(Anaconda2,3共存)</strong></p><blockquote><p>推荐选择进阶版本, 方便升级到3.6。</p></blockquote><p><a href="http://blog.mtianyan.cn/post/230a7ad6.html">http://blog.mtianyan.cn/post/230a7ad6.html</a></p><h2 id="2-2-virtualenv安装和配置"><a href="#2-2-virtualenv安装和配置" class="headerlink" title="2-2 virtualenv安装和配置"></a>2-2 virtualenv安装和配置</h2><h3 id="virtualenv介绍"><a href="#virtualenv介绍" class="headerlink" title="virtualenv介绍"></a>virtualenv介绍</h3><blockquote><p>每个应用可能需要各自拥有一套<code>独立</code>的Python运行环境。virtualenv就是用来为一个应用创建一套<code>隔离</code>的Python运行环境。</p></blockquote><p><strong>virtualenv优点：</strong></p><p><img src="http://myphoto.mtianyan.cn/blog/180106/AmbE1564gJ.png?imageslim" alt="mark"></p><p>它是将全局Python解释器进行私有化复制。<br>如果不使用虚拟环境，默认的<code>pip</code>安装都会安装到同一个目录(java是把自己需要的包放到自己项目目录)，不同项目使用起来会产生问题</p><h3 id="安装virtualenv"><a href="#安装virtualenv" class="headerlink" title="安装virtualenv"></a>安装virtualenv</h3><p>进入cmd，（确保自己的pip已经可用）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenv</span><br><span class="line">virtualenv testvir</span><br><span class="line"><span class="comment"># 在当前用户目录(win+r %HOMEPATH%可查看)生成</span></span><br><span class="line">cd %homepath%</span><br><span class="line">cd testvir</span><br><span class="line">cd Scripts</span><br><span class="line">activate.bat <span class="comment">#激活</span></span><br><span class="line">pip list </span><br><span class="line">deactivate.bat</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180106/lCIHhf568m.png?imageslim" alt="mark"></p><p>默认使用<code>virtualenv testvir</code>该命令，会将虚拟环境创建在我们当前用户目录。</p><p><strong>注意：</strong>我的目录在桌面是我的cmder设置的、还请自行<code>cd %homepath%</code>前往自己的目录</p><p>这样直接使用步骤有写过于繁琐。所以我们使用<code>virtualenvwrapper</code></p><h3 id="virtualenvwrapper安装"><a href="#virtualenvwrapper安装" class="headerlink" title="virtualenvwrapper安装"></a>virtualenvwrapper安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenvwrapper-win</span><br><span class="line">pip install virtualenvwrapper(Linux)</span><br></pre></td></tr></table></figure><ul><li>创建虚拟环境</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv DjangoTest</span><br></pre></td></tr></table></figure><p>会创建在<code>C:\Users\mtian\Envs</code>当前用户目录下的Envs目录。</p><p>修改<code>mkvirtualenv</code>创建的目录：新增环境变量<code>WORKON_HOME</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180106/A2im5He9fK.png?imageslim" alt="mark"></p><ul><li><p>退出激活状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deactivate</span><br></pre></td></tr></table></figure></li><li><p>知道有哪些虚拟环境</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workon</span><br></pre></td></tr></table></figure></li><li><p>直接进入虚拟环境</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workon DjangoTest</span><br></pre></td></tr></table></figure></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/1cJK2F43I0.png?imageslim" alt="mark"></p><p><strong>注意</strong>前面的<code>(DjangoTest)</code>代表进入了虚拟环境。</p><p>执行<code>workon</code>命令之后，执行<code>pip install django==1.9.8</code>安装。</p><h2 id="2-3-Pycharm和Navicat的简单使用"><a href="#2-3-Pycharm和Navicat的简单使用" class="headerlink" title="2-3 Pycharm和Navicat的简单使用"></a>2-3 Pycharm和Navicat的简单使用</h2><h3 id="pycharm简单使用："><a href="#pycharm简单使用：" class="headerlink" title="pycharm简单使用："></a>pycharm简单使用：</h3><p><code>Setting -&gt; reopen</code>取消默认打开上一次项目</p><h4 id="新建项目并验证成功运行"><a href="#新建项目并验证成功运行" class="headerlink" title="新建项目并验证成功运行"></a>新建项目并验证成功运行</h4><ul><li>如何新建django项目：</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180106/d5a87Gid1f.png?imageslim" alt="mark"></p><blockquote><p>选择好自己的项目的解释器为我们新建的虚拟环境。</p></blockquote><p>新建<code>project</code>-&gt;<code>djangotestProj</code> 。别忘了为我们的虚拟环境安装<code>Django</code></p><ul><li>检查django环境是否安装好。<code>interpreter</code></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180106/6CjH0H1l5c.png?imageslim" alt="mark"></p><ul><li>点击导航栏的<code>run</code>可以直接运行我们的django项目</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180106/eKh4AC1mhB.png?imageslim" alt="mark"></p><blockquote><p>上图说明我们的django已经安装并且可以正常运行。</p></blockquote><p>点击浏览器打开<code>http://127.0.0.1:8000/</code>进行验证。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/0cFDmJdChd.png?imageslim" alt="mark"></p><p>出现上画面代表我们<strong>大功告成</strong></p><h4 id="设置eclipse快捷键-keymap"><a href="#设置eclipse快捷键-keymap" class="headerlink" title="设置eclipse快捷键 - keymap"></a>设置eclipse快捷键 - keymap</h4><p>选择<code>setting</code>搜索<code>keymap</code>设置<code>eclipse</code>快捷键</p><blockquote><p>比如 <code>ctrl + H</code> 全局搜索</p></blockquote><h4 id="Run-edit配置修改"><a href="#Run-edit配置修改" class="headerlink" title="Run edit配置修改"></a>Run edit配置修改</h4><p><img src="http://myphoto.mtianyan.cn/blog/180106/ifi4mGE7C9.png?imageslim" alt="mark"></p><p>点击上图中<code>run edit</code> 可对Django运行时的一些设置进行修改。</p><p>比如修改host为<code>0.0.0.0</code>，然后就可以设置监听本机ip。然后点击<code>run</code></p><p>进入<code>cmd</code>下输入<code>ipconfig</code>查询自己的ip</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/6lCEGEAJjL.png?imageslim" alt="mark"></p><blockquote><p>例如我的是<code>192.168.0.4</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.4:8000/ 来访问。</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180106/7gBl6DHb6d.png?imageslim" alt="mark"></p><h4 id="目录颜色不同的原因"><a href="#目录颜色不同的原因" class="headerlink" title="目录颜色不同的原因"></a>目录颜色不同的原因</h4><p><img src="http://myphoto.mtianyan.cn/blog/180106/JAJCHgBflc.png?imageslim" alt="mark"></p><p>可以看到不同的目录颜色不同。这是我们可以进行设置的，为了可以做到智能提示。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/E2GFBe08Gb.png?imageslim" alt="mark"></p><p>右键可以将<code>template</code>目录<code>unmark</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180106/3BicA3E8aj.png?imageslim" alt="mark"></p><p>可以看到上图目录是灰色的。但是我们<code>右键mark</code>为<code>source Root</code>目录，会变为蓝色。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/mLGD68DB8H.png?imageslim" alt="mark"></p><blockquote><p>这意味着我们在<code>import</code>时pycharm会根据设置智能提示。<br>如果不mark可能会出现很多我们在pycharm中报红色，<br>但是cmd确可以运行的情况。</p></blockquote><h3 id="navicat基本使用"><a href="#navicat基本使用" class="headerlink" title="navicat基本使用"></a>navicat基本使用</h3><h3 id="新建连接"><a href="#新建连接" class="headerlink" title="新建连接"></a>新建连接</h3><p><img src="http://myphoto.mtianyan.cn/blog/180106/D7FEGgIiC6.png?imageslim" alt="mark"></p><blockquote><p>点击新建一个mysql的连接。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180106/hAB7KkaB29.png?imageslim" alt="mark"></p><blockquote><p>连接名自行设置，密码填自己安装mysql时设置的密码。</p></blockquote><h3 id="右键新建数据库"><a href="#右键新建数据库" class="headerlink" title="右键新建数据库"></a>右键新建数据库</h3><p><img src="http://myphoto.mtianyan.cn/blog/180106/maL6ccLG90.png?imageslim" alt="mark"></p><blockquote><p>数据库名自行设置，<code>utf-8</code> <code>utf_general_ci</code><br><strong>注意：这里请与图中选择一致。否则保存中文可能出错</strong></p></blockquote><h3 id="新建数据表"><a href="#新建数据表" class="headerlink" title="新建数据表"></a>新建数据表</h3><p>双击数据库<code>testdjango</code>使他变绿，然后选中表，然后右键新建表。或使用右侧<code>新建表</code>按钮</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/Kd0cAeCj1H.png?imageslim" alt="mark"></p><p>输入必要的字段然后使用<code>ctrl + s</code> 进行保存并输入表名。</p><h3 id="增加数据"><a href="#增加数据" class="headerlink" title="增加数据"></a>增加数据</h3><blockquote><p>双击表，可以展示我们的数据，这时候我们可以自行修改值。<br>点击左下角可以新增更多行。并且状态栏会显示一些sql语句信息</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180106/GFCgBHH2fC.png?imageslim" alt="mark"></p><h3 id="设计表"><a href="#设计表" class="headerlink" title="设计表"></a>设计表</h3><p>右键设计表：我们可以添加字段</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/ajiDfHmBim.png?imageslim" alt="mark"></p><h3 id="Sql语句查询"><a href="#Sql语句查询" class="headerlink" title="Sql语句查询"></a>Sql语句查询</h3><p>点击查询，新建查询。我们可以输入Sql语句进行查询。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/1b0h7dh3AC.png?imageslim" alt="mark"></p><h3 id="表的复制粘贴与数据库传输。数据库导入导出。"><a href="#表的复制粘贴与数据库传输。数据库导入导出。" class="headerlink" title="表的复制粘贴与数据库传输。数据库导入导出。"></a>表的复制粘贴与数据库传输。数据库导入导出。</h3><blockquote><p>Navicat支持我们把不同数据库的表之间的复制粘贴操作。<br>支持数据传输：点击工具数据传输</p></blockquote><p>导出：在数据库上右键我们可以<code>转储SQL文件</code>: 可以选择只转存结构。或连带数据一起。<br>导入：右键点击运行SQL文件。<br>对于表的操作：删除，清空等，在点击表的右键菜单里。</p><blockquote class="blockquote-center"><p>小项目不扫何以扫天下</p></blockquote><div class="note success"><p>使用Django+Xadmin打造在线教育平台</p><ul><li>第三章：通过留言板功能回顾django基础知识<br>通过做一个小留言板，学习django基础知识<br>教程仓库地址1: <a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></li></ul></div><h1 id="通过留言版功能回顾django基础知识"><a href="#通过留言版功能回顾django基础知识" class="headerlink" title="通过留言版功能回顾django基础知识"></a>通过留言版功能回顾django基础知识</h1><p>教程中本章对应上传的仓库为: <a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></p><blockquote><p>对应第一次commit:留言板仓库初始化。内容截止3-1一章结束。</p></blockquote><ul><li>将对于django目录结构，使用Django快速搭建可以提交的表单页面，models.py , urls.py, views.py。</li><li>从数据库中取出数据展示到html中：Django Template的配置。</li><li>即django的基础知识通过这个留言板项目进行一个全面细致的学习。</li></ul><h2 id="3-1-django目录结构"><a href="#3-1-django目录结构" class="headerlink" title="3-1 django目录结构"></a>3-1 django目录结构</h2><p>django目录：</p><pre><code>projectname : 保存Django项目的urls,setting，uwsgi文件
</code></pre><p>如下图新建一个Django项目<code>DjangoGetStarted</code>，使用我们上章节中已存在的虚拟环境<code>DjangoTest</code> (里面已经装好了django)</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/BKLg4JDJCe.png?imageslim" alt="mark"></p><h3 id="django自动生成的目录"><a href="#django自动生成的目录" class="headerlink" title="django自动生成的目录"></a>django自动生成的目录</h3><p>初始化完成后的目录如下：(如果不是，那么你们可能创建的不是django项目)</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/3aIIDddEmc.png?imageslim" alt="mark"></p><p>可以看到主目录<code>DjangoGetStarted</code>与项目目录<code>DjangoGetStarted</code></p><ul><li>DjangoGetStarted(文件夹)：<ul><li>setting.py： 项目全局配置文件</li><li>urls.py： 主要的urls配置入口</li><li>wsgi.py： 是Django启动需要的文件。</li></ul></li><li>templates(文件夹)： 放置html文件</li><li>manage.py： 启动Django需要的主要文件。(主要的Django命令都通过manage.py运行)</li></ul><h3 id="还需要我们自己创建的目录"><a href="#还需要我们自己创建的目录" class="headerlink" title="还需要我们自己创建的目录"></a>还需要我们自己创建的目录</h3><p>app是Django里一个一个应用的文件夹单位。</p><p>通过 <code>Tools -&gt; Run manage.py Task</code>创建app：</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/lFgLChlhdc.png?imageslim" alt="mark"></p><h4 id="startapp-message"><a href="#startapp-message" class="headerlink" title="startapp message"></a>startapp message</h4><p>可以看到当输入<code>startapp message</code>之后，创建了<code>message</code>应用。并存放在了：与项目目录同级目录。</p><p><img src="http://myphoto.mtianyan.cn/blog/180106/Ef2F5Bf7FA.png?imageslim" alt="mark"></p><h4 id="新建static目录"><a href="#新建static目录" class="headerlink" title="新建static目录"></a>新建static目录</h4><p>使用<code>static</code>目录来存放网站的静态文件：js，css，图片等。</p><h4 id="新建log目录"><a href="#新建log目录" class="headerlink" title="新建log目录"></a>新建log目录</h4><p>使用<code>log</code>目录来存放网站的日志文件</p><h4 id="新建media目录"><a href="#新建media目录" class="headerlink" title="新建media目录"></a>新建media目录</h4><p>使用<code>media</code>目录存放用户上传的图片等资源。</p><h4 id="解决项目大了之后app过多问题"><a href="#解决项目大了之后app过多问题" class="headerlink" title="解决项目大了之后app过多问题"></a>解决项目大了之后app过多问题</h4><ol><li>新建文件夹 <code>apps</code></li><li>将<code>message</code>文件夹拖入<code>apps</code>文件夹内：会自动生成<code>__init__.py</code>文件表明这是一个包。使得apps文件夹可导入。</li></ol><p><img src="http://myphoto.mtianyan.cn/blog/180106/3625a0imed.png?imageslim" alt="mark"></p><blockquote><p>这时我们就会发现在导入我们的message的内容就得配置较长的路径。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/k10eEBg357.png?imageslim" alt="mark"></p><blockquote><p>每次前面都得加上<code>apps.</code>，这可烦死人啦。</p></blockquote><p><strong>解决方案奉上</strong></p><blockquote><p>将<code>apps</code>目录右键<code>mark</code>成<code>Source Root</code>(Mark 方法查看第一章pycharm简单使用：目录颜色不同的原因)</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/I9255edkaF.png?imageslim" alt="mark"></p><p>mark成功之后<strong>变蓝</strong>(变绿的话，只能摸摸头了，当然选择原谅)，然后可以直接使用短路径进行import</p><h4 id="Mark后Pycharm-不报错，Cmd下运行报错。"><a href="#Mark后Pycharm-不报错，Cmd下运行报错。" class="headerlink" title="Mark后Pycharm 不报错，Cmd下运行报错。"></a>Mark后Pycharm 不报错，Cmd下运行报错。</h4><p>Mark后pycharm知道这是一个项目的<code>Souce Root</code>路径了，但是cmd并不知道。</p><blockquote><p>在项目目录下通过cmd命令行使用<code>python manage.py runserver</code></p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/2043A3KagE.png?imageslim" alt="mark"></p><blockquote><p>pycharm中mark只是pycharm自身可以进行识别短路径。</p></blockquote><p><strong>解决方案：</strong></p><blockquote><p>我们在setting文件中配置我们的<code>apps</code>路径:</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/IhD2bJDI6K.png?imageslim" alt="mark"></p><blockquote><p>图解读：我们需要在setting中向上图一样设置,程序就会接着报错。(换了一个错误了，滑稽脸)</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.insert(<span class="number">0</span>,os.path.join(BASE_DIR,<span class="string">'apps'</span>))</span><br></pre></td></tr></table></figure><p>上述代码为将apps拼接项目绝对路径后的路径插入当前系统的环境变量path中，这样就可以成功解决(个屁屁啊)。</p><p>成功性测试(测试已失败)：</p><blockquote><p>这个import放到manage.py文件是不行的 你把manage.py中这行删除 因为django整个的配置还没有启动好 import django的model是不行的，</p></blockquote><p>插播：忘了失败吧，我偷学下面方法养你。</p><p><strong>终极解决：将这个<code>import</code>方法比如urls.py.等可以成功启动。</strong>或者自行删除该import。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/b230j2d65e.png?imageslim" alt="mark"></p><p>红色警告：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">You have unapplied migrations; your app may not work properly </span><br><span class="line">until they are applied. Run &apos;python manage.py migrate&apos; to apply them.</span><br></pre></td></tr></table></figure><p></p><p>是因为我们没有进行数据库<code>models</code>进行初始化<code>migrate</code>.</p><p><code>python manage.py migrate</code>我们之后会用到，现在不要做。</p><h3 id="github仓库项目初始化第一次commit。"><a href="#github仓库项目初始化第一次commit。" class="headerlink" title="github仓库项目初始化第一次commit。"></a>github仓库项目初始化第一次commit。</h3><p><img src="http://myphoto.mtianyan.cn/blog/180107/aFheliD18B.png?imageslim" alt="mark"></p><blockquote><p>输入用户名密码，点击login。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/ci4AKb7Lb0.png?imageslim" alt="mark"></p><blockquote><p>选择左侧导航中<code>Git</code> 设置你的git.exe的路径</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/6Af7m9cI0i.png?imageslim" alt="mark"></p><p>点击<code>Share project on GitHub</code>会弹出下图窗口</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/JjH1FjmB0i.png?imageslim" alt="mark"></p><p>填写你的项目<code>名称</code>，<code>描述</code>。点击<code>share</code>。</p><p>会弹窗让你选择需要上传的项目文件与commit信息。然后将项目上传至github。</p><p><strong>我教程中上传的仓库为: <a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></strong></p><blockquote><p>对应第一次commit:留言板仓库初始化。内容截止3-1一章结束。</p></blockquote><h2 id="3-2-配置表单页面"><a href="#3-2-配置表单页面" class="headerlink" title="3-2 配置表单页面"></a>3-2 配置表单页面</h2><blockquote><p>上节教程(来学习本节前置条件):</p></blockquote><ul><li>对应第一次commit: 留言板仓库初始化。内容截止3-1一章结束。</li></ul><p><strong>github仓库地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></strong></p><blockquote><p>本节我们学习将表单页面配置进django项目中</p></blockquote><h3 id="必要的该说的，该了解的"><a href="#必要的该说的，该了解的" class="headerlink" title="必要的该说的，该了解的"></a>必要的该说的，该了解的</h3><p><strong>前置条件：</strong></p><blockquote><p>你已经学习了前面教程。将项目的文件夹目录结构，setting配置等修改完毕与我保持一致。</p></blockquote><p>本节通过Django快速的配置一个<strong>留言板页面</strong>来学习</p><p>Django从请求到响应的整个完整流程。为我们开发在线教育平台打下基础。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/ghebBaKDDa.png?imageslim" alt="mark"></p><p>上图便是本节教程所要用到的静态页面: 前往Github下载：<code>form.html</code></p><blockquote><p>具体的业务：填写信息 -&gt; 然后点击提交 -&gt;数据被存储到数据库。</p></blockquote><p>这个<code>html</code>是一个单文件，里面已经包含了<code>css</code> <code>js</code>内容。</p><h3 id="将html文件整合进项目操作步骤"><a href="#将html文件整合进项目操作步骤" class="headerlink" title="将html文件整合进项目操作步骤"></a>将html文件整合进项目操作步骤</h3><h4 id="将html文件直接复制进templates目录"><a href="#将html文件直接复制进templates目录" class="headerlink" title="将html文件直接复制进templates目录."></a>将<code>html</code>文件直接复制进<code>templates</code>目录.</h4><p><img src="http://myphoto.mtianyan.cn/blog/180107/bd7L9HEbB1.png?imageslim" alt="mark"></p><h4 id="创建static目录下的css文件夹-和-static-js"><a href="#创建static目录下的css文件夹-和-static-js" class="headerlink" title="创建static目录下的css文件夹 和 static/js"></a>创建<code>static目录下的css文件夹</code> 和 <code>static/js</code></h4><ul><li>在css中再新建一个<code>style.css</code></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/7L3m4291JK.png?imageslim" alt="mark"></p><ul><li><code>form.html</code>中点击<code>&lt;style&gt;</code>标签左侧减号。将style内容收成一行。然后把这一行内容<strong>剪切粘贴到</strong><code>style.css</code></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/EJHc2DdkK2.png?imageslim" alt="mark"></p><ul><li><p>粘贴进去之后，<strong>将首尾两个<code>&lt;style&gt;</code>删除</strong>,<code>shift + tab</code>可以将css格式化更整齐。</p></li><li><p>在<code>form.html</code>新建<code>&lt;link&gt;</code>来引入css。(文件里其实已经先加上了，学一种操作而已)</p></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/css/style.css"</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="配置Django连接Mysql数据库"><a href="#配置Django连接Mysql数据库" class="headerlink" title="配置Django连接Mysql数据库"></a>配置Django连接Mysql数据库</h3><p>在<code>setting.py</code> 大概80行找到:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.sqlite3&apos;,</span><br><span class="line">        &apos;NAME&apos;: os.path.join(BASE_DIR, &apos;db.sqlite3&apos;),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是Django默认与自己项目根目录下的<code>db.sqlite3</code>连接的设置。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/00e3abbbFJ.png?imageslim" alt="mark"></p><p>我们的项目是与<code>mysql</code>连接，所以我们要改成如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</span><br><span class="line">        &apos;NAME&apos;: &apos;testdjango&apos;,</span><br><span class="line">        &apos;USER&apos;: &apos;root&apos;,</span><br><span class="line">        &apos;PASSWORD&apos;: &apos;密码&apos;,</span><br><span class="line">        &apos;HOST&apos;: &quot;127.0.0.1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中的<code>name</code>应设置为我们中在Navicat中新建的数据库名字。<strong>名字一定要保持一致</strong></p><p>这时要将我们之前建的表提前<strong>全部删除</strong>掉。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/g8l89KCfam.png?imageslim" alt="mark"></p><h4 id="配置mysql驱动和seeting文件。"><a href="#配置mysql驱动和seeting文件。" class="headerlink" title="配置mysql驱动和seeting文件。"></a>配置mysql驱动和seeting文件。</h4><p>点击<code>Tools 菜单下 Run manage.py Task</code>我们会发现报错了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    raise ImproperlyConfigured(&quot;Error loading MySQLdb module: %s&quot; % e)</span><br><span class="line">django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module: No module named MySQLdb</span><br></pre></td></tr></table></figure><blockquote><p>由错误信息我们可以看出是因为没有安装数据库驱动模块<code>MySQLdb</code></p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/lJKDjik9Cb.png?imageslim" alt="mark"></p><p><code>cmd</code>下<code>workon</code>进我们的虚拟环境目录。<code>pip install mysql-python</code><br>然后会发现报错：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/65Gad4D4l9.png?imageslim" alt="mark"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_mysql.c(42) : fatal error C1083: Cannot open include file: &apos;config-win.h&apos;: </span><br><span class="line">No such file or directory error: command </span><br><span class="line">&apos;&quot;C:\Users\mtian\AppData\Local\Programs\Common\Microsoft\Visual C ++ </span><br><span class="line">for Python\9.0\VC\Bin\amd64\cl.exe&quot;&apos; failed with exit status 2</span><br></pre></td></tr></table></figure><p>前往地址 <a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python" target="_blank" rel="noopener">https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python</a></p><p>下载<code>MySQL_python_1.2.5_cp27_none_win_amd64.whl</code>到本地,放到桌面。<br>然后使用下面命令进行安装：注意是在虚拟环境下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd Desktop</span><br><span class="line">pip install MySQL_python-1.2.5-cp27-none-win_amd64.whl</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180107/G60aadGLkJ.png?imageslim" alt="mark"></p><p>这个时候我们再次点击<code>Tools 菜单下 Run manage.py Task</code>会看到已经没有刚才的错误。<br><img src="http://myphoto.mtianyan.cn/blog/180107/4mF5KmaCKj.png?imageslim" alt="mark"><br>但是会有红框里的警告，<strong>面向强迫症解决方案是</strong>在<code>setting.py</code> 新增<code>STATIC_ROOT = &#39;/static/&#39;</code></p><p>但其实现在还没有用到这个参数。后面用到我们再配置。(推荐自行克服强迫症)</p><p>输入下面命令来生成表:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><p></p><p><img src="http://myphoto.mtianyan.cn/blog/180107/gaaL4hlAGj.png?imageslim" alt="mark"></p><p>这时我们去Navicat查看会发现为我们生成了很多表。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/bK273a3j4D.png?imageslim" alt="mark"></p><p>这些都是Django系统默认的<strong>内置</strong>数据表。</p><p>做完这些操作我们可以点击<code>Run</code>来运行项目，<br>然后到<code>http://127.0.0.1:8000/</code>来访问看是否运行成功。成功页面(It worked)</p><h3 id="配置form页面展示出来："><a href="#配置form页面展示出来：" class="headerlink" title="配置form页面展示出来："></a>配置form页面展示出来：</h3><p><code>DjangoGetStarted/urls.py</code>修改如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^form/$'</span>, getform) <span class="comment">#这行是新增加的.</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>新增加<code>url(r&#39;^form/$&#39;, getform)</code>,<code>^</code>是代表以<code>form</code>为开头，<code>$</code>代表以<code>/</code>结尾的地址。<br>这里<code>getform</code> 是对于这个<code>url</code>的相应处理的<code>view</code>。我们先去创建一个.</p><p><code>message/views.py</code>添加如下代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getform</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'message_form.html'</span>)</span><br></pre></td></tr></table></figure><p><code>request</code> 参数是一个django的<code>http request</code>对象。(基础)<br>这里我们可以按住<code>ctrl</code> + <code>左键</code> 跟踪到我们的<code>render</code>函数里面。<br><code>Alt + 左箭头</code> 回来。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render</span><span class="params">(request, template_name,...)</span>:</span></span><br></pre></td></tr></table></figure><p>源代码解读：可以看到我们的<code>render</code>需要一个<code>request对象</code>和<code>template_name</code>参数</p><p><strong>注意：记性好的还记得我们提供的源文件是form.html</strong></p><blockquote><p>知识点：django内置了很多html页面，form会先从内置中寻找。所以我们得改。</p></blockquote><p>因此我们需要右键如下图<code>Refactor</code>修改<code>from.html</code> 为<code>message_form</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180107/l0I7CGB2Be.png?imageslim" alt="mark"></p><p>如果我们的项目在运行，<code>ctrl + s</code>会自动重启我们的项目。</p><p>这时我们有了view，我们可以去配置完整的url了(前面已经配完整的检查一遍)：</p><p><code>DjangoGetStarted/urls.py</code><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from message.views import getform</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(r&apos;^admin/&apos;, admin.site.urls),</span><br><span class="line">    url(r&apos;^form/$&apos;, getform)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p></p><p><strong>这里我们不能加括号</strong>否则会变成方法的调用。</p><p>按住<code>ctrl</code> + <code>render</code> 跟踪到我们的<code>url</code>函数里面查看源码如下:可以看到它除过一组正则表达式，还需要接收一个view对象。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def url(regex, view,...):</span><br></pre></td></tr></table></figure><p>如果<code>getform</code>加上括号会报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: getform() takes exactly 1 argument (0 given)</span><br></pre></td></tr></table></figure><p>访问<code>http://127.0.0.1:8000/</code> 正常结果：Page not found</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Using the URLconf defined in DjangoGetStarted.urls, Django tried these URL patterns, in this order:</span><br><span class="line"></span><br><span class="line">^admin/</span><br><span class="line">^form/$</span><br></pre></td></tr></table></figure><p>是因为我们在url中加入了个人的配置<code>^form/$</code>,它就不会采用默认配置了。</p><p>原因：(源码探究标记点)</p><p>这时访问：<a href="http://127.0.0.1:8000/form/" target="_blank" rel="noopener">http://127.0.0.1:8000/form/</a></p><p>旧版本pycharm会报：<code>TemplateDoesNotExist</code>错误。我的新版本pycharm并没有出现。</p><p>重要代码在<code>DjangoGetStarted/settings.py</code> 60行左右</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 指明我们的templates目录路径</span><br><span class="line">&apos;DIRS&apos;: [os.path.join(BASE_DIR, &apos;templates&apos;)]</span><br><span class="line"># 老版本pycharm创建django项目该值为空。</span><br></pre></td></tr></table></figure><p>现在再次访问 <a href="http://127.0.0.1:8000/form/" target="_blank" rel="noopener">http://127.0.0.1:8000/form/</a></p><p><strong>页面出来了但是样式没有。static目录下的css文件提示没有找到。</strong></p><p><img src="http://myphoto.mtianyan.cn/blog/180107/73EjmflBe9.png?imageslim" alt="mark"></p><p>Setting中静态文件的配置，这是因为我们setting中的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = &apos;/static/&apos;</span><br></pre></td></tr></table></figure><p>只说明了目录的名称。并没有指明查找的根路径。添加下面代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = &apos;/static/&apos;</span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, &apos;static&apos;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>过程中看似不停的出错</strong>，其实是为了让大家更好记住该记住的。</p><h3 id="项目配置流程图"><a href="#项目配置流程图" class="headerlink" title="项目配置流程图"></a>项目配置流程图</h3><p>我们刚才是以倒序：</p><ol><li>把html文件放进来</li><li>通过简单的url配置来访问html。</li><li>发现找不到页面，所以我们设置setting中<code>DIRS</code></li><li>文件找到了又说找不到静态文件，我们设置了<code>STATICFILES_DIRS</code></li></ol><p><img src="http://myphoto.mtianyan.cn/blog/180107/ihf44icl9d.png?imageslim" alt="mark"></p><p>这是我们的整体流程图，推荐新建一个项目再按照正向流程图来一遍。</p><p>后面我们的工作会围绕从<code>migration生成数据表往下的内容</code>展开。</p><p>GitHub地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></p><blockquote><p>本节结束对应于commit：</p></blockquote><h2 id="3-3-django-orm介绍与model设计"><a href="#3-3-django-orm介绍与model设计" class="headerlink" title="3-3 django orm介绍与model设计"></a>3-3 django orm介绍与model设计</h2><p>上节教程完成后代码(来学习本节前置条件):</p><p><strong>github仓库地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></strong></p><ul><li>对应commit: 留言板前端页面展示。本次内容截止教程3-2结束。</li></ul><blockquote><p>可能现在你还在通过手写sql语句来操作数据库，当我们有了orm，数据库操作变得很简单。这一小节我们来学习Django中的orm。</p></blockquote><h3 id="原生sql-与-orm"><a href="#原生sql-与-orm" class="headerlink" title="原生sql 与 orm"></a>原生sql 与 orm</h3><p>没有orm 的情况下message/views.py代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import MySQLdb</span><br><span class="line"></span><br><span class="line"># 使用原生sql获取书的列表</span><br><span class="line">def book_list(request):</span><br><span class="line">    # 创建到数据库的连接: 指明用户名，数据库，密码</span><br><span class="line">    db = MySQLdb.connect(user = &apos;me&apos;, db=&apos;mydb&apos;, passwd=&apos;secret&apos;, host=&apos;localhost&apos;)</span><br><span class="line">    # 创建一个游标对象执行器</span><br><span class="line">    cursor = db.cursor()</span><br><span class="line">    # 书写我们需要的sql语句</span><br><span class="line">    cursor.execute(&apos;SELECT name FROM books ORDER BY name&apos;)</span><br><span class="line">    # 对于fetchall()的结果做遍历，将遍历回来的结果当做数组，取第0个值name。</span><br><span class="line">    names = [row[0] for row in cursor.fetchall()]</span><br><span class="line">    db.close()</span><br></pre></td></tr></table></figure><p>可不可以让数据库字段的查询和使用类的一个属性一样简单？没错登登登：orm上场了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book:name</span><br><span class="line"></span><br><span class="line">book.name</span><br><span class="line">book.save()</span><br></pre></td></tr></table></figure><p>Django的orm就是为了让我们不再写上面那样的语句，而是像使操作数据库像使用类和类属性一样。</p><h3 id="创建我们的models"><a href="#创建我们的models" class="headerlink" title="创建我们的models"></a>创建我们的models</h3><blockquote><p>verbose_name:对象的人类可读的名称，单数:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verbose_name = <span class="string">"pizza"</span></span><br></pre></td></tr></table></figure><p></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Meta，内嵌于 UserMessage 这个类的定义中</span><br><span class="line">如果 class Publisher 是顶格的，那么 class Meta 在它之下要缩进4个空格－－按 Python 的传统</span><br><span class="line">你可以在任意一个 模型 类中使用 Meta 类，来设置一些与特定模型相关的选项。</span><br><span class="line">如：设置ordering = [&apos;name&apos;]，默认地都会按 name 字段排序</span><br></pre></td></tr></table></figure><p>message/models.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承于django.db.models.Model</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserMessage</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 设置最大长度，verbose_name在后台显示字段会用到</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">u"用户名"</span>)</span><br><span class="line">    <span class="comment"># Django提供内置的邮箱字段会帮忙验证` default_validators = [validators.validate_email]`</span></span><br><span class="line">    email = models.EmailField(verbose_name=<span class="string">u"邮箱"</span>)</span><br><span class="line">    address = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"联系地址"</span>)</span><br><span class="line">    message = models.CharField(max_length=<span class="number">500</span>, verbose_name=<span class="string">u"留言信息"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"用户留言信息"</span></span><br><span class="line">        <span class="comment"># db_table ，这里我们让它自动生成所以不用指定</span></span><br></pre></td></tr></table></figure><p>这时我们执行<code>makemigrations messages</code>会发现并没有改动。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/bCK3e2eF9C.png?imageslim" alt="mark"></p><blockquote><p>因为setting中我们没有注册我们的app: message</p></blockquote><p><strong>注意：新建的app都要在setting中注册</strong></p><h3 id="在setting中注册我们的app"><a href="#在setting中注册我们的app" class="headerlink" title="在setting中注册我们的app"></a>在setting中注册我们的app</h3><p>DjangoGetStarted/settings.py 大概36行<code>INSTALLED_APPS</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">`INSTALLED_APPS`</span><br><span class="line">[</span><br><span class="line">    前面的不用变，后面新增下一行</span><br><span class="line">    &apos;message&apos;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>这时候我们重新运行<code>Tools 菜单下 Run manage.py Task</code>会提示：</p><p>如果提示：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyntaxError: Non-ASCII character &apos;\xe7&apos; in file D:\CodeSpace\PythonProject\DjangoGetStarted\apps\message\models.py on line</span><br></pre></td></tr></table></figure><p></p><p>请注意可能你忘记在写过中文的地方加上:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#coding: utf-8</span><br></pre></td></tr></table></figure><p><strong>注意必须加在第一或二行。</strong></p><p>然后执行下面命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">makemigrations message</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180107/7j9GC32b44.png?imageslim" alt="mark"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate message 生成数据表</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180107/dbKECKEBFg.png?imageslim" alt="mark"></p><p>前往Navicat验证：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/26GK5BjhCd.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们的数据表已经创建成功。默认数据表名称为<code>app名称_类名转换为小写</code><br>自动生成的id作为主键。</p></blockquote><h3 id="Models讲解"><a href="#Models讲解" class="headerlink" title="Models讲解"></a>Models讲解</h3><p>除过普通的对应数据库的字段类型如<code>CharField</code>，还有很多高级类型。如<code>EmailField</code>提供email验证。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">models.ForeignKey     # 外键</span><br><span class="line">models.DateTimeField  # 时间字段</span><br><span class="line">models.IntegerField   # 整型</span><br><span class="line">models.IPAddressField # IP地址</span><br><span class="line">models.FileField      # 上传文件</span><br><span class="line">models.ImageField     # 图片</span><br></pre></td></tr></table></figure><blockquote><p>ctrl按住+左键点击<code>models</code> 进入之后点击<code>fields</code>拖到文件开始可以看到所有字段：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__all__ = [str(x) for x in (</span><br><span class="line">    &apos;AutoField&apos;, &apos;BLANK_CHOICE_DASH&apos;, &apos;BigIntegerField&apos;, &apos;BinaryField&apos;,</span><br><span class="line">    &apos;BooleanField&apos;, &apos;CharField&apos;, &apos;CommaSeparatedIntegerField&apos;, &apos;DateField&apos;,</span><br><span class="line">    &apos;DateTimeField&apos;, &apos;DecimalField&apos;, &apos;DurationField&apos;, &apos;EmailField&apos;, &apos;Empty&apos;,</span><br><span class="line">    &apos;Field&apos;, &apos;FieldDoesNotExist&apos;, &apos;FilePathField&apos;, &apos;FloatField&apos;,</span><br><span class="line">    &apos;GenericIPAddressField&apos;, &apos;IPAddressField&apos;, &apos;IntegerField&apos;, &apos;NOT_PROVIDED&apos;,</span><br><span class="line">    &apos;NullBooleanField&apos;, &apos;PositiveIntegerField&apos;, &apos;PositiveSmallIntegerField&apos;,</span><br><span class="line">    &apos;SlugField&apos;, &apos;SmallIntegerField&apos;, &apos;TextField&apos;, &apos;TimeField&apos;, &apos;URLField&apos;,</span><br><span class="line">    &apos;UUIDField&apos;,</span><br><span class="line">)]</span><br></pre></td></tr></table></figure><h4 id="介绍字段参数"><a href="#介绍字段参数" class="headerlink" title="介绍字段参数"></a>介绍字段参数</h4><p><code>CharField</code>必须指明默认最大长度。<code>null=True,blank=True</code>指明字段可以为空<br><code>defalut = &quot; &quot;</code>指定默认值。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = models.CharField(max_length=20,null=True,blank=True, verbose_name=u&quot;用户名&quot;)</span><br></pre></td></tr></table></figure><p></p><p>id是自动生成的，如果需要自定义主键,message/models.py中添加字段：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object_id = models.CharField(primary_key=True, verbose_name=&quot;主键&quot;)</span><br></pre></td></tr></table></figure><p>此时点击<code>Tools 菜单下 Run manage.py Task</code>输入<code>makemigrations message</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180107/IA82jEgmAG.png?imageslim" alt="mark"></p><p><strong>知识点：CharField必须指明最大长度</strong></p><p>object_id改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object_id = models.CharField(primary_key=True, max_length=50 ,verbose_name=&quot;主键&quot;)</span><br></pre></td></tr></table></figure><p>这时点击<code>Tools 菜单下 Run manage.py Task</code>输入<code>makemigrations message</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">You are trying to add a non-nullable field <span class="string">'object_id'</span> to usermessage without a default; we can<span class="string">'t do that (the database needs something to populate existing rows).</span></span><br><span class="line"><span class="string">Please select a fix:</span></span><br><span class="line"><span class="string"> 1) Provide a one-off default now (will be set on all existing rows)</span></span><br><span class="line"><span class="string"> 2) Quit, and let me add a default in models.py</span></span><br></pre></td></tr></table></figure><p>根据提示信息，我们需要给<code>object_id</code>添加默认值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object_id = models.CharField(primary_key=True, max_length=50,default=&quot;&quot;, verbose_name=&quot;主键&quot;)</span><br></pre></td></tr></table></figure><p><strong>get新知识点：object_id必须有默认值</strong></p><p>输入<code>2</code> 退出：然后输入<code>makemigrations message</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180107/0HhH9l2B9G.png?imageslim" alt="mark"></p><p>再输入下面命令生成数据表<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate message</span><br></pre></td></tr></table></figure><p></p><blockquote><p>可以看到上图过程中会告诉我们做了哪些变化，如删除了默认系统生成的主键<code>id</code><br>,变更了<code>name</code>。新增了我们的<code>object_id</code></p></blockquote><p>前往Navicat验证右键设计表：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/0hADe4ggDG.png?imageslim" alt="mark"></p><p>可以看到<code>object_id</code>已经成为我们的新主键。</p><h4 id="介绍Meta信息："><a href="#介绍Meta信息：" class="headerlink" title="介绍Meta信息："></a>介绍Meta信息：</h4><p>Meta信息中我们可以指定常见的类型：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_table = &quot;user_meassage&quot;</span><br></pre></td></tr></table></figure><p>自定义后生成表，表名会与我们的保持一致。而不会前缀<code>appname</code>如：<code>message_</code></p><blockquote><p>这里因为我们已经生成过了，就不要做验证改变表名了。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ordering = &apos;-object_id&apos;</span><br></pre></td></tr></table></figure><p>ordering指定默认排序字段,如：就会以object_id倒序</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verbose_name_plural = u&quot;用户留言信息&quot;</span><br></pre></td></tr></table></figure><p>verbose_name_plural：复数信息，便于人阅读。否则会在后台显示<code>用户留言信息s</code></p><p>已经学习完毕了<code>orm</code>将数据表映射表。<br>github地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a><br>此节结束对应github commit:</p><blockquote><p>留言板数据库orm映射成表完成。内容截止教程3-3结束。</p></blockquote><h2 id="3-4-django-model的增删改"><a href="#3-4-django-model的增删改" class="headerlink" title="3-4 django model的增删改"></a>3-4 django model的增删改</h2><p><strong>github仓库地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></strong></p><ul><li>上小节完成代码对应commit: 留言板数据库orm映射成表完成。内容截止教程3-3结束。</li></ul><p>在<code>message/views.py</code>中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserMessage</span><br></pre></td></tr></table></figure><p>将我们刚才创建的model，import进来。<code>.</code>代表是与当前同级的目录。</p><p>按照下图所示添加一条测试数据。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/IBga4E2FGh.png?imageslim" alt="mark"></p><p>然后再我们的<code>getform</code>方法内部添加下面代码：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def getform(request):</span><br><span class="line">    # UserMessage默认的数据管理器objects。</span><br><span class="line">    # 方法all()是将所有数据返回成一个queryset类型(django的内置类型)</span><br><span class="line">    all_message = UserMessage.objects.all()</span><br><span class="line"></span><br><span class="line">    #我们可以对于all_message进行遍历操作</span><br><span class="line">    for message in all_message:</span><br><span class="line">        # 每个message实际就是一个UserMessage对象（这时我们就可以使用对象的相关方法）。</span><br><span class="line">        print message.name</span><br><span class="line"></span><br><span class="line">    return render(request, &apos;message_form.html&apos;)</span><br></pre></td></tr></table></figure><p></p><p>调试过程：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/FGChlB50k7.png?imageslim" alt="mark"></p><ul><li><p>点击上图小红框位置，打上断点。</p></li><li><p>点击Run -&gt; debug后：在浏览器里打开：<code>http://127.0.0.1:8000/form/</code></p></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/mAebKF06m9.png?imageslim" alt="mark"></p><ul><li>弹出上图代表已进入断点。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/0cb6GGiGDa.png?imageslim" alt="mark"></p><ul><li><p>此时鼠标左键点击：all_message.可以看到这是一个<code>{QuerySet}类型的对象，里面存放着[&lt;UserMessage: UserMessage object&gt;]</code></p></li><li><p>按<code>f6</code>使运行到下一步。此时下方的值窗口内可以看到message的值。说明我们成功取到了数据库的值。</p></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/hJgD3AC3c2.png?imageslim" alt="mark"></p><h3 id="filter取出指定要求值"><a href="#filter取出指定要求值" class="headerlink" title="filter取出指定要求值"></a>filter取出指定要求值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_message = UserMessage.objects.filter(name=&apos; mtianyan&apos;, address=&apos;西安&apos;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180107/Eal2Ldj6e8.png?imageslim" alt="mark"></p><p>按照上面调试过程重新调试可以看到我们同样取出了值。</p><p>小练习：将名字改为与自己数据库存放值不同的。查看结果。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/IChf8L7ecd.png?imageslim" alt="mark"></p><blockquote><p>变成了空列表，说明一切正确。</p></blockquote><h3 id="将数据存入数据库"><a href="#将数据存入数据库" class="headerlink" title="将数据存入数据库"></a>将数据存入数据库</h3><p>了解：django/db/models/base.py 源码中提供save方法<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, force_insert=False, force_update=False, using=None,</span></span></span><br><span class="line"><span class="function"><span class="params">             update_fields=None)</span>:</span></span><br></pre></td></tr></table></figure><p></p><p>getform方法中添加代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存储部分</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 首先实例化一个对象</span></span><br><span class="line">   user_message = UserMessage()</span><br><span class="line"></span><br><span class="line">   <span class="comment"># 为对象增加属性</span></span><br><span class="line">   user_message.name = <span class="string">"mtianyan2"</span></span><br><span class="line">   user_message.message = <span class="string">"blog.mtianyan.cn"</span></span><br><span class="line">   user_message.address = <span class="string">"西安"</span></span><br><span class="line">   user_message.email = <span class="string">"1147727180@qq.com"</span></span><br><span class="line">   user_message.object_id = <span class="string">"efgh"</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 调用save方法进行保存</span></span><br><span class="line">   user_message.save()</span><br></pre></td></tr></table></figure><ul><li>打上断点：如下图。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/3b7aeEg0KE.png?imageslim" alt="mark"></p><ul><li>一直惦记f6单步调试，直到如下图：蓝色到<code>return</code>语句</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/m2fF7j38dC.png?imageslim" alt="mark"></p><p>可以在下方值窗口查看到值</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/bg6ICDcI9I.png?imageslim" alt="mark"></p><h3 id="Navicat进行验证"><a href="#Navicat进行验证" class="headerlink" title="Navicat进行验证"></a>Navicat进行验证</h3><blockquote><p>可以看到成功的添加了数据<code>mtianyan2</code></p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/DiBKcaJd8A.png?imageslim" alt="mark"></p><h3 id="如何从html的提交中取到数据并保存进数据库"><a href="#如何从html的提交中取到数据并保存进数据库" class="headerlink" title="如何从html的提交中取到数据并保存进数据库"></a>如何从html的提交中取到数据并保存进数据库</h3><p>templates/message_form.html：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/glha3bHaC8.png?imageslim" alt="mark"></p><blockquote><p>method是post。action就是指向我们在urls.py中配置的<code>/form/</code><br><strong>前面必须加斜杠指根路径下form</strong><br>里面的input会自动把值传递给后台：这时我们就可以在getform中取到刚才传递过来的值。</p></blockquote><p>运行项目：然后输入需要填写的值。点击提交：出现403错误</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Forbidden (403)</span><br><span class="line">CSRF verification failed. Request aborted.</span><br></pre></td></tr></table></figure><blockquote><p>根据提示：我们的页面没有进行crsf的验证，这时django的安全机制，不允许任意form都往后台提交。</p></blockquote><p><strong>知识点：所以我们需要在html页面中加入csrf_token</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% csrf_token %&#125;</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180107/chCamk6JDk.png?imageslim" alt="mark"></p><p>原有那行删除掉。打上断点</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/3cCBcF96eC.png?imageslim" alt="mark"></p><p>刷新页面并提交。这时候在值窗口可以看到request对象下的POST中存放着我们提交的数据。内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;QueryDict: &#123;u&apos;message&apos;: [u&apos;\u54c8\u54c8&apos;], u&apos;address&apos;: [</span><br><span class="line">u&apos;\u897f\u5b89\u5e02&apos;], u&apos;csrfmiddlewaretoken&apos;: [</span><br><span class="line">u&apos;uIYSMOTWPJBPOPucRwd3uDaWtCzeEaem&apos;], u&apos;name&apos;: [</span><br><span class="line">u&apos;\u5929\u6daf\u660e\u6708\u7b19&apos;], u&apos;email&apos;: [u&apos;1147727180@qq.com&apos;]&#125;&gt;</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180107/3BL02H2ljG.png?imageslim" alt="mark"></p><blockquote><p>数据以dict：key-value 形式存储 key是由如下图html中的name所决定对应的。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180107/c2lIdeH2A1.png?imageslim" alt="mark"></p><h3 id="数据库新增。"><a href="#数据库新增。" class="headerlink" title="数据库新增。"></a>数据库新增。</h3><p><code>request.POST</code>中数据取出，存入<code>user_message</code>对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># html表单部分</span></span><br><span class="line"></span><br><span class="line">   <span class="comment"># 此处对应html中的method="post"，表示我们只处理post请求</span></span><br><span class="line">   <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">       <span class="comment"># 就是取字典里key对应value值而已。取name，取不到默认空</span></span><br><span class="line">       name = request.POST.get(<span class="string">'name'</span>, <span class="string">''</span>)</span><br><span class="line">       message = request.POST.get(<span class="string">'message'</span>, <span class="string">''</span>)</span><br><span class="line">       address = request.POST.get(<span class="string">'address'</span>, <span class="string">''</span>)</span><br><span class="line">       email = request.POST.get(<span class="string">'email'</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">       <span class="comment"># 实例化对象</span></span><br><span class="line">       user_message = UserMessage()</span><br><span class="line"></span><br><span class="line">       <span class="comment"># 将html的值传入我们实例化的对象.</span></span><br><span class="line">       user_message.name = name</span><br><span class="line">       user_message.message = message</span><br><span class="line">       user_message.address = address</span><br><span class="line">       user_message.email = email</span><br><span class="line">       user_message.object_id = <span class="string">"ijkl"</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># 调用save方法进行保存</span></span><br><span class="line">       user_message.save()</span><br></pre></td></tr></table></figure><ul><li>打断点在下图位置：</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/gblC5dg219.png?imageslim" alt="mark"></p><ul><li>进入调试：点击点击method：是get请求。因为我们并没有按提交按钮，而是get这个网页</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/heblbcAf4h.png?imageslim" alt="mark"></p><ul><li>点击f8继续运行我们的项目 浏览器中填写表单内容点提交。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180107/33ECK331eE.png?imageslim" alt="mark"></p><blockquote><p>因为这次是表单提交，已经变成了post方式。按<code>f6</code>进行单步调试。</p></blockquote><p>一直单步到如下图蓝色</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/4Ck700a9Ea.png?imageslim" alt="mark"></p><p>这时候值浏览窗口可以看到</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/i22jKb99Bh.png?imageslim" alt="mark"></p><blockquote><p>检查我们的user_message对象的属性是否已经全部添加进去，</p></blockquote><p>使用f8 继续项目并前往Navicat验证</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/0mJgFKbi9k.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们的数据库中已经新增，标志着我们已经成功存入数据。</p></blockquote><h3 id="删除数据。"><a href="#删除数据。" class="headerlink" title="删除数据。"></a>删除数据。</h3><p>对于查询到的数据做删除：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法2 :filter取出指定条件值，逗号代表and 必须同时满足两个条件才返回。</span></span><br><span class="line">all_message = UserMessage.objects.filter(name=<span class="string">'mtianyan'</span>, address=<span class="string">'西安'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 我的数据库里保存着可以匹配到该条数据的一行。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除操作：使用delete方法删除all_message</span></span><br><span class="line"></span><br><span class="line">all_message.delete()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> all_message:</span><br><span class="line">        <span class="comment"># 删除取到的message对象</span></span><br><span class="line">        message.detele()</span><br><span class="line">        <span class="comment"># print message.name</span></span><br></pre></td></tr></table></figure><p>点击run并访问：<a href="http://127.0.0.1:8000/form/" target="_blank" rel="noopener">http://127.0.0.1:8000/form/</a><br>进入Navicat进行验证。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/BamdmLI1Ec.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们的那条mtianyan + 西安的数据已经被删除。</p></blockquote><p><strong>至此：我们已经学会了新增，删除，查询。</strong></p><p>本节结束github对应commit：</p><blockquote><p>django model的增删改数据库。本次内容截止教程3-4。</p></blockquote><h2 id="3-5-django-url-templates配置"><a href="#3-5-django-url-templates配置" class="headerlink" title="3-5 django url templates配置"></a>3-5 django url templates配置</h2><blockquote><p>项目Github地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a><br>本节开始对应对应Github的commit：django model的增删改数据库。本次内容截止教程3-4。</p></blockquote><p>本节将介绍url的配置，以及如何将数据库数据填充回前台html页面。</p><p>情景：只允许用户修改<code>mtianyan</code>，如果没有就添加，如果有就回填使用户可以修改。</p><h3 id="取出数据"><a href="#取出数据" class="headerlink" title="取出数据"></a>取出数据</h3><p>message/views.py中的getform方法中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">message = <span class="keyword">None</span></span><br><span class="line">all_message = UserMessage.objects.filter(name=<span class="string">'mtianyan'</span>, address=<span class="string">'西安'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if 判断是否存在数据</span></span><br><span class="line"><span class="keyword">if</span> all_message:</span><br><span class="line">    <span class="comment"># all_message是一个list，可以使用切片。</span></span><br><span class="line">    message = all_message[<span class="number">0</span>]</span><br></pre></td></tr></table></figure><blockquote><p>这里注意把前几节写的删除掉</p></blockquote><h3 id="将数据回填至html中"><a href="#将数据回填至html中" class="headerlink" title="将数据回填至html中"></a>将数据回填至html中</h3><h4 id="修改return-render"><a href="#修改return-render" class="headerlink" title="修改return render"></a>修改return render</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">return render(request, &apos;message_form.html&apos;,&#123;</span><br><span class="line">        &quot;my_message&quot; : message</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>这里前面的”my_meassage”是我们可以自行命名的。会有一个<code>my_message</code>对象随着返回前端页面。</p></blockquote><h4 id="在前端页面中放入值。"><a href="#在前端页面中放入值。" class="headerlink" title="在前端页面中放入值。"></a>在前端页面中放入值。</h4><p>为input系列标签添加<code>value</code>: 使用<code>my_message.name</code>取到我们传递过来的<code>my_message</code>对象的属性值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input id=&quot;name&quot; type=&quot;text&quot; name=&quot;name&quot;  </span><br><span class="line">value=&quot;&#123;&#123; my_message.name &#125;&#125;&quot; class=&quot;error&quot; placeholder=&quot;请输入您的姓名&quot;/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>请自行完成姓名，邮箱，联系地址三个<code>input</code>标签。</p></blockquote><p>为<code>textarea</code>标签添加值</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/F60Dl7jf93.png?imageslim" alt="mark"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea id=&quot;message&quot; name=&quot;message&quot;  </span><br><span class="line">placeholder=&quot;请输入你的建议&quot;&gt;&#123;&#123; my_message.message &#125;&#125;&lt;/textarea&gt;</span><br></pre></td></tr></table></figure><p>运行项目，访问：<a href="http://127.0.0.1:8000/form/" target="_blank" rel="noopener">http://127.0.0.1:8000/form/</a></p><p><img src="http://myphoto.mtianyan.cn/blog/180107/27BFK0ieIL.png?imageslim" alt="mark"></p><blockquote><p>成功！！我们已经将后台数据库数据成功展示到前台。</p></blockquote><h3 id="template模板渲染中的一些用法。"><a href="#template模板渲染中的一些用法。" class="headerlink" title="template模板渲染中的一些用法。"></a>template模板渲染中的一些用法。</h3><blockquote><p>在我们的template模板中也就是form.html中，不允许我们写Python的语法，<br>它提供了一套自己的内建标签。</p></blockquote><p><a href="https://docs.djangoproject.com/en/2.0/ref/templates/builtins/" target="_blank" rel="noopener">官方文档中template内建标签用法传送门</a></p><h4 id="常用的几种模板标签介绍："><a href="#常用的几种模板标签介绍：" class="headerlink" title="常用的几种模板标签介绍："></a>常用的几种模板标签介绍：</h4><h5 id="if-else"><a href="#if-else" class="headerlink" title="if - else"></a><code>if - else</code></h5><p>官方提供模板如下：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/mhJlLmCiLh.png?imageslim" alt="mark"></p><p>个人实践：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/Ahch4LBcKd.png?imageslim" alt="mark"></p><p>满足if运行结果：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/kBb2Ak6ec0.png?imageslim" alt="mark"></p><p>不满足if：如改为<code>my_message.name == &quot;mtianyan1&quot;</code>运行结果：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/5c6fK8mDAK.png?imageslim" alt="mark"></p><h5 id="ifequal-amp-ifnotequal"><a href="#ifequal-amp-ifnotequal" class="headerlink" title="ifequal &amp; ifnotequal"></a><code>ifequal</code> &amp; <code>ifnotequal</code></h5><p><img src="http://myphoto.mtianyan.cn/blog/180107/he6fBLk1le.png?imageslim" alt="mark"></p><p>官方文档解释：<code>ifequal a b</code> 相当于<code>f a == b</code>.<code>ifnotequal</code>则相当于<code>if a != b</code></p><p>个人实践：<br><img src="http://myphoto.mtianyan.cn/blog/180107/ihKmHmCLcD.png?imageslim" alt="mark"></p><p>结果为：未找到中文昵称</p><h5 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h5><p><img src="http://myphoto.mtianyan.cn/blog/180107/DccKL0EB4C.png?imageslim" alt="mark"></p><p>官方文档解释：其实就是切片操作。从头开始切到第n个。</p><p>个人实践：</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/m8jJE8KEae.png?imageslim" alt="mark"></p><blockquote><p>本来<code>mtianyan</code> 与 <code>mtianyan1</code>是不同的，但是切片后前八位相同。<br>运行结果显示 ：<code>对应中文昵称：天涯明月笙</code></p></blockquote><h3 id="URl的别名设置技巧"><a href="#URl的别名设置技巧" class="headerlink" title="URl的别名设置技巧"></a>URl的别名设置技巧</h3><p>DjangoGetStarted/urls.py：</p><p>为<code>r&#39;^form/$&#39;</code>添加别名：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^form/$'</span>, getform, name = <span class="string">"form_new"</span>)</span><br></pre></td></tr></table></figure><p>前往html中修改action地址为下面所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=&quot;&#123;% url &quot;form_new&quot; %&#125;&quot; method=&quot;post&quot; class=&quot;smart-green&quot;&gt;</span><br></pre></td></tr></table></figure><p>这时我们如果改动urls.py中的<code>r&#39;^form/$&#39;</code>不需要再修改前端代码中值。</p><h3 id="url先后顺序问题"><a href="#url先后顺序问题" class="headerlink" title="url先后顺序问题"></a>url先后顺序问题</h3><p><strong>注意</strong>url匹配规则中一定不要忘记<code>/$</code>符号代表以<code>form/</code>结束的才会有效。不会向后继续匹配。比如没有<code>/$</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(r&apos;^form&apos;, getform, name=&quot;form_new&quot;)</span><br></pre></td></tr></table></figure><p>这时我们进入浏览器访问时输入<code>http://127.0.0.1:8000/formemmm</code>都可以被响应。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/aehl7G2K20.png?imageslim" alt="mark"></p><p>特别是如果底下还配置有被这个规则包含的条目，会产生被写在更靠前的拦截住得不到正确处理的Bug。</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/jm5AJLLmGd.png?imageslim" alt="mark"></p><blockquote><p>上图我们是想要让formtest响应admin.site.urls。但是会被form提前拦截住。</p></blockquote><p>所以我们一定要注意加上<code>/$</code>符号。</p><p>至此我们完成了留言板项目：学习到了Django必备的基础知识。<br>下一章我们将开始我们的进阶学习：开发在线教育平台网站。</p><p>本章结束：</p><blockquote><p>对应Commit: 留言板项目学习完成，本次内容截止教程3-5。完结，撒花。<br>项目Github地址：<a href="https://github.com/mtianyan/DjangoGetStarted" target="_blank" rel="noopener">https://github.com/mtianyan/DjangoGetStarted</a></p></blockquote><blockquote class="blockquote-center"><p>数据基础决定上层建筑</p></blockquote><div class="note warning"><p> 设计数据库是整个项目的第一项工作:</p><ul><li>完成django的app设计 &amp; 完成app中的models设计</li></ul><p>Django1.9.8对应github: <a href="https://github.com/mtianyan/Mxonline2" target="_blank" rel="noopener">https://github.com/mtianyan/Mxonline2</a><br>Django2.0.1对应github: <a href="https://github.com/mtianyan/Mxonline3" target="_blank" rel="noopener">https://github.com/mtianyan/Mxonline3</a></p></div><h1 id="完成django的app设计-amp-完成app中的models设计"><a href="#完成django的app设计-amp-完成app中的models设计" class="headerlink" title="完成django的app设计 &amp; 完成app中的models设计"></a>完成django的app设计 &amp; 完成app中的models设计</h1><h2 id="4-1-使用py3-6和django1-11开发系统前注意事项"><a href="#4-1-使用py3-6和django1-11开发系统前注意事项" class="headerlink" title="4-1 使用py3.6和django1.11开发系统前注意事项"></a>4-1 使用py3.6和django1.11开发系统前注意事项</h2><p>直接通过Python3.6和django最新版本来开发我们的系统的一些注意事项。</p><blockquote><p>原版本: Python 2.7 &amp; django 1.9.8<br>现在版本：Python 3.6 &amp; django 1.11</p></blockquote><p>我个人使用: 3.5 + django2.0.1 &amp; 2.7 + django 1.9.8</p><p>直接从3.6上手，开始工作，而不用做完2.7再转换。</p><blockquote><p>代码几乎100%兼容2.7 &amp; 3.6</p></blockquote><h3 id="虚拟环境问题"><a href="#虚拟环境问题" class="headerlink" title="虚拟环境问题"></a>虚拟环境问题</h3><blockquote><p>Python2.7 与 Python3.x共存并创建虚拟环境。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv -p C:\...\python.exe mxonline</span><br></pre></td></tr></table></figure><h3 id="设计model的时候的-unicode-方法"><a href="#设计model的时候的-unicode-方法" class="headerlink" title="设计model的时候的__unicode__方法"></a>设计model的时候的<code>__unicode__</code>方法</h3><p>Python2.7 中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span>:</span></span><br><span class="line">	<span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure><p>Python 3.x中:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure><p></p><blockquote><p>3.x下重载Unicode不会报错，但是会在后台显示有问题。</p></blockquote><h3 id="安装Python的mysql驱动时不能用之前的-MYSQL-python"><a href="#安装Python的mysql驱动时不能用之前的-MYSQL-python" class="headerlink" title="安装Python的mysql驱动时不能用之前的 MYSQL python"></a>安装Python的mysql驱动时不能用之前的 MYSQL python</h3><blockquote><p>这个网址是windows下python包安装的居家必备良品，建议收藏。</p></blockquote><p><a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python" target="_blank" rel="noopener">https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python</a></p><p>应该改用<code>Mysqlclient</code>来替换我们的<code>MySQl-python</code></p><blockquote><p>接口是一样的。所以以后建议直接用Mysqlclient，因为它2, 3版本都有。</p></blockquote><h3 id="通过源码方式安装xadmin时。"><a href="#通过源码方式安装xadmin时。" class="headerlink" title="通过源码方式安装xadmin时。"></a>通过源码方式安装xadmin时。</h3><blockquote><p>Github 搜索 <code>mxonline_resources</code>，将里面的Xadmin放进extras_apps中。<br>就不用官方的了。</p></blockquote><p>django 2.0.1 的修复bug版可以使用我的:</p><p><a href="https://github.com/mtianyan/xadmin_django2.0.1" target="_blank" rel="noopener">https://github.com/mtianyan/xadmin_django2.0.1</a></p><blockquote><p>也可以直接使用官方的新版，已经支持了Python3.6</p></blockquote><p>Xadmin安装一定要安装依赖包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">django-crispy-forms=1.6.0</span><br><span class="line">django-import-export&gt;=0.5.1</span><br><span class="line">django-reversion~=2.0.0</span><br><span class="line">django-formtools</span><br><span class="line">future==0.15.2</span><br><span class="line">httplib2==0.9.2</span><br><span class="line">six==1.10.0</span><br></pre></td></tr></table></figure><h3 id="使用DjangoUeditor"><a href="#使用DjangoUeditor" class="headerlink" title="使用DjangoUeditor"></a>使用DjangoUeditor</h3><p>官方的不支持Python3, 去<code>mxonline_resource</code>目录下载兼容Python3的版本。<br>放入<code>extras_apps</code></p><h2 id="4-2-django-app-设计"><a href="#4-2-django-app-设计" class="headerlink" title="4-2 django-app 设计"></a>4-2 django-app 设计</h2><blockquote><p>数据库设计</p></blockquote><h3 id="根据app设计-models"><a href="#根据app设计-models" class="headerlink" title="根据app设计 models"></a>根据app设计 models</h3><h3 id="数据表生成与修改"><a href="#数据表生成与修改" class="headerlink" title="数据表生成与修改"></a>数据表生成与修改</h3><p>授课机构提供讲师录制课程，学员完成在线学习。</p><ul><li>全局头部：用户消息 &amp; 个人中心: 没有登录时，就是登录注册</li><li>对于公开课，授课讲师，授课机构进行搜索。</li><li>轮播图，课程，机构，页脚</li><li>公开课：分页公开课，右边热门推荐。</li><li>点进课程：课程详情页。详情: 后台富文本。右边是课程机构的介绍。收藏 或学习</li><li>章节信息 &amp; 课程资源下载 &amp; 评论</li><li>授课讲师: 授课讲师列表页, 讲师排行榜。分页。</li><li>点进讲师: 看到课程。</li><li>授课机构: 类别筛选，机构性质，所在地区 &amp; 排序。用户提交表单，我要学习, 机构排名.</li><li>个人中心: 修改密码, 修改头像, 个人信息, 我的课程, 我的收藏, 我的消息。</li></ul><p>app大致会有<code>用户模块</code>,<code>课程模块</code>,<code>授课教师</code>与<code>授课机构</code>。</p><p><img src="http://myphoto.mtianyan.cn/blog/180108/DB9D66LmaJ.png?imageslim" alt="mark"></p><p>多一个operation app 是因为数据库的需要。后面会讲。</p><h2 id="4-3-新建项目"><a href="#4-3-新建项目" class="headerlink" title="4-3 新建项目"></a>4-3 新建项目</h2><h3 id="Python2-7-创建虚拟环境。"><a href="#Python2-7-创建虚拟环境。" class="headerlink" title="Python2.7 创建虚拟环境。"></a>Python2.7 创建虚拟环境。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv mxonline2</span><br></pre></td></tr></table></figure><p>安装django</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django==1.9.8</span><br></pre></td></tr></table></figure><blockquote><p>注意Python2下此处必须用1.9.8</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180108/JJamFecfhC.png?imageslim" alt="mark"></p><h3 id="Python3-x-创建虚拟环境"><a href="#Python3-x-创建虚拟环境" class="headerlink" title="Python3.x 创建虚拟环境"></a>Python3.x 创建虚拟环境</h3><p>如果你已经通过我的博文《Python开发环境搭建指南(Anaconda2,3共存)》<br>搭建了完美的共存环境使用下面命令创建虚拟环境</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv -p D:\softEnvDown\Anaconda2\envs\py3\python.exe mxonline3</span><br></pre></td></tr></table></figure><blockquote><p>-p后面路径为自己的Python3的exe文件路径。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180108/i6lKIGdE93.png?imageslim" alt="mark"></p><blockquote><p>官方说明的最新稳定版为2.0.1(2018-01-08 19:37:06)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline3</span><br><span class="line">pip install django==2.0.1</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180108/I1fF3aL00H.png?imageslim" alt="mark"></p><p>至此我们的两个虚拟环境都已经准备好了。</p><h3 id="新建Python2-下Project"><a href="#新建Python2-下Project" class="headerlink" title="新建Python2 下Project"></a>新建Python2 下Project</h3><p>为Mxonline2 配置环境 <code>mxonline2</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180108/3Ic2ehmkGK.png?imageslim" alt="mark"></p><p>注意一直定位到Python.exe。</p><h4 id="安装mysql驱动。"><a href="#安装mysql驱动。" class="headerlink" title="安装mysql驱动。"></a>安装mysql驱动。</h4><p>下载<a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python中" target="_blank" rel="noopener">https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python中</a><br>mysqlclient‑1.3.12‑cp34‑cp34m‑win_amd64.whl进行本地安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline2</span><br><span class="line">pip install mysqlclient-1.3.12-cp27-cp27m-win_amd64.whl</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180108/8dK5e5clJB.png?imageslim" alt="mark"></p><h3 id="新建Python3-下Project"><a href="#新建Python3-下Project" class="headerlink" title="新建Python3 下Project"></a>新建Python3 下Project</h3><p>为Mxonline3 配置环境 <code>mxonline3</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180108/383ceKe92C.png?imageslim" alt="mark"></p><blockquote><p>注意一直定位到Python.exe。</p></blockquote><h4 id="安装mysql驱动。-1"><a href="#安装mysql驱动。-1" class="headerlink" title="安装mysql驱动。"></a>安装mysql驱动。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline3</span><br><span class="line">pip install mysqlclient</span><br></pre></td></tr></table></figure><h3 id="setting中配置"><a href="#setting中配置" class="headerlink" title="setting中配置"></a>setting中配置</h3><p>Mxonline2/settings.py:<br>Mxonline3/settings.py:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</span><br><span class="line">        &apos;NAME&apos;: &apos;mxonline2&apos;,</span><br><span class="line">        &apos;USER&apos;: &apos;root&apos;,</span><br><span class="line">        &apos;PASSWORD&apos;: &apos;你的密码&apos;,</span><br><span class="line">        &apos;HOST&apos;:&apos;127.0.0.1&apos;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</span><br><span class="line">        &apos;NAME&apos;: &apos;mxonline3&apos;,</span><br><span class="line">        &apos;USER&apos;: &apos;root&apos;,</span><br><span class="line">        &apos;PASSWORD&apos;: &apos;你的密码&apos;,</span><br><span class="line">        &apos;HOST&apos;:&apos;127.0.0.1&apos;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="前往Navicat新建数据库"><a href="#前往Navicat新建数据库" class="headerlink" title="前往Navicat新建数据库"></a>前往Navicat新建数据库</h3><p>mxonline2 &amp; mxonline3</p><h4 id="进行数据库初始化makemigrations"><a href="#进行数据库初始化makemigrations" class="headerlink" title="进行数据库初始化makemigrations"></a>进行数据库初始化makemigrations</h4><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><blockquote><p>2,3操作一致</p></blockquote><p>点击 RUn edit</p><p><img src="http://myphoto.mtianyan.cn/blog/180108/al0KDCbiK6.png?imageslim" alt="mark"></p><p>可以为2,3配置不同的port。比如2: 8002 &amp; 3: 8003</p><p>2: 点击run运行: django1.9.8成功画面如下。</p><p><img src="http://myphoto.mtianyan.cn/blog/180108/628mmAGLID.png?imageslim" alt="mark"></p><p>3: 点击run运行: django2.0.1成功画面如下。</p><p><img src="http://myphoto.mtianyan.cn/blog/180108/GeEcJgAbEA.png?imageslim" alt="mark"></p><p>这时我们的项目就新建成功。</p><p>此处对应commit:</p><blockquote><p>项目初始化成功: 完成数据库Migration初始化。 对应4-3</p></blockquote><h2 id="4-4-自定义userprofile"><a href="#4-4-自定义userprofile" class="headerlink" title="4-4 自定义userprofile"></a>4-4 自定义userprofile</h2><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startapp users</span><br></pre></td></tr></table></figure><h3 id="编写我们的model设计user表。"><a href="#编写我们的model设计user表。" class="headerlink" title="编写我们的model设计user表。"></a>编写我们的model设计user表。</h3><p>系统自动生成的user表如下:</p><p><img src="http://myphoto.mtianyan.cn/blog/180108/H6jBl0IKjb.png?imageslim" alt="mark"></p><ul><li>id: 主键, password 密码, last_login Django自动记录用户最后登录时间,。</li><li>is_superuser 表明用户是否是超级用户(后台管理会用到)。</li><li>username 用户名字段不要随便改动, email 邮箱,</li><li>is_staff 表示是否是员工(后台管理会用到)。</li><li>is_active 用户是否是激活状态, date_joined 注册时间。</li></ul><blockquote><p>我们需要扩展我们自己的需求字段。</p></blockquote><p>个人中心页面中:</p><p><img src="http://myphoto.mtianyan.cn/blog/180108/mghmfD45hJ.png?imageslim" alt="mark"></p><p>可以看到我们还需要的有：</p><ul><li>昵称: nickname</li><li>生日: birthday</li><li>性别: gender</li></ul><p>User表的自定义方法可以查看django官方文档。<br>我们既想保留原有字段，又想有新字段。</p><p>users/models.py(3把Unicode改为str)添加代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    <span class="comment"># 自定义的性别选择规则</span></span><br><span class="line">    GENDER_CHOICES = (</span><br><span class="line">        (<span class="string">"male"</span>, <span class="string">u"男"</span>),</span><br><span class="line">        (<span class="string">"female"</span>, <span class="string">u"女"</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 昵称</span></span><br><span class="line">    nick_name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"昵称"</span>, default=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 生日，可以为空</span></span><br><span class="line">    birthday = models.DateField(verbose_name=<span class="string">u"生日"</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 性别 只能男或女，默认女</span></span><br><span class="line">    gender = models.CharField(</span><br><span class="line">        max_length=<span class="number">5</span>,</span><br><span class="line">        verbose_name=<span class="string">u"性别"</span>,</span><br><span class="line">        choices=GENDER_CHOICES,</span><br><span class="line">        default=<span class="string">"female"</span>)</span><br><span class="line">    <span class="comment"># 地址</span></span><br><span class="line">    address = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">"地址"</span>, default=<span class="string">""</span>)</span><br><span class="line">    <span class="comment"># 电话</span></span><br><span class="line">    mobile = models.CharField(max_length=<span class="number">11</span>, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 头像 默认使用default.png</span></span><br><span class="line">    image = models.ImageField(</span><br><span class="line">        upload_to=<span class="string">"image/%Y/%m"</span>,</span><br><span class="line">        default=<span class="string">u"image/default.png"</span>,</span><br><span class="line">        max_length=<span class="number">100</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># meta信息，即后台栏目名</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">"用户信息"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重载Unicode方法，打印实例会打印username，username为继承自abstractuser</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure><p>点进<code>AbstractUser</code>可以看到这个models里面就有我们默认表的那些字段。</p><p>因为Image字段需要用到<code>pillow</code>所以需要安装该库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br></pre></td></tr></table></figure><p><strong>注意：CharField必须有max_length, Imagefield实际也是charfield所以也要有max_length</strong></p><h4 id="setting设置INSTALLED-APPS-amp-AUTH-USER-MODEL。"><a href="#setting设置INSTALLED-APPS-amp-AUTH-USER-MODEL。" class="headerlink" title="setting设置INSTALLED_APPS &amp; AUTH_USER_MODEL。"></a>setting设置INSTALLED_APPS &amp; AUTH_USER_MODEL。</h4><ul><li>INSTALLED_APPS注册app</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;users&apos;</span><br></pre></td></tr></table></figure><ul><li>重载AUTH_USER_MODEL</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 此处重载是为了使我们的UserProfile生效</span><br><span class="line">AUTH_USER_MODEL = &quot;users.UserProfile&quot;</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180108/JDik7FIb8k.png?imageslim" alt="mark"></p><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations users</span><br><span class="line">migrate users</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180108/ijGBh98JL6.png?imageslim" alt="mark"></p><blockquote><p>上图中可以看到数据库做出的改动。输入: yes</p></blockquote><h3 id="进入Navicat进行验证"><a href="#进入Navicat进行验证" class="headerlink" title="进入Navicat进行验证"></a>进入Navicat进行验证</h3><p><img src="http://myphoto.mtianyan.cn/blog/180108/79bbD88gJD.png?imageslim" alt="mark"></p><p>如上图可以看到我们的表已经生成成功。</p><h3 id="附加Python3下不同与报错："><a href="#附加Python3下不同与报错：" class="headerlink" title="附加Python3下不同与报错："></a>附加Python3下不同与报错：</h3><p>将Unicode方法改为str方法<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 重载__str__方法，打印实例会打印username，username为继承自AbstractUser</span><br><span class="line">def __str__(self):</span><br><span class="line">    return self.username</span><br></pre></td></tr></table></figure><p></p><p>报错:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">django.db.migrations.exceptions.InconsistentMigrationHistory: Migration</span><br><span class="line">admin.0001_initial is applied before its dependency users.0001_initial on</span><br><span class="line">database &apos;default&apos;</span><br></pre></td></tr></table></figure><p>解决方案:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">删除数据库中 除了auth_user的其他表</span><br></pre></td></tr></table></figure><p>然后执行命令:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br><span class="line">makemigrations users</span><br><span class="line">migrate users</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180108/gBLe65jc53.png?imageslim" alt="mark"></p><blockquote><p>共11张表，同期django1.9.8会产生13张表</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180108/C3h6f7d4J5.png?imageslim" alt="mark"></p><blockquote><p>我推测是因为在django2.0版本中。我们如果自定义了userProfile并且在setting中进行了设置。那么auth_user将不再拥有多的表。</p></blockquote><p>下次不要再初始化时执行makemigrations &amp; migrate。当我们设计userProfile完成之后再执行。</p><p>本小节完成对应commit:</p><blockquote><p>完成USerProfile models书写。makemigrations &amp; migrate 建表成功。对应4-4</p></blockquote><h2 id="4-5-user-modesl-py设计"><a href="#4-5-user-modesl-py设计" class="headerlink" title="4-5 user modesl.py设计"></a>4-5 user modesl.py设计</h2><p>循环引用:</p><blockquote><p>设计app时每个app都有model</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/LedJLC8e34.png?imageslim" alt="mark"></p><p>如图：我们在user中定义usercourse记录用户学习的课程。会有两个外键：user和course。<br>我们就会<code>import Courses.models</code></p><p>如果用户对课程的评论：会放在 <code>Courses.models</code>当中。评论我们需要保存相应的用户。<br>我们就会<code>import User.models</code></p><p>循环import会出错。a与b相互调用，造成等待。</p><h3 id="解决循环引用-分层设计"><a href="#解决循环引用-分层设计" class="headerlink" title="解决循环引用: 分层设计"></a>解决循环引用: 分层设计</h3><p>目前已有app：users courses organization</p><p>另外一个app高于这些app的层级。<code>operation</code>.上一层app可以import下层的app。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/kmDB89IcFF.png?imageslim" alt="mark"></p><p>上节中: 自定义<code>userprofile</code> 覆盖默认<code>user</code>表</p><p>user中还需要添加的(前提是这些功能比较独立):</p><ul><li>EmailVerifyRecord - 邮箱验证码</li><li>PageBanner - 轮播图</li></ul><p>观察轮播图:</p><blockquote><ol><li>图片 2. 点击图片地址 3. 轮播图序号(控制前后)</li></ol></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/fg4J5a2Kb5.png?imageslim" alt="mark"></p><p>users/models.py中添加代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮箱验证码model</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailVerifyRecord</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    SEND_CHOICES = (</span><br><span class="line">        (<span class="string">"register"</span>, <span class="string">u"注册"</span>),</span><br><span class="line">        (<span class="string">"forget"</span>, <span class="string">u"找回密码"</span>)</span><br><span class="line">    )</span><br><span class="line">    code = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">u"验证码"</span>)</span><br><span class="line">    <span class="comment"># 未设置null = true blank = true 默认不可为空</span></span><br><span class="line">    email = models.EmailField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"邮箱"</span>)</span><br><span class="line">    send_type = models.CharField(choices=SEND_CHOICES, max_length=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># 这里的now得去掉(),不去掉会根据编译时间。而不是根据实例化时间。</span></span><br><span class="line">    send_time = models.DateTimeField(default=datetime.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">"邮箱验证码"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 轮播图model</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Banner</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"标题"</span>)</span><br><span class="line">    image = models.ImageField(</span><br><span class="line">        upload_to=<span class="string">"banner/%Y/%m"</span>,</span><br><span class="line">        verbose_name=<span class="string">u"轮播图"</span>,</span><br><span class="line">        max_length=<span class="number">100</span>)</span><br><span class="line">    url = models.URLField(max_length=<span class="number">200</span>, verbose_name=<span class="string">u"访问地址"</span>)</span><br><span class="line">    <span class="comment"># 默认index很大靠后。想要靠前修改index值。</span></span><br><span class="line">    index = models.IntegerField(default=<span class="number">100</span>, verbose_name=<span class="string">u"顺序"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"轮播图"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure><p>从上往下: 第一块区域import官方包，第二块import第三方。(PEP8)</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/8cmDm7ADf8.png?imageslim" alt="mark"></p><p>如下图: 我们一共创建了三个数据表: Structure可以查看到</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/7ABfdDCf7C.png?imageslim" alt="mark"></p><blockquote><p>与用户相关的评论啊，点赞啊。学习的课程啊并没有放进来，因为那些独立性不高。<br>容易产生循环引用。我们把那些放到operation中。</p></blockquote><p>本小节完成，对应commit:</p><blockquote><p>Usermodel添加邮箱验证码，首页轮播图。对应4-5</p></blockquote><h2 id="4-6-course-models-py编写"><a href="#4-6-course-models-py编写" class="headerlink" title="4-6 course models.py编写"></a>4-6 course models.py编写</h2><p>点击 <code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startapp courses</span><br></pre></td></tr></table></figure><p>course中需要那些表:</p><ul><li>课程本身需要一张表</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/c9eBEHb0mL.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180109/75hlgK7481.png?imageslim" alt="mark"></p><ul><li><p>点进去之后点击开始学习。</p></li><li><p>课程基本信息需要一张表, 章节表与课程表存在(一个课程对应多个章节)</p></li><li>章节表中：章节的名称。 章节与视频(一个章节对应多个视频)</li></ul><p>结构: 课程本身–(一对多)&gt;章节-(一对多)-&gt;视频信息</p><p>资源下载放在课程里面的。一个课程对应多个资源</p><p>共四张表：课程本身–(一对多)&gt;章节-(一对多)-&gt;视频信息 &amp; 资源表</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/Kec5994359.png?imageslim" alt="mark"></p><p>courses/models.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 课程信息表</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    DEGREE_CHOICES = (</span><br><span class="line">        (<span class="string">"cj"</span>, <span class="string">u"初级"</span>),</span><br><span class="line">        (<span class="string">"zj"</span>, <span class="string">u"中级"</span>),</span><br><span class="line">        (<span class="string">"gj"</span>, <span class="string">u"高级"</span>)</span><br><span class="line">    )</span><br><span class="line">    name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"课程名"</span>)</span><br><span class="line">    desc = models.CharField(max_length=<span class="number">300</span>, verbose_name=<span class="string">u"课程描述"</span>)</span><br><span class="line">    <span class="comment"># TextField允许我们不输入长度。可以输入到无限大。暂时定义为TextFiled，之后更新为富文本</span></span><br><span class="line">    detail = models.TextField(verbose_name=<span class="string">u"课程详情"</span>)</span><br><span class="line">    degree = models.CharField(choices=DEGREE_CHOICES, max_length=<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># 使用分钟做后台记录(存储最小单位)前台转换</span></span><br><span class="line">    learn_times = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"学习时长(分钟数)"</span>)</span><br><span class="line">    <span class="comment"># 保存学习人数:点击开始学习才算</span></span><br><span class="line">    students = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"学习人数"</span>)</span><br><span class="line">    fav_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"收藏人数"</span>)</span><br><span class="line">    image = models.ImageField(</span><br><span class="line">        upload_to=<span class="string">"courses/%Y/%m"</span>,</span><br><span class="line">        verbose_name=<span class="string">u"封面图"</span>,</span><br><span class="line">        max_length=<span class="number">100</span>)</span><br><span class="line">    <span class="comment"># 保存点击量，点进页面就算</span></span><br><span class="line">    click_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"点击数"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"课程"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure><p>下面来编写章节 &amp; 视频 &amp; 课程资源:<code>courses/models.py</code></p><p>一对多, 多对一都可以使用django的外键来完成。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 章节</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lesson</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 因为一个课程对应很多章节。所以在章节表中将课程设置为外键。</span></span><br><span class="line">    <span class="comment"># 作为一个字段来让我们可以知道这个章节对应那个课程</span></span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=<span class="string">u"课程"</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"章节名"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"章节"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每章视频</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Video</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 因为一个章节对应很多视频。所以在视频表中将章节设置为外键。</span></span><br><span class="line">    <span class="comment"># 作为一个字段来存储让我们可以知道这个视频对应哪个章节.</span></span><br><span class="line">    lesson = models.ForeignKey(Lesson, verbose_name=<span class="string">u"章节"</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"视频名"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"视频"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 课程资源</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseResource</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 因为一个课程对应很多资源。所以在课程资源表中将课程设置为外键。</span></span><br><span class="line">    <span class="comment"># 作为一个字段来让我们可以知道这个资源对应那个课程</span></span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=<span class="string">u"课程"</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"名称"</span>)</span><br><span class="line">    <span class="comment"># 这里定义成文件类型的field，后台管理系统中会直接有上传的按钮。</span></span><br><span class="line">    <span class="comment"># FileField也是一个字符串类型，要指定最大长度。</span></span><br><span class="line">    download = models.FileField(</span><br><span class="line">        upload_to=<span class="string">"course/resource/%Y/%m"</span>,</span><br><span class="line">        verbose_name=<span class="string">u"资源文件"</span>,</span><br><span class="line">        max_length=<span class="number">100</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"课程资源"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure><p>通过Structure可以看到我们刚才设计的四张表</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/e3081f8bJh.png?imageslim" alt="mark"></p><p>本小节完毕, 对应commit:</p><blockquote><p>设计完成课程app中四张数据表: 课程，章节，视频，资源。对应4-6</p></blockquote><h2 id="4-7-organization-modesl-py设计"><a href="#4-7-organization-modesl-py设计" class="headerlink" title="4-7 organization modesl.py设计"></a>4-7 organization modesl.py设计</h2><p>新建课程机构app:</p><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startapp organization</span><br></pre></td></tr></table></figure><p>课程是属于机构的, 机构有机构类别，城市等字段。讲师实体。<br>我要学习的提交表单会与用户关联，存放在机构。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/K1faIbEA3A.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180109/1L2lebKCl0.png?imageslim" alt="mark"></p><p>其中课程数，学习人数可以动态统计。机构地址，机构经典课程。</p><blockquote><p>机构讲师，机构课程可以通过外键获取到, 不保存到机构中。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/DlgdiG6K16.png?imageslim" alt="mark"></p><blockquote><p>讲师大概所需要的字段如图所示。</p></blockquote><p>organization/models.py 代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding : utf-8</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 城市字典</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CityDict</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">u"城市"</span>)</span><br><span class="line">    <span class="comment"># 城市描述：备用不一定展示出来</span></span><br><span class="line">    desc = models.CharField(max_length=<span class="number">200</span>, verbose_name=<span class="string">u"描述"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"城市"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 课程机构</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseOrg</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"机构名称"</span>)</span><br><span class="line">    <span class="comment"># 机构描述，后面会替换为富文本展示</span></span><br><span class="line">    desc = models.TextField(verbose_name=<span class="string">u"机构描述"</span>)</span><br><span class="line">    click_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"点击数"</span>)</span><br><span class="line">    fav_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"收藏数"</span>)</span><br><span class="line">    image = models.ImageField(</span><br><span class="line">        upload_to=<span class="string">"org/%Y/%m"</span>,</span><br><span class="line">        verbose_name=<span class="string">u"封面图"</span>,</span><br><span class="line">        max_length=<span class="number">100</span>)</span><br><span class="line">    address = models.CharField(max_length=<span class="number">150</span>, verbose_name=<span class="string">u"机构地址"</span>)</span><br><span class="line">    <span class="comment"># 一个城市可以有很多课程机构，通过将city设置外键，变成课程机构的一个字段</span></span><br><span class="line">    <span class="comment"># 可以让我们通过机构找到城市</span></span><br><span class="line">    city = models.ForeignKey(CityDict, verbose_name=<span class="string">u"所在城市"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"课程机构"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 讲师</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 一个机构会有很多老师，所以我们在讲师表添加外键并把课程机构名称保存下来</span></span><br><span class="line">    <span class="comment"># 可以使我们通过讲师找到对应的机构</span></span><br><span class="line">    org = models.ForeignKey(CourseOrg, verbose_name=<span class="string">u"所属机构"</span>)</span><br><span class="line">    name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"教师名称"</span>)</span><br><span class="line">    work_years = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"工作年限"</span>)</span><br><span class="line">    work_company = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"就职公司"</span>)</span><br><span class="line">    work_position = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"公司职位"</span>)</span><br><span class="line">    points = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"教学特点"</span>)</span><br><span class="line">    click_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"点击数"</span>)</span><br><span class="line">    fav_nums = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"收藏数"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"教师"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/fi284KlfDk.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们一共创建了三张表：分别是城市，课程机构，讲师。</p></blockquote><p>本小节对应commit:</p><blockquote><p>课程机构app：城市，机构，讲师表书写完毕。对应4-7</p></blockquote><h2 id="4-8-operation-models-py设计"><a href="#4-8-operation-models-py设计" class="headerlink" title="4-8 operation models.py设计"></a>4-8 operation models.py设计</h2><p>分析需要那些表:</p><ul><li>用户可以提交我要学习的个人需求。</li><li>学员的课程评论信息</li><li>收藏：可以收藏公开课, 授课讲师, 授课机构, 用户消息提醒。</li><li>个人中心：我的课程说明用户和课程之间的学习关系也需要保存。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/5k6HkC49im.png?imageslim" alt="mark"></p><p>新建操作app:</p><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startapp operation</span><br></pre></td></tr></table></figure><p>operation/models.py添加代码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引入我们CourseComments所需要的外键models</span></span><br><span class="line"><span class="keyword">from</span> users.models <span class="keyword">import</span> UserProfile</span><br><span class="line"><span class="keyword">from</span> courses.models <span class="keyword">import</span> Course</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户我要学习表单</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAsk</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">u"姓名"</span>)</span><br><span class="line">    mobile = models.CharField(max_length=<span class="number">11</span>, verbose_name=<span class="string">u"手机"</span>)</span><br><span class="line">    course_name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"课程名"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"用户咨询"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户对于课程评论</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseComments</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 会涉及两个外键: 1. 用户， 2. 课程。import进来</span></span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=<span class="string">u"课程"</span>)</span><br><span class="line">    user = models.ForeignKey(UserProfile, verbose_name=<span class="string">u"用户"</span>)</span><br><span class="line">    comments = models.CharField(max_length=<span class="number">250</span>, verbose_name=<span class="string">u"评论"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"评论时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"课程评论"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户对于课程,机构，讲师的收藏</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavorite</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 会涉及四个外键。用户，课程，机构，讲师import</span></span><br><span class="line">    TYPE_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">u"课程"</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">u"课程机构"</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">u"讲师"</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    user = models.ForeignKey(UserProfile, verbose_name=<span class="string">u"用户"</span>)</span><br><span class="line">    <span class="comment"># course = models.ForeignKey(Course, verbose_name=u"课程")</span></span><br><span class="line">    <span class="comment"># teacher = models.ForeignKey()</span></span><br><span class="line">    <span class="comment"># org = models.ForeignKey()</span></span><br><span class="line">    <span class="comment"># fav_type =</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 机智版</span></span><br><span class="line">    <span class="comment"># 直接保存用户的id.</span></span><br><span class="line">    fav_id = models.IntegerField(default=<span class="number">0</span>)</span><br><span class="line">    <span class="comment"># 表明收藏的是哪种类型。</span></span><br><span class="line">    fav_type = models.IntegerField(</span><br><span class="line">        choices=TYPE_CHOICES,</span><br><span class="line">        default=<span class="number">1</span>,</span><br><span class="line">        verbose_name=<span class="string">u"收藏类型"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"评论时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"用户收藏"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户消息表</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserMessage</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">        <span class="comment"># 因为我们的消息有两种:发给全员和发给某一个用户。</span></span><br><span class="line">        <span class="comment"># 所以如果使用外键，每个消息会对应要有用户。很难实现全员消息。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 机智版 为0发给所有用户，不为0就是发给用户的id</span></span><br><span class="line">    user = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"接收用户"</span>)</span><br><span class="line">    message = models.CharField(max_length=<span class="number">500</span>, verbose_name=<span class="string">u"消息内容"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 是否已读: 布尔类型 BooleanField False未读,True表示已读</span></span><br><span class="line">    has_read = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">u"是否已读"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"用户消息"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户课程表</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserCourse</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 会涉及两个外键: 1. 用户， 2. 课程。import进来</span></span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=<span class="string">u"课程"</span>)</span><br><span class="line">    user = models.ForeignKey(UserProfile, verbose_name=<span class="string">u"用户"</span>)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=<span class="string">u"添加时间"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">u"用户课程"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure><p>至此：我们的五张operation下的数据表models设计完成</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/BHHfi6Gj2J.png?imageslim" alt="mark"></p><h3 id="setting中配置添加app"><a href="#setting中配置添加app" class="headerlink" title="setting中配置添加app"></a>setting中配置添加app</h3><p><img src="http://myphoto.mtianyan.cn/blog/180109/9IJa5kgFAG.png?imageslim" alt="mark"></p><p>本小节对应commit:</p><blockquote><p>operation下的models设计,用户: 课程&amp;消息&amp;收藏&amp;评论&amp;我要学习.并在setting中进行了注册。对应4-8</p></blockquote><h2 id="4-9-数据表生成以及apps目录建立"><a href="#4-9-数据表生成以及apps目录建立" class="headerlink" title="4-9 数据表生成以及apps目录建立"></a>4-9 数据表生成以及apps目录建立</h2><blockquote><p>学习如何通过刚才设计的models生成数据库对应的表</p></blockquote><p>点击<code>Tools 菜单下 Run manage.py Task</code>:</p><h3 id="Python2与Python3不同"><a href="#Python2与Python3不同" class="headerlink" title="Python2与Python3不同:"></a>Python2与Python3不同:</h3><p>Python2下可能会报一些<code>noASCII</code>错误:</p><p>只需要在对应你写了中文的第一行加上:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br></pre></td></tr></table></figure><h3 id="Python3-django2-0-1-会报错"><a href="#Python3-django2-0-1-会报错" class="headerlink" title="Python3(django2.0.1)会报错:"></a>Python3(django2.0.1)会报错:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org = models.ForeignKey(CourseOrg, verbose_name=u&quot;所属机构&quot;)</span><br><span class="line">TypeError: __init__() missing 1 required positional argument: &apos;on_delete&apos;</span><br></pre></td></tr></table></figure><blockquote><p>这是因为在2.0.1中，外键关系必须指明删除时的操作。</p></blockquote><p>比如：出租车都归属于出租车公司。如果出租车公司倒闭了，那这些汽车该怎么处理。<br>必须自己指明: 我觉得可以直接进行级联删除。</p><p>django提供了:</p><ul><li><code>CASCADE</code></li><li><code>PROTECT</code></li><li><code>SET_NULL</code></li><li><code>SET_DEFAULT</code></li></ul><p>等选项。我选择了<code>CASCADE</code>删除。</p><p>将(dajngo 2.0.1)项目中所有的外键修改为如下面代码所示：</p><blockquote><p>也就是添加了<code>on_delete=models.CASCADE</code>使其级联删除。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org = models.ForeignKey(CourseOrg, on_delete=models.CASCADE, verbose_name=<span class="string">u"所属机构"</span>)</span><br></pre></td></tr></table></figure><h3 id="makemirgration-amp-migrate生成表"><a href="#makemirgration-amp-migrate生成表" class="headerlink" title="makemirgration &amp; migrate生成表"></a>makemirgration &amp; migrate生成表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemirgration</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/mdib8gdGHc.png?imageslim" alt="mark"></p><p>上图为makemirgration过程中输出的信息。可以看到我们做出的改动</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/B01J3JChmd.png?imageslim" alt="mark"></p><p>此时我们查看app目录中migrations文件夹可以看到产生的新文件。</p><p><code>operation/migrations/0001_initial.py:</code></p><blockquote><p>可以看到里面也是Python的语法。他会帮我们生成数据表。<br>以后每次<code>migrations</code>时都会生成新的initial文件。这是很重要的变动文件，不能随意删除。</p></blockquote><p>打开Navicat可以看到django的数据库中有它默认的django_migrations表</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/i7Cc4HHBgh.png?imageslim" alt="mark"></p><p>双击django_migrations表可以看到我们migration的记录。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/kE5Fc9kjc7.png?imageslim" alt="mark"></p><blockquote><p>会记录哪个app下的哪个initial.py已经运行了。</p></blockquote><p>进入Navicat进行成功性验证:</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/Bd16J68e9k.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们的表已经生成成功,命名规则为: app名称 + 我们的类名变成小写</p></blockquote><h3 id="把我们的四个app放到一个文件夹下。"><a href="#把我们的四个app放到一个文件夹下。" class="headerlink" title="把我们的四个app放到一个文件夹下。"></a>把我们的四个app放到一个文件夹下。</h3><ul><li>新建Python的package: apps</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/7l4AG2maAD.png?imageslim" alt="mark"></p><ul><li>把四个app都拖进apps中去。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/mGLjCiL8aj.png?imageslim" alt="mark"></p><p>去掉<code>searchfor</code>的勾选。拖进去之后会报错，说找不到那些import的模块了。</p><p>解决方案：右键<code>Mark</code>为<code>sourceRoot</code>。根目录下找不到的，会去apps下搜索。</p><p>但是这时候cmd下还是会报错。</p><p>解决方案(图来源于我的<code>DjangoGetStarted</code>教程):</p><p><img src="http://myphoto.mtianyan.cn/blog/180107/IhD2bJDI6K.png?imageslim" alt="mark"></p><p>同理,插入第0是希望它先搜索我们app下东西：</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/biF9eAhLHi.png?imageslim" alt="mark"></p><h4 id="成功性验证"><a href="#成功性验证" class="headerlink" title="成功性验证"></a>成功性验证</h4><p><img src="http://myphoto.mtianyan.cn/blog/180109/hJc05K1b28.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180109/BH84IH9beb.png?imageslim" alt="mark"></p><blockquote><p>可以看到Django已经可以正常run成功了。</p></blockquote><h3 id="第四章总结"><a href="#第四章总结" class="headerlink" title="第四章总结"></a>第四章总结</h3><ul><li>我们设计了app</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/bbbKglA0LI.png?imageslim" alt="mark"></p><ul><li>设计了user models.py</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/5ehi0hDB3C.png?imageslim" alt="mark"></p><ul><li>循环引用</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/8f32C0imcE.png?imageslim" alt="mark"></p><blockquote><p>得出我们需要创建一个更高层次的app。分层设计，operation在更高层。</p></blockquote><ul><li>Courses models.py</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/e60fJjHeEa.png?imageslim" alt="mark"></p><ul><li>organization models.py</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/jg51D6Baj7.png?imageslim" alt="mark"></p><ul><li>operation models.py</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180109/3CLeJ5LCeD.png?imageslim" alt="mark"></p><p>通过makemigrations 生成表的变动 &amp; migrate<br>每个app下的migration目录的用途，和数据库中django_migration<br>将所有app放到同一个目录之下。</p><p>本章结束对应commit:</p><blockquote><p>数据表全部生成，migration目录&amp;表django_migration。将app放到apps目录。对应4-9.<br>第四章结束！撒花。</p></blockquote><blockquote class="blockquote-center"><p>总之，我们要拿来。我们要或使用，或存放，或毁灭。 - 鲁迅</p></blockquote><div class="note"><p> 既然有django提供的强大admin,我们便要拿来用喽。</p><ul><li>使用xadmin，通过adminx,将已有model注册进后台。快速搭建可用的后台系统。</li></ul></div><h1 id="xadmin快速搭建可用的后台系统"><a href="#xadmin快速搭建可用的后台系统" class="headerlink" title="xadmin快速搭建可用的后台系统"></a>xadmin快速搭建可用的后台系统</h1><h2 id="django-admin介绍"><a href="#django-admin介绍" class="headerlink" title="django admin介绍"></a>django admin介绍</h2><p>上一章我们进行了需求分析和数据库设计。本章我们来快速搭建一个可用的后台管理系统。</p><p>后台管理系统特点：</p><ul><li>权限管理</li><li>少前端样式。(样式一般不是很看重)，</li><li>快速开发</li></ul><p>django的后台管理系统是一套智能的管理系统。<br>django的杀手锏之一就是admin管理系统。</p><p>admin在项目新建时就已经为我们生成好了。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/97kgi66hBJ.png?imageslim" alt="mark"></p><p>Django的admin也是一个app，在我们新建项目时就创建好了。<br>而且会自动在url中配置好了链接。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/BdL32DBc99.png?imageslim" alt="mark"></p><p>访问:<a href="http://127.0.0.1:8000/admin/" target="_blank" rel="noopener">http://127.0.0.1:8000/admin/</a></p><p>可以看到admin的登录窗口。</p><p>Django是不会自动生成admin的用户的，需要我们自己去命令生成。</p><h3 id="createsuperuser"><a href="#createsuperuser" class="headerlink" title="createsuperuser"></a>createsuperuser</h3><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createsuperuser</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/ggemFK9lAJ.png?imageslim" alt="mark"></p><p>输入自己的用户名密码。</p><p>报错:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django.db.utils.DataError: (1406, &quot;Data too long for column &apos;gender&apos; at row 1&quot;)</span><br></pre></td></tr></table></figure><blockquote><p>gender中female是6位。而我们最大长度只有5.</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/ie29f0bI0a.png?imageslim" alt="mark"></p><p>修改后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations users</span><br><span class="line">migrate users</span><br></pre></td></tr></table></figure><p>然后重新<code>createsuperuser</code></p><p>使用自己定义的用户名密码可以登进系统。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/C0h63A68F5.png?imageslim" alt="mark"></p><blockquote><p>默认是用户名 + 密码。后面会讲到如何实现用户名 或 邮箱和密码登录。</p></blockquote><h3 id="修改setting中对应语言，时区，以及数据库写入时间。"><a href="#修改setting中对应语言，时区，以及数据库写入时间。" class="headerlink" title="修改setting中对应语言，时区，以及数据库写入时间。"></a>修改setting中对应语言，时区，以及数据库写入时间。</h3><p>修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 语言改为中文</span><br><span class="line">LANGUAGE_CODE = &apos;zh-hans&apos;</span><br><span class="line"></span><br><span class="line"># 时区改为上海</span><br><span class="line">TIME_ZONE = &apos;Asia/Shanghai&apos;</span><br><span class="line"># 数据库存储使用时间，True时间会被存为UTC的时间</span><br><span class="line">USE_TZ = False</span><br></pre></td></tr></table></figure><p>点击运行可以看到如下图被换成汉语的效果:</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/L3fGhdb7C6.png?imageslim" alt="mark"></p><p>注意: django 2.0.1 并不会看到汉化后的默认页面。只有admin被汉化了。</p><p>组对应数据表: auth_group</p><p>在Django的admin中可以把上章的表都注册进来。对于表进行任意的增删改查。</p><p>默认其实会把user也注册进来的，但是因为我们通过userProfile覆盖了user。所以没有显示。</p><h3 id="注册UserProfile进来"><a href="#注册UserProfile进来" class="headerlink" title="注册UserProfile进来"></a>注册UserProfile进来</h3><p>users/admin.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为同一个目录，所以可以直接.models</span></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserProfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写一个管理器:命名, model+Admin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfileAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将UserProfile注册进我们的admin中, 并为它选择管理器</span></span><br><span class="line">admin.site.register(UserProfile,UserProfileAdmin)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/c58F6dg549.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们的用户信息就注册进来了。</p></blockquote><p><code>USERS</code> 是用户所在表名称。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/Fk7G3EkDC4.png?imageslim" alt="mark"></p><p>进入页面可以看到Django为我们把每个不同类型的字段生成了不同的前端样式。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/761bBAhbJl.png?imageslim" alt="mark"></p><blockquote><p>Django会自动帮我们把密码加密，而且不能反解。单向性。</p></blockquote><p>如果出现错误, 可能是<code>initial</code>文件在我们拖入apps时路径被改变。之后我们添加了环境变量, 前面再加上apps就会报错。</p><p>这时把<code>initial.py</code> 中路径进行修改。</p><p>错误2：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">新增用户信息提示：</span><br><span class="line">Cannot add or update a child row: a foreign key constraint fails</span><br><span class="line">(1452, &apos;Cannot add or update a child row: a foreign key constraint fails </span><br><span class="line">`mxonline`.`django_admin_log`, CONSTRAINT `django_admin_log_user_id_c564eba6_fk_auth_user_id` </span><br><span class="line">FOREIGN KEY (`user_id`) REFERENCES `auth_user` (`id`))&apos;)</span><br></pre></td></tr></table></figure><blockquote><p>解决方案1: 不用解决，之后换Xadmin就好了。</p></blockquote><p>解决方案2: 在setting的databases中添加以下代码取消外键检查</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &apos;default&apos;: &#123;</span><br><span class="line">        &apos;ENGINE&apos;: &apos;django.db.backends.mysql&apos;,</span><br><span class="line">        &apos;NAME&apos;: &apos;mxonline2&apos;,</span><br><span class="line">        &apos;USER&apos;: &apos;root&apos;,</span><br><span class="line">        &apos;PASSWORD&apos;: &apos;你的密码&apos;,</span><br><span class="line">        &apos;HOST&apos;:&apos;127.0.0.1&apos;,</span><br><span class="line">        &apos;OPTIONS&apos;: &#123;</span><br><span class="line">          &quot;init_command&quot;: &quot;SET foreign_key_checks=0;&quot;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/l4mGKFaGm4.png?imageslim" alt="mark"></p><p>实验成功为了不影响后面，把options删除</p><p>本小节结束对应commit:</p><blockquote><p>admin中添加管理器&amp;注册。时区,语言,utc(False).数据库中选项参数。female的长度修改, createsuperuser.对应5-1</p></blockquote><h2 id="xadmin的安装"><a href="#xadmin的安装" class="headerlink" title="xadmin的安装"></a>xadmin的安装</h2><p>一套基于admin, 比admin更强大的系统。</p><ol><li>通过pip安装</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install xadmin</span><br></pre></td></tr></table></figure><h3 id="Python3-amp-Django2-0-1安装官方适配Django2-0的包"><a href="#Python3-amp-Django2-0-1安装官方适配Django2-0的包" class="headerlink" title="Python3 &amp; Django2.0.1安装官方适配Django2.0的包"></a>Python3 &amp; Django2.0.1安装官方适配Django2.0的包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install git+git://github.com/sshwsfc/xadmin.git@django2</span><br></pre></td></tr></table></figure><p>xadmin可以把我们的后台做的很强大，可扩展。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/2c3el2afjg.png?imageslim" alt="mark"></p><p>可以看到它同时下载了很多其他依赖包。</p><h3 id="注册Xadmin-与-crispy-forms"><a href="#注册Xadmin-与-crispy-forms" class="headerlink" title="注册Xadmin 与 crispy-forms"></a>注册Xadmin 与 crispy-forms</h3><p>Mxonline2/settings.py的INSTALLED_APPS中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&apos;xadmin&apos;,</span><br><span class="line">&apos;crispy_forms&apos;</span><br></pre></td></tr></table></figure><p>然后把urls中默认admin指向Xadmin</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入x admin，替换admin</span></span><br><span class="line"><span class="keyword">import</span> xadmin</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^xadmin/'</span>, xadmin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>Python3 Django2.0.1 的url的配置中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(&apos;xadmin/&apos;, xadmin.site.urls),</span><br></pre></td></tr></table></figure><p><strong>注意：Django 2.0.1中不需要加<code>r</code>也不需要加<code>^</code></strong></p><p>将我们原来写的user/admin.py中代码注释掉。</p><p>此时直接运行项目会报错，因为我们Xadmin的默认数据表并没有migarte</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ProgrammingError: (1146, &quot;Table &apos;mxonline2.xadmin_usersettings&apos; doesn&apos;t exist&quot;)</span><br><span class="line">[09/Jan/2018 06:40:27] &quot;GET /xadmin/ HTTP/1.1&quot; 500 150414</span><br></pre></td></tr></table></figure><p>点击<code>Tools 菜单下 Run manage.py Task</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/bgleKlg6kJ.png?imageslim" alt="mark"></p><blockquote><p>可以看到已经被应用成功。</p></blockquote><p>前往Navicat进行验证。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/Al734ikfA4.png?imageslim" alt="mark"></p><blockquote><p>可以看到新增的表。</p></blockquote><p>Xadmin的后台采用的是bootstrap。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/7ccm6L5BG7.png?imageslim" alt="mark"></p><blockquote><p>后面我们会介绍如何制作插件</p></blockquote><h3 id="源码安装："><a href="#源码安装：" class="headerlink" title="源码安装："></a>源码安装：</h3><p>github: <a href="https://github.com/sshwsfc/xadmin" target="_blank" rel="noopener">https://github.com/sshwsfc/xadmin</a></p><p>下载或<code>git clone</code>将源码下载到本地。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/KFaKi4gC3C.png?imageslim" alt="mark"></p><blockquote><p>解压后将Xadmin文件夹复制到我们的项目中。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/FbJeCbijh4.png?imageslim" alt="mark"></p><h4 id="Python3版本源码安装-与url配置不同"><a href="#Python3版本源码安装-与url配置不同" class="headerlink" title="Python3版本源码安装:与url配置不同"></a>Python3版本源码安装:与url配置不同</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -b django2 https://github.com/sshwsfc/xadmin.git</span><br></pre></td></tr></table></figure><p>其余操作一样。</p><h3 id="新建extra-apps，并在setting中注册地址"><a href="#新建extra-apps，并在setting中注册地址" class="headerlink" title="新建extra_apps，并在setting中注册地址"></a>新建extra_apps，并在setting中注册地址</h3><p>新建new package: extra_apps</p><blockquote><p>使用该目录存放我们的第三方插件，将Xadmin移入。<br>右键mark为SourceRoot, 但是这时候cmd下回报错。</p></blockquote><p>所以在setting.py中加入。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.path.insert(<span class="number">0</span>,os.path.join(BASE_DIR, <span class="string">'extra_apps'</span>))</span><br></pre></td></tr></table></figure><blockquote><p>因为我们的source目录已经有Xadmin了，就不会再去系统环境中找了。这时候卸载我们的Xadmin。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline2</span><br><span class="line">pip uninstall xadmin</span><br></pre></td></tr></table></figure><p>但是他的依赖包我们还需要，所以只需要卸载Xadmin。此时我们运行会报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    from future.utils import iteritems</span><br><span class="line">ImportError: No module named future.utils</span><br></pre></td></tr></table></figure><p>安装必要的包:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install future</span><br><span class="line">pip install six</span><br><span class="line">pip install httplib2</span><br><span class="line">pip install django-import-export</span><br></pre></td></tr></table></figure><p>此时又可以成功运行了</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/kmCI61m81H.png?imageslim" alt="mark"></p><p>日志记录：后台管理人员做的操作都会生成一条记录。</p><p>源码安装优点:</p><ul><li>xadmin新特性</li><li>对于源码进行自己的修改。</li></ul><p>本小节结束对应commit:</p><blockquote><p>Xadmin的安装与源码安装，配置setting中extra_apps. 对应5-2</p></blockquote><h2 id="users-app-的model注册"><a href="#users-app-的model注册" class="headerlink" title="users app 的model注册"></a>users app 的model注册</h2><h3 id="遗留问题-django2-0-1使用xadmin时。如验证码等带dateTimefield区域出错。"><a href="#遗留问题-django2-0-1使用xadmin时。如验证码等带dateTimefield区域出错。" class="headerlink" title="遗留问题: django2.0.1使用xadmin时。如验证码等带dateTimefield区域出错。"></a>遗留问题: django2.0.1使用xadmin时。如验证码等带dateTimefield区域出错。</h3><p>xadmin/widgets.py</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/I3F7K6KhLf.png?imageslim" alt="mark"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input_html = [ht <span class="keyword">for</span> ht <span class="keyword">in</span> super(AdminSplitDateTime, self).render(</span><br><span class="line">    name, value, attrs).split(<span class="string">'/&gt;&lt;'</span>) <span class="keyword">if</span> ht != <span class="string">''</span>]</span><br><span class="line">        <span class="keyword">if</span> (len(input_html) &gt; <span class="number">1</span>):</span><br><span class="line">            input_html[<span class="number">0</span>] = input_html[<span class="number">0</span>] + <span class="string">"/&gt;"</span></span><br><span class="line">            input_html[<span class="number">1</span>] = <span class="string">"&lt;"</span> + input_html[<span class="number">1</span>]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/KiBgGKCgLI.png?imageslim" alt="mark"></p><blockquote><p>此时可以看到已经运行正常</p></blockquote><h3 id="真正开始"><a href="#真正开始" class="headerlink" title="真正开始"></a>真正开始</h3><p>Xadmin是基于Django的admin来开发的，所以Xadmin也继承了许多admin的用法。</p><ul><li>比如: models的注册。</li></ul><p>UserProfile已经被自动注册进去了，我们从验证码开始注册。</p><p>我们需要新建一个<code>adminx.py</code>文件，Xadmin会自动搜寻这种命名的文件。</p><h3 id="新建py文件的初始化模板"><a href="#新建py文件的初始化模板" class="headerlink" title="新建py文件的初始化模板"></a>新建py文件的初始化模板</h3><p><img src="http://myphoto.mtianyan.cn/blog/180109/22J8la5G8c.png?imageslim" alt="mark"></p><p>新建users/adminx.py：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/9 0009 08:02&apos;</span><br><span class="line"></span><br><span class="line">import xadmin</span><br><span class="line"></span><br><span class="line">from .models import EmailVerifyRecord</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建admin的管理类,这里不再是继承admin，而是继承object</span><br><span class="line">class EmailVerifyRecordAdmin(object):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xadmin.site.register(EmailVerifyRecord, EmailVerifyRecordAdmin)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/3LEG0j7e2h.png?imageslim" alt="mark"></p><blockquote><p>可以看到这时候访问已经有邮箱验证码了。</p></blockquote><p>邮箱验证码这几个字就是我们代码中Meta中verbose_name定义的:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    verbose_name = <span class="string">"邮箱验证码"</span></span><br><span class="line">    verbose_name_plural = verbose_name</span><br></pre></td></tr></table></figure><p><code>verbose_name_plural</code>是<code>verbose_name</code>的复数形式。</p><p>字段的verbose_name会直接显示在后台。<code>sendtype</code>和<code>sendtime</code>没有设置所以直接显示了英文。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/BL45eAhd66.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们添加验证码成功。注意:上节版本中我们进行了: makemigaration &amp; migrate。<br>但是它是pip安装的Xadmin的数据表生成。我们卸载之后，源码安装需要重新运行进行数据迁移。(django需要通过app文件夹下的init文件来记录表的更改记录，pip的都卸了，所以就没法找到了)</p></blockquote><p>会报错:</p><blockquote><p>Xadmin_log不存在错误。只需要运行这两条命令即可。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/8A5cED00eC.png?imageslim" alt="mark"></p><h4 id="解决后台部分英文显示"><a href="#解决后台部分英文显示" class="headerlink" title="解决后台部分英文显示"></a>解决后台部分英文显示</h4><blockquote><p>全部models中字段自行添加verbose_name</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/GG009ClkEE.png?imageslim" alt="mark"></p><p>这里就不贴出来了，自行检查都加上(没写出的请自行修改全部加上verbose_name)。</p><h4 id="解决EmailVerifyRecord-object显示"><a href="#解决EmailVerifyRecord-object显示" class="headerlink" title="解决EmailVerifyRecord object显示"></a>解决EmailVerifyRecord object显示</h4><blockquote><p><strong>全部</strong>(没写出的请自行修改)model，py2:重载<code>__unicode</code> py3:重载<code>__str__</code></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重载Unicode方法使后台不再直接显示object</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&#123;0&#125;(&#123;1&#125;)'</span>.format(self.code,self.email)</span><br></pre></td></tr></table></figure><blockquote><p>上面代码是python的自身基础语法。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/F45LiKCF16.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180109/gb0kBFIJKH.png?imageslim" alt="mark"></p><h4 id="配置显示列"><a href="#配置显示列" class="headerlink" title="配置显示列"></a>配置显示列</h4><p><img src="http://myphoto.mtianyan.cn/blog/180109/0mbjJe5ImK.png?imageslim" alt="mark"></p><p>users/adminx.py的管理器中设置list_display:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建admin的管理类,这里不再是继承admin，而是继承object</span><br><span class="line">class EmailVerifyRecordAdmin(object):</span><br><span class="line">    # 配置后台我们需要显示的列</span><br><span class="line">    list_display = [&apos;code&apos;, &apos;email&apos;,&apos;send_type&apos;, &apos;send_time&apos;]</span><br></pre></td></tr></table></figure><blockquote><p>list_display可以使用列表或元祖，建议使用列表。否则元组只有一个元素，忘记加逗号就会报错。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/aj9gJbeJJJ.png?imageslim" alt="mark"></p><p>选择框的生成是因为我们加上了<code>choices</code></p><h4 id="配置搜索searchfield"><a href="#配置搜索searchfield" class="headerlink" title="配置搜索searchfield"></a>配置搜索searchfield</h4><p>users/adminx.py的管理器中EmailVerifyRecordAdmin添加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置搜索字段,不做时间搜索</span></span><br><span class="line">search_fields =  [<span class="string">'code'</span>, <span class="string">'email'</span>,<span class="string">'send_type'</span>]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/fDclFJl6el.png?imageslim" alt="mark"></p><p>再添加一条数据验证搜索功能</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/8lLa4IIadB.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180109/FcAJjJcAAm.png?imageslim" alt="mark"></p><h4 id="xadmin导出csv中文乱码解决"><a href="#xadmin导出csv中文乱码解决" class="headerlink" title="xadmin导出csv中文乱码解决"></a>xadmin导出csv中文乱码解决</h4><p><img src="http://myphoto.mtianyan.cn/blog/180109/am4cLCB69D.png?imageslim" alt="mark"></p><blockquote><p>将<code>charset=utf-8</code> 改为<code>charset=gbk</code></p></blockquote><h4 id="xadmin导出xml报错"><a href="#xadmin导出xml报错" class="headerlink" title="xadmin导出xml报错"></a>xadmin导出xml报错</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TypeError at /xadmin/users/emailverifyrecord/</span><br><span class="line">unicode argument expected, got &apos;str&apos;</span><br></pre></td></tr></table></figure><blockquote><p>io.StringIO这个库新版本的python3直接往这个库中加入了一些新的内容，使得该库在Python2.7中较为混乱。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180109/HcG0a8g2Ef.png?imageslim" alt="mark"></p><blockquote><p>将StringIo变为BytesIO</p></blockquote><h4 id="通过时间筛选字段。"><a href="#通过时间筛选字段。" class="headerlink" title="通过时间筛选字段。"></a>通过时间筛选字段。</h4><p>users/adminx.py的管理器中EmailVerifyRecordAdmin添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配置筛选字段</span><br><span class="line">list_filter =  [&apos;code&apos;, &apos;email&apos;,&apos;send_type&apos;, &apos;send_time&apos;]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/FhLLheAi2f.png?imageslim" alt="mark"></p><h3 id="Django的admin-Xadmin和其他系统区别"><a href="#Django的admin-Xadmin和其他系统区别" class="headerlink" title="Django的admin, Xadmin和其他系统区别"></a>Django的admin, Xadmin和其他系统区别</h3><blockquote><p>不像php等其他语言是一个功能模块一个功能设计的。<br>Django是对于每张表增删改查的管理器，我们可以在增删改成的基础上加上我们自己的后台逻辑。<br>因此某种程度可以说他是不依赖于具体业务的。不管啥系统后台都是由表组成。</p></blockquote><p>不依赖于后台逻辑，又可以加上逻辑。</p><h3 id="user-models的注册"><a href="#user-models的注册" class="headerlink" title="user/models的注册"></a>user/models的注册</h3><p>users/adminx.py中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建banner的管理类</span><br><span class="line">class BannerAdmin(object):</span><br><span class="line">    list_display = [&apos;title&apos;, &apos;image&apos;, &apos;url&apos;,&apos;index&apos;, &apos;add_time&apos;]</span><br><span class="line">    search_fields = [&apos;title&apos;, &apos;image&apos;, &apos;url&apos;,&apos;index&apos;]</span><br><span class="line">    list_filter = [&apos;title&apos;, &apos;image&apos;, &apos;url&apos;,&apos;index&apos;, &apos;add_time&apos;]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 将model与admin管理器进行关联注册</span><br><span class="line">xadmin.site.register(Banner, BannerAdmin)</span><br></pre></td></tr></table></figure><p>此时后台页面。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/0L58d277Ba.png?imageslim" alt="mark"></p><blockquote><p>可以自行测试轮播图是否可以新建成功。</p></blockquote><p>本小节结束对应commit:</p><blockquote><p>usersmodels三张表注册进xadmin, 配置搜索过滤展示字段，修复xadmin导出xml错误,导出csv乱码，Unicode重载。对应5-3</p></blockquote><p>py3(django2.0.1):</p><blockquote><p>usersmodels三张表注册进xadmin, 配置搜索过滤展示字段，修复xadmin导出csv乱码，修复django2.0.1的indexError, str重载。对应5-3</p></blockquote><h2 id="剩余app-model注册"><a href="#剩余app-model注册" class="headerlink" title="剩余app model注册"></a>剩余app model注册</h2><h3 id="courses注册"><a href="#courses注册" class="headerlink" title="courses注册"></a>courses注册</h3><p>新建courses/adminx.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/9 0009 20:10'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Course, Lesson, Video, CourseResource</span><br><span class="line"><span class="keyword">import</span> xadmin</span><br><span class="line"></span><br><span class="line"><span class="comment"># Course的admin管理器</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [</span><br><span class="line">        <span class="string">'name'</span>,</span><br><span class="line">        <span class="string">'desc'</span>,</span><br><span class="line">        <span class="string">'detail'</span>,</span><br><span class="line">        <span class="string">'degree'</span>,</span><br><span class="line">        <span class="string">'learn_times'</span>,</span><br><span class="line">        <span class="string">'students'</span>]</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'detail'</span>, <span class="string">'degree'</span>, <span class="string">'students'</span>]</span><br><span class="line">    list_filter = [</span><br><span class="line">        <span class="string">'name'</span>,</span><br><span class="line">        <span class="string">'desc'</span>,</span><br><span class="line">        <span class="string">'detail'</span>,</span><br><span class="line">        <span class="string">'degree'</span>,</span><br><span class="line">        <span class="string">'learn_times'</span>,</span><br><span class="line">        <span class="string">'students'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LessonAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'course'</span>, <span class="string">'name'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'course'</span>, <span class="string">'name'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># __name代表使用外键中name字段</span></span><br><span class="line">    list_filter = [<span class="string">'course__name'</span>, <span class="string">'name'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'lesson'</span>, <span class="string">'name'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'lesson'</span>, <span class="string">'name'</span>]</span><br><span class="line">    list_filter = [<span class="string">'lesson'</span>, <span class="string">'name'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseResourceAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'course'</span>, <span class="string">'name'</span>, <span class="string">'download'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'course'</span>, <span class="string">'name'</span>, <span class="string">'download'</span>]</span><br><span class="line">    <span class="comment"># __name代表使用外键中name字段</span></span><br><span class="line">    list_filter = [<span class="string">'course__name'</span>, <span class="string">'name'</span>, <span class="string">'download'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将管理器与model进行注册关联</span></span><br><span class="line">xadmin.site.register(Course, CourseAdmin)</span><br><span class="line">xadmin.site.register(Lesson, LessonAdmin)</span><br><span class="line">xadmin.site.register(Video, VideoAdmin)</span><br><span class="line">xadmin.site.register(CourseResource, CourseResourceAdmin)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/H8eLIc73d9.png?imageslim" alt="mark"></p><blockquote><p>注意：对应后台显示英文的字段自行检查<code>verbosename</code>，自行加上。<br>注意: py2下重载<code>__unicode__</code>方法，py3下重载<code>__str__</code>方法</p></blockquote><p>如(注意缩进):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'《&#123;0&#125;》课程的章节 &gt;&gt; &#123;1&#125;'</span>.format(self.course,self.name)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/ICGm5c3acB.png?imageslim" alt="mark"></p><p><code>int</code>类型后台会生成如下图区间取值:</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/9mcfFD7kml.png?imageslim" alt="mark"></p><p>可以看到有外键关系的会有一个小符号。</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/dH8Kblkmaj.png?imageslim" alt="mark"></p><h3 id="注册机构app的adminx"><a href="#注册机构app的adminx" class="headerlink" title="注册机构app的adminx"></a>注册机构app的adminx</h3><p>新建<code>organization/adminx.py</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/9 0009 21:01'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xadmin</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> CityDict, CourseOrg, Teacher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 机构所属城市名后台管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CityDictAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'desc'</span>]</span><br><span class="line">    list_filter = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 机构课程信息管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseOrgAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>,<span class="string">'add_time'</span> ]</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>]</span><br><span class="line">    list_filter = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>,<span class="string">'city__name'</span>,<span class="string">'address'</span>,<span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeacherAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [ <span class="string">'name'</span>,<span class="string">'org'</span>, <span class="string">'work_years'</span>, <span class="string">'work_company'</span>,<span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'org'</span>, <span class="string">'name'</span>, <span class="string">'work_years'</span>, <span class="string">'work_company'</span>]</span><br><span class="line">    list_filter = [<span class="string">'org__name'</span>, <span class="string">'name'</span>, <span class="string">'work_years'</span>, <span class="string">'work_company'</span>,<span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xadmin.site.register(CityDict, CityDictAdmin)</span><br><span class="line">xadmin.site.register(CourseOrg, CourseOrgAdmin)</span><br><span class="line">xadmin.site.register(Teacher, TeacherAdmin)</span><br></pre></td></tr></table></figure><blockquote><p>注意：对应后台显示英文的字段自行检查verbosename，自行加上。<br>注意: py2下重载<code>__unicode__</code>方法，py3下重载<code>__str__</code>方法</p></blockquote><p>如(注意缩进):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"[&#123;0&#125;]的教师: &#123;1&#125;"</span>.format(self.org, self.name)</span><br></pre></td></tr></table></figure><p>如果注册后没有显示： 重新登录，或重启项目</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/cIe1LjK7gC.png?imageslim" alt="mark"></p><h3 id="operation-app注册xadmin"><a href="#operation-app注册xadmin" class="headerlink" title="operation app注册xadmin"></a>operation app注册xadmin</h3><p>新建<code>operation/adminx.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/9 0009 22:12'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xadmin</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserAsk, UserCourse, UserMessage, CourseComments, UserFavorite</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户表单我要学习后台管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAskAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'name'</span>, <span class="string">'mobile'</span>, <span class="string">'course_name'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'mobile'</span>, <span class="string">'course_name'</span>]</span><br><span class="line">    list_filter = [<span class="string">'name'</span>, <span class="string">'mobile'</span>, <span class="string">'course_name'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户课程学习后台管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserCourseAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'user'</span>, <span class="string">'course'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'user'</span>, <span class="string">'course'</span>]</span><br><span class="line">    list_filter = [<span class="string">'user'</span>, <span class="string">'course'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户消息后台管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserMessageAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'user'</span>, <span class="string">'message'</span>, <span class="string">'has_read'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'user'</span>, <span class="string">'message'</span>, <span class="string">'has_read'</span>]</span><br><span class="line">    list_filter = [<span class="string">'user'</span>, <span class="string">'message'</span>, <span class="string">'has_read'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户评论后台管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseCommentsAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'user'</span>, <span class="string">'course'</span>, <span class="string">'comments'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'user'</span>, <span class="string">'course'</span>, <span class="string">'comments'</span>]</span><br><span class="line">    list_filter = [<span class="string">'user'</span>, <span class="string">'course'</span>, <span class="string">'comments'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户收藏后台管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserFavoriteAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'user'</span>, <span class="string">'fav_id'</span>, <span class="string">'fav_type'</span>, <span class="string">'add_time'</span>]</span><br><span class="line">    search_fields = [<span class="string">'user'</span>, <span class="string">'fav_id'</span>, <span class="string">'fav_type'</span>]</span><br><span class="line">    list_filter = [<span class="string">'user'</span>, <span class="string">'fav_id'</span>, <span class="string">'fav_type'</span>, <span class="string">'add_time'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将后台管理器与models进行关联注册。</span></span><br><span class="line">xadmin.site.register(UserAsk, UserAskAdmin)</span><br><span class="line">xadmin.site.register(UserCourse, UserCourseAdmin)</span><br><span class="line">xadmin.site.register(UserMessage, UserMessageAdmin)</span><br><span class="line">xadmin.site.register(CourseComments, CourseCommentsAdmin)</span><br><span class="line">xadmin.site.register(UserFavorite, UserFavoriteAdmin)</span><br></pre></td></tr></table></figure><blockquote><p>注意：对应后台显示英文的字段自行检查<code>verbosename</code>，自行加上。<br>注意: py2下重载<code>__unicode__</code>方法，py3下重载<code>__str__</code>方法</p></blockquote><p>如(注意缩进):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"[&#123;0&#125;]的教师: &#123;1&#125;"</span>.format(self.org, self.name)</span><br></pre></td></tr></table></figure><p>成功性验证:</p><p><img src="http://myphoto.mtianyan.cn/blog/180109/E6il5E9j86.png?imageslim" alt="mark"></p><p>本小节结束对于commit:</p><blockquote><p>5:4 注册完成operation,机构，课程app。注意:自行重载str/unicode。补全verbosename。</p></blockquote><h2 id="xadmin全局配置"><a href="#xadmin全局配置" class="headerlink" title="xadmin全局配置"></a>xadmin全局配置</h2><p>将全局配置修改:</p><ul><li>如左上角：django Xadmin。下面的我的公司</li><li>主题修改，app名称汉化，菜单收叠。</li></ul><h3 id="使用Xadmin的主题功能。"><a href="#使用Xadmin的主题功能。" class="headerlink" title="使用Xadmin的主题功能。"></a>使用Xadmin的主题功能。</h3><p>把全站的配置放在users\adminx.py中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xadmin <span class="keyword">import</span> views</span><br><span class="line"><span class="comment"># 创建X admin的全局管理器并与view绑定。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSetting</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># 开启主题功能</span></span><br><span class="line">    enable_themes = <span class="keyword">True</span></span><br><span class="line">    use_bootswatch = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将全局配置管理与view绑定注册</span></span><br><span class="line">xadmin.site.register(views.BaseAdminView, BaseSetting)</span><br></pre></td></tr></table></figure><h3 id="解决django1-9-python2-下Xadmin主题不生效问题。"><a href="#解决django1-9-python2-下Xadmin主题不生效问题。" class="headerlink" title="解决django1.9(python2)下Xadmin主题不生效问题。"></a>解决django1.9(python2)下Xadmin主题不生效问题。</h3><p><a href="https://my.oschina.net/u/2396236/blog/1083251" target="_blank" rel="noopener">https://my.oschina.net/u/2396236/blog/1083251</a></p><ul><li>安装requests</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install requests</span><br></pre></td></tr></table></figure><ul><li>/xadmin/plugins/themes.py 引入requests</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br></pre></td></tr></table></figure><ul><li>修改block_top_navmenu方法：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">def block_top_navmenu(self, context, nodes):</span><br><span class="line"></span><br><span class="line">       themes = [</span><br><span class="line">           &#123;&apos;name&apos;: _(u&quot;Default&quot;), &apos;description&apos;: _(u&quot;Default bootstrap theme&quot;), &apos;css&apos;: self.default_theme&#125;,</span><br><span class="line">           &#123;&apos;name&apos;: _(u&quot;Bootstrap2&quot;), &apos;description&apos;: _(u&quot;Bootstrap 2.x theme&quot;), &apos;css&apos;: self.bootstrap2_theme&#125;,</span><br><span class="line">           ]</span><br><span class="line">       select_css = context.get(&apos;site_theme&apos;, self.default_theme)</span><br><span class="line"></span><br><span class="line">       if self.user_themes:</span><br><span class="line">           themes.extend(self.user_themes)</span><br><span class="line"></span><br><span class="line">       if self.use_bootswatch:</span><br><span class="line">           ex_themes = cache.get(THEME_CACHE_KEY)</span><br><span class="line">           if ex_themes:</span><br><span class="line">               themes.extend(json.loads(ex_themes))</span><br><span class="line">           else:</span><br><span class="line">               ex_themes = []</span><br><span class="line">               try:</span><br><span class="line">                   flag = False#假如为True使用原来的代码，假如为Flase，使用requests库来访问</span><br><span class="line">                   if flag:</span><br><span class="line">                       h = httplib2.Http()</span><br><span class="line">                       resp, content = h.request(&quot;http://bootswatch.com/api/3.json&quot;, &apos;GET&apos;, &apos;&apos;,</span><br><span class="line">                           headers=&#123;&quot;Accept&quot;: &quot;application/json&quot;, &quot;User-Agent&quot;: self.request.META[&apos;HTTP_USER_AGENT&apos;]&#125;)</span><br><span class="line">                       if six.PY3:</span><br><span class="line">                           content = content.decode()</span><br><span class="line">                       watch_themes = json.loads(content)[&apos;themes&apos;]</span><br><span class="line">                   else:</span><br><span class="line">                       content = requests.get(&quot;https://bootswatch.com/api/3.json&quot;)</span><br><span class="line">                       if six.PY3:</span><br><span class="line">                           content = content.text.decode()</span><br><span class="line">                       watch_themes = json.loads(content.text)[&apos;themes&apos;]</span><br><span class="line"></span><br><span class="line">                   ex_themes.extend([</span><br><span class="line">                       &#123;&apos;name&apos;: t[&apos;name&apos;], &apos;description&apos;: t[&apos;description&apos;],</span><br><span class="line">                           &apos;css&apos;: t[&apos;cssMin&apos;], &apos;thumbnail&apos;: t[&apos;thumbnail&apos;]&#125;</span><br><span class="line">                       for t in watch_themes])</span><br><span class="line">               except Exception as e:</span><br><span class="line">                   print(e)</span><br><span class="line"></span><br><span class="line">               cache.set(THEME_CACHE_KEY, json.dumps(ex_themes), 24 * 3600)</span><br><span class="line">               themes.extend(ex_themes)</span><br><span class="line"></span><br><span class="line">       nodes.append(loader.render_to_string(&apos;xadmin/blocks/comm.top.theme.html&apos;, &#123;&apos;themes&apos;: themes, &apos;select_css&apos;: select_css&#125;))</span><br></pre></td></tr></table></figure><h3 id="修改django-admin-和下面的我的公司收起菜单"><a href="#修改django-admin-和下面的我的公司收起菜单" class="headerlink" title="修改django admin 和下面的我的公司收起菜单"></a>修改django admin 和下面的我的公司收起菜单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># x admin 全局配置参数信息设置</span><br><span class="line">class GlobalSettings(object):</span><br><span class="line">    site_title = &quot;天涯明月笙: 慕课后台管理站&quot;</span><br><span class="line">    site_footer = &quot;mtianyan&apos;s mooc&quot;</span><br><span class="line">    # 收起菜单</span><br><span class="line">    menu_style = &quot;accordion&quot;</span><br><span class="line"># 将头部与脚部信息进行注册:</span><br><span class="line">xadmin.site.register(views.CommAdminView, GlobalSettings)</span><br></pre></td></tr></table></figure><h3 id="apps-py配置app的显示名称"><a href="#apps-py配置app的显示名称" class="headerlink" title="apps.py配置app的显示名称"></a>apps.py配置app的显示名称</h3><p>每个app下执行同样操作:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoursesConfig</span><span class="params">(AppConfig)</span>:</span></span><br><span class="line">    name = <span class="string">'courses'</span></span><br><span class="line">    verbose_name = <span class="string">u"课程"</span></span><br></pre></td></tr></table></figure><p><strong>注意自行找猫画虎为每个app添加中文名</strong></p><blockquote><p>新建app时并没有引用apps的配置</p></blockquote><p>在app下的init.py中添加:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default_app_config = <span class="string">"operation.apps.OperationConfig"</span></span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180109/14kIeC7dbA.png?imageslim" alt="mark"></p><p>注意对应关系。</p><p><strong>注意为每个都添加对应的default_app_config</strong></p><p>最终大功告成：</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/KGcFbA85d9.png?imageslim" alt="mark"></p><h3 id="自定义导航菜单顺序"><a href="#自定义导航菜单顺序" class="headerlink" title="自定义导航菜单顺序"></a>自定义导航菜单顺序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class GlobalSetting(object):</span><br><span class="line">     def get_site_menu(self):</span><br><span class="line">        return (</span><br><span class="line">            &#123;&apos;title&apos;: &apos;课程管理&apos;, &apos;menus&apos;: (</span><br><span class="line">                &#123;&apos;title&apos;: &apos;课程信息&apos;, &apos;url&apos;: self.get_model_url(Course, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;章节信息&apos;, &apos;url&apos;: self.get_model_url(Lesson, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;视频信息&apos;, &apos;url&apos;: self.get_model_url(Video, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;课程资源&apos;, &apos;url&apos;: self.get_model_url(CourseResource, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;课程评论&apos;, &apos;url&apos;: self.get_model_url(CourseComments, &apos;changelist&apos;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line">            &#123;&apos;title&apos;: &apos;机构管理&apos;, &apos;menus&apos;: (</span><br><span class="line">                &#123;&apos;title&apos;: &apos;所在城市&apos;, &apos;url&apos;: self.get_model_url(CityDict, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;机构讲师&apos;, &apos;url&apos;: self.get_model_url(Teacher, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;机构信息&apos;, &apos;url&apos;: self.get_model_url(CourseOrg, &apos;changelist&apos;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line">            &#123;&apos;title&apos;: &apos;用户管理&apos;, &apos;menus&apos;: (</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户信息&apos;, &apos;url&apos;: self.get_model_url(UserProfile, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户验证&apos;, &apos;url&apos;: self.get_model_url(EmailVerifyRecord, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户课程&apos;, &apos;url&apos;: self.get_model_url(UserCourse, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户收藏&apos;, &apos;url&apos;: self.get_model_url(UserFavorite, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户消息&apos;, &apos;url&apos;: self.get_model_url(UserMessage, &apos;changelist&apos;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#123;&apos;title&apos;: &apos;系统管理&apos;, &apos;menus&apos;: (</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户咨询&apos;, &apos;url&apos;: self.get_model_url(UserAsk, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;首页轮播&apos;, &apos;url&apos;: self.get_model_url(Banner, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户分组&apos;, &apos;url&apos;: self.get_model_url(Group, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;用户权限&apos;, &apos;url&apos;: self.get_model_url(Permission, &apos;changelist&apos;)&#125;,</span><br><span class="line">                &#123;&apos;title&apos;: &apos;日志记录&apos;, &apos;url&apos;: self.get_model_url(Log, &apos;changelist&apos;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line"></span><br><span class="line">xadmin.site.register(views.CommAdminView, GlobalSetting)</span><br></pre></td></tr></table></figure><p>最终成型菜单:</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/314L2DdfGB.png?imageslim" alt="mark"></p><h3 id="日志记录的使用"><a href="#日志记录的使用" class="headerlink" title="日志记录的使用"></a>日志记录的使用</h3><blockquote><p>日志记录会记录下我们进行过什么操作。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180110/34EdEDHgac.png?imageslim" alt="mark"></p><p>通过点击动作，进入当时修改的某条信息</p><p>第五章完结对应commit:</p><blockquote><p>5-5 (第五章完结),配置了页头页脚信息，修改了菜单的顺序，配置apps中文名，修复Python2下，xadmin主题不生效问题。 完结撒花。</p></blockquote><blockquote class="blockquote-center"><p>矛盾的普遍性是指矛盾存在于一切事物的发展过程之中，矛盾存在于一切事物发展过程的始终。</p></blockquote><div class="note"><p> 我想只要是个系统，就少不了登录注册。这是我们需要首先处理的主要矛盾。</p><ul><li>完成登录 注册 找回密码 激活 验证码集成</li></ul></div><h1 id="完成登录-注册-找回密码-激活-验证码集成"><a href="#完成登录-注册-找回密码-激活-验证码集成" class="headerlink" title="完成登录 注册 找回密码 激活 验证码集成"></a>完成登录 注册 找回密码 激活 验证码集成</h1><h2 id="6-1-首页和登录页面的配置"><a href="#6-1-首页和登录页面的配置" class="headerlink" title="6-1 首页和登录页面的配置"></a>6-1 首页和登录页面的配置</h2><p>用户访问我们的根目录，我们需要把html文件返回给用户。因此我们第一步把html文件放入template目录。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/fBkbi7968D.png?imageslim" alt="mark"></p><p>在html中找到首页的html。拷贝到我们的template目录</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/1EJD2hFc7E.png?imageslim" alt="mark"></p><h3 id="新建static目录-1"><a href="#新建static目录-1" class="headerlink" title="新建static目录"></a>新建static目录</h3><blockquote><p>用来存放css, js等静态文件</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180110/ECL5dmKFkc.png?imageslim" alt="mark"></p><h4 id="配置处理静态文件的url。"><a href="#配置处理静态文件的url。" class="headerlink" title="配置处理静态文件的url。"></a>配置处理静态文件的url。</h4><p>Django2.0.1版本下:</p><p>Mxonline3/urls.py：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.views.generic import TemplateView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(&apos;xadmin/&apos;, xadmin.site.urls),</span><br><span class="line">    # TemplateView.as_view会将template转换为view</span><br><span class="line">    path(&apos;&apos;, TemplateView.as_view(template_name= &quot;index.html&quot;), name=  &quot;index&quot;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>Django1.9.8版本下:</p><p>Mxonline2/urls.py：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.views.generic import TemplateView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(r&apos;^xadmin/&apos;, xadmin.site.urls),</span><br><span class="line">    url(&apos;^$&apos;, TemplateView.as_view(template_name=&quot;index.html&quot;), name=&quot;index&quot;)</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>此时运行访问就可以访问到我们的index页面，不过会没有样式。</p><h3 id="设置static文件"><a href="#设置static文件" class="headerlink" title="设置static文件"></a>设置static文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 说明静态文件放在哪个目录</span></span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line"></span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">"static"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="修改index页面中前端样式的引用地址"><a href="#修改index页面中前端样式的引用地址" class="headerlink" title="修改index页面中前端样式的引用地址"></a>修改index页面中前端样式的引用地址</h3><p><img src="http://myphoto.mtianyan.cn/blog/180110/LflfkaA3Kj.png?imageslim" alt="mark"></p><p>使用ctrl+f查找出所有<code>../</code>,全部替换为<code>/static/</code></p><p>然后点击运行，刷新页面可以看到我们的页面已经显示正常了。</p><h3 id="拷贝登录页面到template"><a href="#拷贝登录页面到template" class="headerlink" title="拷贝登录页面到template"></a>拷贝登录页面到template</h3><p><img src="http://myphoto.mtianyan.cn/blog/180110/cJ8c3l41H4.png?imageslim" alt="mark"></p><p>使用ctrl+f查找出所有<code>../</code>,全部替换为<code>/static/</code></p><blockquote><p>将css，js，图片全部替换完。</p></blockquote><h4 id="url配置跳转登录页面"><a href="#url配置跳转登录页面" class="headerlink" title="url配置跳转登录页面"></a>url配置跳转登录页面</h4><p>Mxonline2/urls.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录页面跳转url</span></span><br><span class="line">url(<span class="string">'^login/$'</span>, TemplateView.as_view(template_name=<span class="string">"login.html"</span>), name=<span class="string">"login"</span>)</span><br></pre></td></tr></table></figure><p>Mxonline3/urls.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TemplateView.as_view会将template转换为view</span></span><br><span class="line">path(<span class="string">''</span>, TemplateView.as_view(template_name= <span class="string">"index.html"</span>), name=  <span class="string">"index"</span>),</span><br><span class="line">path(<span class="string">'login/'</span>, TemplateView.as_view(template_name= <span class="string">"login.html"</span>), name=  <span class="string">"login"</span>)</span><br></pre></td></tr></table></figure><p>在index页面，ctrl+f找到登录。将a标签中地址替换为login的url。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/CBIAK2cjH0.png?imageslim" alt="mark"></p><p>取消注释后，将login.html改为<code>/login/</code></p><p><img src="http://myphoto.mtianyan.cn/blog/180110/ejcbBB0diJ.png?imageslim" alt="mark"></p><p>点击左侧减号收起。然后使用<code>&lt;!--</code>与<code>--&gt;</code>将个人中心暂时注释。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/889BdI0a2g.png?imageslim" alt="mark"></p><p>可以看到登录注册，点击登录。</p><blockquote><p>根路径下的所有url都不需要斜杠</p><p>此时我们的首页已经可以成功显示，通过首页点击登录也可以成功跳转登录页面</p></blockquote><p>本小节完成对应commit:</p><blockquote><p>6-1: 完成首页与登录页面配置，设置了STATICFILES_DIRS。注意：dirs是一个元组，不要少逗号。删除了前面上传头像等直接传到根目录的目录。</p></blockquote><h2 id="6-2-用户登录-1"><a href="#6-2-用户登录-1" class="headerlink" title="6-2 用户登录-1"></a>6-2 用户登录-1</h2><blockquote><p>配置url之前我们要书写好对应处理的view</p></blockquote><p>Django的view实际就是一个函数，接收request请求对象，处理后返回response对象。</p><p>users/views.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="comment"># 当我们配置url被这个view处理时，自动传入request对象.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 前端向后端发送的请求方式: get 或post</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录提交表单为post</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># 获取登录页面为get</span></span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">        <span class="comment"># render就是渲染html返回用户</span></span><br><span class="line">        <span class="comment"># render三变量: request 模板名称 一个字典写明传给前端的值</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure><p>django1.9.8/urls.py<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> user_login</span><br><span class="line">    <span class="comment"># 登录页面跳转url login不要直接调用。而只是指向这个函数对象。</span></span><br><span class="line">    url(<span class="string">'^login/$'</span>,login, name=<span class="string">"login"</span>)</span><br></pre></td></tr></table></figure><p></p><p>django2.0.1/urls.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> login</span><br><span class="line">    path(<span class="string">'login/'</span>, login, name=<span class="string">"login"</span>)</span><br></pre></td></tr></table></figure><p>在两行返回语句的位置打上断点:</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/lm6DF2CE02.png?imageslim" alt="mark"></p><p>点击debug，进入首页后点击登录。可以看到</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/5LiGiKh2ID.png?imageslim" alt="mark"></p><p>说明确实是通过get请求请求页面的。</p><p>通过值浏览器窗口可以看到这是一个<code>&lt;WSGIRequest: GET &#39;/login/&#39;&gt;</code>对象</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/I2C4i7FFj4.png?imageslim" alt="mark"></p><p><code>path:</code>是指向的地址。</p><p><code>f8</code>继续运行。跳转到登录页面。</p><h2 id="6-3-用户登录2"><a href="#6-3-用户登录2" class="headerlink" title="6-3 用户登录2"></a>6-3 用户登录2</h2><h3 id="html-form基础知识"><a href="#html-form基础知识" class="headerlink" title="html form基础知识"></a>html form基础知识</h3><p>templates/login.html:</p><blockquote><p>可以看到form表单中有input。点击提交会把值提交到后台。我们需要修改action让它指向我们的后台相应地址。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180110/IkkaFHhGAl.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180110/ddDBg58ek1.png?imageslim" alt="mark"></p><blockquote><p>input中的name值会被传递到后台。回组成键值对形式。</p></blockquote><p>submit类型的input</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/KAFII10hf9.png?imageslim" alt="mark"></p><p>只保留post这里的断点。输入用户名密码。查看debug情况</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/mEjmk6c1j9.png?imageslim" alt="mark"></p><p><code>403禁止访问</code>错误: html页面内必须加上<code>crsf token</code> 才能传值到后台。</p><blockquote><p>我会随机的给前端发一串符号，你必须把这串符号带回来，我才允许你post。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180110/CgEm92B9Ig.png?imageslim" alt="mark"></p><p>from表单之前写上<code>crsf token</code></p><p>此时我们查看前端页面：</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/4aBegCbaAk.png?imageslim" alt="mark"></p><p>可以看到html中登录下面有一个隐藏着的值：crsf token, 不会显示。</p><p>此时点击登录跳转到pass位置。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/cc82F1f1kE.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180110/F7JgIA41me.png?imageslim" alt="mark"></p><p>可以看到request中的POST中是一个queryset的对象。我们可以把它当成一个字典来用。<br>来取到前端的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">    <span class="comment"># 取不到时为空，username，password为前端页面name值</span></span><br><span class="line">    user_name = request.POST.get(<span class="string">"username"</span>, <span class="string">""</span>)</span><br><span class="line">    pass_word = request.POST.get(<span class="string">"password"</span>, <span class="string">""</span>)</span><br></pre></td></tr></table></figure><p>取到用户名和密码我们就要开始进行验证登录。使用Django自带的<code>auth</code>方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate, login</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录提交表单为post</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        <span class="comment"># 取不到时为空，username，password为前端页面name值</span></span><br><span class="line">        user_name = request.POST.get(<span class="string">"username"</span>, <span class="string">""</span>)</span><br><span class="line">        pass_word = request.POST.get(<span class="string">"password"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 成功返回user对象,失败返回null</span></span><br><span class="line">        user = authenticate(username= user_name, password= pass_word)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果不是null说明验证成功</span></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="comment"># login_in 两参数：request, user</span></span><br><span class="line">            <span class="comment"># 实际是对request写了一部分东西进去，然后在render的时候：</span></span><br><span class="line">            <span class="comment"># request是要render回去的。这些信息也就随着返回浏览器。完成登录</span></span><br><span class="line">            login(request, user)</span><br><span class="line">            <span class="comment"># 跳转到首页 user request会被带回到首页</span></span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"index.html"</span>)</span><br><span class="line">        <span class="comment"># 没有成功说明里面的值是None，并再次跳转回主页面</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure><blockquote><p>authenticate调用只需要传入用户名和密码。成功会返回user对象，失败返回null</p></blockquote><p>html中通过</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/Gcia8G8fgG.png?imageslim" alt="mark"></p><blockquote><p>设置成如果登录显示个人中心那段，未登录显示登录注册</p></blockquote><p>打上断点</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/AeBb1BJE9m.png?imageslim" alt="mark"></p><p>点击debug后可以看到</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/J4caJi44DG.png?imageslim" alt="mark"></p><blockquote><p>我们成功的取到了值。</p></blockquote><p>Django默认我们使用用户名和密码来登录</p><p>成功的登录user值如下</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/741Ia99FLf.png?imageslim" alt="mark"></p><p>但是继续执行报错:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login() takes exactly 1 argument (2 given)</span><br></pre></td></tr></table></figure><p>这时因为我们处理登录的自定义函数也叫login。就直接调用了自身，而不是调用Django提供的login。<strong>所以我们一定不要把自定义view函数命名与Django提供的冲突</strong></p><blockquote><p>解决方案：将我们的login改为<code>def user_login(request):</code></p></blockquote><p>并且前往urls.py中将login也一并改了</p><p>此时运行可以看到我们的个人中心已经出来了。</p><h3 id="改造为使用邮箱用户名均可。Setting中重载变量"><a href="#改造为使用邮箱用户名均可。Setting中重载变量" class="headerlink" title="改造为使用邮箱用户名均可。Setting中重载变量"></a>改造为使用邮箱用户名均可。Setting中重载变量</h3><blockquote><p>自定义authenticate方法</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> UserProfile</span><br><span class="line"><span class="comment"># 并集运算</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实现用户名邮箱均可登录</span></span><br><span class="line"><span class="comment"># 继承ModelBackend类，因为它有方法authenticate，可点进源码查看</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomBackend</span><span class="params">(ModelBackend)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, username=None, password=None, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 不希望用户存在两个，get只能有一个。两个是get失败的一种原因 Q为使用并集查询</span></span><br><span class="line"></span><br><span class="line">            user = UserProfile.objects.get(Q(username=username)|Q(email=username))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># django的后台中密码加密：所以不能password==password</span></span><br><span class="line">            <span class="comment"># UserProfile继承的AbstractUser中有def check_password(self, raw_password):</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure><p>Mxonline2/settings.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置邮箱和用户名均可登录</span></span><br><span class="line">AUTHENTICATION_BACKENDS = (</span><br><span class="line">    <span class="string">'users.views.CustomBackend'</span>,</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180110/g1Hb79JKGK.png?imageslim" alt="mark"></p><blockquote><p>使用xadmin的退出，注销当前用户的退出。</p></blockquote><p>此时我们可以通过邮箱和用户名都可以完成登录。</p><h3 id="用户提示：return页面时提供它的错误信息"><a href="#用户提示：return页面时提供它的错误信息" class="headerlink" title="用户提示：return页面时提供它的错误信息"></a>用户提示：return页面时提供它的错误信息</h3><p><img src="http://myphoto.mtianyan.cn/blog/180110/l55JiK9Cmh.png?imageslim" alt="mark"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;<span class="string">"msg"</span>:<span class="string">"用户名或密码错误! "</span>&#125;)</span><br></pre></td></tr></table></figure><p>Html中如何取到这个值;</p><p>login html中这段是用来做错误提示的。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/3i7BF5edj8.png?imageslim" alt="mark"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;error btns login-form-tips&quot; id=&quot;jsLoginTips&quot;&gt;&#123;&#123; msg &#125;&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>验证：</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/7I9gdJ5DLj.png?imageslim" alt="mark"></p><p>本小节结束对应commit:</p><blockquote><p>6-2&amp;3 完成了用户登录，登录验证自定义：邮箱用户名均可。错误信息返回前端。设置登录显示个人中心判断，注意不要把自定义方法写成login。</p></blockquote><h2 id="6-4-用form实现登录-1"><a href="#6-4-用form实现登录-1" class="headerlink" title="6-4 用form实现登录-1"></a>6-4 用form实现登录-1</h2><p>上面我们的用户登录的方法是基于函数来做的。本节我们做一个基于类方法的版本。<br>要求对类的继承有了解。</p><p>基础教程中基本上都是基于函数来做的，其实更推荐基于类来做。基于类可以带来不少好处</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于类实现需要继承的view</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic.base <span class="keyword">import</span> View</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="comment"># 直接调用get方法免去判断</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># render就是渲染html返回用户</span></span><br><span class="line">        <span class="comment"># render三变量: request 模板名称 一个字典写明传给前端的值</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 取不到时为空，username，password为前端页面name值</span></span><br><span class="line">        user_name = request.POST.get(<span class="string">"username"</span>, <span class="string">""</span>)</span><br><span class="line">        pass_word = request.POST.get(<span class="string">"password"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 成功返回user对象,失败返回null</span></span><br><span class="line">        user = authenticate(username=user_name, password=pass_word)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果不是null说明验证成功</span></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="comment"># login_in 两参数：request, user</span></span><br><span class="line">            <span class="comment"># 实际是对request写了一部分东西进去，然后在render的时候：</span></span><br><span class="line">            <span class="comment"># request是要render回去的。这些信息也就随着返回浏览器。完成登录</span></span><br><span class="line">            login(request, user)</span><br><span class="line">            <span class="comment"># 跳转到首页 user request会被带回到首页</span></span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"index.html"</span>)</span><br><span class="line">        <span class="comment"># 没有成功说明里面的值是None，并再次跳转回主页面</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;<span class="string">"msg"</span>: <span class="string">"用户名或密码错误! "</span>&#125;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180110/9mKFBk0Fc8.png?imageslim" alt="mark"></p><blockquote><p>继承的view中的方法。</p></blockquote><p>django1.9.8 urls中的配置:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 换用类实现</span></span><br><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> LoginView</span><br><span class="line">    <span class="comment"># 基于类方法实现登录,这里是调用它的方法</span></span><br><span class="line">    url(<span class="string">'^login/$'</span>, LoginView.as_view(), name=<span class="string">"login"</span>)</span><br></pre></td></tr></table></figure><p>Django2.0.1 urls配置:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于类方法实现登录,这里是调用它的方法</span></span><br><span class="line">path(<span class="string">'login/'</span>, LoginView.as_view(), name=<span class="string">"login"</span>)</span><br></pre></td></tr></table></figure><h2 id="6-5-form字段验证"><a href="#6-5-form字段验证" class="headerlink" title="6-5 form字段验证"></a>6-5 form字段验证</h2><p>验证最大长度，是否为空等一系列。</p><p>users下新建forms文件。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/10 0010 04:44'</span></span><br><span class="line"><span class="comment"># 引入Django表单</span></span><br><span class="line"><span class="keyword">from</span>  django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录表单验证</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    <span class="comment"># 用户名密码不能为空</span></span><br><span class="line">    username = forms.CharField(required=<span class="keyword">True</span>)</span><br><span class="line">    password = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>定义好forms之后我们来使用它做验证。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 类实例化需要一个字典参数dict:request.POST就是一个QueryDict所以直接传入</span></span><br><span class="line">        <span class="comment"># POST中的usernamepassword，会对应到form中</span></span><br><span class="line">        login_form = LoginForm(request.POST)</span><br><span class="line">		<span class="comment">#is_valid判断我们字段是否有错执行我们原有逻辑，验证失败跳回login页面</span></span><br><span class="line">        <span class="keyword">if</span> login_form.is_valid():</span><br><span class="line">            <span class="comment"># 取不到时为空，username，password为前端页面name值</span></span><br><span class="line">            user_name = request.POST.get(<span class="string">"username"</span>, <span class="string">""</span>)</span><br><span class="line">            pass_word = request.POST.get(<span class="string">"password"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 成功返回user对象,失败返回null</span></span><br><span class="line">            user = authenticate(username=user_name, password=pass_word)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果不是null说明验证成功</span></span><br><span class="line">            <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                <span class="comment"># login_in 两参数：request, user</span></span><br><span class="line">                <span class="comment"># 实际是对request写了一部分东西进去，然后在render的时候：</span></span><br><span class="line">                <span class="comment"># request是要render回去的。这些信息也就随着返回浏览器。完成登录</span></span><br><span class="line">                login(request, user)</span><br><span class="line">                <span class="comment"># 跳转到首页 user request会被带回到首页</span></span><br><span class="line">                <span class="keyword">return</span> render(request, <span class="string">"index.html"</span>)</span><br><span class="line">        <span class="comment"># 验证不成功跳回登录页面</span></span><br><span class="line">        <span class="comment"># 没有成功说明里面的值是None，并再次跳转回主页面</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;<span class="string">"msg"</span>: <span class="string">"用户名或密码错误! "</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="完善错误提示"><a href="#完善错误提示" class="headerlink" title="完善错误提示"></a>完善错误提示</h3><p>比如：既然表单都验证失败了，就不用显示密码出错了</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/Ca0lhc68He.png?imageslim" alt="mark"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 仅当用户真的密码出错时</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>,&#123;<span class="string">"msg"</span>:<span class="string">"用户名或密码错误!"</span>&#125;)</span><br><span class="line">        <span class="comment"># 验证不成功跳回登录页面</span></span><br><span class="line">        <span class="comment"># 没有成功说明里面的值是None，并再次跳转回主页面</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(</span><br><span class="line">                request, <span class="string">"login.html"</span>, &#123;</span><br><span class="line">                    <span class="string">"login_form"</span>: login_form &#125;)</span><br></pre></td></tr></table></figure><p>forms中的名称username和password必须和html中的一致。毕竟他是使用的request.POST<br>而request是从前面传过来的。</p><p>实例化<code>LoginView</code>时已经对于我们的字段进行了验证。</p><p>打上断点:</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/aelBLBFBG3.png?imageslim" alt="mark"></p><p><code>debug</code>后<code>f6</code>运行到</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/F86386mI15.png?imageslim" alt="mark"></p><p>此时可以看到<code>errors(ErrorDict)</code>中的错误</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/EefmGb08e9.png?imageslim" alt="mark"></p><p>将form传回前端:</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/CKdB5L49dc.png?imageslim" alt="mark"></p><p>前端中取值：</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/C6AajKcm51.png?imageslim" alt="mark"></p><p>给这个class加上errorput会显示红色外框。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/G89gGl2G75.png?imageslim" alt="mark"></p><blockquote><p>注意:写在class里面</p></blockquote><h3 id="将forms错误信息显示出来"><a href="#将forms错误信息显示出来" class="headerlink" title="将forms错误信息显示出来"></a>将forms错误信息显示出来</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class="error btns login-form-tips" id="jsLoginTips"&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> key, error <span class="keyword">in</span> login_form.errors.items %&#125;</span><br><span class="line">&#123;&#123; error &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;&#123; msg &#125;&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180110/a3CjlEhC9B.png?imageslim" alt="mark"></p><ul><li>写了一个类继承Django的view，然后写了get post方法(get/post的if是Django替我们完成的)</li><li>在url中调用Loginview的as_view方法需要加上括号，进行调用。</li><li>Django的form进行表单验证并把error值传到前台。</li><li>is_valid方法，验证表单</li></ul><p>本小节完毕对应commit:</p><blockquote><p>6-4 &amp; 5 登录换用类继承view实现,使用Django form进行表单验证并把错误信息提示到前台。</p></blockquote><h2 id="6-6-session和cookie自动登录机制"><a href="#6-6-session和cookie自动登录机制" class="headerlink" title="6-6 session和cookie自动登录机制"></a>6-6 session和cookie自动登录机制</h2><blockquote><p>我们本节来讲session和cookie</p></blockquote><p>User1如何实现登录的。</p><h3 id="cookie的存储"><a href="#cookie的存储" class="headerlink" title="cookie的存储"></a>cookie的存储</h3><p>cookie是浏览器支持的一种本地存储方式。以dict，键值对方式存储。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;sessionkey&quot;: &quot;123&quot;&#125;</span><br></pre></td></tr></table></figure><p>浏览器会自动对于它进行解析。</p><h3 id="http请求是一种无状态的请求"><a href="#http请求是一种无状态的请求" class="headerlink" title="http请求是一种无状态的请求"></a>http请求是一种无状态的请求</h3><p>用户向服务器发起的两次请求之间是没有状态的。也就是服务器并不知道这是同一个用户发的。</p><p>做到记住用户:</p><blockquote><p>浏览器a在向服务器发起请求，服务器会自动给浏览器a回复一个id，浏览器a把id放到cookie当中，在下一次请求时带上这个cookie里的id值向浏览器请求，服务器就知道你是哪个浏览器发过来的了。</p></blockquote><h3 id="有状态请求-cookie"><a href="#有状态请求-cookie" class="headerlink" title="有状态请求(cookie)"></a>有状态请求(cookie)</h3><p><img src="http://myphoto.mtianyan.cn/blog/180110/4F22diHeF6.png?imageslim" alt="mark"></p><p>服务器<code>a</code>发回来的<code>id</code>会放到服务器<code>a</code>的域之下。<strong>不能跨域访问cookie。</strong></p><p>使用浏览器随便打开一个网页，然后<code>f12</code>打开。</p><p>比如我使用的<code>Chrome</code>浏览器</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/Bb6elgf96A.png?imageslim" alt="mark"></p><p>会找到存储在浏览器本地的cookie值</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/b3CH160G9h.png?imageslim" alt="mark"></p><p>点击<code>clear all</code>清空所有的<code>cookie</code> <code>f5</code>刷新页面，会发现又把这些cookie值进来。</p><p>如果将用户名和密码直接保存在cookie，可以实现<strong>最垃圾最简略版本的</strong>自动登录。</p><h3 id="解决cookie放在本地不安全的问题-session"><a href="#解决cookie放在本地不安全的问题-session" class="headerlink" title="解决cookie放在本地不安全的问题(session)"></a>解决cookie放在本地不安全的问题(session)</h3><blockquote><p>用户在第一次请求后，浏览器回复的id既可以是用户的user id。<br>也可以一段任意的字符串，我们把它叫做session id</p></blockquote><p>根据用户名和密码，服务器会采用自己的规则生成<code>session id</code>。这个<code>session id</code>保存在本地cookie。浏览器请求服务器会携带。</p><ul><li>输入用户名 &amp; 密码</li><li>调用 login(), 后端程序会根据用户名密码生成session id。保存在数据库中。</li><li>用户登录之后，需要通过这个<code>session id</code>取出这些基本信息。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180110/F6d3AkdJB0.png?imageslim" alt="mark"></p><p>Django的默认表中的<code>session</code>表就记录了用户登录时，后端我们Django为用户生成的<code>sessionid</code>。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/9L54Emf6md.png?imageslim" alt="mark"></p><p>可以看到<code>session key value</code> 和过期时间。</p><p>我们可以清空这张表的数据。运行项目进行登录。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/kLdLLALGB1.png?imageslim" alt="mark"></p><blockquote><p>可以看到我们刚刚生成的session id。</p></blockquote><p>此时通过<code>f12</code>查看浏览器在本地存储的<code>session id</code>。可以看到如下图和我们数据库中的一致。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/2Hee7I5fIl.png?imageslim" alt="mark"></p><blockquote><p><strong>session_key 发到浏览器叫做session id</strong></p></blockquote><p>通过session id 用户访问任何一个页面都会携带，服务器就会认识。</p><p>Setting.py中，</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/Gi40A0FFhB.png?imageslim" alt="mark"></p><p>这个app会拦截我们每次的request请求，在<code>request</code>中找到session id，然后去数据表中进行查询。<br>然后通过<code>session key</code> 去找到<code>session data</code>。此时直接为我们取出了user。</p><p>在服务器返回浏览器的<code>response</code>中也会直接加上<code>session id</code></p><blockquote><p>cookie是浏览器本地存储机制，存在域名之下，存储不安全。<br>服务器在返回id时通过规则生成一串字符，并设置了过期时间。存储在服务器端(数据库)</p></blockquote><p>文章: <a href="http://projectsedu.com/2016/10/17/django%E4%BB%8E%E8%AF%B7%E6%B1%82%E5%88%B0%E8%BF%94%E5%9B%9E%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88/" target="_blank" rel="noopener">http://projectsedu.com/2016/10/17/django%E4%BB%8E%E8%AF%B7%E6%B1%82%E5%88%B0%E8%BF%94%E5%9B%9E%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88/</a></p><h2 id="6-7-用户注册"><a href="#6-7-用户注册" class="headerlink" title="6-7 用户注册"></a>6-7 用户注册</h2><h3 id="拷贝注册页面进入template目录"><a href="#拷贝注册页面进入template目录" class="headerlink" title="拷贝注册页面进入template目录"></a>拷贝注册页面进入template目录</h3><h3 id="书写我们对应要处理的view-RegisterView"><a href="#书写我们对应要处理的view-RegisterView" class="headerlink" title="书写我们对应要处理的view(RegisterView)"></a>书写我们对应要处理的view(RegisterView)</h3><p>users/views.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册功能的view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="comment"># get方法直接返回页面</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"register.html"</span>, &#123;&#125;)</span><br></pre></td></tr></table></figure><h3 id="配置对应的url"><a href="#配置对应的url" class="headerlink" title="配置对应的url"></a>配置对应的url</h3><p>Django1.9.8 url配置如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> RegisterView</span><br><span class="line">    <span class="comment"># 注册url</span></span><br><span class="line">    url(<span class="string">"^register/"</span>, RegisterView.as_view(), name=<span class="string">"register"</span>),</span><br></pre></td></tr></table></figure><p>Django2.0.1 url配置如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> users.views <span class="keyword">import</span> RegisterView</span><br><span class="line">    <span class="comment"># 注册url</span></span><br><span class="line">    path(<span class="string">"register/"</span>, RegisterView.as_view(), name = <span class="string">"register"</span> )</span><br></pre></td></tr></table></figure><h3 id="修改index页面中注册url"><a href="#修改index页面中注册url" class="headerlink" title="修改index页面中注册url"></a>修改index页面中注册url</h3><p><img src="http://myphoto.mtianyan.cn/blog/180110/BJl97lJ8bd.png?imageslim" alt="mark"></p><p>此时访问首页发现可以成功跳转到注册页面</p><h3 id="修改静态文件中static目录引用"><a href="#修改静态文件中static目录引用" class="headerlink" title="修改静态文件中static目录引用"></a>修改静态文件中static目录引用</h3><h4 id="关键步骤load-staticfile"><a href="#关键步骤load-staticfile" class="headerlink" title="关键步骤load staticfile"></a>关键步骤load staticfile</h4><p><img src="http://myphoto.mtianyan.cn/blog/180110/Hm54EJ7IH9.png?imageslim" alt="mark"></p><h4 id="然后修改路径为一个相对于static的相对路径"><a href="#然后修改路径为一个相对于static的相对路径" class="headerlink" title="然后修改路径为一个相对于static的相对路径"></a>然后修改路径为一个相对于static的相对路径</h4><p><img src="http://myphoto.mtianyan.cn/blog/180110/ackf2LaLJ8.png?imageslim" alt="mark"></p><blockquote><p>他会自动根据setting中配置，为我们加上前缀</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180110/3FDhdl2aiH.png?imageslim" alt="mark"></p><blockquote><p>如果我们把目录在setting中改到mystatic。url中会自动添加指定的前缀</p></blockquote><p>可以看到可以访问成功。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/0KkhH7b8Bm.png?imageslim" alt="mark"></p><h4 id="将目前的三个html中的静态文件全部修改目录"><a href="#将目前的三个html中的静态文件全部修改目录" class="headerlink" title="将目前的三个html中的静态文件全部修改目录"></a>将目前的三个html中的静态文件全部修改目录</h4><blockquote><p>枯燥但是要有耐心。</p></blockquote><p>这时候访问三个页面，查看样式是否完好。</p><h3 id="验证码库实现验证码"><a href="#验证码库实现验证码" class="headerlink" title="验证码库实现验证码"></a>验证码库实现验证码</h3><p><a href="https://github.com/mbi/django-simple-captcha" target="_blank" rel="noopener">https://github.com/mbi/django-simple-captcha</a></p><h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline3</span><br><span class="line">pip install  django-simple-captcha</span><br><span class="line">workon mxonline2</span><br><span class="line">pip install  django-simple-captcha==0.4.6</span><br></pre></td></tr></table></figure><ul><li><p>Add <code>captcha</code> to the <code>INSTALLED_APPS</code> in your <code>settings.py</code></p></li><li><p>Add an entry to your <code>urls.py</code>:</p></li></ul><p>django1.9.8如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line">urlpatterns += [</span><br><span class="line">    url(<span class="string">r'^captcha/'</span>, include(<span class="string">'captcha.urls'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>django2.0.1如下；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 验证码url</span><br><span class="line">path(&quot;captcha/&quot;, include(&apos;captcha.urls&apos;))</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180110/0Igb4IgB0F.png?imageslim" alt="mark"></p><p>进入数据库查看生成的表</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/JiI713cAdd.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180111/ac8KFHkCBc.png?imageslim" alt="mark"></p><h3 id="将验证码展示到页面"><a href="#将验证码展示到页面" class="headerlink" title="将验证码展示到页面"></a>将验证码展示到页面</h3><p>users/forms.py:</p><h4 id="定义我们的register-form"><a href="#定义我们的register-form" class="headerlink" title="定义我们的register form:"></a>定义我们的register form:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 引入验证码field</span></span><br><span class="line"><span class="keyword">from</span> captcha.fields <span class="keyword">import</span> CaptchaField</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证码form &amp; 注册表单form</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    <span class="comment"># 此处email与前端name需保持一致。</span></span><br><span class="line">    email = forms.EmailField(required=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 密码不能小于5位</span></span><br><span class="line">    password = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># 应用验证码</span></span><br><span class="line">    captcha = CaptchaField()</span><br></pre></td></tr></table></figure><p>users/views.py</p><h4 id="在我们的registerform中实例化并传送到前端"><a href="#在我们的registerform中实例化并传送到前端" class="headerlink" title="在我们的registerform中实例化并传送到前端:"></a>在我们的registerform中实例化并传送到前端:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># form表单验证 &amp; 验证码</span><br><span class="line">from .forms import LoginForm, RegisterForm</span><br><span class="line"></span><br><span class="line"># 注册功能的view</span><br><span class="line">class RegisterView(View):</span><br><span class="line">    # get方法直接返回页面</span><br><span class="line">    def get(self, request):</span><br><span class="line">        # 添加验证码</span><br><span class="line">        register_form = RegisterForm()</span><br><span class="line">        return render(request, &quot;register.html&quot;, &#123;&apos;register_form&apos;:register_form&#125;)</span><br></pre></td></tr></table></figure><h4 id="前端获取验证码值"><a href="#前端获取验证码值" class="headerlink" title="前端获取验证码值"></a>前端获取验证码值</h4><p><img src="http://myphoto.mtianyan.cn/blog/180110/d55glDI9E1.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180110/DL7ejk8EcF.png?imageslim" alt="mark"></p><p>找到上图验证码部分。修改为下图</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/01gC20eabk.png?imageslim" alt="mark"></p><p>Forms中的field会生成不同的框。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/ChgL88Ed76.png?imageslim" alt="mark"></p><p>我们只有label但是前端可以查看到input框等，也就是Registerform会为我们生成输入框+验证码。</p><blockquote><p>隐藏的字符串的框会被带到后台，由Django为我们进行验证。验证该验证码是否保存过。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180110/547cdji7Gl.png?imageslim" alt="mark"></p><blockquote><p>可以看得我们数据库中将这个hashkey进行了保存。这个key与验证码内容对应。</p></blockquote><p>后台会把验证码值 和 hashkey进行联合查询。</p><h3 id="编写register-view的后台逻辑-RegisterView"><a href="#编写register-view的后台逻辑-RegisterView" class="headerlink" title="编写register view的后台逻辑(RegisterView)"></a>编写register view的后台逻辑(RegisterView)</h3><p>users/views.py的RegisterView中添加post方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def post(self, request):</span><br><span class="line">    # 实例化form</span><br><span class="line">    register_form = RegisterForm(request.POST)</span><br><span class="line">    if register_form.is_valid():</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180110/BKIjc06AF3.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180110/bA0KEd7bhc.png?imageslim" alt="mark"></p><p>修改form表单提交方式与提交到哪个url</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/ahg7KfbCAi.png?imageslim" alt="mark"></p><p>前端的form提交加上对应的crsf token</p><p>刷新验证码是前端帮我们完成的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//刷新验证码</span><br><span class="line">function refresh_captcha(event)&#123;</span><br><span class="line">    $.get(&quot;/captcha/refresh/?&quot;+Math.random(), function(result)&#123;</span><br><span class="line">        $(&apos;#&apos;+event.data.form_id+&apos; .captcha&apos;).attr(&quot;src&quot;,result.image_url);</span><br><span class="line">        $(&apos;#id_captcha_0&apos;).attr(&quot;value&quot;,result.key);</span><br><span class="line">    &#125;);</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="获取前端页面值并封装成一个user-profile对象，保存到数据库。"><a href="#获取前端页面值并封装成一个user-profile对象，保存到数据库。" class="headerlink" title="获取前端页面值并封装成一个user_profile对象，保存到数据库。"></a>获取前端页面值并封装成一个user_profile对象，保存到数据库。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.auth.hashers import make_password</span><br><span class="line"></span><br><span class="line">        if register_form.is_valid():</span><br><span class="line">            user_name = request.POST.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line">            pass_word = request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">            # 实例化一个user_profile对象，将前台值存入</span><br><span class="line">            user_profile = UserProfile()</span><br><span class="line">            user_profile.username = user_name</span><br><span class="line">            user_profile.email = user_name</span><br><span class="line"></span><br><span class="line">            # 加密password进行保存</span><br><span class="line">            user_profile.password = make_password(pass_word)</span><br><span class="line">            user_profile.save()</span><br><span class="line">            pass</span><br></pre></td></tr></table></figure><h4 id="发送邮件实现"><a href="#发送邮件实现" class="headerlink" title="发送邮件实现"></a>发送邮件实现</h4><p>setting中配置；</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发送邮件的setting设置</span></span><br><span class="line"></span><br><span class="line">EMAIL_HOST = <span class="string">"smtp.qq.com"</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">"mxonline.mtianyan.cn"</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">" "</span></span><br><span class="line">EMAIL_USE_TLS= <span class="keyword">True</span></span><br><span class="line">EMAIL_FROM = <span class="string">"mxonline.mtianyan.cn"</span></span><br></pre></td></tr></table></figure><p>新建package后新建文件。</p><p><code>apps：utils/email_send.py</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/10 0010 20:47'</span></span><br><span class="line"><span class="keyword">from</span>  users.models <span class="keyword">import</span> EmailVerifyRecord</span><br><span class="line"><span class="comment"># 导入Django自带的邮件模块</span></span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> send_mail</span><br><span class="line"><span class="comment"># 导入setting中发送邮件的配置</span></span><br><span class="line"><span class="keyword">from</span> Mxonline2.settings <span class="keyword">import</span> EMAIL_FROM</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成随机字符串</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_str</span><span class="params">(random_length=<span class="number">8</span>)</span>:</span></span><br><span class="line">    str = <span class="string">''</span></span><br><span class="line">    <span class="comment"># 生成字符串的可选字符串</span></span><br><span class="line">    chars = <span class="string">'AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz0123456789'</span></span><br><span class="line">    length = len(chars) - <span class="number">1</span></span><br><span class="line">    random = Random()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(random_length):</span><br><span class="line">        str += chars[random.randint(<span class="number">0</span>, length)]</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送注册邮件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_register_eamil</span><span class="params">(email, send_type=<span class="string">"register"</span>)</span>:</span></span><br><span class="line">    <span class="comment"># 发送之前先保存到数据库，到时候查询链接是否存在</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 实例化一个EmailVerifyRecord对象</span></span><br><span class="line">    email_record = EmailVerifyRecord()</span><br><span class="line">    <span class="comment"># 生成随机的code放入链接</span></span><br><span class="line">    code = random_str(<span class="number">16</span>)</span><br><span class="line">    email_record.code = code</span><br><span class="line">    email_record.email = email</span><br><span class="line">    email_record.send_type = send_type</span><br><span class="line"></span><br><span class="line">    email_record.save()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 定义邮件内容:</span></span><br><span class="line">    email_title = <span class="string">""</span></span><br><span class="line">    email_body = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> send_type == <span class="string">"register"</span>:</span><br><span class="line">        email_title = <span class="string">"mtianyan慕课小站 注册激活链接"</span></span><br><span class="line">        email_body = <span class="string">"请点击下面的链接激活你的账号: http://127.0.0.1:8000/active/&#123;0&#125;"</span>.format(code)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 使用Django内置函数完成邮件发送。四个参数：主题，邮件内容，从哪里发，接受者list</span></span><br><span class="line">        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])</span><br><span class="line">        <span class="comment"># 如果发送成功</span></span><br><span class="line">        <span class="keyword">if</span> send_status:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180110/8leIJ2l6LD.png?imageslim" alt="mark"></p><p>上图为qq邮箱开启smtp服务</p><p>点击生成授权码</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/6fDDI979Dk.png?imageslim" alt="mark"></p><p>def post中加上发送邮件</p><p><code>users/views.py</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 发送邮件</span><br><span class="line">from utils.email_send import send_register_eamil</span><br><span class="line">            # 发送注册激活邮件</span><br><span class="line">            send_register_eamil(user_name, &quot;register&quot;)</span><br></pre></td></tr></table></figure><p>点击注册提交，因为我们没有return。一直在转圈圈。</p><p>但是数据库中已经添加了字段。</p><p><img src="http://myphoto.mtianyan.cn/blog/180110/FL04F47985.png?imageslim" alt="mark"></p><p>可以看到我们的邮件已经被发送到邮箱中。</p><p>如果注册成功返回login页面:不成功，返回register页面并报错。</p><h4 id="完善错误提示。"><a href="#完善错误提示。" class="headerlink" title="完善错误提示。"></a>完善错误提示。</h4><blockquote><p>找猫画虎：将login中的错误提示搬运到register中来。</p></blockquote><ul><li>register_form的报错信息。</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180110/gmDlEB0L2G.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180110/e7a65cgj8D.png?imageslim" alt="mark"></p><ul><li>邮箱 &amp; 密码 form验证</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180110/ElHe2gdDAL.png?imageslim" alt="mark"></p><h4 id="完善用户值回填逻辑"><a href="#完善用户值回填逻辑" class="headerlink" title="完善用户值回填逻辑"></a>完善用户值回填逻辑</h4><p><img src="http://myphoto.mtianyan.cn/blog/180110/DGHbaLBkd3.png?imageslim" alt="mark"></p><p>如果传回的有值则，显示传回来值。</p><p>密码也做同样操作</p><h4 id="修改默认的激活状态为false"><a href="#修改默认的激活状态为false" class="headerlink" title="修改默认的激活状态为false"></a>修改默认的激活状态为false</h4><p>post方法中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 默认激活状态为false</span><br><span class="line">user_profile.is_active = False</span><br></pre></td></tr></table></figure><p>书写处理激活的view。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 激活用户的view</span><br><span class="line">class ActiveUserView(View):</span><br><span class="line">    def get(self, request, active_code):</span><br><span class="line">        # 查询邮箱验证记录是否存在</span><br><span class="line">        all_record = EmailVerifyRecord.objects.filter(code = active_code)</span><br><span class="line">        # 激活form负责给激活跳转进来的人加验证码</span><br><span class="line">        active_form = ActiveForm(request.GET)</span><br><span class="line">        # 如果不为空也就是有用户</span><br><span class="line">        if all_record:</span><br><span class="line">            for record in all_record:</span><br><span class="line">                # 获取到对应的邮箱</span><br><span class="line">                email = record.email</span><br><span class="line">                # 查找到邮箱对应的user</span><br><span class="line">                user = UserProfile.objects.get(email=email)</span><br><span class="line">                user.is_active = True</span><br><span class="line">                user.save()</span><br><span class="line">                # 激活成功跳转到登录页面</span><br><span class="line">                return render(request, &quot;login.html&quot;, )</span><br><span class="line">        # 自己瞎输的验证码</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &quot;register.html&quot;, &#123;&quot;msg&quot;: &quot;您的激活链接无效&quot;,&quot;active_form&quot;: active_form&#125;)</span><br></pre></td></tr></table></figure><p>配置用户激活的url并通过url提取到变量:</p><p>django1.9.8:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 激活用户url</span><br><span class="line">url(r&apos;^active/(?P&lt;active_code&gt;.*)/$&apos;,ActiveUserView.as_view(), name= &quot;user_active&quot;)</span><br></pre></td></tr></table></figure><p>django2.0.1：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 激活用户url</span><br><span class="line">re_path(&apos;active/(?P&lt;active_code&gt;.*)/&apos;, ActiveUserView.as_view(), name= &quot;user_active&quot;)</span><br></pre></td></tr></table></figure><p>这里通过<code>?p</code>将后面<code>.*</code>代表全部提取的正则，符合的内容传入参数active_code中<code>/$</code>代表以<code>/$</code>为结尾</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/i7DdIaB5bd.png?imageslim" alt="mark"></p><blockquote><p>其他细节根据自己需要进行优化。</p></blockquote><p>注册功能制作完毕。对应commit:</p><blockquote><p>注册功能实现完毕，流程:注册，发邮件，激活，登录。对应6-6,7,8,9,10</p></blockquote><h2 id="6-8-找回密码"><a href="#6-8-找回密码" class="headerlink" title="6-8 找回密码"></a>6-8 找回密码</h2><blockquote><p>这个6-8对应对应6-11,6-12</p></blockquote><h3 id="拷入forgetpassword页面"><a href="#拷入forgetpassword页面" class="headerlink" title="拷入forgetpassword页面"></a>拷入forgetpassword页面</h3><h3 id="书写处理忘记密码的view"><a href="#书写处理忘记密码的view" class="headerlink" title="书写处理忘记密码的view"></a>书写处理忘记密码的view</h3><p>users/views.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户忘记密码的处理view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForgetPwdView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="comment"># get方法直接返回页面</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"forgetpwd.html"</span>, &#123; &#125;)</span><br></pre></td></tr></table></figure><p>django2.0.1 urls中配置:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 忘记密码</span><br><span class="line">path(&apos;forget/&apos;, ForgetPwdView.as_view(), name= &quot;forget_pwd&quot;),</span><br></pre></td></tr></table></figure><p>Django1.9.8 urls中配置:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 忘记密码</span><br><span class="line">url(&apos;forget/$&apos;, ForgetPwdView.as_view(), name=&quot;forget_pwd&quot;),</span><br></pre></td></tr></table></figure><h4 id="login-html中忘记密码"><a href="#login-html中忘记密码" class="headerlink" title="login html中忘记密码"></a>login html中忘记密码</h4><p><img src="http://myphoto.mtianyan.cn/blog/180111/cgk66mgd35.png?imageslim" alt="mark"></p><h4 id="配置忘记密码页面中静态文件。"><a href="#配置忘记密码页面中静态文件。" class="headerlink" title="配置忘记密码页面中静态文件。"></a>配置忘记密码页面中静态文件。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load static</span><br><span class="line">修改static的目录</span><br><span class="line">修改其中的url</span><br></pre></td></tr></table></figure><h4 id="定义一个给forget的form"><a href="#定义一个给forget的form" class="headerlink" title="定义一个给forget的form"></a>定义一个给forget的form</h4><p>users/forms.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册验证码实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForgetForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    <span class="comment"># 此处email与前端name需保持一致。</span></span><br><span class="line">    email = forms.EmailField(required=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># 应用验证码 自定义错误输出key必须与异常一样</span></span><br><span class="line">    captcha = CaptchaField(error_messages=&#123;<span class="string">"invalid"</span>: <span class="string">u"验证码错误"</span>&#125;)</span><br></pre></td></tr></table></figure><h4 id="添加验证码"><a href="#添加验证码" class="headerlink" title="添加验证码"></a>添加验证码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 用户忘记密码的处理view</span><br><span class="line">class ForgetPwdView(View):</span><br><span class="line">    # get方法直接返回页面</span><br><span class="line">    def get(self, request):</span><br><span class="line">        forget_from = ForgetForm()</span><br><span class="line">        return render(request, &quot;forgetpwd.html&quot;, &#123;&quot;forget_from&quot;:forget_from &#125;)</span><br></pre></td></tr></table></figure><h4 id="html中加上验证码"><a href="#html中加上验证码" class="headerlink" title="html中加上验证码"></a>html中加上验证码</h4><p><img src="http://myphoto.mtianyan.cn/blog/180111/Cf24GA16g0.png?imageslim" alt="mark"></p><h4 id="post中逻辑"><a href="#post中逻辑" class="headerlink" title="post中逻辑"></a>post中逻辑</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># post方法实现</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    forget_form = ForgetForm(request.POST)</span><br><span class="line">    <span class="comment"># form验证合法情况下取出email</span></span><br><span class="line">    <span class="keyword">if</span> forget_form.is_valid():</span><br><span class="line">        email = request.POST.get(<span class="string">"email"</span>,<span class="string">""</span>)</span><br><span class="line">        <span class="comment"># 发送找回密码邮件</span></span><br><span class="line">        send_register_eamil(email, <span class="string">"forget"</span>)</span><br><span class="line">        <span class="comment"># 发送完毕返回登录页面并显示发送邮件成功。</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;<span class="string">"msg"</span>:<span class="string">"重置密码邮件已发送,请注意查收"</span>&#125;)</span><br><span class="line">    <span class="comment"># 如果表单验证失败也就是他验证码输错等。</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"forgetpwd.html"</span>, &#123;<span class="string">"forget_from"</span>: forget_form &#125;)</span><br></pre></td></tr></table></figure><h4 id="邮箱重置密码邮件发送"><a href="#邮箱重置密码邮件发送" class="headerlink" title="邮箱重置密码邮件发送"></a>邮箱重置密码邮件发送</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">elif send_type == &quot;forget&quot;:</span><br><span class="line">       email_title = &quot;mtianyan慕课小站 找回密码链接&quot;</span><br><span class="line">       email_body = loader.render_to_string(</span><br><span class="line">           &quot;email_forget.html&quot;,  # 需要渲染的html模板</span><br><span class="line">           &#123;</span><br><span class="line">               &quot;active_code&quot;: code  # 参数</span><br><span class="line">           &#125;</span><br><span class="line">       )</span><br><span class="line">       msg = EmailMessage(email_title, email_body, EMAIL_FROM, [email])</span><br><span class="line">       msg.content_subtype = &quot;html&quot;</span><br><span class="line">       send_status = msg.send()</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180111/4e60888a7F.png?imageslim" alt="mark"></p><h4 id="前端页面添加错误信息"><a href="#前端页面添加错误信息" class="headerlink" title="前端页面添加错误信息"></a>前端页面添加错误信息</h4><p>已经重复很多遍这个操作了。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/fl8Dhg5B2H.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180111/KEmkdk9c3b.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180111/FI5fafG9a8.png?imageslim" alt="mark"></p><blockquote><p>上述三图进行改正，不一一列举</p></blockquote><h4 id="书写重置密码view"><a href="#书写重置密码view" class="headerlink" title="书写重置密码view"></a>书写重置密码view</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重置密码的view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResetView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, active_code)</span>:</span></span><br><span class="line">        <span class="comment"># 查询邮箱验证记录是否存在</span></span><br><span class="line">        all_record = EmailVerifyRecord.objects.filter(code=active_code)</span><br><span class="line">        <span class="comment"># 如果不为空也就是有用户</span></span><br><span class="line">        active_form = ActiveForm(request.GET)</span><br><span class="line">        <span class="keyword">if</span> all_record:</span><br><span class="line">            <span class="keyword">for</span> record <span class="keyword">in</span> all_record:</span><br><span class="line">                <span class="comment"># 获取到对应的邮箱</span></span><br><span class="line">                email = record.email</span><br><span class="line">                <span class="comment"># 将email传回来</span></span><br><span class="line">                <span class="keyword">return</span> render(request, <span class="string">"password_reset.html"</span>, &#123;<span class="string">"email"</span>:email&#125;)</span><br><span class="line">        <span class="comment"># 自己瞎输的验证码</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render(</span><br><span class="line">                request, <span class="string">"forgetpwd.html"</span>, &#123;</span><br><span class="line">                    <span class="string">"msg"</span>: <span class="string">"您的重置密码链接无效,请重新请求"</span>, <span class="string">"active_form"</span>: active_form&#125;)</span><br></pre></td></tr></table></figure><h4 id="配置重置密码url"><a href="#配置重置密码url" class="headerlink" title="配置重置密码url"></a>配置重置密码url</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django1.9.8:</span></span><br><span class="line">    <span class="comment"># 重置密码urlc ：用来接收来自邮箱的重置链接</span></span><br><span class="line">    url(<span class="string">'reset/(?P&lt;active_code&gt;.*)/$'</span>, ResetView.as_view(), name=<span class="string">"reset_pwd"</span>),</span><br><span class="line"><span class="comment"># django2.0.1:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 重置密码urlc ：用来接收来自邮箱的重置链接</span></span><br><span class="line">    re_path(<span class="string">'reset/(?P&lt;active_code&gt;.*)/'</span>, ResetView.as_view(), name=<span class="string">"reset_pwd"</span>),</span><br></pre></td></tr></table></figure><h4 id="拷贝进来password-reset页面"><a href="#拷贝进来password-reset页面" class="headerlink" title="拷贝进来password reset页面"></a>拷贝进来password reset页面</h4><p><img src="http://myphoto.mtianyan.cn/blog/180111/LFKlj0CLAb.png?imageslim" alt="mark"></p><blockquote><p>添加一个隐藏的input框，以便于我们知道到底是哪个用户在重置密码</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180111/BfaLgiG5k3.png?imageslim" alt="mark"></p><p>配置html中三大变化加url配置。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/AiiGBEkJLj.png?imageslim" alt="mark"></p><p><code>reset</code>的<code>url</code>需要我们传参进来,但是<code>modify</code>的不需要。<br>所以url配置和view都得分开。</p><h4 id="创建改变密码的forms"><a href="#创建改变密码的forms" class="headerlink" title="创建改变密码的forms:"></a>创建改变密码的forms:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重置密码form实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModifyPwdForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    <span class="comment"># 密码不能小于5位</span></span><br><span class="line">    password1 = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># 密码不能小于5位</span></span><br><span class="line">    password2 = forms.CharField(required=<span class="keyword">True</span>, min_length=<span class="number">5</span>)</span><br></pre></td></tr></table></figure><h4 id="书写改变密码的view；"><a href="#书写改变密码的view；" class="headerlink" title="书写改变密码的view；"></a>书写改变密码的view；</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 改变密码的view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModifyPwdView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        modiypwd_form = ModifyPwdForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> modiypwd_form.is_valid():</span><br><span class="line">            pwd1 = request.POST.get(<span class="string">"password1"</span>, <span class="string">""</span>)</span><br><span class="line">            pwd2 = request.POST.get(<span class="string">"password2"</span>, <span class="string">""</span>)</span><br><span class="line">            email = request.POST.get(<span class="string">"email"</span>, <span class="string">""</span>)</span><br><span class="line">            <span class="comment"># 如果两次密码不相等，返回错误信息</span></span><br><span class="line">            <span class="keyword">if</span> pwd1 != pwd2:</span><br><span class="line">                <span class="keyword">return</span> render(request, <span class="string">"password_reset.html"</span>, &#123;<span class="string">"email"</span>: email, <span class="string">"msg"</span>: <span class="string">"密码不一致"</span>&#125;)</span><br><span class="line">            <span class="comment"># 如果密码一致</span></span><br><span class="line">            user = UserProfile.objects.get(email=email)</span><br><span class="line">            <span class="comment"># 加密成密文</span></span><br><span class="line">            user.password = make_password(pwd2)</span><br><span class="line">            <span class="comment"># save保存到数据库</span></span><br><span class="line">            user.save()</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"login.html"</span>, &#123;<span class="string">"msg"</span>: <span class="string">"密码修改成功，请登录"</span>&#125;)</span><br><span class="line">        <span class="comment"># 验证失败说明密码位数不够。</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            email = request.POST.get(<span class="string">"email"</span>, <span class="string">""</span>)</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">"password_reset.html"</span>, &#123;<span class="string">"email"</span>: email, <span class="string">"modiypwd_form"</span>:modiypwd_form&#125;)</span><br></pre></td></tr></table></figure><h4 id="配置modify的url。"><a href="#配置modify的url。" class="headerlink" title="配置modify的url。"></a>配置modify的url。</h4><p>django2.0.1:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改密码url; 用于passwordreset页面提交表单</span></span><br><span class="line">path(<span class="string">'modify_pwd/'</span>, ModifyPwdView.as_view(), name=<span class="string">"modify_pwd"</span>),</span><br></pre></td></tr></table></figure><p>django1.9.8:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改密码url; 用于passwordreset页面提交表单</span></span><br><span class="line">url(<span class="string">r'^modify_pwd/$'</span>, ModifyPwdView.as_view(), name=<span class="string">"modify_pwd"</span>),</span><br></pre></td></tr></table></figure><p>建议自行走一遍注册，登录，忘记密码。重置密码。<br>错误的激活链接，错误的重置链接。值回填，form报错</p><p>更多: 重置密码链接是否被点击过，过期时间。</p><blockquote><p>对应commit忘记密码重置功能实现完毕，并进行了必要的测试。对应6-11,6-12</p></blockquote><blockquote class="blockquote-center"><p>在绝望中寻找希望，人生终将辉煌 - 新东方</p></blockquote><div class="note default"><p>作为一个正经的教育网站，我们更是拥有正规的机构合作: 比如来自火星的星星优培。</p><ul><li>完成授课机构的功能实现。</li></ul></div><h1 id="完成授课机构的功能实现。"><a href="#完成授课机构的功能实现。" class="headerlink" title="完成授课机构的功能实现。"></a>完成授课机构的功能实现。</h1><h2 id="7-1-django-templates模板继承1"><a href="#7-1-django-templates模板继承1" class="headerlink" title="7-1 django templates模板继承1"></a>7-1 django templates模板继承1</h2><ul><li>机构可以筛选类别</li><li>机构可以根据所在地区进行分类</li></ul><p>右侧我要学习功能: form表单提交<br>右下：授课机构排名</p><p>页面头部与底部为全局头和全局底部。</p><h3 id="Django-template-共用头部底部机制"><a href="#Django-template-共用头部底部机制" class="headerlink" title="Django template 共用头部底部机制"></a>Django template 共用头部底部机制</h3><p>将head和foot放在两个html中，然后在写其他需要这两个部分的页面时include进来。</p><p>Django也是支持include机制的。</p><h3 id="include的问题"><a href="#include的问题" class="headerlink" title="include的问题"></a>include的问题</h3><p>include的进来的死页面，这时候该怎么办？</p><p>解决这种问题：进行模板的继承机制。定义一个父类的框架，子类可以替换其中一部分block，子类只需要重写自己需要改变的block。</p><h3 id="template中新建base-html"><a href="#template中新建base-html" class="headerlink" title="template中新建base.html"></a>template中新建base.html</h3><p>将课程机构列表页。orglist拷贝进template目录</p><p>将orglist内容替换base内容。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/Idbj8d04h5.png?imageslim" alt="mark"></p><p>将div收起来</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/4gb7aiICk7.png?imageslim" alt="mark"></p><p>loadstaticfiles &amp; 修改静态文件路径为static</p><blockquote><p>这个步骤做过太多遍了，自行完成。耐心就行了。</p></blockquote><h3 id="定义父模板-包含head-amp-footer"><a href="#定义父模板-包含head-amp-footer" class="headerlink" title="定义父模板: 包含head &amp; footer"></a>定义父模板: 包含head &amp; footer</h3><p>title应该是可以被子页面替换的所以要包起来。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/3e96fGcGma.png?imageslim" alt="mark"></p><p>css有共用的部分，也有可以被子页面替换的部分。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/14mBAlhH8D.png?imageslim" alt="mark"></p><p>js同理</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/bBjf5DBLh2.png?imageslim" alt="mark"></p><p>面包屑是需要被各个页面自己替换的。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/IekmEbK9A8.png?imageslim" alt="mark"></p><p>将正文内容包起来；</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/hbhi9lBah2.png?imageslim" alt="mark"></p><p>此时base页面就制作好了</p><h2 id="7-2-开始orglist编写"><a href="#7-2-开始orglist编写" class="headerlink" title="7-2 开始orglist编写"></a>7-2 开始orglist编写</h2><p>第一步:清空所有内容</p><ul><li>继承base页面</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180111/9AL06C2hjh.png?imageslim" alt="mark"></p><ul><li>覆盖父类的title</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180111/BL8G2CkmGl.png?imageslim" alt="mark"></p><ul><li>书写课程机构view<br>organization/views.py</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from django.views.generic.base import View</span><br><span class="line"># 处理课程机构列表的view</span><br><span class="line">class OrgView(View):</span><br><span class="line">    def get(self,request):</span><br><span class="line">        return render(request, &quot;org-list.html&quot;, &#123; &#125;)</span><br></pre></td></tr></table></figure><ul><li>Django2.0.1配置课程机构首页url</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构首页url</span><br><span class="line">path(&apos;org_list/&apos;, OrgView.as_view(), name=&quot;org_list&quot;),</span><br></pre></td></tr></table></figure><ul><li>Django1.9.8配置url：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构首页url</span><br><span class="line">url(r&apos;^org_list/$&apos;, OrgView.as_view(), name=&quot;org_list&quot;),</span><br></pre></td></tr></table></figure><h3 id="修改面包屑"><a href="#修改面包屑" class="headerlink" title="修改面包屑"></a>修改面包屑</h3><ul><li>base中只保留首页</li><li>org中重写block custom_bread</li><li><p>block之间没有先后顺序。</p></li><li><p>将base中block content拿到orglist重写</p></li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180111/emCCcfGcEd.png?imageslim" alt="mark"></p><ul><li>然后将base中block中间section删除掉</li></ul><p><img src="http://myphoto.mtianyan.cn/blog/180111/7KKbaGb97i.png?imageslim" alt="mark"></p><blockquote><p>orglist开始loadstaticfiles</p></blockquote><p><code>ctrl+d</code>快速删除</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/D5hBDAjHeA.png?imageslim" alt="mark"></p><p>页面的继承关系使得变量也可以直接用</p><blockquote><p>比如user中的form数据传递到register文件当中.如果register继承的是base页面。<br>base页面当中也是可以用这些数据的。<code>参数的向上传递</code></p></blockquote><p>每个request对象都会传递到html中来，如果继承了base，request也会向上传递到base。<br>base中就可以加入我们的逻辑: 用户是否登录等。</p><p>小节结束对应commit:</p><blockquote><p>完成Django templates的继承关系了解，机构列表展示页。对应7-1 &amp; 2</p></blockquote><h2 id="7-3-课程机构列表页数据展示1"><a href="#7-3-课程机构列表页数据展示1" class="headerlink" title="7-3 课程机构列表页数据展示1"></a>7-3 课程机构列表页数据展示1</h2><p>确定由后台传过来的动态数据:</p><p>授课机构列表本身， 授课机构的排名，所在地区(后台取出所有地区), 机构类别写成静态，因为一般不怎么变动。</p><p>在xadmin中添加城市信息，课程信息。</p><p>添加城市</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/CJG79b8JJ5.png?imageslim" alt="mark"></p><p>添加机构。</p><p>插播知识点：</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/325Id7l954.png?imageslim" alt="mark"></p><p>这里指定的路径是一个相对路径</p><p>setting中要配置我们把文件存放在哪个根目录之下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 设置我们上传文件的路径</span><br><span class="line"></span><br><span class="line">MEDIA_URL = &apos;/media/&apos;</span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, &apos;media&apos;)</span><br></pre></td></tr></table></figure><p>在项目根目录创建media文件夹</p><p>在后台上传图片</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/EG198BJgi3.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180111/I4A16CDal5.png?imageslim" alt="mark"></p><p>修改机构信息中封面图为logo</p><p>自行添加十个课程机构</p><h3 id="models中添加机构类别"><a href="#models中添加机构类别" class="headerlink" title="models中添加机构类别"></a>models中添加机构类别</h3><p>organization/models.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseOrg</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    ORG_CHOICES =(</span><br><span class="line">        (<span class="string">"pxjg"</span>, <span class="string">u"培训机构"</span>),</span><br><span class="line">        (<span class="string">"gx"</span>, <span class="string">u"高校"</span>),</span><br><span class="line">        (<span class="string">"gr"</span>, <span class="string">u"个人"</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    name = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">u"机构名称"</span>)</span><br><span class="line">    <span class="comment"># 机构描述，后面会替换为富文本展示</span></span><br><span class="line">    desc = models.TextField(verbose_name=<span class="string">u"机构描述"</span>)</span><br><span class="line">    <span class="comment"># 机构类别:</span></span><br><span class="line">    category = models.CharField(max_length=<span class="number">20</span>, choices=ORG_CHOICES, verbose_name=<span class="string">u"机构类别"</span>, default=<span class="string">"pxjg"</span>)</span><br></pre></td></tr></table></figure><p>修改了models之后做数据库的变动:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations organization</span><br><span class="line">migrate organization</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180111/lFLGKIH5fE.png?imageslim" alt="mark"></p><p>完成之后打开Navicat进行验证：</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/C6B1Hb7LKD.png?imageslim" alt="mark"></p><p>可以看到新增了。</p><h3 id="完善我们的view"><a href="#完善我们的view" class="headerlink" title="完善我们的view"></a>完善我们的view</h3><p>将列表里的静态数据变成后台获取的动态数据</p><p>organization/views.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> CourseOrg, CityDict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrgView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="comment"># 查找到所有的课程机构</span></span><br><span class="line">        all_orgs = CourseOrg.objects.all()</span><br><span class="line">        <span class="comment"># 取出所有的城市</span></span><br><span class="line">        all_citys = CityDict.objects.all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"org-list.html"</span>, &#123;</span><br><span class="line">            <span class="string">"all_orgs"</span>:all_orgs,</span><br><span class="line">            <span class="string">"all_citys"</span>: all_citys,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><h2 id="7-4-课程机构列表页数据展示2"><a href="#7-4-课程机构列表页数据展示2" class="headerlink" title="7-4 课程机构列表页数据展示2"></a>7-4 课程机构列表页数据展示2</h2><h3 id="前去html中进行数据填充"><a href="#前去html中进行数据填充" class="headerlink" title="前去html中进行数据填充"></a>前去html中进行数据填充</h3><p><img src="http://myphoto.mtianyan.cn/blog/180111/amEhg6kFbf.png?imageslim" alt="mark"></p><blockquote><p>可以看到所有城市是通过a标签，当前选中城市为active。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180111/LcIB9jeKem.png?imageslim" alt="mark"></p><p>之后把下面的写死的城市删除掉。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/hg5g6Cc7f0.png?imageslim" alt="mark"></p><p>这时就是我们在后台添加的数据了</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/8D6a8Dl3h3.png?imageslim" alt="mark"></p><p>可以看到每个课程机构都是一个dl</p><p>同理使用for循环。</p><h3 id="如何将imageField转换为图片地址"><a href="#如何将imageField转换为图片地址" class="headerlink" title="如何将imageField转换为图片地址"></a>如何将imageField转换为图片地址</h3><p>数据库中img存放的是字符串：相对路径</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/k1DG3bflLH.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180111/L7d5cE3D7h.png?imageslim" alt="mark"></p><p>上图这种取法会取出一个相对地址。</p><p><img src="http://myphoto.mtianyan.cn/blog/180111/6ejHjBFb9c.png?imageslim" alt="mark"></p><p>将setting中配置的mediaurl放在前面可以补全地址。</p><h3 id="设置media处理器"><a href="#设置media处理器" class="headerlink" title="设置media处理器"></a>设置media处理器</h3><p><img src="http://myphoto.mtianyan.cn/blog/180111/H0Gjeci29F.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180111/E18ecbCEEI.png?imageslim" alt="mark"></p><blockquote><p>注册之后，mediaurl将可以在html中使用</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180111/c2kA33KE9E.png?imageslim" alt="mark"></p><p>图片还是没有显示。因为url中没有处理图片相应路径的url</p><p>Django1.9.8 urls.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line">    <span class="comment"># 处理图片显示的url,使用Django自带serve,传入参数告诉它去哪个路径找，我们有配置好的路径MEDIAROOT</span></span><br><span class="line">    url(<span class="string">r'^media/(?P&lt;path&gt;.*)$'</span>, serve, &#123;<span class="string">"document_root"</span>: MEDIA_ROOT &#125;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180111/cKmHj6E9gi.png?imageslim" alt="mark"></p><p>Django2.0.1 urls.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"><span class="comment"># 处理图片显示的url,使用Django自带serve,传入参数告诉它去哪个路径找，我们有配置好的路径MEDIAROOT</span></span><br><span class="line">    re_path(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>, serve, &#123;<span class="string">"document_root"</span>: MEDIA_ROOT &#125;)</span><br></pre></td></tr></table></figure><h3 id="完善xadmin的adminx为机构添加分类索引字段"><a href="#完善xadmin的adminx为机构添加分类索引字段" class="headerlink" title="完善xadmin的adminx为机构添加分类索引字段"></a>完善xadmin的adminx为机构添加分类索引字段</h3><p>organization/adminx.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 机构课程信息管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseOrgAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [<span class="string">'name'</span>, <span class="string">'desc'</span>,<span class="string">'category'</span>, <span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>,<span class="string">'add_time'</span> ]</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'category'</span>,<span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>]</span><br><span class="line">    list_filter = [<span class="string">'name'</span>, <span class="string">'desc'</span>,<span class="string">'category'</span> ,<span class="string">'click_nums'</span>, <span class="string">'fav_nums'</span>,<span class="string">'city__name'</span>,<span class="string">'address'</span>,<span class="string">'add_time'</span>]</span><br></pre></td></tr></table></figure><h3 id="去除加载小圈圈"><a href="#去除加载小圈圈" class="headerlink" title="去除加载小圈圈"></a>去除加载小圈圈</h3><p>static/css/style.css中scrollLoading置为空:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.scrollLoading &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>完成后台数据添加，列表页数据展示。对应7-3&amp;7-4</p></blockquote><h2 id="7-5-列表分页功能"><a href="#7-5-列表分页功能" class="headerlink" title="7-5 列表分页功能"></a>7-5 列表分页功能</h2><p>github搜索django-pure-pagination</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-pure-pagination</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180111/cA22hF4fi7.png?imageslim" alt="mark"></p><p>install app中添加:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'pure_pagination'</span>,</span><br></pre></td></tr></table></figure><p>可设置参数；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PAGINATION_SETTINGS = &#123;</span><br><span class="line">    &apos;PAGE_RANGE_DISPLAYED&apos;: 10,</span><br><span class="line">    &apos;MARGIN_PAGES_DISPLAYED&apos;: 2,</span><br><span class="line">    &apos;SHOW_FIRST_PAGE_WHEN_INVALID&apos;: True,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180111/8KAAL61KBk.png?imageslim" alt="mark"></p><p><code>PAGE_RANGE_DISPLAYED</code>是总共会显示多少个page。(包括省略号，包括两边和中间)<br><code>MARGIN_PAGES_DISPLAYED</code>是旁边会显示多少个。<br><code>SHOW_FIRST_PAGE_WHEN_INVALID</code>:当输入页数不合法是否要跳到第一页</p><p>官方实例；</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render_to_response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pure_pagination <span class="keyword">import</span> Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 尝试获取页数参数</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        page = request.GET.get(<span class="string">'page'</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> PageNotAnInteger:</span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">    <span class="comment"># objects是取到的数据</span></span><br><span class="line">    objects = [<span class="string">'john'</span>, <span class="string">'edward'</span>, <span class="string">'josh'</span>, <span class="string">'frank'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Provide Paginator with the request object for complete querystring generation</span></span><br><span class="line">    <span class="comment"># 对于取到的数据进行分页处理。</span></span><br><span class="line">    p = Paginator(objects, request=request)</span><br><span class="line">    <span class="comment"># 此时前台显示的就应该是我们此时获取的第几页的数据</span></span><br><span class="line">    people = p.page(page)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_to_response(<span class="string">'index.html'</span>, &#123;</span><br><span class="line">        <span class="string">'people'</span>: people,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>我们对照着的实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pure_pagination <span class="keyword">import</span> Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrgView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="comment"># 查找到所有的课程机构</span></span><br><span class="line">        all_orgs = CourseOrg.objects.all()</span><br><span class="line">        <span class="comment"># 总共有多少家机构使用count进行统计</span></span><br><span class="line">        org_nums = all_orgs.count()</span><br><span class="line">        <span class="comment"># 取出所有的城市</span></span><br><span class="line">        all_city = CityDict.objects.all()</span><br><span class="line">        <span class="comment"># 对课程机构进行分页</span></span><br><span class="line">        <span class="comment"># 尝试获取前台get请求传递过来的page参数</span></span><br><span class="line">        <span class="comment"># 如果是不合法的配置参数默认返回第一页</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            page = request.GET.get(<span class="string">'page'</span>, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> PageNotAnInteger:</span><br><span class="line">            page = <span class="number">1</span></span><br><span class="line">        <span class="comment"># 这里指从allorg中取五个出来，每页显示5个</span></span><br><span class="line">        p = Paginator(all_orgs, <span class="number">5</span>, request=request)</span><br><span class="line">        orgs = p.page(page)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"org-list.html"</span>, &#123;</span><br><span class="line">            <span class="string">"all_orgs"</span>:orgs,</span><br><span class="line">            <span class="string">"all_city"</span>: all_city,</span><br><span class="line">            <span class="string">"org_nums"</span>: org_nums,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><h3 id="对于html中分页进行配置"><a href="#对于html中分页进行配置" class="headerlink" title="对于html中分页进行配置"></a>对于html中分页进行配置</h3><blockquote><p>不再是objects，而是objectlist</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180111/jadkKHKkbI.png?imageslim" alt="mark"></p><blockquote><p>使用默认的render<br><img src="http://myphoto.mtianyan.cn/blog/180111/fcae2A0E0c.png?imageslim" alt="mark"></p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180111/8gcmfdHb4J.png?imageslim" alt="mark"></p><h3 id="自定义html的样式"><a href="#自定义html的样式" class="headerlink" title="自定义html的样式"></a>自定义html的样式</h3><p><img src="http://myphoto.mtianyan.cn/blog/180112/DmC94JAmh3.png?imageslim" alt="mark"></p><p>本小节完成对应commit:</p><blockquote><p>7-3, 4 &amp; 5:完成列表数据展示列表分页功能：使用pure_pagination</p></blockquote><h2 id="7-6-分类筛选功能"><a href="#7-6-分类筛选功能" class="headerlink" title="7-6 分类筛选功能"></a>7-6 分类筛选功能</h2><p><img src="http://myphoto.mtianyan.cn/blog/180112/jIL4FAdjJb.png?imageslim" alt="mark"></p><p>当用户点击某一个city时对应加上参数city的id</p><h3 id="在后台处理这个city"><a href="#在后台处理这个city" class="headerlink" title="在后台处理这个city"></a>在后台处理这个city</h3><p><img src="http://myphoto.mtianyan.cn/blog/180112/59iFhGLaCD.png?imageslim" alt="mark"></p><p>获取传入的参数进行进一步筛选。</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/aiKJL6kCKL.png?imageslim" alt="mark"></p><blockquote><p>将city_id传回html，使得可以知道哪个是选中的。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180112/mmChH6l2j9.png?imageslim" alt="mark"></p><p>因为city.id是后端传回来的值是一个int。所以我们要做类型转换。</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/GJa43hh95F.png?imageslim" alt="mark"></p><p>当city_id为空的时候，显示全部。</p><h3 id="后台处理类别"><a href="#后台处理类别" class="headerlink" title="后台处理类别"></a>后台处理类别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 类别筛选</span><br><span class="line">      category = request.GET.get(&apos;ct&apos;, &quot;&quot;)</span><br><span class="line">      if category:</span><br><span class="line">          # 我们就在机构中作进一步筛选类别</span><br><span class="line">          all_orgs = all_orgs.filter(category=category)</span><br></pre></td></tr></table></figure><p>返回前台类别值以active</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">return render(request, &quot;org-list.html&quot;, &#123;</span><br><span class="line">          &quot;all_orgs&quot;:orgs,</span><br><span class="line">          &quot;all_city&quot;: all_city,</span><br><span class="line">          &quot;org_nums&quot;: org_nums,</span><br><span class="line">          &quot;city_id&quot;:city_id,</span><br><span class="line">          &quot;category&quot;:category,</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180112/Fgl4eHGJb8.png?imageslim" alt="mark"></p><p>对于类别做同样的ifequal判断</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/me43dl1f0g.png?imageslim" alt="mark"></p><p>如上图所示进行城市与分类的联动:</p><p>当选择全部类别的时候，就只通过当前城市id。<br>当选择全部城市的时候，就只通过当前目录id。<br>当两者都选的时候使用&amp;连接。</p><p>刚才统计机构数目过早，应该移到后面后面已经筛选过后，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 总共有多少家机构使用count进行统计</span><br><span class="line">       org_nums = all_orgs.count()</span><br></pre></td></tr></table></figure><h3 id="课程机构排名"><a href="#课程机构排名" class="headerlink" title="课程机构排名"></a>课程机构排名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 热门机构,如果不加负号会是有小到大。</span><br><span class="line">     hot_orgs = all_orgs.order_by(&quot;-click_nums&quot;)[:3]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180112/BiKdf066CL.png?imageslim" alt="mark"></p><p>循环时内置变量forloop.counter取当前循环到第几次</p><p>待完成:点击排名机构的连接</p><h3 id="课程机构排序。"><a href="#课程机构排序。" class="headerlink" title="课程机构排序。"></a>课程机构排序。</h3><p>学习人数，课程数</p><p>organization/models.py<br>CourseOrg</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当学生点击学习课程，找到所属机构，学习人数加1</span></span><br><span class="line">   students = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"学习人数"</span>)</span><br><span class="line">   <span class="comment"># 当发布课程就加1</span></span><br><span class="line">   course_nums =  models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">u"课程数"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations organization</span><br><span class="line">migrate organization</span><br></pre></td></tr></table></figure><p>前端页面学习人数，添加参数sort</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/dbFlbHIBmb.png?imageslim" alt="mark"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进行排序</span></span><br><span class="line">       sort = request.GET.get(<span class="string">'sort'</span>, <span class="string">""</span>)</span><br><span class="line">       <span class="keyword">if</span> sort:</span><br><span class="line">           <span class="keyword">if</span> sort == <span class="string">"students"</span>:</span><br><span class="line">               all_orgs = all_orgs.order_by(<span class="string">"-students"</span>)</span><br><span class="line">           <span class="keyword">elif</span> sort == <span class="string">"courses"</span>:</span><br><span class="line">               all_orgs = all_orgs.order_by(<span class="string">"-course_nums"</span>)</span><br></pre></td></tr></table></figure><p>添加选择效果</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/DJeKIb9cK1.png?imageslim" alt="mark"></p><h2 id="7-7-modelform-提交我要学习咨询1"><a href="#7-7-modelform-提交我要学习咨询1" class="headerlink" title="7-7 modelform 提交我要学习咨询1"></a>7-7 modelform 提交我要学习咨询1</h2><p>对应表<code>userask</code></p><p><code>form</code>会对字段先做验证，然后保存到数据库中。</p><p>可以看到我们的forms和我们的model中有很多内容是一样的。我们如何让代码重复利用呢？</p><p>使用modelform解决这个问题。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> operation.models <span class="keyword">import</span> UserAsk</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/12 0012 03:20'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 普通版本的form</span></span><br><span class="line"><span class="comment"># class UserAskForm(forms.Form):</span></span><br><span class="line"><span class="comment">#     name = forms.CharField(required=True, min_length=2, max_length=20)</span></span><br><span class="line"><span class="comment">#     phone = forms.CharField(required=True, max_length=11, min_length=11)</span></span><br><span class="line"><span class="comment">#     course_name = forms.CharField(required=True, min_length=5, max_length=50)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进阶版本的modelform：它可以向model一样save</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnotherUserForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="comment"># 继承之余还可以新增字段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 是由哪个model转换的</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = UserAsk</span><br><span class="line">        <span class="comment"># 我需要验证的字段</span></span><br><span class="line">        fields = [<span class="string">'name'</span>,<span class="string">'mobile'</span>,<span class="string">'course_name'</span>]</span><br></pre></td></tr></table></figure><h3 id="include的机制配置应用自己的url"><a href="#include的机制配置应用自己的url" class="headerlink" title="include的机制配置应用自己的url"></a>include的机制配置应用自己的url</h3><p>django1.9.8 创建organization/urls.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/12 0012 06:20'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> organization.views <span class="keyword">import</span> OrgView</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 课程机构列表url</span></span><br><span class="line">    url(<span class="string">'list/&amp;'</span>, OrgView.as_view(), name=<span class="string">"org_list"</span>),</span><br></pre></td></tr></table></figure><p>django1.9.8 Mxonline2/urls.py:<br>删掉orglist,新增如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 课程机构app的url配置</span></span><br><span class="line">  url(<span class="string">r"^org/"</span>, include(<span class="string">'organization.urls'</span>,namespace=<span class="string">"org"</span>)),</span><br></pre></td></tr></table></figure><p>django2.0.1: 新建organization/urls.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> organization.views <span class="keyword">import</span> OrgView</span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'mtianyan'</span></span><br><span class="line">__date__ = <span class="string">'2018/1/12 0012 03:28'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, re_path</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 课程机构列表url</span></span><br><span class="line">    path(<span class="string">'list/'</span>, OrgView.as_view(), name=<span class="string">"org_list"</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>django2.0.1: urls.py中:</p><p>删掉org_list，新增include</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构app的url配置</span><br><span class="line">path(&quot;org/&quot;, include(&apos;organization.urls&apos;,namespace=&quot;org&quot;)),</span><br></pre></td></tr></table></figure><p>使用命名空间防止重复</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/cH5Dmm14Cj.png?imageslim" alt="mark"></p><p>解决Django2.0.1报错:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="string">'Specifying a namespace in include() without providing an app_name '</span> </span><br><span class="line">django.core.exceptions.ImproperlyConfigured: Specifying a namespace <span class="keyword">in</span> </span><br><span class="line">include() without providing an app_name <span class="keyword">is</span> <span class="keyword">not</span> supported. Set the app_name </span><br><span class="line">attribute <span class="keyword">in</span> the included module, <span class="keyword">or</span> <span class="keyword">pass</span> a <span class="number">2</span>-tuple containing the list of </span><br><span class="line">patterns <span class="keyword">and</span> app_name instead.</span><br></pre></td></tr></table></figure><p>在自己的app下的urls中写上appname</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from organization.views import OrgView</span><br><span class="line"></span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/12 0012 03:28&apos;</span><br><span class="line"></span><br><span class="line">from django.urls import path, re_path</span><br><span class="line"></span><br><span class="line">app_name = &quot;organization&quot;</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line"></span><br><span class="line">    # 课程机构列表url</span><br><span class="line">    path(&apos;list/&apos;, OrgView.as_view(), name=&quot;org_list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>html中使用命名空间方式:</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/FkaCFJ4B7h.png?imageslim" alt="mark"></p><h3 id="使用modelform做提交"><a href="#使用modelform做提交" class="headerlink" title="使用modelform做提交"></a>使用modelform做提交</h3><p>比较合理的操作是异步的，不会对整个页面进行刷新。<br>如果有错误，显示错误。一种ajax的异步操作。</p><p>因此我们此时不能直接render一个页面回来。<br>应该是给前端返回json数据，而不是页面</p><p><code>HttpResponse</code>类指明给用户返回哪种类型数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from django.http import HttpResponse</span><br></pre></td></tr></table></figure><p>配置一个modelform的view</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户添加我要学习</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddUserAskView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="comment"># 处理表单提交当然post</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        userask_form = UserAskForm(request.POST)</span><br><span class="line">        <span class="comment"># 判断该form是否有效</span></span><br><span class="line">        <span class="keyword">if</span> userask_form.is_valid():</span><br><span class="line">            <span class="comment"># 这里是modelform和form的区别</span></span><br><span class="line">            <span class="comment"># 它有model的属性</span></span><br><span class="line">            <span class="comment"># 当commit为true进行真正保存</span></span><br><span class="line">            user_ask = userask_form.save(commit=<span class="keyword">True</span>)</span><br><span class="line">            <span class="comment"># 这样就不需要把一个一个字段取出来然后存到model的对象中之后save</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果保存成功,返回json字符串,后面content type是告诉浏览器的,</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"&#123;'status': 'success'&#125;"</span>, content_type=<span class="string">'application/json'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果保存失败，返回json字符串,并将form的报错信息通过msg传递到前端</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">"&#123;'status': 'fail', 'msg':&#123;0&#125;&#125;"</span>.format(userask_form.errors),  content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></table></figure><h3 id="配置相应的url"><a href="#配置相应的url" class="headerlink" title="配置相应的url"></a>配置相应的url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 添加我要学习</span><br><span class="line">path(&apos;add_ask/&apos;, AddUserAskView.as_view(), name=&quot;add_ask&quot;)</span><br></pre></td></tr></table></figure><h2 id="7-8-modelform-提交我要学习"><a href="#7-8-modelform-提交我要学习" class="headerlink" title="7-8 modelform 提交我要学习"></a>7-8 modelform 提交我要学习</h2><h3 id="分析ajax请求"><a href="#分析ajax请求" class="headerlink" title="分析ajax请求"></a>分析ajax请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(function()&#123;</span><br><span class="line">        $(&apos;#jsStayBtn&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                cache: false,</span><br><span class="line">                type: &quot;POST&quot;,</span><br><span class="line">  				url:&quot;&#123;% url &quot;org:add_ask&quot; %&#125;&quot;,</span><br><span class="line">                data:$(&apos;#jsStayForm&apos;).serialize(),</span><br><span class="line">                async: true,</span><br><span class="line">                success: function(data) &#123;</span><br><span class="line">                    if(data.status == &apos;success&apos;)&#123;</span><br><span class="line">                        $(&apos;#jsStayForm&apos;)[0].reset();</span><br><span class="line">                        alert(&quot;提交成功&quot;)</span><br><span class="line">                    &#125;else if(data.status == &apos;fail&apos;)&#123;</span><br><span class="line">                        $(&apos;#jsCompanyTips&apos;).html(data.msg)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><blockquote><p>监听这个button，用户如果点击了button。我们来向这个url进行post请求。<br>将我们的表单进行序列化。</p></blockquote><p>form表单添加crsf_token</p><p>如果后台返回的状态值为success，那么我们将弹出提交成功。<br>失败，就会在错误提示框中写入。</p><h3 id="手机号码正则表达式验证"><a href="#手机号码正则表达式验证" class="headerlink" title="手机号码正则表达式验证:"></a>手机号码正则表达式验证:</h3><p>organization/forms.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 手机号的正则表达式验证</span><br><span class="line">    def clean_mobile(self):</span><br><span class="line">        mobile = self.cleaned_data[&apos;mobile&apos;]</span><br><span class="line">        REGEX_MOBILE = &quot;^1[358]\d&#123;9&#125;$|^147\d&#123;8&#125;$|^176\d&#123;8&#125;$&quot;</span><br><span class="line">        p = re.compile(REGEX_MOBILE)</span><br><span class="line">        if p.match(mobile):</span><br><span class="line">            return mobile</span><br><span class="line">        else:</span><br><span class="line">            raise forms.ValidationError(u&quot;手机号码非法&quot;, code=&quot;mobile_invalid&quot;)</span><br></pre></td></tr></table></figure><p>本小节完毕对应提交commit:</p><blockquote><p>7-7&amp;8 使用modelform完成表单我要学习的异步提交</p></blockquote><h2 id="7-9-机构详情"><a href="#7-9-机构详情" class="headerlink" title="7-9 机构详情"></a>7-9 机构详情</h2><ul><li>机构首页</li><li>机构课程</li><li>机构介绍</li><li>机构讲师</li></ul><p>登录xadmin添加基础的必要数据。添加课程与讲师。</p><p>课程中应该有一个外键指向它是哪个机构的。</p><p>courses/models.py</p><p>Django1.9.8中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> organization.models <span class="keyword">import</span> CourseOrg</span><br><span class="line"></span><br><span class="line">course_org = models.ForeignKey(CourseOrg, verbose_name=<span class="string">u"所属机构"</span>,null=<span class="keyword">True</span>,blank=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure><p>django2.0.1下；</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">course_org = models.ForeignKey(CourseOrg,on_delete=models.CASCADE, verbose_name=<span class="string">u"所属机构"</span>,null=<span class="keyword">True</span>,blank=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure><p>新增外键字段应该<code>null=true,blank=true。</code></p><blockquote><p>因为历史数据中没有这个外键字段</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigration course</span><br><span class="line">migrate course</span><br></pre></td></tr></table></figure><p>将前端给我们的org相关的四个页面拷进template</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/BeIFlkf97m.png?imageslim" alt="mark"></p><p>新建org_base页面</p><p>将org_home页面内容拿过去。</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/DFHg4mGkFb.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180112/k09CHekje2.png?imageslim" alt="mark"></p><ul><li>loadstaticfiles -&gt; 改css文件路径-&gt;改js文件路径-&gt;改图片路径</li><li>改已经实现的url。-&gt;将子页面继承后需要改得地方使用block包裹。</li></ul><p>将home页面清空</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/BBI8iLE97D.png?imageslim" alt="mark"></p><p>完成替换之后添加访问的view以及URl</p><p>organization/views.py:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class OrgHomeView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构首页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org = CourseOrg.objects.get(id= int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        all_courses = course_org.course_set.all()[:4]</span><br><span class="line">        all_teacher = course_org.teacher_set.all()[:2]</span><br><span class="line"></span><br><span class="line">        return render(request, &apos;org-detail-homepage.html&apos;,&#123;</span><br><span class="line">           &apos;all_courses&apos;:all_courses,</span><br><span class="line">            &apos;all_teacher&apos;:all_teacher,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>Django2.0.1下url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   # home页面,取纯数字</span><br><span class="line">re_path(&apos;home/(?P&lt;org_id&gt;\d+)/&apos;, OrgHomeView.as_view(), name=&quot;org_home&quot;),</span><br></pre></td></tr></table></figure><p>django1.9.8下url:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># home页面,取纯数字</span><br><span class="line">url(r&apos;home/(?P&lt;org_id&gt;\d+)/$&apos;, OrgHomeView.as_view(), name=&quot;org_home&quot;)</span><br></pre></td></tr></table></figure><p>html中使用for循环遍历:</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/ECJ36kDclf.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180112/4j037g1DKj.png?imageslim" alt="mark"></p><blockquote><p>如上图可以直接通过外键字段再找到外键对象的字段</p></blockquote><p>templates/org-list.html</p><p>配置里面跳转到详情页的url</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/90m2l2A0Dj.png?imageslim" alt="mark"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> render(request, <span class="string">'org-detail-homepage.html'</span>,&#123;</span><br><span class="line">   <span class="string">'all_courses'</span>:all_courses,</span><br><span class="line">    <span class="string">'all_teacher'</span>:all_teacher,</span><br><span class="line">    <span class="string">'course_org'</span>: course_org,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>将<code>course_org</code>也return回来，就可以把网页里这部分值替换掉</p><p>templates/org_base.html</p><p>数值会随继承链向上传递。</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/0ED5bcC9Jf.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180112/I83bFbddC3.png?imageslim" alt="mark"></p><h3 id="为讲师增加头像字段"><a href="#为讲师增加头像字段" class="headerlink" title="为讲师增加头像字段"></a>为讲师增加头像字段</h3><p>organization/models.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">image = models.ImageField(</span><br><span class="line">    default= &apos;&apos;,</span><br><span class="line">    upload_to=&quot;teacher/%Y/%m&quot;,</span><br><span class="line">    verbose_name=u&quot;头像&quot;,</span><br><span class="line">    max_length=100)</span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemgration organization</span><br><span class="line">migrate organization</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180112/mL08LkChhe.png?imageslim" alt="mark"></p><p>使用for循环填充数据</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/cLg8IFB1jA.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180112/G2ICdgdDgh.png?imageslim" alt="mark"></p><p>同理可得，我们把机构课程页不同的部分拿出来即可</p><h3 id="配置访问的view和url"><a href="#配置访问的view和url" class="headerlink" title="配置访问的view和url"></a>配置访问的view和url</h3><p>organization/urls.py:</p><p>Django 2.0.1：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 访问课程</span><br><span class="line">re_path(&apos;course/(?P&lt;org_id&gt;\d+)/&apos;, OrgCourseView.as_view(), name=&quot;org_course&quot;),</span><br></pre></td></tr></table></figure><p>Django 1.9.8：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 访问课程</span><br><span class="line">url(r&apos;^course/(?P&lt;org_id&gt;\d+)/$&apos;, OrgCourseView.as_view(), name=&quot;org_course&quot;),</span><br></pre></td></tr></table></figure><p>organization/views.py<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class OrgCourseView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构课程列表页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org = CourseOrg.objects.get(id= int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        all_courses = course_org.course_set.all()</span><br><span class="line"></span><br><span class="line">        return render(request, &apos;org-detail-course.html&apos;,&#123;</span><br><span class="line">           &apos;all_courses&apos;:all_courses,</span><br><span class="line">            &apos;course_org&apos;: course_org,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p></p><p>base页面的left链接修改</p><blockquote><p>这里能直接用到course_org.id。是因为子页面render时都向上传递了course_org对象</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180112/b7heml49dh.png?imageslim" alt="mark"></p><p>使用for循环，填充内容。</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/5gjFji2d25.png?imageslim" alt="mark"></p><h3 id="左侧active修改"><a href="#左侧active修改" class="headerlink" title="左侧active修改"></a>左侧active修改</h3><p>因为现在没有值能判断当前是哪个页面。所以在orghomeview中传值回来current page<br><img src="http://myphoto.mtianyan.cn/blog/180112/Kd5ijhIAgK.png?imageslim" alt="mark"><br><img src="http://myphoto.mtianyan.cn/blog/180112/3CFjke2B3C.png?imageslim" alt="mark"></p><p>写两个view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">class OrgDescView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构描述详情页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 向前端传值，表明现在在home页</span><br><span class="line">        current_page = &quot;desc&quot;</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org = CourseOrg.objects.get(id= int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        # 向前端传值说明用户是否收藏</span><br><span class="line">        has_fav = False</span><br><span class="line">        # 必须是用户已登录我们才需要判断。</span><br><span class="line">        if request.user.is_authenticated:</span><br><span class="line">            if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):</span><br><span class="line">                has_fav = True</span><br><span class="line">        return render(request, &apos;org-detail-desc.html&apos;,&#123;</span><br><span class="line">            &apos;course_org&apos;: course_org,</span><br><span class="line">            &quot;current_page&quot;:current_page,</span><br><span class="line">            &quot;has_fav&quot;:has_fav,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">class OrgTeacherView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构讲师列表页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 向前端传值，表明现在在home页</span><br><span class="line">        current_page = &quot;teacher&quot;</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org = CourseOrg.objects.get(id= int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        all_teachers = course_org.teacher_set.all()</span><br><span class="line">        # 向前端传值说明用户是否收藏</span><br><span class="line">        has_fav = False</span><br><span class="line">        # 必须是用户已登录我们才需要判断。</span><br><span class="line">        if request.user.is_authenticated:</span><br><span class="line">            if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):</span><br><span class="line">                has_fav = True</span><br><span class="line">        return render(request, &apos;org-detail-teachers.html&apos;,&#123;</span><br><span class="line">           &apos;all_teachers&apos;:all_teachers,</span><br><span class="line">            &apos;course_org&apos;: course_org,</span><br><span class="line">            &quot;current_page&quot;:current_page,</span><br><span class="line">            &quot;has_fav&quot;:has_fav</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>加两个url</p><p>Django2.0.1下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构描述</span><br><span class="line">re_path(&apos;desc/(?P&lt;org_id&gt;\d+)/&apos;, OrgDescView.as_view(), name=&quot;org_desc&quot;),</span><br><span class="line"></span><br><span class="line"># 访问机构讲师</span><br><span class="line">re_path(&apos;teacher/(?P&lt;org_id&gt;\d+)/&apos;, OrgTeacherView.as_view(), name=&quot;org_teacher&quot;),</span><br></pre></td></tr></table></figure><p>Django1.9.8下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构描述</span><br><span class="line">url(r&apos;^desc/(?P&lt;org_id&gt;\d+)/$&apos;, OrgDescView.as_view(), name=&quot;org_desc&quot;),</span><br><span class="line"></span><br><span class="line"># 访问机构讲师</span><br><span class="line">url(r&apos;^teacher/(?P&lt;org_id&gt;\d+)/$&apos;, OrgTeacherView.as_view(), name=&quot;org_teacher&quot;),</span><br></pre></td></tr></table></figure><p>修改base页面相关跳转链接，注意点：加上course_org.id</p><p>重载我们的pagepath，使得面包屑动态显示</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/2AdFE6He3D.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180112/4f7A1Ei2Fg.png?imageslim" alt="mark"></p><h2 id="7-10-课程机构收藏功能"><a href="#7-10-课程机构收藏功能" class="headerlink" title="7-10 课程机构收藏功能"></a>7-10 课程机构收藏功能</h2><p>书写收藏的后台逻辑:</p><p>url配置</p><p>django2.0.1下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 机构收藏</span></span><br><span class="line">path(<span class="string">'add_fav/'</span>, AddFavView.as_view(), name=<span class="string">"add_fav"</span>),</span><br></pre></td></tr></table></figure><p>django1.9.8下；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 机构收藏</span><br><span class="line">url(r&apos;^add_fav/$&apos;, AddFavView.as_view(), name=&quot;add_fav&quot;),</span><br></pre></td></tr></table></figure><p>配套的view；</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddFavView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户收藏与取消收藏功能</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 表明你收藏的不管是课程，讲师，还是机构。他们的id</span></span><br><span class="line">        <span class="comment"># 默认值取0是因为空串转int报错</span></span><br><span class="line">        id = request.POST.get(<span class="string">'fav_id'</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="comment"># 取到你收藏的类别，从前台提交的ajax请求中取</span></span><br><span class="line">        type = request.POST.get(<span class="string">'fav_type'</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 收藏与已收藏取消收藏</span></span><br><span class="line">        <span class="comment"># 判断用户是否登录:即使没登录会有一个匿名的user</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> request.user.is_authenticated:</span><br><span class="line">            <span class="comment"># 未登录时返回json提示未登录，跳转到登录页面是在ajax中做的</span></span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status":"fail", "msg":"用户未登录"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</span><br><span class="line">        exist_records = UserFavorite.objects.filter(user=request.user, fav_id=int(id), fav_type=int(type))</span><br><span class="line">        <span class="keyword">if</span> exist_records:</span><br><span class="line">            <span class="comment"># 如果记录已经存在， 则表示用户取消收藏</span></span><br><span class="line">            exist_records.delete()</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status":"success", "msg":"收藏"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user_fav = UserFavorite()</span><br><span class="line">            <span class="comment"># 过滤掉未取到fav_id type的默认情况</span></span><br><span class="line">            <span class="keyword">if</span> int(type) &gt;<span class="number">0</span> <span class="keyword">and</span> int(id) &gt;<span class="number">0</span>:</span><br><span class="line">                user_fav.fav_id = int(id)</span><br><span class="line">                user_fav.fav_type = int(type)</span><br><span class="line">                user_fav.user = request.user</span><br><span class="line">                user_fav.save()</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status":"success", "msg":"已收藏"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> HttpResponse(<span class="string">'&#123;"status":"fail", "msg":"收藏出错"&#125;'</span>, content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></table></figure><p>相关处理收藏的jQuery代码写在org base Html</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/c8aa7f62L1.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180112/KelfeB7D2C.png?imageslim" alt="mark"></p><p>添加返回页面的收藏值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 向前端传值说明用户是否收藏</span><br><span class="line">       has_fav = False</span><br><span class="line">       # 必须是用户已登录我们才需要判断。</span><br><span class="line">       if request.user.is_authenticated:</span><br><span class="line">           if UserFavorite.objects.filter(user=request.user, fav_id=course_org.id, fav_type=2):</span><br><span class="line">               has_fav = True</span><br><span class="line"></span><br><span class="line"># return redener加上值</span><br><span class="line">            &quot;has_fav&quot;: has_fav</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180112/DI3GJKkJLI.png?imageslim" alt="mark"></p><p>前台 org_base.html中</p><p><img src="http://myphoto.mtianyan.cn/blog/180112/3gBdC96Aij.png?imageslim" alt="mark"></p><p>同理添加剩下的几个页面的。</p><p>第七章完结撒花。对应commit:</p><blockquote><p>7-9&amp;10&amp;11&amp;12将机构详情展示完毕，为课程机构添加了收藏功能。修复了index未登录状态下爆炸的错误</p></blockquote><blockquote class="blockquote-center"><p>三年六班，三年六班，李子明，李子明同学，你妈妈拿了两罐旺仔牛奶给你</p></blockquote><div class="note success"><p>上帝说得有课程！ 得有详情 ！点了开始学习，得有章节！章节得有视频。<br>课程还得能评论下，还得有相关课程。于是这章出现了。</p></div><h1 id="课程相关功能实现"><a href="#课程相关功能实现" class="headerlink" title="课程相关功能实现"></a>课程相关功能实现</h1><h2 id="8-1-课程列表"><a href="#8-1-课程列表" class="headerlink" title="8-1 课程列表"></a>8-1 课程列表</h2><p>拷贝课程列表页到template目录</p><p>创建课程相关的urls.py</p><p>Mxonline2/urls.py中声明包含到course的url中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程app的url配置</span><br><span class="line">url(r&quot;^course/&quot;, include(&apos;courses.urls&apos;, namespace=&quot;course&quot;)),</span><br></pre></td></tr></table></figure><p>django2.0.1版本:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程app的url配置</span><br><span class="line">path(&quot;course/&quot;, include(&apos;courses.urls&apos;, namespace=&quot;course&quot;)),</span><br></pre></td></tr></table></figure><p>书写处理列表展示相关的view</p><p>courses/views.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123; &#125;)</span><br></pre></td></tr></table></figure><p>courses/urls.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from courses.views import CourseListView</span><br><span class="line"></span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/13 0013 00:39&apos;</span><br><span class="line"></span><br><span class="line">from django.conf.urls import url</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    # 课程列表url</span><br><span class="line">    url(r&apos;^list/$&apos;, CourseListView.as_view(), name=&quot;list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>django2.0.1版本:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/13 0013 01:57&apos;</span><br><span class="line"></span><br><span class="line"># encoding: utf-8</span><br><span class="line">from courses.views import CourseListView</span><br><span class="line">from django.urls import path</span><br><span class="line">app_name = &quot;courses&quot;</span><br><span class="line">urlpatterns = [</span><br><span class="line">    # 课程列表url</span><br><span class="line">    path(&apos;list/&apos;, CourseListView.as_view(), name=&quot;list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>此时访问没有样式。我们开始对于course list html进行工作<br>可以观察到它和orglist一样可以有共同的头尾。所以继承base页面</p><p>xadmin中添加一些课程。</p><p>然后在view中返回课程数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_course = Course.objects.all()</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_course&quot;:all_course,</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180113/32hbAB04ec.png?imageslim" alt="mark"></p><p>保留一个div</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/L1Jm283bck.png?imageslim" alt="mark"></p><blockquote><p>通过外键字段取外键表中字段</p></blockquote><h3 id="分页功能"><a href="#分页功能" class="headerlink" title="分页功能"></a>分页功能</h3><p>拷贝代码:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from pure_pagination import Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"> # 对课程机构进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page = request.GET.get(&apos;page&apos;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page = 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p = Paginator(all_orgs, 4, request=request)</span><br><span class="line">        orgs = p.page(page)</span><br></pre></td></tr></table></figure><p>改动完成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_course = Course.objects.all()</span><br><span class="line">        # 对课程进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page = request.GET.get(&apos;page&apos;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page = 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p = Paginator(all_course,6 , request=request)</span><br><span class="line">        courses = p.page(page)</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_course&quot;:courses,</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>在html中使用时注意object_list</p><blockquote><p>此时的all_course已经不是一个queryset，而是一个purepage对象。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180113/JBm95D0fK8.png?imageslim" alt="mark"></p><h3 id="对于页码进行修改"><a href="#对于页码进行修改" class="headerlink" title="对于页码进行修改"></a>对于页码进行修改</h3><p><img src="http://myphoto.mtianyan.cn/blog/180113/L7Ibjh9g72.png?imageslim" alt="mark"></p><p>直接把orglist中的那段拿过来就行了。自行替换变量名称</p><p>此时已经好了。</p><h3 id="排序功能"><a href="#排序功能" class="headerlink" title="排序功能"></a>排序功能</h3><p>将之前的sort逻辑拷贝过来:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">        sort = request.GET.get(&apos;sort&apos;, &quot;&quot;)</span><br><span class="line">        if sort:</span><br><span class="line">            if sort == &quot;students&quot;:</span><br><span class="line">                all_orgs = all_orgs.order_by(&quot;-students&quot;)</span><br><span class="line">            elif sort == &quot;courses&quot;:</span><br><span class="line">                all_orgs = all_orgs.order_by(&quot;-course_nums&quot;)</span><br></pre></td></tr></table></figure><p>修改完成:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">sort = request.GET.get(&apos;sort&apos;, &quot;&quot;)</span><br><span class="line">if sort:</span><br><span class="line">    if sort == &quot;students&quot;:</span><br><span class="line">        all_course = all_course.order_by(&quot;-students&quot;)</span><br><span class="line">    elif sort == &quot;hot&quot;:</span><br><span class="line">        all_course = all_course.order_by(&quot;-click_nums&quot;)</span><br></pre></td></tr></table></figure><p>应放在分页之前。让分页处理所有筛选过的数据</p><p>return render时添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;sort&quot;:sort,</span><br></pre></td></tr></table></figure><blockquote><p>用来判断激活状态。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180113/0DhjiABaA4.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/al219GFJJ1.png?imageslim" alt="mark"></p><p>修改a标签参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 热门课程推荐</span><br><span class="line">    hot_courses = Course.objects.all().order_by(&quot;-students&quot;)[:3]</span><br><span class="line">    return render</span><br><span class="line">     &quot;hot_courses&quot;:hot_courses</span><br></pre></td></tr></table></figure><p>修改html中<br><img src="http://myphoto.mtianyan.cn/blog/180113/FkIJ7mCjH3.png?imageslim" alt="mark"></p><p>for循环填充内容</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/ji6bee4D31.png?imageslim" alt="mark"></p><p>这里的degree我们在数据库中填写的是字母。如何显示为中文。</p><ul><li>个人猜测: template if</li></ul><p>get_degree_display degree是字段名。专门用于choice字段显示</p><p>本小节完成对应commit：</p><blockquote><p>8-1完成课程列表页展示，分页，热门课程。</p></blockquote><h2 id="8-2-课程详情页1"><a href="#8-2-课程详情页1" class="headerlink" title="8-2 课程详情页1"></a>8-2 课程详情页1</h2><p>拷贝course_detail进入template目录</p><p>可以看出这个页面也是继承base页面的。将course_list的页面框架拿过来</p><p>替换面包屑。</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/Jb07I8Ef1f.png?imageslim" alt="mark"></p><p>配置url访问</p><p>django2.0.1：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程详情页</span><br><span class="line">re_path(&apos;course/(?P&lt;course_id&gt;\d+)/&apos;, CourseDetailView.as_view(), name=&quot;course_detail&quot;),</span><br></pre></td></tr></table></figure><p>书写对应访问的view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> 课程详情处理view</span><br><span class="line"></span><br><span class="line">class CourseDetailView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        return  render(request, &quot;course-detail.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>尝试访问：</p><p>在列表展示页放入详情的url。</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/6Ca5l1lBCf.png?imageslim" alt="mark"></p><p>有参数类型的把参数也传进来</p><p>进行数据填充:先取出当前的课程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 此处的id为表默认为我们添加的值。</span><br><span class="line">course = Course.objects.get(id = int(course_id))</span><br><span class="line"></span><br><span class="line">        return  render(request, &quot;course-detail.html&quot;, &#123;</span><br><span class="line">    &quot;course&quot;:course,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>html中取出数据:</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/mk6Gb823k6.png?imageslim" alt="mark"></p><p>课程的章节数如何实现？</p><p>models.py中自定义方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def get_zj_nums(self):</span><br><span class="line">    # 获取课程章节数的方法</span><br><span class="line">    return self.lesson_set.all().count()</span><br></pre></td></tr></table></figure><p>添加课程类别字段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category = models.CharField(max_length=20, default=u&quot;&quot;, verbose_name=u&quot;课程类别&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><p>operation中专门有张表是做用户学习记录的。</p><p>UserCourse查询有哪些学生学习了这门课</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 获取学习这门课程的用户</span><br><span class="line">def get_learn_users(self):</span><br><span class="line">    # 谁的里面添加了它做外键，他都可以取出来</span><br><span class="line">    return self.usercourse_set.all()[:5]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180113/HKLll9bL4F.png?imageslim" alt="mark"></p><p>链式调用取出数据</p><p>添加一些用户课程进行验证</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/3kmjFehf7F.png?imageslim" alt="mark"></p><p>可以看到已经大功告成</p><p>课程详情的view中添加clicknums+1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 增加课程点击数</span><br><span class="line">course.click_nums += 1</span><br><span class="line">course.save()</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180113/93LBHie41d.png?imageslim" alt="mark"></p><h2 id="8-3-课程详情页2"><a href="#8-3-课程详情页2" class="headerlink" title="8-3 课程详情页2"></a>8-3 课程详情页2</h2><p><img src="http://myphoto.mtianyan.cn/blog/180113/F0jLggJge6.png?imageslim" alt="mark"></p><p>tab_cont1 中填充我们自己的内容。</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/8fDFkB7DIm.png?imageslim" alt="mark"></p><p>教师数自定义函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def get_teacher_nums:</span><br><span class="line">	return self.teacher_set.all().count</span><br></pre></td></tr></table></figure><p>不用自定义函数的方法如下</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/37jDHdha1l.png?imageslim" alt="mark"></p><h3 id="课程是否相关"><a href="#课程是否相关" class="headerlink" title="课程是否相关"></a>课程是否相关</h3><p>定义课程的tag ，如果tag相同，那么是相关课程。</p><p>courses/models.py:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tag = models.CharField(max_length=15, verbose_name=u&quot;课程标签&quot;, default=u&quot;&quot;)</span><br></pre></td></tr></table></figure><p>更改数据库后必然。此处略。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tag = course.tag</span><br><span class="line">       if tag:</span><br><span class="line">       # 需要从1开始不然会推荐自己</span><br><span class="line">           relate_courses = Course.objects.filter(tag=tag)[1:2]</span><br><span class="line">       else:</span><br><span class="line">           relate_courses = []</span><br></pre></td></tr></table></figure><p>return render加上：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;relate_courses&quot;:relate_courses,</span><br></pre></td></tr></table></figure><h3 id="收藏功能"><a href="#收藏功能" class="headerlink" title="收藏功能:"></a>收藏功能:</h3><p>将block js写到页面底部。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">//收藏分享</span><br><span class="line">function add_fav(current_elem, fav_id, fav_type)&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        cache: false,</span><br><span class="line">        type: &quot;POST&quot;,</span><br><span class="line">        url:&quot;&#123;% url &quot;org:add_fav&quot; %&#125;&quot;,</span><br><span class="line">        data:&#123;&apos;fav_id&apos;:fav_id, &apos;fav_type&apos;:fav_type&#125;,</span><br><span class="line">        async: true,</span><br><span class="line">        beforeSend:function(xhr, settings)&#123;</span><br><span class="line">            xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token &#125;&#125;&quot;);</span><br><span class="line">        &#125;,</span><br><span class="line">        success: function(data) &#123;</span><br><span class="line">            if(data.status == &apos;fail&apos;)&#123;</span><br><span class="line">                if(data.msg == &apos;用户未登录&apos;)&#123;</span><br><span class="line">                    window.location.href=&quot;/login/&quot;;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    alert(data.msg)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;else if(data.status == &apos;success&apos;)&#123;</span><br><span class="line">                current_elem.text(data.msg)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(&apos;#jsLeftBtn&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">    add_fav($(this), &#123;&#123; course.id &#125;&#125;, 1);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$(&apos;#jsRightBtn&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">    add_fav($(this), &#123;&#123; course.course_org.id &#125;&#125;, 2);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>刷新后又不见了的问题，从view中传递has_fav的参数。前台进行判断。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 是否收藏课程</span><br><span class="line">      has_fav_course = False</span><br><span class="line">      has_fav_org = False</span><br><span class="line"></span><br><span class="line">      # 必须是用户已登录我们才需要判断。</span><br><span class="line">      if request.user.is_authenticated:</span><br><span class="line">          if UserFavorite.objects.filter(user=request.user, fav_id=course.id, fav_type=1):</span><br><span class="line">              has_fav_course = True</span><br><span class="line">          if UserFavorite.objects.filter(user=request.user, fav_id=course.course_org.id, fav_type=2):</span><br><span class="line">              has_fav_org = True</span><br></pre></td></tr></table></figure><p>return render</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;has_fav_course&quot;:has_fav_course,</span><br><span class="line">&quot;has_fav_org&quot;:has_fav_org,</span><br></pre></td></tr></table></figure><p>html中使用；</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/KJc25I0KF8.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/mKHhjj2d32.png?imageslim" alt="mark"></p><blockquote><p>8-2&amp;3完成课程详情页展示，课程详情页机构，相关推荐课程。收藏课程，收藏机构。</p></blockquote><h2 id="8-4-课程章节信息"><a href="#8-4-课程章节信息" class="headerlink" title="8-4 课程章节信息"></a>8-4 课程章节信息</h2><p>章节信息，评论信息。</p><p>course comments 和 course video放入 template</p><p>它也有head和foot继承我们的base页面</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/D4L8a0lmI0.png?imageslim" alt="mark"></p><p>配置相应的url:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理课程章节信息页面的view</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseInfoView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, course_id)</span>:</span></span><br><span class="line">        <span class="comment"># 此处的id为表默认为我们添加的值。</span></span><br><span class="line">        course = Course.objects.get(id=int(course_id))</span><br><span class="line">        <span class="comment"># 是否收藏课程</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"course-video.html"</span>, &#123;</span><br><span class="line">            <span class="string">"course"</span>: course,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程章节信息页</span><br><span class="line">url(r&apos;^info/(?P&lt;course_id&gt;\d+)/$&apos;, CourseInfoView.as_view(), name=&quot;course_info&quot;),</span><br></pre></td></tr></table></figure><p>用户点击开始学习链接修改</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/hBAAmHlm4g.png?imageslim" alt="mark"></p><p>为课程添加章节以及视频。</p><h2 id="8-5-章节视频信息"><a href="#8-5-章节视频信息" class="headerlink" title="8-5 章节视频信息"></a>8-5 章节视频信息</h2><p>为video表添加视频对应的url信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = models.CharField(max_length=200, default=&quot;http://blog.mtianyan.cn/&quot; ,verbose_name=u&quot;访问地址&quot;)</span><br></pre></td></tr></table></figure><p>将章节信息填充进页面</p><p>通过课程可以找到章节:course.lesson_set</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/5GjjhDe40D.png?imageslim" alt="mark"></p><p>video的时长添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用分钟做后台记录(存储最小单位)前台转换</span><br><span class="line">   learn_times = models.IntegerField(default=0, verbose_name=u&quot;学习时长(分钟数)&quot;)</span><br></pre></td></tr></table></figure><p>资源下载功能:</p><p>后台自行上传点文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">all_resources = CourseResource.objects.filter(course=course)</span><br><span class="line"></span><br><span class="line">          &quot;all_resources&quot;:all_resources,</span><br></pre></td></tr></table></figure><p>或者前端直接:</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/CL7fke0LGF.png?imageslim" alt="mark"></p><p>创建课程与讲师之间的外键关联</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">teacher = models.ForeignKey(Teacher,verbose_name=u&quot;讲师&quot;, null=True, blank=True)</span><br></pre></td></tr></table></figure><p>前往课程，设置讲师。</p><p><strong>注意:不要在Unicode方法里使用外键字段很容易报错。</strong></p><p>增加课程需知字段和老师告诉你学什么？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">you_need_know = models.CharField(max_length=300, default=u&quot;一颗勤学的心是本课程必要前提&quot;,verbose_name=u&quot;课程须知&quot;)</span><br><span class="line">  teacher_tell = models.CharField(max_length=300, default=u&quot;按时交作业,不然叫家长&quot;,verbose_name=u&quot;老师告诉你&quot;)</span><br></pre></td></tr></table></figure><p>将这两个字段显示到页面。</p><p>对应commit:</p><p>8-4&amp;5完成课程章节信息，课程资源，课程老师信息。</p><h2 id="8-6-课程评论页面"><a href="#8-6-课程评论页面" class="headerlink" title="8-6 课程评论页面"></a>8-6 课程评论页面</h2><p>配置课程评论的url和view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class CommentsView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        # 此处的id为表默认为我们添加的值。</span><br><span class="line">        course = Course.objects.get(id=int(course_id))</span><br><span class="line">        all_resources = CourseResource.objects.filter(course=course)</span><br><span class="line">        return render(request, &quot;course-comment.html&quot;, &#123;</span><br><span class="line">            &quot;course&quot;: course,</span><br><span class="line">            &quot;all_resources&quot;: all_resources,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程章节信息页</span><br><span class="line">    re_path(&apos;comments/(?P&lt;course_id&gt;\d+)/&apos;, CommentsView.as_view(), name=&quot;course_comments&quot;),</span><br></pre></td></tr></table></figure><p>course video中跳转到评论链接</p><p>发表评论功能</p><p>ajax操作。如果发布成功就会刷新页面。</p><p>新建view用于添加评论:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># ajax方式添加评论</span><br><span class="line">class AddCommentsView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        if not request.user.is_authenticated:</span><br><span class="line">            # 未登录时返回json提示未登录，跳转到登录页面是在ajax中做的</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;用户未登录&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        course_id = request.POST.get(&quot;course_id&quot;, 0)</span><br><span class="line">        comments = request.POST.get(&quot;comments&quot;, &quot;&quot;)</span><br><span class="line">        if int(course_id) &gt; 0 and comments:</span><br><span class="line">            course_comments = CourseComments()</span><br><span class="line">            # get只能取出一条数据，如果有多条抛出异常。没有数据也抛异常</span><br><span class="line">            # filter取一个列表出来，queryset。没有数据返回空的queryset不会抛异常</span><br><span class="line">            course = Course.objects.get(id = int(course_id))</span><br><span class="line">            # 外键存入要存入对象</span><br><span class="line">            course_comments.course = course</span><br><span class="line">            course_comments.comments = comments</span><br><span class="line">            course_comments.user = request.user</span><br><span class="line">            course_comments.save()</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;:&quot;评论成功&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;评论失败&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br></pre></td></tr></table></figure><p>添加配套的url:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加课程评论,已经把参数放到post当中了</span></span><br><span class="line">path(<span class="string">'add_comment/'</span>, AddCommentsView.as_view(), name=<span class="string">"add_comment"</span>),</span><br></pre></td></tr></table></figure><p>js代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    //添加评论</span><br><span class="line">    $(&apos;#js-pl-submit&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">        var comments = $(&quot;#js-pl-textarea&quot;).val()</span><br><span class="line">        if(comments == &quot;&quot;)&#123;</span><br><span class="line">            alert(&quot;评论不能为空&quot;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            cache: false,</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url:&quot;&#123;% url &apos;course:add_comment&apos; %&#125;&quot;,</span><br><span class="line">            data:&#123;&apos;course_id&apos;:&#123;&#123; course.id &#125;&#125;, &apos;comments&apos;:comments&#125;,</span><br><span class="line">            async: true,</span><br><span class="line">            beforeSend:function(xhr, settings)&#123;</span><br><span class="line">                xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token &#125;&#125;&quot;);</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function(data) &#123;</span><br><span class="line">                if(data.status == &apos;fail&apos;)&#123;</span><br><span class="line">                    if(data.msg == &apos;用户未登录&apos;)&#123;</span><br><span class="line">                        window.location.href=&quot;/login/&quot;;</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                        alert(data.msg)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;else if(data.status == &apos;success&apos;)&#123;</span><br><span class="line">                    window.location.reload();//刷新当前页面.</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>后端已经将all_comments传过来了。然后for循环输出。</p><p>本小节完毕对应commit:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8-6完成课程评论功能，添加评论并展示到页面。</span><br></pre></td></tr></table></figure><h2 id="8-7-相关课程推荐"><a href="#8-7-相关课程推荐" class="headerlink" title="8-7 相关课程推荐:"></a>8-7 相关课程推荐:</h2><blockquote><p>学过该课程的还学过</p></blockquote><p>CourseInfoView</p><p>添加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选出学了这门课的学生关系</span></span><br><span class="line">        user_courses = UserCourse.objects.filter(course= course)</span><br><span class="line">        <span class="comment"># 从关系中取出user_id</span></span><br><span class="line">        user_ids = [user_course.user_id <span class="keyword">for</span> user_course <span class="keyword">in</span> user_courses]</span><br><span class="line">        <span class="comment"># 这些用户学了的课程,外键会自动有id，取到字段</span></span><br><span class="line">        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)</span><br><span class="line">        <span class="comment"># 取出所有课程id</span></span><br><span class="line">        course_ids = [all_user_course.course_id <span class="keyword">for</span> all_user_course <span class="keyword">in</span> all_user_courses]</span><br><span class="line">        <span class="comment"># 获取学过该课程用户学过的其他课程</span></span><br><span class="line">        relate_courses = Course.objects.filter(id__in=course_ids).order_by(<span class="string">"-click_nums"</span>)[:<span class="number">5</span>]</span><br><span class="line">        <span class="comment"># 是否收藏课程</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"course-video.html"</span>, &#123;</span><br><span class="line">            <span class="string">"course"</span>: course,</span><br><span class="line">            <span class="string">"all_resources"</span>: all_resources,</span><br><span class="line">            <span class="string">"relate_courses"</span>:relate_courses,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><blockquote><p>重点: 两个下划线代表我传进来的是一个list，你进行遍历。</p></blockquote><p>comments也做同样处理</p><p>用户未登录，不要让他能点进view</p><p>如果使用的是方法型编程可以使用装饰器<code>loginrequired</code></p><p>而我们使用的是类。所以要继承。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.mixins <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseInfoView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></span><br><span class="line">    login_url = <span class="string">'/login/'</span></span><br><span class="line">    redirect_field_name = <span class="string">'redirect_to'</span></span><br></pre></td></tr></table></figure><blockquote><p>8-7完成相关课程推荐功能，取出相关课程去除本身。课程评论login require鉴权添加。登录页面重定向回登录前浏览页面</p></blockquote><h2 id="8-8-课程播放页面"><a href="#8-8-课程播放页面" class="headerlink" title="8-8 课程播放页面"></a>8-8 课程播放页面</h2><p>将视频播放页面拷贝到template目录</p><p>使用开源库video js</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/f0j8Ffec87.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/kCAHJkbAdb.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/26FehA9AAf.png?imageslim" alt="mark"></p><p>添加访问的url和view；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程视频播放页</span><br><span class="line">url(r&apos;^video/(?P&lt;video_id&gt;\d+)/$&apos;, VideoPlayView.as_view(), name=&quot;video_play&quot;),</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 播放视频的view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoPlayView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></span><br><span class="line">    login_url = <span class="string">'/login/'</span></span><br><span class="line">    redirect_field_name = <span class="string">'next'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, video_id)</span>:</span></span><br><span class="line">        <span class="comment"># 此处的id为表默认为我们添加的值。</span></span><br><span class="line">        video = Video.objects.get(id=int(video_id))</span><br><span class="line">        <span class="comment"># 找到对应的course</span></span><br><span class="line">        course = video.lesson.course</span><br><span class="line">        <span class="comment"># 查询用户是否开始学习了该课，如果还未学习则，加入用户课程表</span></span><br><span class="line">        user_courses = UserCourse.objects.filter(user=request.user, course=course)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_courses:</span><br><span class="line">            user_course = UserCourse(user=request.user, course=course)</span><br><span class="line">            user_course.save()</span><br><span class="line">        <span class="comment"># 查询课程资源</span></span><br><span class="line">        all_resources = CourseResource.objects.filter(course=course)</span><br><span class="line">        <span class="comment"># 选出学了这门课的学生关系</span></span><br><span class="line">        user_courses = UserCourse.objects.filter(course=course)</span><br><span class="line">        <span class="comment"># 从关系中取出user_id</span></span><br><span class="line">        user_ids = [user_course.user_id <span class="keyword">for</span> user_course <span class="keyword">in</span> user_courses]</span><br><span class="line">        <span class="comment"># 这些用户学了的课程,外键会自动有id，取到字段</span></span><br><span class="line">        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)</span><br><span class="line">        <span class="comment"># 取出所有课程id</span></span><br><span class="line">        course_ids = [user_course.course_id <span class="keyword">for</span> user_course <span class="keyword">in</span> all_user_courses]</span><br><span class="line">        <span class="comment"># 获取学过该课程用户学过的其他课程</span></span><br><span class="line">        relate_courses = Course.objects.filter(id__in=course_ids).order_by(<span class="string">"-click_nums"</span>).exclude(id=course.id)[:<span class="number">4</span>]</span><br><span class="line">        <span class="comment"># 是否收藏课程</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"course-play.html"</span>, &#123;</span><br><span class="line">            <span class="string">"course"</span>: course,</span><br><span class="line">            <span class="string">"all_resources"</span>: all_resources,</span><br><span class="line">            <span class="string">"relate_courses"</span>: relate_courses,</span><br><span class="line">            <span class="string">"video"</span>: video,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>title 与面包屑的修改</p><p>对应commit:</p><blockquote><p>第八章公开课模块全部完成，完结撒花。</p></blockquote><blockquote class="blockquote-center"><p>师者，所以传道受业解惑也 - 韩愈</p></blockquote><div class="note"><p>上帝说得课程得有老师来讲！ 得有老师的详情 ！<br>老师应该可以收藏分享，我得看到老师是哪个机构，它讲了啥课。于是这章出现了。</p></div><p>授课讲师列表页。列表页右侧是讲师排行榜。列表页可以进行排序</p><p>点击课程讲师进入课程讲师的详情页: 分享 &amp; 点击收藏 右边是讲师所属课程机构</p><p>下面是讲师的课程详情。</p><h1 id="讲师相关功能实现"><a href="#讲师相关功能实现" class="headerlink" title="讲师相关功能实现"></a>讲师相关功能实现</h1><h2 id="9-1-讲师列表页"><a href="#9-1-讲师列表页" class="headerlink" title="9-1 讲师列表页"></a>9-1 讲师列表页</h2><p>teacherlist 和 teacher detail 一起放到template目录之下</p><p>继承base页面</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/ljke7AEDjj.png?imageslim" alt="mark"></p><h3 id="书写view与配置url"><a href="#书写view与配置url" class="headerlink" title="书写view与配置url"></a>书写view与配置url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 讲师列表</span><br><span class="line">path(&apos;teacher_list/&apos;, TeacherListView.as_view(), name=&quot;teacher_list&quot;),</span><br></pre></td></tr></table></figure><p>添加讲师的年龄字段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">age = models.IntegerField(default=18, verbose_name=u&quot;年龄&quot;)</span><br></pre></td></tr></table></figure><h3 id="分页仿照orglist-注意object-list"><a href="#分页仿照orglist-注意object-list" class="headerlink" title="分页仿照orglist 注意object_list"></a>分页仿照orglist 注意object_list</h3><p>view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 课程讲师列表页</span><br><span class="line">class TeacherListView(View):</span><br><span class="line">        def get(self, request):</span><br><span class="line">            all_teacher = Teacher.objects.all()</span><br><span class="line">            # 总共有多少老师使用count进行统计</span><br><span class="line">            teacher_nums = all_teacher.count()</span><br><span class="line">            # 对讲师进行分页</span><br><span class="line">            # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">            # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">            try:</span><br><span class="line">                page = request.GET.get(&apos;page&apos;, 1)</span><br><span class="line">            except PageNotAnInteger:</span><br><span class="line">                page = 1</span><br><span class="line">            # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">            p = Paginator(all_teacher, 4, request=request)</span><br><span class="line">            teachers = p.page(page)</span><br><span class="line">            return render(request, &quot;teachers-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_teacher&quot;:teachers,</span><br><span class="line">            &quot;teacher_nums&quot;:teacher_nums</span><br><span class="line">            &#125;)</span><br></pre></td></tr></table></figure><h3 id="排序-amp-讲师排行榜"><a href="#排序-amp-讲师排行榜" class="headerlink" title="排序 &amp; 讲师排行榜"></a>排序 &amp; 讲师排行榜</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sort = request.GET.get(&quot;sort&quot;, &quot;&quot;)</span><br><span class="line">           if sort:</span><br><span class="line">               if sort == &quot;hot&quot;:</span><br><span class="line">                   all_teacher = all_teacher.order_by(&quot;-click_nums&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;sort&quot;:sort</span><br></pre></td></tr></table></figure><p>将sort return到前端。实现active</p><p>排行榜讲师</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 排行榜讲师</span><br><span class="line">rank_teacher = Teacher.objects.all().order_by(&quot;-fav_nums&quot;)[:5]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180114/k03L400l4c.png?imageslim" alt="mark"></p><p>forloop.count 取出当前是第几次循环</p><h2 id="9-2-讲师详情页"><a href="#9-2-讲师详情页" class="headerlink" title="9-2 讲师详情页"></a>9-2 讲师详情页</h2><p><img src="http://myphoto.mtianyan.cn/blog/180114/H49BkEleaA.png?imageslim" alt="mark"></p><h3 id="配置url和view"><a href="#配置url和view" class="headerlink" title="配置url和view"></a>配置url和view</h3><p>列表页中配置入口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 教师详情页面</span><br><span class="line"></span><br><span class="line">class TeacherDetailView(View):</span><br><span class="line">    def get(self, request, teacher_id):</span><br><span class="line">        teacher = Teacher.objects.get(id = int(teacher_id))</span><br><span class="line">        all_course = teacher.course_set.all()</span><br><span class="line">        # 排行榜讲师</span><br><span class="line">        rank_teacher = Teacher.objects.all().order_by(&quot;-fav_nums&quot;)[:5]</span><br><span class="line"></span><br><span class="line">        has_fav_teacher = False</span><br><span class="line">        if UserFavorite.objects.filter(user=request.user, fav_type=3, fav_id= teacher.id):</span><br><span class="line">            has_fav_teacher = True</span><br><span class="line">        has_fav_org = False</span><br><span class="line">        if  UserFavorite.objects.filter(user=request.user, fav_type=2, fav_id= teacher.org.id):</span><br><span class="line">            has_fav_org = True</span><br><span class="line">        return render(request, &quot;teacher-detail.html&quot;, &#123;</span><br><span class="line">            &quot;teacher&quot;:teacher,</span><br><span class="line">            &quot;all_course&quot;:all_course,</span><br><span class="line">            &quot;rank_teacher&quot;:rank_teacher,</span><br><span class="line">            &quot;has_fav_teacher&quot;:has_fav_teacher,</span><br><span class="line">            &quot;has_fav_org&quot;:has_fav_org,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构讲师</span><br><span class="line">re_path(&apos;teacher/detail/(?P&lt;teacher_id&gt;\d+)/&apos;, TeacherDetailView.as_view(), name=&quot;teacher_detail&quot;),</span><br></pre></td></tr></table></figure><blockquote><p>第九章完结</p></blockquote><blockquote class="blockquote-center"><p>不以个人为中心, 但我们得有个个人中心。</p></blockquote><div class="note default"><p>做一做全局导航，做一做个人中心，做一做全局搜索。<br>洒洒水啦。</p></div><h1 id="全局导航-amp-个人中心-amp-全局搜索"><a href="#全局导航-amp-个人中心-amp-全局搜索" class="headerlink" title="全局导航&amp;个人中心&amp;全局搜索"></a>全局导航&amp;个人中心&amp;全局搜索</h1><h2 id="配置全局导航"><a href="#配置全局导航" class="headerlink" title="配置全局导航"></a>配置全局导航</h2><p>让index页面也继承base页面</p><p>base页面的导航栏配置</p><p><img src="http://myphoto.mtianyan.cn/blog/180114/4LGd72eA4J.png?imageslim" alt="mark"></p><p>但是现在我们不知道当前是哪一个页面，因为后端没有传值过来</p><p>后台的每个view中添加current nav字段。然后向上传递到base页面</p><p>为了满足前台有current view的值，我们写的每个view都得加上这个字段。</p><p>小技巧：根据request的地址中的前几位来判断在哪一个区域之下</p><p>request.path</p><p>修改url中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构讲师</span><br><span class="line">url(r&apos;^org_teacher/(?P&lt;org_id&gt;\d+)/$&apos;, OrgTeacherView.as_view(), name=&quot;org_teacher&quot;),</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180114/kGG5I71CE1.png?imageslim" alt="mark"></p><h2 id="全局搜索功能开发"><a href="#全局搜索功能开发" class="headerlink" title="全局搜索功能开发"></a>全局搜索功能开发</h2><p>搜索跳到列表展示</p><p>courselist后加参数keywords</p><p>搜索的代码放在deco-common js中</p><p>课程的搜索功能：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 搜索功能</span><br><span class="line">search_keywords = request.GET.get(&apos;keywords&apos;,&apos;&apos;)</span><br><span class="line">if search_keywords:</span><br><span class="line">    # 在name字段进行操作,做like语句的操作。i代表不区分大小写</span><br><span class="line">    # or操作使用Q</span><br><span class="line">    all_course = all_course.filter(Q(name__icontains=search_keywords)|Q(desc__icontains=search_keywords)|Q(detail__icontains=search_keywords))</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;search_keywords&quot;:search_keywords,</span><br></pre></td></tr></table></figure><h2 id="个人中心信息展示"><a href="#个人中心信息展示" class="headerlink" title="个人中心信息展示"></a>个人中心信息展示</h2><p>将用户中心相关的六个页面，全部拷贝进template</p><p>新建usercenter base页面</p><p><img src="http://myphoto.mtianyan.cn/blog/180114/3I2G5kaK1G.png?imageslim" alt="mark"></p><p>配置url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># user app的url配置</span><br><span class="line">url(r&quot;^users/&quot;, include(&apos;users.urls&apos;, namespace=&quot;users&quot;)),</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from .views import UserInfoView</span><br><span class="line"></span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/14 0014 04:00&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from django.conf.urls import url</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    # 用户信息</span><br><span class="line">    url(r&apos;^info/$&apos;, UserInfoView.as_view(), name=&quot;user_info&quot;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 用户个人信息view</span><br><span class="line">class UserInfoView(LoginRequiredMixin,View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;usercenter-info.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>user app 下新建url</p><p>django自带的filter</p><p>request.user.mobile|default_if_none:’’</p><h2 id="修改密码和修改头像"><a href="#修改密码和修改头像" class="headerlink" title="修改密码和修改头像"></a>修改密码和修改头像</h2><p>新建url 和 view</p><p>小技巧:</p><blockquote><p>django的xadmin和admin当中，实际上是可以对form定义为文件的时候，是可以自动对上传的文件做保存的。<br>使用form的一个字段定义一个文件类型。把字段取出来就是内存中的文件。<br>赋值到user.image 就完成图片的一个存储。</p></blockquote><p>users/forms.py：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 用于文件上传，修改头像</span><br><span class="line">class UploadImageForm(forms.ModelForm):</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model = UserProfile</span><br><span class="line">        fields = [&apos;image&apos;]</span><br></pre></td></tr></table></figure><p>实例化时，传进来是post 和 文件类型的request 存放地址</p><p><img src="http://myphoto.mtianyan.cn/blog/180114/Jabljb878I.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180114/Lb09b3457I.png?imageslim" alt="mark"></p><p>上传文件时通过一个form完成的。</p><p><img src="http://myphoto.mtianyan.cn/blog/180114/1IGKhbagJC.png?imageslim" alt="mark"></p><p>必须指明enctype，才能把文件类型传递到后台</p><p>url 和view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 用户头像上传</span><br><span class="line">url(r&apos;^image/upload/$&apos;, UploadImageView.as_view(), name=&quot;image_upload&quot;),</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 用户上传图片的view:用于修改头像</span><br><span class="line">class UploadImageView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 这时候用户上传的文件就已经被保存到imageform了</span><br><span class="line">        image_form = UploadImageForm(request.POST, request.FILES)</span><br><span class="line">        if image_form.is_valid():</span><br><span class="line">            pass</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180114/he98j111Lj.png?imageslim" alt="mark"></p><p>这里的name必须和form中的一样</p><p><img src="http://myphoto.mtianyan.cn/blog/180114/J6kBci76lA.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180114/3Bm665idcK.png?imageslim" alt="mark"></p><blockquote><p>所有验证通过的字段放在cleaned data</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 用户上传图片的view:用于修改头像</span><br><span class="line">class UploadImageView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 这时候用户上传的文件就已经被保存到imageform了 ，为modelform添加instance值直接保存</span><br><span class="line">        image_form = UploadImageForm(request.POST, request.FILES, instance=request.user)</span><br><span class="line">        if image_form.is_valid():</span><br><span class="line">            image_form.save()</span><br><span class="line">            # # 取出cleaned data中的值,一个dict</span><br><span class="line">            # image = image_form.cleaned_data[&apos;image&apos;]</span><br><span class="line">            # request.user.image = image</span><br><span class="line">            # request.user.save()</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;success&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br></pre></td></tr></table></figure><p>修改密码功能:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 在个人中心修改用户密码</span><br><span class="line">class UpdatePwdView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        modiypwd_form = ModifyPwdForm(request.POST)</span><br><span class="line">        if modiypwd_form.is_valid():</span><br><span class="line">            pwd1 = request.POST.get(&quot;password1&quot;, &quot;&quot;)</span><br><span class="line">            pwd2 = request.POST.get(&quot;password2&quot;, &quot;&quot;)</span><br><span class="line">            # 如果两次密码不相等，返回错误信息</span><br><span class="line">            if pwd1 != pwd2:</span><br><span class="line">                return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;密码不一致&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">            # 如果密码一致</span><br><span class="line">            user =request.user</span><br><span class="line">            # 加密成密文</span><br><span class="line">            user.password = make_password(pwd2)</span><br><span class="line">            # save保存到数据库</span><br><span class="line">            user.save()</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;success&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        # 验证失败说明密码位数不够。</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;填写错误请检查&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180114/CC02dfbG57.png?imageslim" alt="mark"></p><p>必须与我们的form中定义的一致</p><p>实现的js代码在deco-user.js</p><p>js文件中的url就一定不能用template的模板语言了</p><h2 id="修改邮箱提交form表单"><a href="#修改邮箱提交form表单" class="headerlink" title="修改邮箱提交form表单"></a>修改邮箱提交form表单</h2><p>有两个接口需要完成。点击获取验证码时，后台需要向用户新邮箱发送验证码。<br>邮箱如果出错，会返回错误信息。</p><p>输入了邮箱和验证码，验证是否匹配。</p><h3 id="获取验证码接口"><a href="#获取验证码接口" class="headerlink" title="获取验证码接口:"></a>获取验证码接口:</h3><p>配置url:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 专用于发送验证码的</span><br><span class="line">url(r&apos;^sendemail_code/$&apos;, SendEmailCodeView.as_view(), name=&quot;sendemail_code&quot;),</span><br></pre></td></tr></table></figure><p>新增邮箱验证码model类型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SEND_CHOICES = (</span><br><span class="line">        (&quot;register&quot;, u&quot;注册&quot;),</span><br><span class="line">        (&quot;forget&quot;, u&quot;找回密码&quot;),</span><br><span class="line">        (&quot;update_email&quot;, u&quot;修改邮箱&quot;)</span><br><span class="line">    )</span><br><span class="line">           max_length=20,</span><br></pre></td></tr></table></figure><p>发送邮箱验证码view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class SendEmailCodeView(LoginRequiredMixin, View):</span><br><span class="line">    def get(self,request):</span><br><span class="line">        # 取出需要发送的邮件</span><br><span class="line">        email = request.GET.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        # 不能是已注册的邮箱</span><br><span class="line">        if UserProfile.objects.filter(email=email):</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;email&quot;:&quot;邮箱已经存在&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        send_register_eamil(email, &quot;update_email&quot;)</span><br><span class="line">        return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;success&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br></pre></td></tr></table></figure><p>发送邮箱验证码的功能放在deco-user.js中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">elif send_type == &quot;update_email&quot;:</span><br><span class="line">    code = random_str(4)</span><br><span class="line">    email_title = &quot;mtianyan慕课小站 修改邮箱验证码&quot;</span><br><span class="line">    email_body = loader.render_to_string(</span><br><span class="line">        &quot;email_update_email.html&quot;,  # 需要渲染的html模板</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;active_code&quot;: code  # 参数</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    msg = EmailMessage(email_title, email_body, EMAIL_FROM, [email])</span><br><span class="line">    msg.content_subtype = &quot;html&quot;</span><br><span class="line">    send_status = msg.send()</span><br></pre></td></tr></table></figure><h3 id="修改邮箱的view"><a href="#修改邮箱的view" class="headerlink" title="修改邮箱的view"></a>修改邮箱的view</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 修改邮箱的view:</span><br><span class="line">class UpdateEmailView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        email = request.POST.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line">        code = request.POST.get(&quot;code&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        existed_records = EmailVerifyRecord.objects.filter(email=email, code=code, send_type=&apos;update_email&apos;)</span><br><span class="line">        if existed_records:</span><br><span class="line">            user = request.user</span><br><span class="line">            user.email = email</span><br><span class="line">            user.save()</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;success&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;email&quot;:&quot;验证码无效&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br></pre></td></tr></table></figure><p>修改邮箱的url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(r&apos;^update_email/$&apos;, UpdateEmailView.as_view(), name=&quot;update_email&quot;),</span><br></pre></td></tr></table></figure><p>为userInfo view增加post方法。使用modelform完成直接提交</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def post(self,request):</span><br><span class="line">    # 不像用户咨询是一个新的。需要指明instance。不然无法修改，而是新增用户</span><br><span class="line">    user_info_form = UserInfoForm(request.POST, instance=request.user)</span><br><span class="line">    if user_info_form.is_valid():</span><br><span class="line">        user_info_form.save()</span><br></pre></td></tr></table></figure><p>user_info_form</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 用于个人中心修改个人信息</span><br><span class="line">class UserInfoForm(forms.ModelForm):</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model = UserProfile</span><br><span class="line">        fields = [&apos;nick_name&apos;,&apos;gender&apos;,&apos;birthday&apos;,&apos;address&apos;,&apos;mobile&apos;]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180114/ADFBmE7a6B.png?imageslim" alt="mark"></p><p>配置url和view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 用户中心我的课程</span><br><span class="line">path(&apos;mycourse/&apos;, MyCourseView.as_view(), name=&quot;mycourse&quot;),</span><br></pre></td></tr></table></figure><p>usercenter base中添加链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 个人中心页我的课程</span><br><span class="line"></span><br><span class="line">class MyCourseView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        user_courses = UserCourse.objects.filter(user=request.user)</span><br><span class="line">        return render(request, &quot;usercenter-mycourse.html&quot;, &#123;</span><br><span class="line">            &quot;user_courses&quot;:user_courses,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180114/8LAe6f1dl7.png?imageslim" alt="mark"></p><h3 id="配置url和view-1"><a href="#配置url和view-1" class="headerlink" title="配置url和view"></a>配置url和view</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程机构</span><br><span class="line">path(&apos;myfav/org/&apos;, MyFavOrgView.as_view(), name=&quot;myfav_org&quot;),</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class MyFavOrgView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        org_list = []</span><br><span class="line">        fav_orgs= UserFavorite.objects.filter(user=request.user, fav_type=2)</span><br><span class="line">        # 上面的fav_orgs只是存放了id。我们还需要通过id找到机构对象</span><br><span class="line">        for fav_org in fav_orgs:</span><br><span class="line">            # 取出fav_id也就是机构的id。</span><br><span class="line">            org_id = fav_org.fav_id</span><br><span class="line">            # 获取这个机构对象</span><br><span class="line">            org = CourseOrg.objects.get(id=org_id)</span><br><span class="line">            org_list.append(org)</span><br><span class="line">        return render(request, &quot;usercenter-fav-org.html&quot;, &#123;</span><br><span class="line">            &quot;org_list&quot;: org_list,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的授课讲师</span><br><span class="line"></span><br><span class="line">class MyFavTeacherView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        teacher_list = []</span><br><span class="line">        fav_teachers= UserFavorite.objects.filter(user=request.user, fav_type=3)</span><br><span class="line">        # 上面的fav_orgs只是存放了id。我们还需要通过id找到机构对象</span><br><span class="line">        for fav_teacher in fav_teachers:</span><br><span class="line">            # 取出fav_id也就是机构的id。</span><br><span class="line">            teacher_id = fav_teacher.fav_id</span><br><span class="line">            # 获取这个机构对象</span><br><span class="line">            teacher = Teacher.objects.get(id=teacher_id)</span><br><span class="line">            teacher_list.append(teacher)</span><br><span class="line">        return render(request, &quot;usercenter-fav-teacher.html&quot;, &#123;</span><br><span class="line">            &quot;teacher_list&quot;: teacher_list,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程机构</span><br><span class="line">path(&apos;myfav/org/&apos;, MyFavOrgView.as_view(), name=&quot;myfav_org&quot;),</span><br><span class="line"></span><br><span class="line"># 我收藏的授课讲师</span><br><span class="line">path(&apos;myfav/teacher/&apos;, MyFavTeacherView.as_view(), name=&quot;myfav_teacher&quot;),</span><br></pre></td></tr></table></figure><h3 id="配置view和url"><a href="#配置view和url" class="headerlink" title="配置view和url"></a>配置view和url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程</span><br><span class="line"></span><br><span class="line">class MyFavCourseView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        course_list = []</span><br><span class="line">        fav_courses = UserFavorite.objects.filter(user=request.user, fav_type=1)</span><br><span class="line">        # 上面的fav_orgs只是存放了id。我们还需要通过id找到机构对象</span><br><span class="line">        for fav_course in fav_courses:</span><br><span class="line">            # 取出fav_id也就是机构的id。</span><br><span class="line">            course_id = fav_course.fav_id</span><br><span class="line">            # 获取这个机构对象</span><br><span class="line">            course = Course.objects.get(id=course_id)</span><br><span class="line">            course_list.append(course)</span><br><span class="line">        return render(request, &quot;usercenter-fav-course.html&quot;, &#123;</span><br><span class="line">            &quot;course_list&quot;: course_list,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程</span><br><span class="line">path(&apos;myfav/course/&apos;, MyFavCourseView.as_view(), name=&quot;myfav_course&quot;),</span><br></pre></td></tr></table></figure><h2 id="取消收藏"><a href="#取消收藏" class="headerlink" title="取消收藏"></a>取消收藏</h2><p>templates/usercenter-fav-course.html</p><p><img src="http://myphoto.mtianyan.cn/blog/180114/i92c3ffgJD.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180114/LjGjh0B3cL.png?imageslim" alt="mark"></p><p>取消收藏的代码在base页面中。三个js。</p><h2 id="我的消息页面"><a href="#我的消息页面" class="headerlink" title="我的消息页面"></a>我的消息页面</h2><p><img src="http://myphoto.mtianyan.cn/blog/180114/B4HKiBfla1.png?imageslim" alt="mark"></p><h3 id="配置url和view-2"><a href="#配置url和view-2" class="headerlink" title="配置url和view"></a>配置url和view</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程</span><br><span class="line">path(&apos;my_message/&apos;, MyMessageView.as_view(), name=&quot;my_message&quot;),</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 我的消息</span><br><span class="line">class MyMessageView(LoginRequiredMixin, View):</span><br><span class="line">    login_url = &apos;/login/&apos;</span><br><span class="line">    redirect_field_name = &apos;next&apos;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_message = UserMessage.objects.filter(user= request.user.id)</span><br><span class="line">        # 对课程机构进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page = request.GET.get(&apos;page&apos;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page = 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p = Paginator(all_message, 4)</span><br><span class="line">        messages = p.page(page)</span><br><span class="line">        return  render(request, &quot;usercenter-message.html&quot;, &#123;</span><br><span class="line">        &quot;messages&quot;:messages,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><h3 id="注册时发生欢迎消息"><a href="#注册时发生欢迎消息" class="headerlink" title="注册时发生欢迎消息"></a>注册时发生欢迎消息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 写入欢迎注册消息</span><br><span class="line">           user_message = UserMessage()</span><br><span class="line">           user_message.user = user_profile.id</span><br><span class="line">           user_message.message = &quot;欢迎注册mtianyan慕课小站!!&quot;</span><br><span class="line">           user_message.save()</span><br></pre></td></tr></table></figure><h3 id="页面顶部小喇叭"><a href="#页面顶部小喇叭" class="headerlink" title="页面顶部小喇叭"></a>页面顶部小喇叭</h3><p>所有页面都要读取一个共同的变量：未读消息的数量。我们需要向request中注入这个变量<br>所有页面都有request.user对象。所以我们在userprofile中自定义方法，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 获取用户未读消息的数量</span><br><span class="line">def unread_nums(self):</span><br><span class="line">    from operation.models import UserMessage</span><br><span class="line">    return  UserMessage.objects.filter(user=self.id).count()</span><br></pre></td></tr></table></figure><blockquote class="blockquote-center"><p>泰山不让土壤，故能成其大；河海不择细流，故能就其深。</p></blockquote><div class="note success"><p>细节决定成败，大体的网站已经做好了。<br>佛曰：给我把细节再搞一搞</p></div><h1 id="首页-全局功能细节和404以及500页面配置"><a href="#首页-全局功能细节和404以及500页面配置" class="headerlink" title="首页,全局功能细节和404以及500页面配置"></a>首页,全局功能细节和404以及500页面配置</h1><h2 id="登出和点击数以及收藏数完善"><a href="#登出和点击数以及收藏数完善" class="headerlink" title="登出和点击数以及收藏数完善"></a>登出和点击数以及收藏数完善</h2><h3 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h3><p>Python3+django2.0.1下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class LogoutView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        # django自带的logout</span><br><span class="line">        logout(request)</span><br><span class="line">        # 重定向到首页,</span><br><span class="line">        return HttpResponseRedirect(reverse(&quot;index&quot;))</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 退出功能url</span><br><span class="line">path(&apos;logout/&apos;, LogoutView.as_view(), name=&quot;logout&quot;),</span><br></pre></td></tr></table></figure><h3 id="点击数加1"><a href="#点击数加1" class="headerlink" title="点击数加1"></a>点击数加1</h3><p>CourseInfoView学习人数加1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">course.students += 1</span><br><span class="line">course.save()</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180115/kDd20GdFDb.png?imageslim" alt="mark"></p><p>TeacherDetailView：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">teacher.click_nums +=1</span><br><span class="line">teacher.save()</span><br></pre></td></tr></table></figure><p>OrgHomeView</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">course_org.click_nums +=1</span><br><span class="line">        course_org.save()</span><br></pre></td></tr></table></figure><p>收藏数统计</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">exist_records.delete()</span><br><span class="line">if int(type) == 1:</span><br><span class="line">    course = Course.objects.get(id=int(id))</span><br><span class="line">    course.fav_nums -=1</span><br><span class="line">    if course.fav_nums &lt; 0:</span><br><span class="line">        course.fav_nums = 0</span><br><span class="line">    course.save()</span><br><span class="line">elif int(type) == 2:</span><br><span class="line">    org = CourseOrg.objects.get(id=int(id))</span><br><span class="line">    org.fav_nums -= 1</span><br><span class="line">    if org.fav_nums &lt; 0:</span><br><span class="line">        org.fav_nums = 0</span><br><span class="line">    org.save()</span><br><span class="line">elif int(type) == 3:</span><br><span class="line">    teacher = Teacher.objects.get(id=int(id))</span><br><span class="line">    teacher.fav_nums -=1</span><br><span class="line">    if teacher.fav_nums &lt; 0:</span><br><span class="line">        teacher.fav_nums = 0</span><br><span class="line">    teacher.save()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">user_fav.save()</span><br><span class="line"></span><br><span class="line">               if int(type) == 1:</span><br><span class="line">                   course = Course.objects.get(id=int(id))</span><br><span class="line">                   course.fav_nums += 1</span><br><span class="line">                   course.save()</span><br><span class="line">               elif int(type) == 2:</span><br><span class="line">                   org = CourseOrg.objects.get(id=int(id))</span><br><span class="line">                   org.fav_nums += 1</span><br><span class="line">                   org.save()</span><br><span class="line">               elif int(type) == 3:</span><br><span class="line">                   teacher = Teacher.objects.get(id=int(id))</span><br><span class="line">                   teacher.fav_nums += 1</span><br><span class="line">                   teacher.save()</span><br></pre></td></tr></table></figure><p>注意负数的处理：</p><p>修改消息已读</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 用户进入个人中心消息页面，清空未读消息记录</span><br><span class="line">all_unread_messages = UserMessage.objects.filter(user=request.user.id, has_read=False)</span><br><span class="line">for unread_message in all_unread_messages:</span><br><span class="line">    unread_message.has_read = True</span><br><span class="line">    unread_message.save()</span><br></pre></td></tr></table></figure><p>改进取出未读数字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return  UserMessage.objects.filter(has_read=False, user=self.id).count()</span><br></pre></td></tr></table></figure><h2 id="首页功能开发"><a href="#首页功能开发" class="headerlink" title="首页功能开发"></a>首页功能开发</h2><p>轮播图</p><p>公开课</p><p>授课机构</p><p>新建view</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 首页view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="comment"># 取出轮播图</span></span><br><span class="line">        all_banner = Banner.objects.all().order_by(<span class="string">'index'</span>)[:<span class="number">5</span>]</span><br><span class="line">        <span class="comment"># 正常位课程</span></span><br><span class="line">        courses = Course.objects.filter(is_banner=<span class="keyword">False</span>)[:<span class="number">6</span>]</span><br><span class="line">        <span class="comment"># 轮播图课程取三个</span></span><br><span class="line">        banner_courses = Course.objects.filter(is_banner=<span class="keyword">True</span>)[:<span class="number">3</span>]</span><br><span class="line">        <span class="comment"># 课程机构</span></span><br><span class="line">        course_orgs = CourseOrg.objects.all()[:<span class="number">15</span>]</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'index.html'</span>, &#123;</span><br><span class="line">            <span class="string">"all_banner"</span>:all_banner,</span><br><span class="line">            <span class="string">"courses"</span>:courses,</span><br><span class="line">            <span class="string">"banner_courses"</span>:banner_courses,</span><br><span class="line">            <span class="string">"course_orgs"</span>:course_orgs,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>为课程添加字段: <code>isbanner</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">is_banner = models.BooleanField(default=<span class="keyword">False</span>, verbose_name=<span class="string">u"是否轮播"</span>)</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">url配置:</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">path(<span class="string">''</span>, IndexView.as_view(), name=  <span class="string">"index"</span>)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180115/8IDjg5e8K0.png?imageslim" alt="mark"></p><p>使用django自带模板标签<code>add</code>添加2</p><p>为<code>courseOrg</code>添加字段<code>tag</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tag = models.CharField(max_length=<span class="number">10</span>, default= <span class="string">u"国内名校"</span>,verbose_name=<span class="string">u"机构标签"</span>)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180115/468aAaiajk.png?imageslim" alt="mark"></p><p>template内建标签被五整除</p><h2 id="配置全局404和500"><a href="#配置全局404和500" class="headerlink" title="配置全局404和500"></a>配置全局404和500</h2><p>Mxonline3/urls.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局404页面配置</span></span><br><span class="line">handler404 = <span class="string">'users.views.page_not_found'</span></span><br></pre></td></tr></table></figure><p>users/views.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 404对应处理view</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">from</span> django.shortcuts <span class="keyword">import</span>  render_to_response</span><br><span class="line">    response = render_to_response(<span class="string">"404.html"</span>, &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment"># 设置response的状态码</span></span><br><span class="line">    response.status_code = <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><p>Debug = True 404是不起作用的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS = [&apos;*&apos;]</span><br></pre></td></tr></table></figure><p>在debug为false情况下。</p><p>我们在访问media的时候配置过用serve来取<br>告诉它访问media的时候去哪个路径下找</p><p>debug为True</p><p>会自动前往STATICFILES——DIRS取文件的</p><p>一旦debug改为false，django就不会代管你的静态文件，</p><p>一般静态文件通过第三方http服务器代理转发。</p><p>nignx 和 Apache都会自动代理这些静态文件</p><p>方法1：我们自己url响应我们的static</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, &apos;static&apos;)</span><br></pre></td></tr></table></figure><h1 id="常见web攻击及防范"><a href="#常见web攻击及防范" class="headerlink" title="常见web攻击及防范"></a>常见web攻击及防范</h1><h2 id="sql注入攻击与防范"><a href="#sql注入攻击与防范" class="headerlink" title="sql注入攻击与防范"></a>sql注入攻击与防范</h2><p>sql注入的危害</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/C2H1D6mBhg.png?imageslim" alt="mark"></p><p>对于用户的输入进行合法性判断。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class LoginUnsafeView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;login.html&quot;, &#123;&#125;)</span><br><span class="line">    def post(self, request):</span><br><span class="line">        user_name = request.POST.get(&quot;username&quot;, &quot;&quot;)</span><br><span class="line">        pass_word = request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        import MySQLdb</span><br><span class="line">        conn = MySQLdb.connect(host=&apos;127.0.0.1&apos;, user=&apos;root&apos;, passwd=&apos;root&apos;, db=&apos;mxonline&apos;, charset=&apos;utf8&apos;)</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">        sql_select = &quot;select * from users_userprofile where email=&apos;&#123;0&#125;&apos; and password=&apos;&#123;1&#125;&apos;&quot;.format(user_name, pass_word)</span><br><span class="line"></span><br><span class="line">        result = cursor.execute(sql_select)</span><br><span class="line">        for row in cursor.fetchall():</span><br><span class="line">            # 查询到用户</span><br><span class="line">            pass</span><br><span class="line">        print &apos;hello&apos;</span><br><span class="line"></span><br><span class="line">urls.py</span><br><span class="line">from users.views import LoginUnsafeView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(&apos;^login/&apos;, LoginUnsafeView.as_view(), name=&apos;login&apos;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>参数中加入sql语句拼接字符串使之为真。</p><p>使用django的orm，它已经对这些做了处理</p><h2 id="xss攻击"><a href="#xss攻击" class="headerlink" title="xss攻击"></a>xss攻击</h2><p>xss跨站脚本攻击(Cross Site Scripting)的危害</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/8EjD3Ik9Gj.png?imageslim" alt="mark"></p><p>正常流程</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/4F1KK3IaaI.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180115/cB5cDiKFdJ.png?imageslim" alt="mark"></p><p>当传入iPhone6时，这个字符会被显示到页面中。</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/kfLLLEGa19.png?imageslim" alt="mark"></p><p>将这段代码改成js代码</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/d42ef1h5HC.png?imageslim" alt="mark"></p><p>黑客拿到你的cookie信息。然后伪装成用户。</p><p>Xss攻击防范</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/03jDakfC5A.png?imageslim" alt="mark"></p><h2 id="crsf攻击与防护"><a href="#crsf攻击与防护" class="headerlink" title="crsf攻击与防护"></a>crsf攻击与防护</h2><p>crsf跨站请求伪造(Cross-site request forgery)的危害</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/6Ikm6edG47.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180115/043H5F0K8G.png?imageslim" alt="mark"></p><p>用户并没有向a请求，而是访问了b。b要求用户访问a的。<br>原因：用户向a的每次请求都会带上session id</p><p>图片中插入。</p><p>提交form表单必须添加crsf token</p><p>攻击网站无法生成crsf token</p><h1 id="xadmin的进阶开发"><a href="#xadmin的进阶开发" class="headerlink" title="xadmin的进阶开发"></a>xadmin的进阶开发</h1><h2 id="static目录问题。"><a href="#static目录问题。" class="headerlink" title="static目录问题。"></a>static目录问题。</h2><p>xadmin的static文件在自己的目录下所以我们找不到</p><p>1- url下的static路由配置注释掉<br>2- setting中的StaticRoot注释掉</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/blD3Cgd9jG.png?imageslim" alt="mark"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from xadmin.plugins.auth import UserAdmin</span><br><span class="line"></span><br><span class="line">class UserProfileAdmin(UserAdmin):</span><br><span class="line">	pass</span><br><span class="line"></span><br><span class="line">xadmin.site.register(UserProfile,UserProfileAdmin)</span><br><span class="line"></span><br><span class="line">from django.contrib.auth.models import User</span><br><span class="line">xadmin.site.unregister(User)</span><br></pre></td></tr></table></figure><p>点进UserProfileAdmin中可以看官方是怎么实现布局的，我们可以重载</p><p>get_form_layout</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">自定义的显示方式</span><br></pre></td></tr></table></figure><p>get_user_model 获取用户: User =</p><p>django权限赋值方式：赋给用户。没一个表的增删改查。</p><p>auth_permission 组权限</p><h2 id="自定义icon"><a href="#自定义icon" class="headerlink" title="自定义icon"></a>自定义icon</h2><p>model_icon = ‘fa fa-group’</p><p>xadmin/static/xadmin/vendor/font-awesome</p><p>官网下载然后替换css和font</p><h2 id="默认排序"><a href="#默认排序" class="headerlink" title="默认排序"></a>默认排序</h2><p>adminx中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ordering = [&apos;-click_nums&apos;]</span><br><span class="line">readonly_fields =[&apos;click_nums&apos;,&apos;fav_nums&apos;]</span><br><span class="line">    exclude = [&apos;fav_nums&apos;]</span><br></pre></td></tr></table></figure><p>两个字段是冲突的。</p><h2 id="下拉框搜索："><a href="#下拉框搜索：" class="headerlink" title="下拉框搜索："></a>下拉框搜索：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">relfield_style = &apos;fk-ajax&apos;</span><br></pre></td></tr></table></figure><p>当有外键指向他，会以ajax方式加载</p><p>数据量过大时很有用</p><h2 id="inlines添加数据。"><a href="#inlines添加数据。" class="headerlink" title="inlines添加数据。"></a>inlines添加数据。</h2><p>在一个页面直接完成章节。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 课程直接添加章节</span><br><span class="line">class LessonInline(object):</span><br><span class="line">    model = Lesson</span><br><span class="line">    extra = 0</span><br><span class="line"></span><br><span class="line">        # 课程直接添加章节</span><br><span class="line">    inlines = [LessonInline]</span><br></pre></td></tr></table></figure><p>没法完成在章节中再嵌套视频<br>但是可以有多个inline。在添加课程时添加课程资源</p><h2 id="一张表分两个model来管理"><a href="#一张表分两个model来管理" class="headerlink" title="一张表分两个model来管理"></a>一张表分两个model来管理</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerCourse</span><span class="params">(Course)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        verbose_name = <span class="string">"轮播课程"</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line">        proxy = <span class="keyword">True</span></span><br></pre></td></tr></table></figure><p>设置proxy = true会具有model的功能，但不会生成表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Course的admin管理器</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BannerCourseAdmin</span><span class="params">(object)</span>:</span></span><br><span class="line">    list_display = [</span><br><span class="line">        <span class="string">'name'</span>,</span><br><span class="line">        <span class="string">'desc'</span>,</span><br><span class="line">        <span class="string">'detail'</span>,</span><br><span class="line">        <span class="string">'degree'</span>,</span><br><span class="line">        <span class="string">'learn_times'</span>,</span><br><span class="line">        <span class="string">'students'</span>]</span><br><span class="line">    search_fields = [<span class="string">'name'</span>, <span class="string">'desc'</span>, <span class="string">'detail'</span>, <span class="string">'degree'</span>, <span class="string">'students'</span>]</span><br><span class="line">    list_filter = [</span><br><span class="line">        <span class="string">'name'</span>,</span><br><span class="line">        <span class="string">'desc'</span>,</span><br><span class="line">        <span class="string">'detail'</span>,</span><br><span class="line">        <span class="string">'degree'</span>,</span><br><span class="line">        <span class="string">'learn_times'</span>,</span><br><span class="line">        <span class="string">'students'</span>]</span><br><span class="line">    ordering = [<span class="string">'-click_nums'</span>]</span><br><span class="line">    readonly_fields =[<span class="string">'click_nums'</span>]</span><br><span class="line">    exclude = [<span class="string">'fav_nums'</span>]</span><br><span class="line">    <span class="comment"># 课程直接添加章节</span></span><br><span class="line">    inlines = [LessonInline,CourseResourceInline]</span><br><span class="line"><span class="comment"># 将管理器与model进行注册关联</span></span><br><span class="line">xadmin.site.register(BannerCourse, BannerCourseAdmin)</span><br></pre></td></tr></table></figure><p>admin中重载queryset方法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 过滤列表中的数据</span><br><span class="line">def queryset(self):</span><br><span class="line">    qs = super(BannerCourseAdmin, self).queryset()</span><br><span class="line">    qs = qs.filter(is_banner=True)</span><br><span class="line">    return qs</span><br><span class="line"># 过滤列表中的数据</span><br><span class="line">def queryset(self):</span><br><span class="line">    qs = super(CourseAdmin, self).queryset()</span><br><span class="line">    qs = qs.filter(is_banner=False)</span><br><span class="line">    return qs</span><br></pre></td></tr></table></figure><h2 id="xamdin其他常见功能："><a href="#xamdin其他常见功能：" class="headerlink" title="xamdin其他常见功能："></a>xamdin其他常见功能：</h2><h3 id="可以在列表上快速修改内容、"><a href="#可以在列表上快速修改内容、" class="headerlink" title="可以在列表上快速修改内容、"></a>可以在列表上快速修改内容、</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list_editable = [ &apos;degree&apos;,&apos;desc&apos;,]</span><br></pre></td></tr></table></figure><h3 id="自定义函数作为列"><a href="#自定义函数作为列" class="headerlink" title="自定义函数作为列"></a>自定义函数作为列</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def get_zj_nums(self):</span><br><span class="line">    return self.lesson_set.all().count()</span><br><span class="line">get_zj_nums.short_description = &quot;章节数&quot;</span><br></pre></td></tr></table></figure><h3 id="显示自定义的html代码"><a href="#显示自定义的html代码" class="headerlink" title="显示自定义的html代码"></a>显示自定义的html代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  def go_to(self):</span><br><span class="line">    from django.utils.safestring import mark_safe</span><br><span class="line">    # 如果不mark safe。会对其进行转义</span><br><span class="line">    return  mark_safe(&quot;&lt;a href=&apos;http://blog.mtianyan.cn&apos;&gt;跳转&lt;/&gt;&quot;)</span><br><span class="line">go_to.short_description = &quot;跳转&quot;</span><br></pre></td></tr></table></figure><h3 id="xadmin的工具-refresh"><a href="#xadmin的工具-refresh" class="headerlink" title="xadmin的工具: refresh"></a>xadmin的工具: refresh</h3><p>xadmin/plugins/refresh.py</p><p>列表页定时刷新的工具</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refresh_times = [3,5]</span><br></pre></td></tr></table></figure><h3 id="字段联动"><a href="#字段联动" class="headerlink" title="字段联动"></a>字段联动</h3><p>应用场景: 新增一门课程之后，courseorg的课程数+1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def save_models(self):</span><br><span class="line">      # 在保存课程的时候统计课程机构的课程数</span><br><span class="line">      # 字段联动</span><br><span class="line">      obj = self.new_obj</span><br><span class="line">      # 新增课程还没有保存，统计的课程数少一个</span><br><span class="line">      obj.save()</span><br><span class="line">      # 必须确定存在。</span><br><span class="line">      if obj.course_org is not None:</span><br><span class="line">          # obj实际是一个course对象</span><br><span class="line">          course_org = obj.course_org</span><br><span class="line">          course_org.course_nums = Course.objects.filter(course_org = course_org).count()</span><br><span class="line">          course_org.save()</span><br></pre></td></tr></table></figure><p>不用在课程里面添加章节数。</p><h2 id="xadmin自行探究"><a href="#xadmin自行探究" class="headerlink" title="xadmin自行探究"></a>xadmin自行探究</h2><ul><li>local 语言包</li><li>migration 数据表的记录</li><li>plugins 每一个后台页面都是一个plugin 插件机制</li><li>static文件。js css</li><li>template xadmin自己用到的html文件</li><li>对django admin的封装</li></ul><h3 id="下载源码包"><a href="#下载源码包" class="headerlink" title="下载源码包"></a>下载源码包</h3><p>添加插件使得可以识别ueditor field</p><p>记得在init中注册。</p><p><img src="http://myphoto.mtianyan.cn/blog/180115/jIJ1A5EijI.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180115/kF99c72b0K.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180115/lcH1c4Bb11.png?imageslim" alt="mark"></p><p>关闭自动转义。</p><h2 id="导入excel"><a href="#导入excel" class="headerlink" title="导入excel"></a>导入excel</h2><ol><li>如何注入导入excel代码到菜单</li><li>如何只在课程列表显示</li><li>如何接收文件对文件进行处理</li></ol><p><img src="http://myphoto.mtianyan.cn/blog/180115/H92HC8eJ1D.png?imageslim" alt="mark"></p><p>adminx 文件中的变量覆盖插件内部变量。</p><p>只需要重载<code>block_top_toolbar</code>，就会把这个放到页面里面<br>默认使用bootstrap</p><p><code>init</code>确定是否启用插件，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def post(self, request, *args , **kwargs):</span><br><span class="line">    if &apos;excel&apos; in request.FILES:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure><p>adminx中重写post方法。上传文件会被放在<code>request.FILES</code>中。</p><p>中间pass步骤不管做什么事情，都要最后return父类的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return super(CourseAdmin, self).post(request, args, kwargs)</span><br></pre></td></tr></table></figure><h1 id="把项目部署上线"><a href="#把项目部署上线" class="headerlink" title="把项目部署上线"></a>把项目部署上线</h1><p>nginx + uwsgi(Python) Tomcat(java)</p><p>端口转发。负载均衡。<br>静态文件交给nginx转发。静态文件代理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br><span class="line">ps aux | grep nginx</span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server</span><br><span class="line">提示:输入用户名密码</span><br><span class="line">ps aux | grep mysql</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">showdatabases</span><br></pre></td></tr></table></figure><p>修改<code>bind address</code>为<code>0.0.0.0</code> 是为了让win进行连接。真正部署尽量127.0.0.1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class="line"></span><br><span class="line">sudo service mysql restart</span><br><span class="line"></span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure><p>然后Navicat中连接会报错</p><p>你不用localhost(127)。使用本机ip都是不行的。</p><p><code>*.*</code>里面是可以指定某一张表。root用户名 IP地址<br>通过该IP地址过来的root用户，通过密码才可以访问所有表。<br>‘%’表示所有ip可以访问。</p><p>mysql下运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;tp131861&apos; WITH GRANT OPTION;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><ol><li>安装pip</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/get-pip.py  --no-check-certificate</span><br><span class="line">sudo python get-pip.py</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pip install virtualenv</span><br><span class="line">pip install virtualenvwrapper</span><br><span class="line"></span><br><span class="line">workon</span><br><span class="line"></span><br><span class="line">vim ~/.bashrc</span><br><span class="line"></span><br><span class="line">export WORKON_HOME=$HOME/.virtualenvs</span><br><span class="line">source /usr/local/bin/virtualenvwrapper.sh</span><br><span class="line"></span><br><span class="line">source ~/.bashrc</span><br><span class="line"></span><br><span class="line">workon mxonline2</span><br><span class="line"></span><br><span class="line">pip freeze &gt; requirements.txt</span><br><span class="line"></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line">sudo pip install virtualenvwrapper</span><br><span class="line"></span><br><span class="line">sudo apt-get install libmysqlclient-dev</span><br><span class="line"></span><br><span class="line">pip install -i https://pypi.douban.com/simple pillow==3.4.1</span><br><span class="line"></span><br><span class="line">pip install uwsgi</span><br><span class="line"></span><br><span class="line">uwsgi --http :8000 --module MxOnline.wsgi(暂时不管报错)</span><br><span class="line"></span><br><span class="line">python manage.py runserver</span><br><span class="line"></span><br><span class="line">数据库设置</span><br><span class="line"></span><br><span class="line">数据传输</span><br></pre></td></tr></table></figure><p>sudo ln -s /mnt/Mxonline2/uc_nginx.conf /etc/nginx/conf.d/</p><p>```</p><p>将setting中 static路径指明。然后将staticDIRS注释掉</p><p>项目根目录创建conf文件夹。然后创建uwsgi.ini.</p><p><code>uwsgi -i /mnt/Mxonline2/conf/uwsgi.ini &amp;</code></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/post/8b4c6c13.html">强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版</a></p><p><span>文章作者:</span><a href="/" title="访问 mtianyan 的个人博客">mtianyan</a></p><p><span>发布时间:</span>2018年01月17日 - 00:01</p><p><span>最后更新:</span>2018年01月30日 - 03:01</p><p><span>原始链接:</span><a href="/post/8b4c6c13.html" title="强力Django+杀手级Xadmin打造在线教育平台 - 系列完整版">http://blog.mtianyan.cn/post/8b4c6c13.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://blog.mtianyan.cn/post/8b4c6c13.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>请博主吃包辣条</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="mtianyan 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.jpg" alt="mtianyan 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a><a href="/tags/Django/" rel="tag"><i class="fa fa-tag"></i> Django</a><a href="/tags/在线教育平台/" rel="tag"><i class="fa fa-tag"></i> 在线教育平台</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/743baaa3.html" rel="next" title="强力Django+杀手级Xadmin打造在线教育平台(十三)"><i class="fa fa-chevron-left"></i> 强力Django+杀手级Xadmin打造在线教育平台(十三)</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/post/54943bfb.html" rel="prev" title="2018.2最新-Scrapy+elasticSearch+Django打造搜索引擎(一)">2018.2最新-Scrapy+elasticSearch+Django打造搜索引擎(一)<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"> <span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2154292" charset="utf-8"></script></div></div></div><div class="comments" id="comments"><div id="SOHUCS"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="mtianyan"><p class="site-author-name" itemprop="name">mtianyan</p><p class="site-description motion-element" itemprop="description">爱分享，爱技术，爱生活。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">36</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/mtianyan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/db9a7a0daa1f" target="_blank" title="简书"><i class="fa fa-fw fa-book"></i> 简书</a></span><span class="links-of-author-item"><a href="https://plus.google.com/u/0/114963812195952881148" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://mtianyan.gitee.io/" title="本站孪生站(国内码云托管)" target="_blank">本站孪生站(国内码云托管)</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#项目演示和课程介绍"><span class="nav-number">1.</span> <span class="nav-text">项目演示和课程介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#开发环境搭建任务"><span class="nav-number">1.1.</span> <span class="nav-text">开发环境搭建任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#django基础知识回顾任务"><span class="nav-number">1.2.</span> <span class="nav-text">django基础知识回顾任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库设计和xadmin搭建后台管理系统任务"><span class="nav-number">1.3.</span> <span class="nav-text">数据库设计和xadmin搭建后台管理系统任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统功能模块实现任务"><span class="nav-number">1.4.</span> <span class="nav-text">系统功能模块实现任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#web系统知识以及网络安全任务"><span class="nav-number">1.5.</span> <span class="nav-text">web系统知识以及网络安全任务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xadmin扩展知识"><span class="nav-number">1.6.</span> <span class="nav-text">xadmin扩展知识</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#windows下搭建开发环境"><span class="nav-number">2.</span> <span class="nav-text">windows下搭建开发环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-pycharm-mysql-Navicat安装。"><span class="nav-number">2.1.</span> <span class="nav-text">2-1 pycharm,mysql,Navicat安装。</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mysql"><span class="nav-number">2.1.1.</span> <span class="nav-text">Mysql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Navicat"><span class="nav-number">2.1.2.</span> <span class="nav-text">Navicat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PyCharm-2017-3-2"><span class="nav-number">2.1.3.</span> <span class="nav-text">PyCharm 2017.3.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python2-7安装"><span class="nav-number">2.1.4.</span> <span class="nav-text">Python2.7安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-virtualenv安装和配置"><span class="nav-number">2.2.</span> <span class="nav-text">2-2 virtualenv安装和配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#virtualenv介绍"><span class="nav-number">2.2.1.</span> <span class="nav-text">virtualenv介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装virtualenv"><span class="nav-number">2.2.2.</span> <span class="nav-text">安装virtualenv</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#virtualenvwrapper安装"><span class="nav-number">2.2.3.</span> <span class="nav-text">virtualenvwrapper安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-Pycharm和Navicat的简单使用"><span class="nav-number">2.3.</span> <span class="nav-text">2-3 Pycharm和Navicat的简单使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pycharm简单使用："><span class="nav-number">2.3.1.</span> <span class="nav-text">pycharm简单使用：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#新建项目并验证成功运行"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">新建项目并验证成功运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置eclipse快捷键-keymap"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">设置eclipse快捷键 - keymap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-edit配置修改"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">Run edit配置修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#目录颜色不同的原因"><span class="nav-number">2.3.1.4.</span> <span class="nav-text">目录颜色不同的原因</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#navicat基本使用"><span class="nav-number">2.3.2.</span> <span class="nav-text">navicat基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建连接"><span class="nav-number">2.3.3.</span> <span class="nav-text">新建连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#右键新建数据库"><span class="nav-number">2.3.4.</span> <span class="nav-text">右键新建数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建数据表"><span class="nav-number">2.3.5.</span> <span class="nav-text">新建数据表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加数据"><span class="nav-number">2.3.6.</span> <span class="nav-text">增加数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计表"><span class="nav-number">2.3.7.</span> <span class="nav-text">设计表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sql语句查询"><span class="nav-number">2.3.8.</span> <span class="nav-text">Sql语句查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表的复制粘贴与数据库传输。数据库导入导出。"><span class="nav-number">2.3.9.</span> <span class="nav-text">表的复制粘贴与数据库传输。数据库导入导出。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#通过留言版功能回顾django基础知识"><span class="nav-number">3.</span> <span class="nav-text">通过留言版功能回顾django基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-django目录结构"><span class="nav-number">3.1.</span> <span class="nav-text">3-1 django目录结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#django自动生成的目录"><span class="nav-number">3.1.1.</span> <span class="nav-text">django自动生成的目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#还需要我们自己创建的目录"><span class="nav-number">3.1.2.</span> <span class="nav-text">还需要我们自己创建的目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#startapp-message"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">startapp message</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新建static目录"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">新建static目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新建log目录"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">新建log目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新建media目录"><span class="nav-number">3.1.2.4.</span> <span class="nav-text">新建media目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决项目大了之后app过多问题"><span class="nav-number">3.1.2.5.</span> <span class="nav-text">解决项目大了之后app过多问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mark后Pycharm-不报错，Cmd下运行报错。"><span class="nav-number">3.1.2.6.</span> <span class="nav-text">Mark后Pycharm 不报错，Cmd下运行报错。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#github仓库项目初始化第一次commit。"><span class="nav-number">3.1.3.</span> <span class="nav-text">github仓库项目初始化第一次commit。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-配置表单页面"><span class="nav-number">3.2.</span> <span class="nav-text">3-2 配置表单页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#必要的该说的，该了解的"><span class="nav-number">3.2.1.</span> <span class="nav-text">必要的该说的，该了解的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将html文件整合进项目操作步骤"><span class="nav-number">3.2.2.</span> <span class="nav-text">将html文件整合进项目操作步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#将html文件直接复制进templates目录"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">将html文件直接复制进templates目录.</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建static目录下的css文件夹-和-static-js"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">创建static目录下的css文件夹 和 static/js</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Django连接Mysql数据库"><span class="nav-number">3.2.3.</span> <span class="nav-text">配置Django连接Mysql数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置mysql驱动和seeting文件。"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">配置mysql驱动和seeting文件。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置form页面展示出来："><span class="nav-number">3.2.4.</span> <span class="nav-text">配置form页面展示出来：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目配置流程图"><span class="nav-number">3.2.5.</span> <span class="nav-text">项目配置流程图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-django-orm介绍与model设计"><span class="nav-number">3.3.</span> <span class="nav-text">3-3 django orm介绍与model设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#原生sql-与-orm"><span class="nav-number">3.3.1.</span> <span class="nav-text">原生sql 与 orm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建我们的models"><span class="nav-number">3.3.2.</span> <span class="nav-text">创建我们的models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在setting中注册我们的app"><span class="nav-number">3.3.3.</span> <span class="nav-text">在setting中注册我们的app</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Models讲解"><span class="nav-number">3.3.4.</span> <span class="nav-text">Models讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#介绍字段参数"><span class="nav-number">3.3.4.1.</span> <span class="nav-text">介绍字段参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#介绍Meta信息："><span class="nav-number">3.3.4.2.</span> <span class="nav-text">介绍Meta信息：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-django-model的增删改"><span class="nav-number">3.4.</span> <span class="nav-text">3-4 django model的增删改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#filter取出指定要求值"><span class="nav-number">3.4.1.</span> <span class="nav-text">filter取出指定要求值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将数据存入数据库"><span class="nav-number">3.4.2.</span> <span class="nav-text">将数据存入数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Navicat进行验证"><span class="nav-number">3.4.3.</span> <span class="nav-text">Navicat进行验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何从html的提交中取到数据并保存进数据库"><span class="nav-number">3.4.4.</span> <span class="nav-text">如何从html的提交中取到数据并保存进数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库新增。"><span class="nav-number">3.4.5.</span> <span class="nav-text">数据库新增。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除数据。"><span class="nav-number">3.4.6.</span> <span class="nav-text">删除数据。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-django-url-templates配置"><span class="nav-number">3.5.</span> <span class="nav-text">3-5 django url templates配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#取出数据"><span class="nav-number">3.5.1.</span> <span class="nav-text">取出数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将数据回填至html中"><span class="nav-number">3.5.2.</span> <span class="nav-text">将数据回填至html中</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改return-render"><span class="nav-number">3.5.2.1.</span> <span class="nav-text">修改return render</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在前端页面中放入值。"><span class="nav-number">3.5.2.2.</span> <span class="nav-text">在前端页面中放入值。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template模板渲染中的一些用法。"><span class="nav-number">3.5.3.</span> <span class="nav-text">template模板渲染中的一些用法。</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常用的几种模板标签介绍："><span class="nav-number">3.5.3.1.</span> <span class="nav-text">常用的几种模板标签介绍：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#if-else"><span class="nav-number">3.5.3.1.1.</span> <span class="nav-text">if - else</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ifequal-amp-ifnotequal"><span class="nav-number">3.5.3.1.2.</span> <span class="nav-text">ifequal &amp; ifnotequal</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#slice"><span class="nav-number">3.5.3.1.3.</span> <span class="nav-text">slice</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URl的别名设置技巧"><span class="nav-number">3.5.4.</span> <span class="nav-text">URl的别名设置技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#url先后顺序问题"><span class="nav-number">3.5.5.</span> <span class="nav-text">url先后顺序问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#完成django的app设计-amp-完成app中的models设计"><span class="nav-number">4.</span> <span class="nav-text">完成django的app设计 &amp; 完成app中的models设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-使用py3-6和django1-11开发系统前注意事项"><span class="nav-number">4.1.</span> <span class="nav-text">4-1 使用py3.6和django1.11开发系统前注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#虚拟环境问题"><span class="nav-number">4.1.1.</span> <span class="nav-text">虚拟环境问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设计model的时候的-unicode-方法"><span class="nav-number">4.1.2.</span> <span class="nav-text">设计model的时候的__unicode__方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Python的mysql驱动时不能用之前的-MYSQL-python"><span class="nav-number">4.1.3.</span> <span class="nav-text">安装Python的mysql驱动时不能用之前的 MYSQL python</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过源码方式安装xadmin时。"><span class="nav-number">4.1.4.</span> <span class="nav-text">通过源码方式安装xadmin时。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用DjangoUeditor"><span class="nav-number">4.1.5.</span> <span class="nav-text">使用DjangoUeditor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-django-app-设计"><span class="nav-number">4.2.</span> <span class="nav-text">4-2 django-app 设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#根据app设计-models"><span class="nav-number">4.2.1.</span> <span class="nav-text">根据app设计 models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据表生成与修改"><span class="nav-number">4.2.2.</span> <span class="nav-text">数据表生成与修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-新建项目"><span class="nav-number">4.3.</span> <span class="nav-text">4-3 新建项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Python2-7-创建虚拟环境。"><span class="nav-number">4.3.1.</span> <span class="nav-text">Python2.7 创建虚拟环境。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python3-x-创建虚拟环境"><span class="nav-number">4.3.2.</span> <span class="nav-text">Python3.x 创建虚拟环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建Python2-下Project"><span class="nav-number">4.3.3.</span> <span class="nav-text">新建Python2 下Project</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装mysql驱动。"><span class="nav-number">4.3.3.1.</span> <span class="nav-text">安装mysql驱动。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建Python3-下Project"><span class="nav-number">4.3.4.</span> <span class="nav-text">新建Python3 下Project</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装mysql驱动。-1"><span class="nav-number">4.3.4.1.</span> <span class="nav-text">安装mysql驱动。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setting中配置"><span class="nav-number">4.3.5.</span> <span class="nav-text">setting中配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前往Navicat新建数据库"><span class="nav-number">4.3.6.</span> <span class="nav-text">前往Navicat新建数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#进行数据库初始化makemigrations"><span class="nav-number">4.3.6.1.</span> <span class="nav-text">进行数据库初始化makemigrations</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-自定义userprofile"><span class="nav-number">4.4.</span> <span class="nav-text">4-4 自定义userprofile</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写我们的model设计user表。"><span class="nav-number">4.4.1.</span> <span class="nav-text">编写我们的model设计user表。</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#setting设置INSTALLED-APPS-amp-AUTH-USER-MODEL。"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">setting设置INSTALLED_APPS &amp; AUTH_USER_MODEL。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进入Navicat进行验证"><span class="nav-number">4.4.2.</span> <span class="nav-text">进入Navicat进行验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附加Python3下不同与报错："><span class="nav-number">4.4.3.</span> <span class="nav-text">附加Python3下不同与报错：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-user-modesl-py设计"><span class="nav-number">4.5.</span> <span class="nav-text">4-5 user modesl.py设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#解决循环引用-分层设计"><span class="nav-number">4.5.1.</span> <span class="nav-text">解决循环引用: 分层设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-course-models-py编写"><span class="nav-number">4.6.</span> <span class="nav-text">4-6 course models.py编写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-7-organization-modesl-py设计"><span class="nav-number">4.7.</span> <span class="nav-text">4-7 organization modesl.py设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-8-operation-models-py设计"><span class="nav-number">4.8.</span> <span class="nav-text">4-8 operation models.py设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#setting中配置添加app"><span class="nav-number">4.8.1.</span> <span class="nav-text">setting中配置添加app</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-9-数据表生成以及apps目录建立"><span class="nav-number">4.9.</span> <span class="nav-text">4-9 数据表生成以及apps目录建立</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Python2与Python3不同"><span class="nav-number">4.9.1.</span> <span class="nav-text">Python2与Python3不同:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python3-django2-0-1-会报错"><span class="nav-number">4.9.2.</span> <span class="nav-text">Python3(django2.0.1)会报错:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#makemirgration-amp-migrate生成表"><span class="nav-number">4.9.3.</span> <span class="nav-text">makemirgration &amp; migrate生成表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#把我们的四个app放到一个文件夹下。"><span class="nav-number">4.9.4.</span> <span class="nav-text">把我们的四个app放到一个文件夹下。</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#成功性验证"><span class="nav-number">4.9.4.1.</span> <span class="nav-text">成功性验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第四章总结"><span class="nav-number">4.9.5.</span> <span class="nav-text">第四章总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#xadmin快速搭建可用的后台系统"><span class="nav-number">5.</span> <span class="nav-text">xadmin快速搭建可用的后台系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#django-admin介绍"><span class="nav-number">5.1.</span> <span class="nav-text">django admin介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createsuperuser"><span class="nav-number">5.1.1.</span> <span class="nav-text">createsuperuser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改setting中对应语言，时区，以及数据库写入时间。"><span class="nav-number">5.1.2.</span> <span class="nav-text">修改setting中对应语言，时区，以及数据库写入时间。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册UserProfile进来"><span class="nav-number">5.1.3.</span> <span class="nav-text">注册UserProfile进来</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xadmin的安装"><span class="nav-number">5.2.</span> <span class="nav-text">xadmin的安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Python3-amp-Django2-0-1安装官方适配Django2-0的包"><span class="nav-number">5.2.1.</span> <span class="nav-text">Python3 &amp; Django2.0.1安装官方适配Django2.0的包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册Xadmin-与-crispy-forms"><span class="nav-number">5.2.2.</span> <span class="nav-text">注册Xadmin 与 crispy-forms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#源码安装："><span class="nav-number">5.2.3.</span> <span class="nav-text">源码安装：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Python3版本源码安装-与url配置不同"><span class="nav-number">5.2.3.1.</span> <span class="nav-text">Python3版本源码安装:与url配置不同</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建extra-apps，并在setting中注册地址"><span class="nav-number">5.2.4.</span> <span class="nav-text">新建extra_apps，并在setting中注册地址</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#users-app-的model注册"><span class="nav-number">5.3.</span> <span class="nav-text">users app 的model注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#遗留问题-django2-0-1使用xadmin时。如验证码等带dateTimefield区域出错。"><span class="nav-number">5.3.1.</span> <span class="nav-text">遗留问题: django2.0.1使用xadmin时。如验证码等带dateTimefield区域出错。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#真正开始"><span class="nav-number">5.3.2.</span> <span class="nav-text">真正开始</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建py文件的初始化模板"><span class="nav-number">5.3.3.</span> <span class="nav-text">新建py文件的初始化模板</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解决后台部分英文显示"><span class="nav-number">5.3.3.1.</span> <span class="nav-text">解决后台部分英文显示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解决EmailVerifyRecord-object显示"><span class="nav-number">5.3.3.2.</span> <span class="nav-text">解决EmailVerifyRecord object显示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置显示列"><span class="nav-number">5.3.3.3.</span> <span class="nav-text">配置显示列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置搜索searchfield"><span class="nav-number">5.3.3.4.</span> <span class="nav-text">配置搜索searchfield</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xadmin导出csv中文乱码解决"><span class="nav-number">5.3.3.5.</span> <span class="nav-text">xadmin导出csv中文乱码解决</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xadmin导出xml报错"><span class="nav-number">5.3.3.6.</span> <span class="nav-text">xadmin导出xml报错</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过时间筛选字段。"><span class="nav-number">5.3.3.7.</span> <span class="nav-text">通过时间筛选字段。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Django的admin-Xadmin和其他系统区别"><span class="nav-number">5.3.4.</span> <span class="nav-text">Django的admin, Xadmin和其他系统区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user-models的注册"><span class="nav-number">5.3.5.</span> <span class="nav-text">user/models的注册</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#剩余app-model注册"><span class="nav-number">5.4.</span> <span class="nav-text">剩余app model注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#courses注册"><span class="nav-number">5.4.1.</span> <span class="nav-text">courses注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册机构app的adminx"><span class="nav-number">5.4.2.</span> <span class="nav-text">注册机构app的adminx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#operation-app注册xadmin"><span class="nav-number">5.4.3.</span> <span class="nav-text">operation app注册xadmin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xadmin全局配置"><span class="nav-number">5.5.</span> <span class="nav-text">xadmin全局配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Xadmin的主题功能。"><span class="nav-number">5.5.1.</span> <span class="nav-text">使用Xadmin的主题功能。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决django1-9-python2-下Xadmin主题不生效问题。"><span class="nav-number">5.5.2.</span> <span class="nav-text">解决django1.9(python2)下Xadmin主题不生效问题。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改django-admin-和下面的我的公司收起菜单"><span class="nav-number">5.5.3.</span> <span class="nav-text">修改django admin 和下面的我的公司收起菜单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#apps-py配置app的显示名称"><span class="nav-number">5.5.4.</span> <span class="nav-text">apps.py配置app的显示名称</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义导航菜单顺序"><span class="nav-number">5.5.5.</span> <span class="nav-text">自定义导航菜单顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志记录的使用"><span class="nav-number">5.5.6.</span> <span class="nav-text">日志记录的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#完成登录-注册-找回密码-激活-验证码集成"><span class="nav-number">6.</span> <span class="nav-text">完成登录 注册 找回密码 激活 验证码集成</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-首页和登录页面的配置"><span class="nav-number">6.1.</span> <span class="nav-text">6-1 首页和登录页面的配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建static目录-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">新建static目录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置处理静态文件的url。"><span class="nav-number">6.1.1.1.</span> <span class="nav-text">配置处理静态文件的url。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置static文件"><span class="nav-number">6.1.2.</span> <span class="nav-text">设置static文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改index页面中前端样式的引用地址"><span class="nav-number">6.1.3.</span> <span class="nav-text">修改index页面中前端样式的引用地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝登录页面到template"><span class="nav-number">6.1.4.</span> <span class="nav-text">拷贝登录页面到template</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#url配置跳转登录页面"><span class="nav-number">6.1.4.1.</span> <span class="nav-text">url配置跳转登录页面</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-用户登录-1"><span class="nav-number">6.2.</span> <span class="nav-text">6-2 用户登录-1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-用户登录2"><span class="nav-number">6.3.</span> <span class="nav-text">6-3 用户登录2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#html-form基础知识"><span class="nav-number">6.3.1.</span> <span class="nav-text">html form基础知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#改造为使用邮箱用户名均可。Setting中重载变量"><span class="nav-number">6.3.2.</span> <span class="nav-text">改造为使用邮箱用户名均可。Setting中重载变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用户提示：return页面时提供它的错误信息"><span class="nav-number">6.3.3.</span> <span class="nav-text">用户提示：return页面时提供它的错误信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-用form实现登录-1"><span class="nav-number">6.4.</span> <span class="nav-text">6-4 用form实现登录-1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-form字段验证"><span class="nav-number">6.5.</span> <span class="nav-text">6-5 form字段验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#完善错误提示"><span class="nav-number">6.5.1.</span> <span class="nav-text">完善错误提示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将forms错误信息显示出来"><span class="nav-number">6.5.2.</span> <span class="nav-text">将forms错误信息显示出来</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-6-session和cookie自动登录机制"><span class="nav-number">6.6.</span> <span class="nav-text">6-6 session和cookie自动登录机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cookie的存储"><span class="nav-number">6.6.1.</span> <span class="nav-text">cookie的存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http请求是一种无状态的请求"><span class="nav-number">6.6.2.</span> <span class="nav-text">http请求是一种无状态的请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#有状态请求-cookie"><span class="nav-number">6.6.3.</span> <span class="nav-text">有状态请求(cookie)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决cookie放在本地不安全的问题-session"><span class="nav-number">6.6.4.</span> <span class="nav-text">解决cookie放在本地不安全的问题(session)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-7-用户注册"><span class="nav-number">6.7.</span> <span class="nav-text">6-7 用户注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝注册页面进入template目录"><span class="nav-number">6.7.1.</span> <span class="nav-text">拷贝注册页面进入template目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#书写我们对应要处理的view-RegisterView"><span class="nav-number">6.7.2.</span> <span class="nav-text">书写我们对应要处理的view(RegisterView)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置对应的url"><span class="nav-number">6.7.3.</span> <span class="nav-text">配置对应的url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改index页面中注册url"><span class="nav-number">6.7.4.</span> <span class="nav-text">修改index页面中注册url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改静态文件中static目录引用"><span class="nav-number">6.7.5.</span> <span class="nav-text">修改静态文件中static目录引用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关键步骤load-staticfile"><span class="nav-number">6.7.5.1.</span> <span class="nav-text">关键步骤load staticfile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#然后修改路径为一个相对于static的相对路径"><span class="nav-number">6.7.5.2.</span> <span class="nav-text">然后修改路径为一个相对于static的相对路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#将目前的三个html中的静态文件全部修改目录"><span class="nav-number">6.7.5.3.</span> <span class="nav-text">将目前的三个html中的静态文件全部修改目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证码库实现验证码"><span class="nav-number">6.7.6.</span> <span class="nav-text">验证码库实现验证码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装配置"><span class="nav-number">6.7.6.1.</span> <span class="nav-text">安装配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将验证码展示到页面"><span class="nav-number">6.7.7.</span> <span class="nav-text">将验证码展示到页面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义我们的register-form"><span class="nav-number">6.7.7.1.</span> <span class="nav-text">定义我们的register form:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在我们的registerform中实例化并传送到前端"><span class="nav-number">6.7.7.2.</span> <span class="nav-text">在我们的registerform中实例化并传送到前端:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#前端获取验证码值"><span class="nav-number">6.7.7.3.</span> <span class="nav-text">前端获取验证码值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写register-view的后台逻辑-RegisterView"><span class="nav-number">6.7.8.</span> <span class="nav-text">编写register view的后台逻辑(RegisterView)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取前端页面值并封装成一个user-profile对象，保存到数据库。"><span class="nav-number">6.7.8.1.</span> <span class="nav-text">获取前端页面值并封装成一个user_profile对象，保存到数据库。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送邮件实现"><span class="nav-number">6.7.8.2.</span> <span class="nav-text">发送邮件实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完善错误提示。"><span class="nav-number">6.7.8.3.</span> <span class="nav-text">完善错误提示。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完善用户值回填逻辑"><span class="nav-number">6.7.8.4.</span> <span class="nav-text">完善用户值回填逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改默认的激活状态为false"><span class="nav-number">6.7.8.5.</span> <span class="nav-text">修改默认的激活状态为false</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-8-找回密码"><span class="nav-number">6.8.</span> <span class="nav-text">6-8 找回密码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#拷入forgetpassword页面"><span class="nav-number">6.8.1.</span> <span class="nav-text">拷入forgetpassword页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#书写处理忘记密码的view"><span class="nav-number">6.8.2.</span> <span class="nav-text">书写处理忘记密码的view</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#login-html中忘记密码"><span class="nav-number">6.8.2.1.</span> <span class="nav-text">login html中忘记密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置忘记密码页面中静态文件。"><span class="nav-number">6.8.2.2.</span> <span class="nav-text">配置忘记密码页面中静态文件。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义一个给forget的form"><span class="nav-number">6.8.2.3.</span> <span class="nav-text">定义一个给forget的form</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加验证码"><span class="nav-number">6.8.2.4.</span> <span class="nav-text">添加验证码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#html中加上验证码"><span class="nav-number">6.8.2.5.</span> <span class="nav-text">html中加上验证码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#post中逻辑"><span class="nav-number">6.8.2.6.</span> <span class="nav-text">post中逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#邮箱重置密码邮件发送"><span class="nav-number">6.8.2.7.</span> <span class="nav-text">邮箱重置密码邮件发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#前端页面添加错误信息"><span class="nav-number">6.8.2.8.</span> <span class="nav-text">前端页面添加错误信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#书写重置密码view"><span class="nav-number">6.8.2.9.</span> <span class="nav-text">书写重置密码view</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置重置密码url"><span class="nav-number">6.8.2.10.</span> <span class="nav-text">配置重置密码url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝进来password-reset页面"><span class="nav-number">6.8.2.11.</span> <span class="nav-text">拷贝进来password reset页面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建改变密码的forms"><span class="nav-number">6.8.2.12.</span> <span class="nav-text">创建改变密码的forms:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#书写改变密码的view；"><span class="nav-number">6.8.2.13.</span> <span class="nav-text">书写改变密码的view；</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置modify的url。"><span class="nav-number">6.8.2.14.</span> <span class="nav-text">配置modify的url。</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#完成授课机构的功能实现。"><span class="nav-number">7.</span> <span class="nav-text">完成授课机构的功能实现。</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-django-templates模板继承1"><span class="nav-number">7.1.</span> <span class="nav-text">7-1 django templates模板继承1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Django-template-共用头部底部机制"><span class="nav-number">7.1.1.</span> <span class="nav-text">Django template 共用头部底部机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include的问题"><span class="nav-number">7.1.2.</span> <span class="nav-text">include的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template中新建base-html"><span class="nav-number">7.1.3.</span> <span class="nav-text">template中新建base.html</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义父模板-包含head-amp-footer"><span class="nav-number">7.1.4.</span> <span class="nav-text">定义父模板: 包含head &amp; footer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-开始orglist编写"><span class="nav-number">7.2.</span> <span class="nav-text">7-2 开始orglist编写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改面包屑"><span class="nav-number">7.2.1.</span> <span class="nav-text">修改面包屑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-课程机构列表页数据展示1"><span class="nav-number">7.3.</span> <span class="nav-text">7-3 课程机构列表页数据展示1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#models中添加机构类别"><span class="nav-number">7.3.1.</span> <span class="nav-text">models中添加机构类别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完善我们的view"><span class="nav-number">7.3.2.</span> <span class="nav-text">完善我们的view</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-课程机构列表页数据展示2"><span class="nav-number">7.4.</span> <span class="nav-text">7-4 课程机构列表页数据展示2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前去html中进行数据填充"><span class="nav-number">7.4.1.</span> <span class="nav-text">前去html中进行数据填充</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何将imageField转换为图片地址"><span class="nav-number">7.4.2.</span> <span class="nav-text">如何将imageField转换为图片地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置media处理器"><span class="nav-number">7.4.3.</span> <span class="nav-text">设置media处理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完善xadmin的adminx为机构添加分类索引字段"><span class="nav-number">7.4.4.</span> <span class="nav-text">完善xadmin的adminx为机构添加分类索引字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#去除加载小圈圈"><span class="nav-number">7.4.5.</span> <span class="nav-text">去除加载小圈圈</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5-列表分页功能"><span class="nav-number">7.5.</span> <span class="nav-text">7-5 列表分页功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对于html中分页进行配置"><span class="nav-number">7.5.1.</span> <span class="nav-text">对于html中分页进行配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义html的样式"><span class="nav-number">7.5.2.</span> <span class="nav-text">自定义html的样式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6-分类筛选功能"><span class="nav-number">7.6.</span> <span class="nav-text">7-6 分类筛选功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在后台处理这个city"><span class="nav-number">7.6.1.</span> <span class="nav-text">在后台处理这个city</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后台处理类别"><span class="nav-number">7.6.2.</span> <span class="nav-text">后台处理类别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#课程机构排名"><span class="nav-number">7.6.3.</span> <span class="nav-text">课程机构排名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#课程机构排序。"><span class="nav-number">7.6.4.</span> <span class="nav-text">课程机构排序。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-7-modelform-提交我要学习咨询1"><span class="nav-number">7.7.</span> <span class="nav-text">7-7 modelform 提交我要学习咨询1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#include的机制配置应用自己的url"><span class="nav-number">7.7.1.</span> <span class="nav-text">include的机制配置应用自己的url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用modelform做提交"><span class="nav-number">7.7.2.</span> <span class="nav-text">使用modelform做提交</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置相应的url"><span class="nav-number">7.7.3.</span> <span class="nav-text">配置相应的url</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-8-modelform-提交我要学习"><span class="nav-number">7.8.</span> <span class="nav-text">7-8 modelform 提交我要学习</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分析ajax请求"><span class="nav-number">7.8.1.</span> <span class="nav-text">分析ajax请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手机号码正则表达式验证"><span class="nav-number">7.8.2.</span> <span class="nav-text">手机号码正则表达式验证:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-9-机构详情"><span class="nav-number">7.9.</span> <span class="nav-text">7-9 机构详情</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为讲师增加头像字段"><span class="nav-number">7.9.1.</span> <span class="nav-text">为讲师增加头像字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置访问的view和url"><span class="nav-number">7.9.2.</span> <span class="nav-text">配置访问的view和url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#左侧active修改"><span class="nav-number">7.9.3.</span> <span class="nav-text">左侧active修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-10-课程机构收藏功能"><span class="nav-number">7.10.</span> <span class="nav-text">7-10 课程机构收藏功能</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#课程相关功能实现"><span class="nav-number">8.</span> <span class="nav-text">课程相关功能实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-课程列表"><span class="nav-number">8.1.</span> <span class="nav-text">8-1 课程列表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分页功能"><span class="nav-number">8.1.1.</span> <span class="nav-text">分页功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对于页码进行修改"><span class="nav-number">8.1.2.</span> <span class="nav-text">对于页码进行修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排序功能"><span class="nav-number">8.1.3.</span> <span class="nav-text">排序功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-课程详情页1"><span class="nav-number">8.2.</span> <span class="nav-text">8-2 课程详情页1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-课程详情页2"><span class="nav-number">8.3.</span> <span class="nav-text">8-3 课程详情页2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#课程是否相关"><span class="nav-number">8.3.1.</span> <span class="nav-text">课程是否相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#收藏功能"><span class="nav-number">8.3.2.</span> <span class="nav-text">收藏功能:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-课程章节信息"><span class="nav-number">8.4.</span> <span class="nav-text">8-4 课程章节信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-章节视频信息"><span class="nav-number">8.5.</span> <span class="nav-text">8-5 章节视频信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-6-课程评论页面"><span class="nav-number">8.6.</span> <span class="nav-text">8-6 课程评论页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-7-相关课程推荐"><span class="nav-number">8.7.</span> <span class="nav-text">8-7 相关课程推荐:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-8-课程播放页面"><span class="nav-number">8.8.</span> <span class="nav-text">8-8 课程播放页面</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#讲师相关功能实现"><span class="nav-number">9.</span> <span class="nav-text">讲师相关功能实现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-讲师列表页"><span class="nav-number">9.1.</span> <span class="nav-text">9-1 讲师列表页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#书写view与配置url"><span class="nav-number">9.1.1.</span> <span class="nav-text">书写view与配置url</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分页仿照orglist-注意object-list"><span class="nav-number">9.1.2.</span> <span class="nav-text">分页仿照orglist 注意object_list</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排序-amp-讲师排行榜"><span class="nav-number">9.1.3.</span> <span class="nav-text">排序 &amp; 讲师排行榜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-讲师详情页"><span class="nav-number">9.2.</span> <span class="nav-text">9-2 讲师详情页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置url和view"><span class="nav-number">9.2.1.</span> <span class="nav-text">配置url和view</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#全局导航-amp-个人中心-amp-全局搜索"><span class="nav-number">10.</span> <span class="nav-text">全局导航&amp;个人中心&amp;全局搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置全局导航"><span class="nav-number">10.1.</span> <span class="nav-text">配置全局导航</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#全局搜索功能开发"><span class="nav-number">10.2.</span> <span class="nav-text">全局搜索功能开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#个人中心信息展示"><span class="nav-number">10.3.</span> <span class="nav-text">个人中心信息展示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改密码和修改头像"><span class="nav-number">10.4.</span> <span class="nav-text">修改密码和修改头像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改邮箱提交form表单"><span class="nav-number">10.5.</span> <span class="nav-text">修改邮箱提交form表单</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取验证码接口"><span class="nav-number">10.5.1.</span> <span class="nav-text">获取验证码接口:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改邮箱的view"><span class="nav-number">10.5.2.</span> <span class="nav-text">修改邮箱的view</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置url和view-1"><span class="nav-number">10.5.3.</span> <span class="nav-text">配置url和view</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置view和url"><span class="nav-number">10.5.4.</span> <span class="nav-text">配置view和url</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#取消收藏"><span class="nav-number">10.6.</span> <span class="nav-text">取消收藏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#我的消息页面"><span class="nav-number">10.7.</span> <span class="nav-text">我的消息页面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置url和view-2"><span class="nav-number">10.7.1.</span> <span class="nav-text">配置url和view</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注册时发生欢迎消息"><span class="nav-number">10.7.2.</span> <span class="nav-text">注册时发生欢迎消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面顶部小喇叭"><span class="nav-number">10.7.3.</span> <span class="nav-text">页面顶部小喇叭</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#首页-全局功能细节和404以及500页面配置"><span class="nav-number">11.</span> <span class="nav-text">首页,全局功能细节和404以及500页面配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#登出和点击数以及收藏数完善"><span class="nav-number">11.1.</span> <span class="nav-text">登出和点击数以及收藏数完善</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#退出登录"><span class="nav-number">11.1.1.</span> <span class="nav-text">退出登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#点击数加1"><span class="nav-number">11.1.2.</span> <span class="nav-text">点击数加1</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#首页功能开发"><span class="nav-number">11.2.</span> <span class="nav-text">首页功能开发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置全局404和500"><span class="nav-number">11.3.</span> <span class="nav-text">配置全局404和500</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常见web攻击及防范"><span class="nav-number">12.</span> <span class="nav-text">常见web攻击及防范</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#sql注入攻击与防范"><span class="nav-number">12.1.</span> <span class="nav-text">sql注入攻击与防范</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xss攻击"><span class="nav-number">12.2.</span> <span class="nav-text">xss攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#crsf攻击与防护"><span class="nav-number">12.3.</span> <span class="nav-text">crsf攻击与防护</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#xadmin的进阶开发"><span class="nav-number">13.</span> <span class="nav-text">xadmin的进阶开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#static目录问题。"><span class="nav-number">13.1.</span> <span class="nav-text">static目录问题。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义icon"><span class="nav-number">13.2.</span> <span class="nav-text">自定义icon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#默认排序"><span class="nav-number">13.3.</span> <span class="nav-text">默认排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下拉框搜索："><span class="nav-number">13.4.</span> <span class="nav-text">下拉框搜索：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#inlines添加数据。"><span class="nav-number">13.5.</span> <span class="nav-text">inlines添加数据。</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一张表分两个model来管理"><span class="nav-number">13.6.</span> <span class="nav-text">一张表分两个model来管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xamdin其他常见功能："><span class="nav-number">13.7.</span> <span class="nav-text">xamdin其他常见功能：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#可以在列表上快速修改内容、"><span class="nav-number">13.7.1.</span> <span class="nav-text">可以在列表上快速修改内容、</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义函数作为列"><span class="nav-number">13.7.2.</span> <span class="nav-text">自定义函数作为列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#显示自定义的html代码"><span class="nav-number">13.7.3.</span> <span class="nav-text">显示自定义的html代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xadmin的工具-refresh"><span class="nav-number">13.7.4.</span> <span class="nav-text">xadmin的工具: refresh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段联动"><span class="nav-number">13.7.5.</span> <span class="nav-text">字段联动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xadmin自行探究"><span class="nav-number">13.8.</span> <span class="nav-text">xadmin自行探究</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载源码包"><span class="nav-number">13.8.1.</span> <span class="nav-text">下载源码包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#导入excel"><span class="nav-number">13.9.</span> <span class="nav-text">导入excel</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#把项目部署上线"><span class="nav-number">14.</span> <span class="nav-text">把项目部署上线</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">mtianyan</span><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共179.9k字</span></div></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="site-uv">本站访客数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人次</span> <span class="site-pv">本站总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script type="text/javascript">!function(){var t="1eb79150519fd9b791c77e8eef6f3632";if((window.innerWidth||document.documentElement.clientWidth)<960)window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=cyrJmJ3rL&conf='+t+'"><\/script>');else{!function(t,e){var n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:"cyrJmJ3rL",conf:t})})}}()</script><script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script><script type="text/javascript">var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")};function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){var r=!1,s=0,a=0,i=n.title.trim(),c=i.toLowerCase(),l=n.content.trim().replace(/<[^>]+>/g,""),h=l.toLowerCase(),p=decodeURIComponent(n.url),u=[],f=[];if(""!=i&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}u=u.concat(e(t,c,!1)),f=f.concat(e(t,h,!1))}),(u.length>0||f.length>0)&&(r=!0,s=u.length+f.length)),r){[u,f].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});function d(e,o,n,r){for(var s=r[r.length-1],i=s.position,c=s.word,l=[],h=0;i+c.length<=n&&0!=r.length;){c===t&&h++,l.push({position:i,length:c.length});var p=i+c.length;for(r.pop();0!=r.length&&(i=(s=r[r.length-1]).position,c=s.word,p>i);)r.pop()}return a+=h,{hits:l,start:o,end:n,searchTextCount:h}}var g=[];0!=u.length&&g.push(d(0,0,i.length,u));for(var v=[];0!=f.length;){var $=f[f.length-1],C=$.position,m=$.word,x=C-20,w=C+80;x<0&&(x=0),w<C+m.length&&(w=C+m.length),w>l.length&&(w=l.length),v.push(d(0,x,w,f))}v.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var y=parseInt("1");y>=0&&(v=v.slice(0,y));function T(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var b="";0!=g.length?b+="<li><a href='"+p+"' class='search-result-title'>"+T(i,g[0])+"</a>":b+="<li><a href='"+p+"' class='search-result-title'>"+i+"</a>",v.forEach(function(t){b+="<a href='"+p+'\'><p class="search-result">'+T(l,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:a,hitCount:s,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("2uqmIjYredIvFy6tEXbKG4Fj-gzGzoHsz","CWl1rE8cQlIseOg2Cq3hzxYi")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var i=0;i<e.length;i++){var s=e[i],r=s.get("url"),l=s.get("time"),c=document.getElementById(r);$(c).find(t).text(l)}for(i=0;i<n.length;i++){r=n[i],c=document.getElementById(r);var u=$(c).find(t);""==u.text()&&u.text(0)}}else o.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,r=new AV.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0),s.setACL(r),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="default",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="default",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script><script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><div id="hexo-helper-live2d"><canvas id="live2dcanvas" width="150" height="300"></canvas></div><style>#live2dcanvas{position:fixed;width:150px;height:300px;opacity:.7;right:-30px;z-index:999;pointer-events:none;bottom:40px}</style><script type="text/javascript" src="/live2d/device.min.js"></script><script type="text/javascript">
const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    var trElement = document.getElementById('hexo-helper-live2d');
    trElement.parentNode.removeChild(trElement);
    return;
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/hijiki.model.json", 0.5);});
})();
</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>