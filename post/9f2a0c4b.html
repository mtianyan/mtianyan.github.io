<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3"><link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="Python,Django,在线教育平台,"><link rel="alternate" href="/atom.xml" title="mtianyan's blog" type="application/atom+xml"><meta name="description" content="三年六班，三年六班，李子明，李子明同学，你妈妈拿了两罐旺仔牛奶给你   上帝说得有课程！ 得有详情 ！点了开始学习，得有章节！章节得有视频。课程还得能评论下，还得有相关课程。于是这章出现了。"><meta name="keywords" content="Python,Django,在线教育平台"><meta property="og:type" content="article"><meta property="og:title" content="强力Django+杀手级Xadmin打造在线教育平台(八)"><meta property="og:url" content="http://blog.mtianyan.cn/post/9f2a0c4b.html"><meta property="og:site_name" content="mtianyan&#39;s blog"><meta property="og:description" content="三年六班，三年六班，李子明，李子明同学，你妈妈拿了两罐旺仔牛奶给你   上帝说得有课程！ 得有详情 ！点了开始学习，得有章节！章节得有视频。课程还得能评论下，还得有相关课程。于是这章出现了。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/32hbAB04ec.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/L1Jm283bck.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/JBm95D0fK8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/L7Ibjh9g72.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/0DhjiABaA4.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/al219GFJJ1.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/FkIJ7mCjH3.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/ji6bee4D31.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/Jb07I8Ef1f.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/6Ca5l1lBCf.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/mk6Gb823k6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/HKLll9bL4F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/3kmjFehf7F.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/93LBHie41d.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/F0jLggJge6.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/8fDFkB7DIm.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/37jDHdha1l.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/KJc25I0KF8.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/mKHhjj2d32.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/D4L8a0lmI0.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/hBAAmHlm4g.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/5GjjhDe40D.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/CL7fke0LGF.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/f0j8Ffec87.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/kCAHJkbAdb.png?imageslim"><meta property="og:image" content="http://myphoto.mtianyan.cn/blog/180113/26FehA9AAf.png?imageslim"><meta property="og:updated_time" content="2018-01-16T16:42:24.731Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="强力Django+杀手级Xadmin打造在线教育平台(八)"><meta name="twitter:description" content="三年六班，三年六班，李子明，李子明同学，你妈妈拿了两罐旺仔牛奶给你   上帝说得有课程！ 得有详情 ！点了开始学习，得有章节！章节得有视频。课程还得能评论下，还得有相关课程。于是这章出现了。"><meta name="twitter:image" content="http://myphoto.mtianyan.cn/blog/180113/32hbAB04ec.png?imageslim"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.mtianyan.cn/post/9f2a0c4b.html"><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement("script"),n=t.getElementsByTagName("script")[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,0,("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"e28768be"}),daovoice("update")</script><title>强力Django+杀手级Xadmin打造在线教育平台(八) | mtianyan's blog</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?415372bd35fec36f7558dd96b48ec03f";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/mtianyan" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">mtianyan's blog</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">天涯明月笙的博客小站(Github托管)</p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br> 公益404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://blog.mtianyan.cn/post/9f2a0c4b.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="mtianyan"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="mtianyan's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">强力Django+杀手级Xadmin打造在线教育平台(八)</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-13T22:09:17+08:00">2018-01-13</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Django-Xadmin打造在线教育平台/" itemprop="url" rel="index"><span itemprop="name">Django+Xadmin打造在线教育平台</span></a></span></span> <span id="/post/9f2a0c4b.html" class="leancloud_visitors" data-flag-title="强力Django+杀手级Xadmin打造在线教育平台(八)"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">热度&#58;</span><span class="leancloud-visitors-count"></span> <span>℃</span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3,330</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">15</span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote class="blockquote-center"><p>三年六班，三年六班，李子明，李子明同学，你妈妈拿了两罐旺仔牛奶给你</p></blockquote><div class="note success"><p>上帝说得有课程！ 得有详情 ！点了开始学习，得有章节！章节得有视频。<br>课程还得能评论下，还得有相关课程。于是这章出现了。</p></div><a id="more"></a><h2 id="8-1-课程列表"><a href="#8-1-课程列表" class="headerlink" title="8-1 课程列表"></a>8-1 课程列表</h2><p>拷贝课程列表页到template目录</p><p>创建课程相关的urls.py</p><p>Mxonline2/urls.py中声明包含到course的url中：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程app的url配置</span><br><span class="line">url(r&quot;^course/&quot;, include(&apos;courses.urls&apos;, namespace=&quot;course&quot;)),</span><br></pre></td></tr></table></figure><p>django2.0.1版本:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程app的url配置</span><br><span class="line">path(&quot;course/&quot;, include(&apos;courses.urls&apos;, namespace=&quot;course&quot;)),</span><br></pre></td></tr></table></figure><p>书写处理列表展示相关的view</p><p>courses/views.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123; &#125;)</span><br></pre></td></tr></table></figure><p>courses/urls.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from courses.views import CourseListView</span><br><span class="line"></span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/13 0013 00:39&apos;</span><br><span class="line"></span><br><span class="line">from django.conf.urls import url</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    # 课程列表url</span><br><span class="line">    url(r&apos;^list/$&apos;, CourseListView.as_view(), name=&quot;list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>django2.0.1版本:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">__author__ = &apos;mtianyan&apos;</span><br><span class="line">__date__ = &apos;2018/1/13 0013 01:57&apos;</span><br><span class="line"></span><br><span class="line"># encoding: utf-8</span><br><span class="line">from courses.views import CourseListView</span><br><span class="line">from django.urls import path</span><br><span class="line">app_name = &quot;courses&quot;</span><br><span class="line">urlpatterns = [</span><br><span class="line">    # 课程列表url</span><br><span class="line">    path(&apos;list/&apos;, CourseListView.as_view(), name=&quot;list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>此时访问没有样式。我们开始对于course list html进行工作<br>可以观察到它和orglist一样可以有共同的头尾。所以继承base页面</p><p>xadmin中添加一些课程。</p><p>然后在view中返回课程数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_course = Course.objects.all()</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_course&quot;:all_course,</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180113/32hbAB04ec.png?imageslim" alt="mark"></p><p>保留一个div</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/L1Jm283bck.png?imageslim" alt="mark"></p><blockquote><p>通过外键字段取外键表中字段</p></blockquote><h3 id="分页功能"><a href="#分页功能" class="headerlink" title="分页功能"></a>分页功能</h3><p>拷贝代码:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from pure_pagination import Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"> # 对课程机构进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page = request.GET.get(&apos;page&apos;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page = 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p = Paginator(all_orgs, 4, request=request)</span><br><span class="line">        orgs = p.page(page)</span><br></pre></td></tr></table></figure><p>改动完成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_course = Course.objects.all()</span><br><span class="line">        # 对课程进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page = request.GET.get(&apos;page&apos;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page = 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p = Paginator(all_course,6 , request=request)</span><br><span class="line">        courses = p.page(page)</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_course&quot;:courses,</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>在html中使用时注意object_list</p><blockquote><p>此时的all_course已经不是一个queryset，而是一个purepage对象。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180113/JBm95D0fK8.png?imageslim" alt="mark"></p><h3 id="对于页码进行修改"><a href="#对于页码进行修改" class="headerlink" title="对于页码进行修改"></a>对于页码进行修改</h3><p><img src="http://myphoto.mtianyan.cn/blog/180113/L7Ibjh9g72.png?imageslim" alt="mark"></p><p>直接把orglist中的那段拿过来就行了。自行替换变量名称</p><p>此时已经好了。</p><h3 id="排序功能"><a href="#排序功能" class="headerlink" title="排序功能"></a>排序功能</h3><p>将之前的sort逻辑拷贝过来:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">        sort = request.GET.get(&apos;sort&apos;, &quot;&quot;)</span><br><span class="line">        if sort:</span><br><span class="line">            if sort == &quot;students&quot;:</span><br><span class="line">                all_orgs = all_orgs.order_by(&quot;-students&quot;)</span><br><span class="line">            elif sort == &quot;courses&quot;:</span><br><span class="line">                all_orgs = all_orgs.order_by(&quot;-course_nums&quot;)</span><br></pre></td></tr></table></figure><p>修改完成:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">sort = request.GET.get(&apos;sort&apos;, &quot;&quot;)</span><br><span class="line">if sort:</span><br><span class="line">    if sort == &quot;students&quot;:</span><br><span class="line">        all_course = all_course.order_by(&quot;-students&quot;)</span><br><span class="line">    elif sort == &quot;hot&quot;:</span><br><span class="line">        all_course = all_course.order_by(&quot;-click_nums&quot;)</span><br></pre></td></tr></table></figure><p>应放在分页之前。让分页处理所有筛选过的数据</p><p>return render时添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;sort&quot;:sort,</span><br></pre></td></tr></table></figure><blockquote><p>用来判断激活状态。</p></blockquote><p><img src="http://myphoto.mtianyan.cn/blog/180113/0DhjiABaA4.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/al219GFJJ1.png?imageslim" alt="mark"></p><p>修改a标签参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 热门课程推荐</span><br><span class="line">    hot_courses = Course.objects.all().order_by(&quot;-students&quot;)[:3]</span><br><span class="line">    return render</span><br><span class="line">     &quot;hot_courses&quot;:hot_courses</span><br></pre></td></tr></table></figure><p>修改html中<br><img src="http://myphoto.mtianyan.cn/blog/180113/FkIJ7mCjH3.png?imageslim" alt="mark"></p><p>for循环填充内容</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/ji6bee4D31.png?imageslim" alt="mark"></p><p>这里的degree我们在数据库中填写的是字母。如何显示为中文。</p><ul><li>个人猜测: template if</li></ul><p>get_degree_display degree是字段名。专门用于choice字段显示</p><p>本小节完成对应commit：</p><blockquote><p>8-1完成课程列表页展示，分页，热门课程。</p></blockquote><h2 id="8-2-课程详情页1"><a href="#8-2-课程详情页1" class="headerlink" title="8-2 课程详情页1"></a>8-2 课程详情页1</h2><p>拷贝course_detail进入template目录</p><p>可以看出这个页面也是继承base页面的。将course_list的页面框架拿过来</p><p>替换面包屑。</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/Jb07I8Ef1f.png?imageslim" alt="mark"></p><p>配置url访问</p><p>django2.0.1：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程详情页</span><br><span class="line">re_path(&apos;course/(?P&lt;course_id&gt;\d+)/&apos;, CourseDetailView.as_view(), name=&quot;course_detail&quot;),</span><br></pre></td></tr></table></figure><p>书写对应访问的view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> 课程详情处理view</span><br><span class="line"></span><br><span class="line">class CourseDetailView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        return  render(request, &quot;course-detail.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>尝试访问：</p><p>在列表展示页放入详情的url。</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/6Ca5l1lBCf.png?imageslim" alt="mark"></p><p>有参数类型的把参数也传进来</p><p>进行数据填充:先取出当前的课程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 此处的id为表默认为我们添加的值。</span><br><span class="line">course = Course.objects.get(id = int(course_id))</span><br><span class="line"></span><br><span class="line">        return  render(request, &quot;course-detail.html&quot;, &#123;</span><br><span class="line">    &quot;course&quot;:course,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>html中取出数据:</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/mk6Gb823k6.png?imageslim" alt="mark"></p><p>课程的章节数如何实现？</p><p>models.py中自定义方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def get_zj_nums(self):</span><br><span class="line">    # 获取课程章节数的方法</span><br><span class="line">    return self.lesson_set.all().count()</span><br></pre></td></tr></table></figure><p>添加课程类别字段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category = models.CharField(max_length=20, default=u&quot;&quot;, verbose_name=u&quot;课程类别&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure><p>operation中专门有张表是做用户学习记录的。</p><p>UserCourse查询有哪些学生学习了这门课</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 获取学习这门课程的用户</span><br><span class="line">def get_learn_users(self):</span><br><span class="line">    # 谁的里面添加了它做外键，他都可以取出来</span><br><span class="line">    return self.usercourse_set.all()[:5]</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180113/HKLll9bL4F.png?imageslim" alt="mark"></p><p>链式调用取出数据</p><p>添加一些用户课程进行验证</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/3kmjFehf7F.png?imageslim" alt="mark"></p><p>可以看到已经大功告成</p><p>课程详情的view中添加clicknums+1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 增加课程点击数</span><br><span class="line">course.click_nums += 1</span><br><span class="line">course.save()</span><br></pre></td></tr></table></figure><p><img src="http://myphoto.mtianyan.cn/blog/180113/93LBHie41d.png?imageslim" alt="mark"></p><h2 id="8-3-课程详情页2"><a href="#8-3-课程详情页2" class="headerlink" title="8-3 课程详情页2"></a>8-3 课程详情页2</h2><p><img src="http://myphoto.mtianyan.cn/blog/180113/F0jLggJge6.png?imageslim" alt="mark"></p><p>tab_cont1 中填充我们自己的内容。</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/8fDFkB7DIm.png?imageslim" alt="mark"></p><p>教师数自定义函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def get_teacher_nums:</span><br><span class="line">	return self.teacher_set.all().count</span><br></pre></td></tr></table></figure><p>不用自定义函数的方法如下</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/37jDHdha1l.png?imageslim" alt="mark"></p><h3 id="课程是否相关"><a href="#课程是否相关" class="headerlink" title="课程是否相关"></a>课程是否相关</h3><p>定义课程的tag ，如果tag相同，那么是相关课程。</p><p>courses/models.py:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tag = models.CharField(max_length=15, verbose_name=u&quot;课程标签&quot;, default=u&quot;&quot;)</span><br></pre></td></tr></table></figure><p>更改数据库后必然。此处略。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tag = course.tag</span><br><span class="line">       if tag:</span><br><span class="line">       # 需要从1开始不然会推荐自己</span><br><span class="line">           relate_courses = Course.objects.filter(tag=tag)[1:2]</span><br><span class="line">       else:</span><br><span class="line">           relate_courses = []</span><br></pre></td></tr></table></figure><p>return render加上：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;relate_courses&quot;:relate_courses,</span><br></pre></td></tr></table></figure><h3 id="收藏功能"><a href="#收藏功能" class="headerlink" title="收藏功能:"></a>收藏功能:</h3><p>将block js写到页面底部。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">//收藏分享</span><br><span class="line">function add_fav(current_elem, fav_id, fav_type)&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        cache: false,</span><br><span class="line">        type: &quot;POST&quot;,</span><br><span class="line">        url:&quot;&#123;% url &quot;org:add_fav&quot; %&#125;&quot;,</span><br><span class="line">        data:&#123;&apos;fav_id&apos;:fav_id, &apos;fav_type&apos;:fav_type&#125;,</span><br><span class="line">        async: true,</span><br><span class="line">        beforeSend:function(xhr, settings)&#123;</span><br><span class="line">            xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token &#125;&#125;&quot;);</span><br><span class="line">        &#125;,</span><br><span class="line">        success: function(data) &#123;</span><br><span class="line">            if(data.status == &apos;fail&apos;)&#123;</span><br><span class="line">                if(data.msg == &apos;用户未登录&apos;)&#123;</span><br><span class="line">                    window.location.href=&quot;/login/&quot;;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    alert(data.msg)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;else if(data.status == &apos;success&apos;)&#123;</span><br><span class="line">                current_elem.text(data.msg)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(&apos;#jsLeftBtn&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">    add_fav($(this), &#123;&#123; course.id &#125;&#125;, 1);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$(&apos;#jsRightBtn&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">    add_fav($(this), &#123;&#123; course.course_org.id &#125;&#125;, 2);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>刷新后又不见了的问题，从view中传递has_fav的参数。前台进行判断。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 是否收藏课程</span><br><span class="line">      has_fav_course = False</span><br><span class="line">      has_fav_org = False</span><br><span class="line"></span><br><span class="line">      # 必须是用户已登录我们才需要判断。</span><br><span class="line">      if request.user.is_authenticated:</span><br><span class="line">          if UserFavorite.objects.filter(user=request.user, fav_id=course.id, fav_type=1):</span><br><span class="line">              has_fav_course = True</span><br><span class="line">          if UserFavorite.objects.filter(user=request.user, fav_id=course.course_org.id, fav_type=2):</span><br><span class="line">              has_fav_org = True</span><br></pre></td></tr></table></figure><p>return render</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;has_fav_course&quot;:has_fav_course,</span><br><span class="line">&quot;has_fav_org&quot;:has_fav_org,</span><br></pre></td></tr></table></figure><p>html中使用；</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/KJc25I0KF8.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/mKHhjj2d32.png?imageslim" alt="mark"></p><blockquote><p>8-2&amp;3完成课程详情页展示，课程详情页机构，相关推荐课程。收藏课程，收藏机构。</p></blockquote><h2 id="8-4-课程章节信息"><a href="#8-4-课程章节信息" class="headerlink" title="8-4 课程章节信息"></a>8-4 课程章节信息</h2><p>章节信息，评论信息。</p><p>course comments 和 course video放入 template</p><p>它也有head和foot继承我们的base页面</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/D4L8a0lmI0.png?imageslim" alt="mark"></p><p>配置相应的url:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 处理课程章节信息页面的view</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseInfoView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, course_id)</span>:</span></span><br><span class="line">        <span class="comment"># 此处的id为表默认为我们添加的值。</span></span><br><span class="line">        course = Course.objects.get(id=int(course_id))</span><br><span class="line">        <span class="comment"># 是否收藏课程</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"course-video.html"</span>, &#123;</span><br><span class="line">            <span class="string">"course"</span>: course,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程章节信息页</span><br><span class="line">url(r&apos;^info/(?P&lt;course_id&gt;\d+)/$&apos;, CourseInfoView.as_view(), name=&quot;course_info&quot;),</span><br></pre></td></tr></table></figure><p>用户点击开始学习链接修改</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/hBAAmHlm4g.png?imageslim" alt="mark"></p><p>为课程添加章节以及视频。</p><h2 id="8-5-章节视频信息"><a href="#8-5-章节视频信息" class="headerlink" title="8-5 章节视频信息"></a>8-5 章节视频信息</h2><p>为video表添加视频对应的url信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = models.CharField(max_length=200, default=&quot;http://blog.mtianyan.cn/&quot; ,verbose_name=u&quot;访问地址&quot;)</span><br></pre></td></tr></table></figure><p>将章节信息填充进页面</p><p>通过课程可以找到章节:course.lesson_set</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/5GjjhDe40D.png?imageslim" alt="mark"></p><p>video的时长添加</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 使用分钟做后台记录(存储最小单位)前台转换</span><br><span class="line">   learn_times = models.IntegerField(default=0, verbose_name=u&quot;学习时长(分钟数)&quot;)</span><br></pre></td></tr></table></figure><p>资源下载功能:</p><p>后台自行上传点文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">all_resources = CourseResource.objects.filter(course=course)</span><br><span class="line"></span><br><span class="line">          &quot;all_resources&quot;:all_resources,</span><br></pre></td></tr></table></figure><p>或者前端直接:</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/CL7fke0LGF.png?imageslim" alt="mark"></p><p>创建课程与讲师之间的外键关联</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">teacher = models.ForeignKey(Teacher,verbose_name=u&quot;讲师&quot;, null=True, blank=True)</span><br></pre></td></tr></table></figure><p>前往课程，设置讲师。</p><p><strong>注意:不要在Unicode方法里使用外键字段很容易报错。</strong></p><p>增加课程需知字段和老师告诉你学什么？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">you_need_know = models.CharField(max_length=300, default=u&quot;一颗勤学的心是本课程必要前提&quot;,verbose_name=u&quot;课程须知&quot;)</span><br><span class="line">  teacher_tell = models.CharField(max_length=300, default=u&quot;按时交作业,不然叫家长&quot;,verbose_name=u&quot;老师告诉你&quot;)</span><br></pre></td></tr></table></figure><p>将这两个字段显示到页面。</p><p>对应commit:</p><p>8-4&amp;5完成课程章节信息，课程资源，课程老师信息。</p><h2 id="8-6-课程评论页面"><a href="#8-6-课程评论页面" class="headerlink" title="8-6 课程评论页面"></a>8-6 课程评论页面</h2><p>配置课程评论的url和view</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class CommentsView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        # 此处的id为表默认为我们添加的值。</span><br><span class="line">        course = Course.objects.get(id=int(course_id))</span><br><span class="line">        all_resources = CourseResource.objects.filter(course=course)</span><br><span class="line">        return render(request, &quot;course-comment.html&quot;, &#123;</span><br><span class="line">            &quot;course&quot;: course,</span><br><span class="line">            &quot;all_resources&quot;: all_resources,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程章节信息页</span><br><span class="line">    re_path(&apos;comments/(?P&lt;course_id&gt;\d+)/&apos;, CommentsView.as_view(), name=&quot;course_comments&quot;),</span><br></pre></td></tr></table></figure><p>course video中跳转到评论链接</p><p>发表评论功能</p><p>ajax操作。如果发布成功就会刷新页面。</p><p>新建view用于添加评论:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># ajax方式添加评论</span><br><span class="line">class AddCommentsView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        if not request.user.is_authenticated:</span><br><span class="line">            # 未登录时返回json提示未登录，跳转到登录页面是在ajax中做的</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;用户未登录&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        course_id = request.POST.get(&quot;course_id&quot;, 0)</span><br><span class="line">        comments = request.POST.get(&quot;comments&quot;, &quot;&quot;)</span><br><span class="line">        if int(course_id) &gt; 0 and comments:</span><br><span class="line">            course_comments = CourseComments()</span><br><span class="line">            # get只能取出一条数据，如果有多条抛出异常。没有数据也抛异常</span><br><span class="line">            # filter取一个列表出来，queryset。没有数据返回空的queryset不会抛异常</span><br><span class="line">            course = Course.objects.get(id = int(course_id))</span><br><span class="line">            # 外键存入要存入对象</span><br><span class="line">            course_comments.course = course</span><br><span class="line">            course_comments.comments = comments</span><br><span class="line">            course_comments.user = request.user</span><br><span class="line">            course_comments.save()</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;:&quot;评论成功&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&apos;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;评论失败&quot;&#125;&apos;, content_type=&apos;application/json&apos;)</span><br></pre></td></tr></table></figure><p>添加配套的url:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加课程评论,已经把参数放到post当中了</span></span><br><span class="line">path(<span class="string">'add_comment/'</span>, AddCommentsView.as_view(), name=<span class="string">"add_comment"</span>),</span><br></pre></td></tr></table></figure><p>js代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">    //添加评论</span><br><span class="line">    $(&apos;#js-pl-submit&apos;).on(&apos;click&apos;, function()&#123;</span><br><span class="line">        var comments = $(&quot;#js-pl-textarea&quot;).val()</span><br><span class="line">        if(comments == &quot;&quot;)&#123;</span><br><span class="line">            alert(&quot;评论不能为空&quot;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            cache: false,</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url:&quot;&#123;% url &apos;course:add_comment&apos; %&#125;&quot;,</span><br><span class="line">            data:&#123;&apos;course_id&apos;:&#123;&#123; course.id &#125;&#125;, &apos;comments&apos;:comments&#125;,</span><br><span class="line">            async: true,</span><br><span class="line">            beforeSend:function(xhr, settings)&#123;</span><br><span class="line">                xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token &#125;&#125;&quot;);</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function(data) &#123;</span><br><span class="line">                if(data.status == &apos;fail&apos;)&#123;</span><br><span class="line">                    if(data.msg == &apos;用户未登录&apos;)&#123;</span><br><span class="line">                        window.location.href=&quot;/login/&quot;;</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                        alert(data.msg)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;else if(data.status == &apos;success&apos;)&#123;</span><br><span class="line">                    window.location.reload();//刷新当前页面.</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>后端已经将all_comments传过来了。然后for循环输出。</p><p>本小节完毕对应commit:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8-6完成课程评论功能，添加评论并展示到页面。</span><br></pre></td></tr></table></figure><h2 id="8-7-相关课程推荐"><a href="#8-7-相关课程推荐" class="headerlink" title="8-7 相关课程推荐:"></a>8-7 相关课程推荐:</h2><blockquote><p>学过该课程的还学过</p></blockquote><p>CourseInfoView</p><p>添加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 选出学了这门课的学生关系</span></span><br><span class="line">        user_courses = UserCourse.objects.filter(course= course)</span><br><span class="line">        <span class="comment"># 从关系中取出user_id</span></span><br><span class="line">        user_ids = [user_course.user_id <span class="keyword">for</span> user_course <span class="keyword">in</span> user_courses]</span><br><span class="line">        <span class="comment"># 这些用户学了的课程,外键会自动有id，取到字段</span></span><br><span class="line">        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)</span><br><span class="line">        <span class="comment"># 取出所有课程id</span></span><br><span class="line">        course_ids = [all_user_course.course_id <span class="keyword">for</span> all_user_course <span class="keyword">in</span> all_user_courses]</span><br><span class="line">        <span class="comment"># 获取学过该课程用户学过的其他课程</span></span><br><span class="line">        relate_courses = Course.objects.filter(id__in=course_ids).order_by(<span class="string">"-click_nums"</span>)[:<span class="number">5</span>]</span><br><span class="line">        <span class="comment"># 是否收藏课程</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"course-video.html"</span>, &#123;</span><br><span class="line">            <span class="string">"course"</span>: course,</span><br><span class="line">            <span class="string">"all_resources"</span>: all_resources,</span><br><span class="line">            <span class="string">"relate_courses"</span>:relate_courses,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><blockquote><p>重点: 两个下划线代表我传进来的是一个list，你进行遍历。</p></blockquote><p>comments也做同样处理</p><p>用户未登录，不要让他能点进view</p><p>如果使用的是方法型编程可以使用装饰器<code>loginrequired</code></p><p>而我们使用的是类。所以要继承。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.mixins <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CourseInfoView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></span><br><span class="line">    login_url = <span class="string">'/login/'</span></span><br><span class="line">    redirect_field_name = <span class="string">'redirect_to'</span></span><br></pre></td></tr></table></figure><blockquote><p>8-7完成相关课程推荐功能，取出相关课程去除本身。课程评论login require鉴权添加。登录页面重定向回登录前浏览页面</p></blockquote><h2 id="8-8-课程播放页面"><a href="#8-8-课程播放页面" class="headerlink" title="8-8 课程播放页面"></a>8-8 课程播放页面</h2><p>将视频播放页面拷贝到template目录</p><p>使用开源库video js</p><p><img src="http://myphoto.mtianyan.cn/blog/180113/f0j8Ffec87.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/kCAHJkbAdb.png?imageslim" alt="mark"></p><p><img src="http://myphoto.mtianyan.cn/blog/180113/26FehA9AAf.png?imageslim" alt="mark"></p><p>添加访问的url和view；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 课程视频播放页</span><br><span class="line">url(r&apos;^video/(?P&lt;video_id&gt;\d+)/$&apos;, VideoPlayView.as_view(), name=&quot;video_play&quot;),</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 播放视频的view</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoPlayView</span><span class="params">(LoginRequiredMixin, View)</span>:</span></span><br><span class="line">    login_url = <span class="string">'/login/'</span></span><br><span class="line">    redirect_field_name = <span class="string">'next'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, video_id)</span>:</span></span><br><span class="line">        <span class="comment"># 此处的id为表默认为我们添加的值。</span></span><br><span class="line">        video = Video.objects.get(id=int(video_id))</span><br><span class="line">        <span class="comment"># 找到对应的course</span></span><br><span class="line">        course = video.lesson.course</span><br><span class="line">        <span class="comment"># 查询用户是否开始学习了该课，如果还未学习则，加入用户课程表</span></span><br><span class="line">        user_courses = UserCourse.objects.filter(user=request.user, course=course)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_courses:</span><br><span class="line">            user_course = UserCourse(user=request.user, course=course)</span><br><span class="line">            user_course.save()</span><br><span class="line">        <span class="comment"># 查询课程资源</span></span><br><span class="line">        all_resources = CourseResource.objects.filter(course=course)</span><br><span class="line">        <span class="comment"># 选出学了这门课的学生关系</span></span><br><span class="line">        user_courses = UserCourse.objects.filter(course=course)</span><br><span class="line">        <span class="comment"># 从关系中取出user_id</span></span><br><span class="line">        user_ids = [user_course.user_id <span class="keyword">for</span> user_course <span class="keyword">in</span> user_courses]</span><br><span class="line">        <span class="comment"># 这些用户学了的课程,外键会自动有id，取到字段</span></span><br><span class="line">        all_user_courses = UserCourse.objects.filter(user_id__in=user_ids)</span><br><span class="line">        <span class="comment"># 取出所有课程id</span></span><br><span class="line">        course_ids = [user_course.course_id <span class="keyword">for</span> user_course <span class="keyword">in</span> all_user_courses]</span><br><span class="line">        <span class="comment"># 获取学过该课程用户学过的其他课程</span></span><br><span class="line">        relate_courses = Course.objects.filter(id__in=course_ids).order_by(<span class="string">"-click_nums"</span>).exclude(id=course.id)[:<span class="number">4</span>]</span><br><span class="line">        <span class="comment"># 是否收藏课程</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">"course-play.html"</span>, &#123;</span><br><span class="line">            <span class="string">"course"</span>: course,</span><br><span class="line">            <span class="string">"all_resources"</span>: all_resources,</span><br><span class="line">            <span class="string">"relate_courses"</span>: relate_courses,</span><br><span class="line">            <span class="string">"video"</span>: video,</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure><p>title 与面包屑的修改</p><p>对应commit:</p><blockquote><p>第八章公开课模块全部完成，完结撒花。</p></blockquote></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/post/9f2a0c4b.html">强力Django+杀手级Xadmin打造在线教育平台(八)</a></p><p><span>文章作者:</span><a href="/" title="访问 mtianyan 的个人博客">mtianyan</a></p><p><span>发布时间:</span>2018年01月13日 - 22:01</p><p><span>最后更新:</span>2018年01月17日 - 00:01</p><p><span>原始链接:</span><a href="/post/9f2a0c4b.html" title="强力Django+杀手级Xadmin打造在线教育平台(八)">http://blog.mtianyan.cn/post/9f2a0c4b.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://blog.mtianyan.cn/post/9f2a0c4b.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>请博主吃包辣条</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="mtianyan 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.jpg" alt="mtianyan 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a><a href="/tags/Django/" rel="tag"><i class="fa fa-tag"></i> Django</a><a href="/tags/在线教育平台/" rel="tag"><i class="fa fa-tag"></i> 在线教育平台</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/5678b347.html" rel="next" title="强力Django+杀手级Xadmin打造在线教育平台(七)"><i class="fa fa-chevron-left"></i> 强力Django+杀手级Xadmin打造在线教育平台(七)</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/post/83fbe6af.html" rel="prev" title="强力Django+杀手级Xadmin打造在线教育平台(九)">强力Django+杀手级Xadmin打造在线教育平台(九)<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"> <span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2154292" charset="utf-8"></script></div></div></div><div class="comments" id="comments"><div id="SOHUCS"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="mtianyan"><p class="site-author-name" itemprop="name">mtianyan</p><p class="site-description motion-element" itemprop="description">爱分享，爱技术，爱生活。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">22</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/mtianyan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/db9a7a0daa1f" target="_blank" title="简书"><i class="fa fa-fw fa-book"></i> 简书</a></span><span class="links-of-author-item"><a href="https://plus.google.com/u/0/114963812195952881148" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://mtianyan.gitee.io/" title="本站孪生站(国内码云托管)" target="_blank">本站孪生站(国内码云托管)</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-课程列表"><span class="nav-number">1.</span> <span class="nav-text">8-1 课程列表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#分页功能"><span class="nav-number">1.1.</span> <span class="nav-text">分页功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对于页码进行修改"><span class="nav-number">1.2.</span> <span class="nav-text">对于页码进行修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排序功能"><span class="nav-number">1.3.</span> <span class="nav-text">排序功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-课程详情页1"><span class="nav-number">2.</span> <span class="nav-text">8-2 课程详情页1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-课程详情页2"><span class="nav-number">3.</span> <span class="nav-text">8-3 课程详情页2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#课程是否相关"><span class="nav-number">3.1.</span> <span class="nav-text">课程是否相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#收藏功能"><span class="nav-number">3.2.</span> <span class="nav-text">收藏功能:</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-课程章节信息"><span class="nav-number">4.</span> <span class="nav-text">8-4 课程章节信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-5-章节视频信息"><span class="nav-number">5.</span> <span class="nav-text">8-5 章节视频信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-6-课程评论页面"><span class="nav-number">6.</span> <span class="nav-text">8-6 课程评论页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-7-相关课程推荐"><span class="nav-number">7.</span> <span class="nav-text">8-7 相关课程推荐:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-8-课程播放页面"><span class="nav-number">8.</span> <span class="nav-text">8-8 课程播放页面</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">mtianyan</span><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共178.0k字</span></div></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="site-uv">本站访客数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span> 人次</span> <span class="site-pv">本站总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script type="text/javascript">!function(){var t="1eb79150519fd9b791c77e8eef6f3632";if((window.innerWidth||document.documentElement.clientWidth)<960)window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=cyrJmJ3rL&conf='+t+'"><\/script>');else{!function(t,e){var n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:"cyrJmJ3rL",conf:t})})}}()</script><script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script><script type="text/javascript">var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")};function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){var r=!1,s=0,a=0,i=n.title.trim(),c=i.toLowerCase(),l=n.content.trim().replace(/<[^>]+>/g,""),h=l.toLowerCase(),p=decodeURIComponent(n.url),u=[],f=[];if(""!=i&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}u=u.concat(e(t,c,!1)),f=f.concat(e(t,h,!1))}),(u.length>0||f.length>0)&&(r=!0,s=u.length+f.length)),r){[u,f].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});function d(e,o,n,r){for(var s=r[r.length-1],i=s.position,c=s.word,l=[],h=0;i+c.length<=n&&0!=r.length;){c===t&&h++,l.push({position:i,length:c.length});var p=i+c.length;for(r.pop();0!=r.length&&(i=(s=r[r.length-1]).position,c=s.word,p>i);)r.pop()}return a+=h,{hits:l,start:o,end:n,searchTextCount:h}}var g=[];0!=u.length&&g.push(d(0,0,i.length,u));for(var v=[];0!=f.length;){var $=f[f.length-1],C=$.position,m=$.word,x=C-20,w=C+80;x<0&&(x=0),w<C+m.length&&(w=C+m.length),w>l.length&&(w=l.length),v.push(d(0,x,w,f))}v.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var y=parseInt("1");y>=0&&(v=v.slice(0,y));function T(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var b="";0!=g.length?b+="<li><a href='"+p+"' class='search-result-title'>"+T(i,g[0])+"</a>":b+="<li><a href='"+p+"' class='search-result-title'>"+i+"</a>",v.forEach(function(t){b+="<a href='"+p+'\'><p class="search-result">'+T(l,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:a,hitCount:s,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("2uqmIjYredIvFy6tEXbKG4Fj-gzGzoHsz","CWl1rE8cQlIseOg2Cq3hzxYi")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var i=0;i<e.length;i++){var s=e[i],r=s.get("url"),l=s.get("time"),c=document.getElementById(r);$(c).find(t).text(l)}for(i=0;i<n.length;i++){r=n[i],c=document.getElementById(r);var u=$(c).find(t);""==u.text()&&u.text(0)}}else o.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var s=new e,r=new AV.ACL;r.setPublicReadAccess(!0),r.setPublicWriteAccess(!0),s.setACL(r),s.set("title",o),s.set("url",n),s.set("time",1),s.save(null,{success:function(e){$(document.getElementById(n)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="default",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="default",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Wechat,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script><script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><div id="hexo-helper-live2d"><canvas id="live2dcanvas" width="150" height="300"></canvas></div><style>#live2dcanvas{position:fixed;width:150px;height:300px;opacity:.7;right:-30px;z-index:999;pointer-events:none;bottom:40px}</style><script type="text/javascript" src="/live2d/device.min.js"></script><script type="text/javascript">
const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    var trElement = document.getElementById('hexo-helper-live2d');
    trElement.parentNode.removeChild(trElement);
    return;
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/hijiki.model.json", 0.5);});
})();
</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>